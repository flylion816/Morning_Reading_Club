# æ™¨è¯»è¥å°ç¨‹åº - æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£ v1.0

**é¡¹ç›®åç§°**ï¼šæ™¨è¯»è¥å°ç¨‹åº  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0ï¼ˆæ¶æ„è®¾è®¡é˜¶æ®µï¼‰  
**ç¼–åˆ¶æ—¥æœŸ**ï¼š2025å¹´10æœˆ30æ—¥  
**é€‚ç”¨èŒƒå›´**ï¼šå‰ç«¯ã€åç«¯ã€æµ‹è¯•ã€è¿ç»´å›¢é˜Ÿ  
**çŠ¶æ€**ï¼šâœ… å‡†å¤‡è¿›å…¥ç ”å‘ç¼–ç é˜¶æ®µ

---

## ç›®å½•

1. [æ¶æ„è®¾è®¡æ¦‚è¿°](#1-æ¶æ„è®¾è®¡æ¦‚è¿°)
2. [ç³»ç»Ÿæ•´ä½“æ¶æ„](#2-ç³»ç»Ÿæ•´ä½“æ¶æ„)
3. [å‰ç«¯æŠ€æœ¯æ¶æ„](#3-å‰ç«¯æŠ€æœ¯æ¶æ„)
4. [åç«¯æŠ€æœ¯æ¶æ„](#4-åç«¯æŠ€æœ¯æ¶æ„)
5. [æ•°æ®åº“æ¶æ„è®¾è®¡](#5-æ•°æ®åº“æ¶æ„è®¾è®¡)
6. [ç¼“å­˜ä¸å­˜å‚¨ç­–ç•¥](#6-ç¼“å­˜ä¸å­˜å‚¨ç­–ç•¥)
7. [æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥å¤„ç†](#7-æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥å¤„ç†)
8. [APIç½‘å…³ä¸è·¯ç”±](#8-apiç½‘å…³ä¸è·¯ç”±)
9. [è®¤è¯ä¸æƒé™ä½“ç³»](#9-è®¤è¯ä¸æƒé™ä½“ç³»)
10. [å®‰å…¨ä¸éšç§ä¿æŠ¤](#10-å®‰å…¨ä¸éšç§ä¿æŠ¤)
11. [æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ](#11-æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ)
12. [ç›‘æ§ã€æ—¥å¿—ä¸å‘Šè­¦](#12-ç›‘æ§æ—¥å¿—ä¸å‘Šè­¦)
13. [éƒ¨ç½²æ¶æ„](#13-éƒ¨ç½²æ¶æ„)
14. [ç¾éš¾æ¢å¤ä¸é«˜å¯ç”¨](#14-ç¾éš¾æ¢å¤ä¸é«˜å¯ç”¨)
15. [é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡](#15-é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡)
16. [æŠ€æœ¯æ ˆé€‰å‹æ€»ç»“](#16-æŠ€æœ¯æ ˆé€‰å‹æ€»ç»“)

---

# 1 æ¶æ„è®¾è®¡æ¦‚è¿°

## 1.1 è®¾è®¡åŸåˆ™

### æ ¸å¿ƒåŸåˆ™
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒ50,000+ç”¨æˆ·ï¼Œæ—¥æ´»10,000+
- **å¯é æ€§**ï¼šæ ¸å¿ƒä¸šåŠ¡æµç¨‹å®¹é”™èƒ½åŠ›å¼ºï¼ŒRTO â‰¤ 1å°æ—¶
- **æ€§èƒ½**ï¼šAPIå“åº”æ—¶é—´ P99 < 500msï¼Œé¡µé¢åŠ è½½ < 2s
- **å®‰å…¨æ€§**ï¼šç”¨æˆ·æ•°æ®åŠ å¯†å­˜å‚¨ï¼Œæƒé™ç»†ç²’åº¦æ§åˆ¶
- **æ˜“ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼Œä¾¿äºè¿­ä»£å’Œæ‰©å±•

### æ¶æ„é£æ ¼
- **å‰åç«¯åˆ†ç¦»**ï¼šå¾®ä¿¡å°ç¨‹åº + RESTful API
- **åˆ†å±‚è®¾è®¡**ï¼šè¡¨ç°å±‚ã€åº”ç”¨å±‚ã€ä¸šåŠ¡å±‚ã€æ•°æ®å±‚
- **æœåŠ¡åˆ†ç¦»**ï¼šæ ¸å¿ƒæœåŠ¡ã€ç”¨æˆ·æœåŠ¡ã€è¯¾ç¨‹æœåŠ¡ã€åé¦ˆæœåŠ¡
- **äº‹ä»¶é©±åŠ¨**ï¼šå¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æ‰“å¡ã€åé¦ˆç”Ÿæˆç­‰è€—æ—¶æ“ä½œ

## 1.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æŒ‡æ ‡ | ä¼˜å…ˆçº§ |
|------|------|--------|
| ç”¨æˆ·ä½“éªŒ | é¡µé¢åŠ è½½ < 2sï¼Œæ“ä½œå“åº” < 300ms | ğŸ”´ P0 |
| ç³»ç»Ÿæ€§èƒ½ | API P99 < 500msï¼Œç¼“å­˜å‘½ä¸­ç‡ > 80% | ğŸ”´ P0 |
| é«˜å¯ç”¨ | å¯ç”¨æ€§ 99.5%+ï¼Œæ•…éšœè‡ªåŠ¨è½¬ç§» | ğŸ”´ P0 |
| æ•°æ®å®‰å…¨ | ç”¨æˆ·æ•°æ®åŠ å¯†ï¼Œæƒé™éšç§ä¿æŠ¤ | ğŸ”´ P0 |
| å¯ç»´æŠ¤æ€§ | ä»£ç è´¨é‡è¾¾æ ‡ï¼Œæ–‡æ¡£å®Œæ•´ | ğŸŸ¡ P1 |
| æˆæœ¬æ§åˆ¶ | èµ„æºåˆ©ç”¨ç‡ > 70%ï¼Œè‡ªåŠ¨æ‰©ç¼©å®¹ | ğŸŸ¡ P1 |

## 1.3 æ¶æ„æ¼”è¿›è·¯çº¿

```
v1.0: å•ä½“+åˆ†å¸ƒå¼DB+ç¼“å­˜ (å³å°†å¼€å‘)
  â†“
v2.0: å¾®æœåŠ¡+æ¶ˆæ¯é˜Ÿåˆ—+åˆ†æç³»ç»Ÿ (2026å¹´2æœˆ)
  â†“
v3.0: äº‘åŸç”Ÿ+å®¹å™¨ç¼–æ’+CDN (2026å¹´4æœˆ)
```

---

# 2 ç³»ç»Ÿæ•´ä½“æ¶æ„

## 2.1 ä¸‰å±‚æ¶æ„æ€»ä½“å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®¢æˆ·ç«¯å±‚ (Client)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å¾®ä¿¡å°ç¨‹åº(iOS) â”‚  â”‚ å¾®ä¿¡å°ç¨‹åº(Android)â”‚  â”‚  æµè§ˆå™¨   â”‚ â”‚
â”‚  â”‚   WeChat Mini    â”‚  â”‚   WeChat Mini    â”‚  â”‚   (åˆ†äº«)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTPS
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                APIç½‘å…³ä¸CDNå±‚ (Gateway/CDN)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Nginx / API Gateway (è·¯ç”±ã€é™æµã€ç¼“å­˜)                   â”‚ â”‚
â”‚  â”‚ CDNæœåŠ¡ (é™æ€èµ„æºã€å›¾ç‰‡åŠ é€Ÿ)                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ REST API
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åº”ç”¨æœåŠ¡å±‚ (Application Layer)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  ç”¨æˆ·æœåŠ¡    â”‚ â”‚  è¯¾ç¨‹æœåŠ¡    â”‚ â”‚  æ‰“å¡æœåŠ¡    â”‚         â”‚
â”‚  â”‚  User Svc    â”‚ â”‚  Course Svc  â”‚ â”‚  CheckIn Svc â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  è¯„è®ºæœåŠ¡    â”‚ â”‚  åé¦ˆæœåŠ¡    â”‚ â”‚  æƒé™æœåŠ¡    â”‚         â”‚
â”‚  â”‚ Comment Svc  â”‚ â”‚ Insight Svc  â”‚ â”‚ Permission   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¸šåŠ¡ä¸­é—´ä»¶å±‚ (è®¤è¯ã€æˆæƒã€æ—¥å¿—ã€å¼‚å¸¸å¤„ç†)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         â”‚             â”‚
    â–¼                         â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼“å­˜å±‚      â”‚ â”‚ é˜Ÿåˆ—å±‚           â”‚ â”‚ æ–‡ä»¶å­˜å‚¨      â”‚
â”‚ Redis       â”‚ â”‚ Message Queue    â”‚ â”‚ å¯¹è±¡å­˜å‚¨(OSS) â”‚
â”‚ (çƒ­æ•°æ®)    â”‚ â”‚ (RabbitMQ/Kafka) â”‚ â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚                   â”‚
       â”‚                 â–¼                   â”‚
       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚         â”‚ å¼‚æ­¥å¤„ç†å±‚          â”‚    â”‚
       â”‚         â”‚ AIåé¦ˆç”Ÿæˆ          â”‚    â”‚
       â”‚         â”‚ å®šæ—¶ä»»åŠ¡            â”‚    â”‚
       â”‚         â”‚ æ¶ˆæ¯æ¨é€            â”‚    â”‚
       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                    â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚           â”‚
                â–¼           â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    æ•°æ®æŒä¹…å±‚            â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
         â”‚  â”‚ MySQLä¸»ä»å¤åˆ¶        â”‚â”‚
         â”‚  â”‚ åˆ†åº“åˆ†è¡¨ç­–ç•¥         â”‚â”‚
         â”‚  â”‚ è¯»å†™åˆ†ç¦»             â”‚â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
         â”‚  â”‚ MongoDB (æ—¥å¿—å­˜å‚¨)   â”‚â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
         â”‚  â”‚ Elasticsearch (æœç´¢) â”‚â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2.2 ç³»ç»Ÿæ¨¡å—åˆ’åˆ†

```
æ™¨è¯»è¥ç³»ç»Ÿ
â”œâ”€ ç”¨æˆ·æ¨¡å— (User Module)
â”‚  â”œâ”€ æ³¨å†Œ/ç™»å½• (Authentication)
â”‚  â”œâ”€ ä¸ªäººä¿¡æ¯ç®¡ç† (Profile Management)
â”‚  â”œâ”€ æƒé™ç®¡ç† (Authorization)
â”‚  â””â”€ æ•°æ®ç»Ÿè®¡ (User Analytics)
â”‚
â”œâ”€ è¯¾ç¨‹æ¨¡å— (Course Module)
â”‚  â”œâ”€ è¯¾ç¨‹æœŸæ¬¡ç®¡ç† (Period Management)
â”‚  â”œâ”€ è¯¾ç¨‹å†…å®¹ç®¡ç† (Section Content)
â”‚  â”œâ”€ ç”¨æˆ·æŠ¥å (Enrollment)
â”‚  â””â”€ è¯¾ç¨‹è¿›åº¦è¿½è¸ª (Progress Tracking)
â”‚
â”œâ”€ æ‰“å¡æ¨¡å— (Check-in Module)
â”‚  â”œâ”€ æ‰“å¡è®°å½• (Check-in Record)
â”‚  â”œâ”€ æ‰“å¡ç»Ÿè®¡ (Statistics)
â”‚  â”œâ”€ è¡¥å¡å¤„ç† (Make-up Check-in)
â”‚  â””â”€ å¼‚å¸¸å¤„ç† (Exception Handling)
â”‚
â”œâ”€ åé¦ˆæ¨¡å— (Insight Module)
â”‚  â”œâ”€ AIåé¦ˆç”Ÿæˆ (AI Generation)
â”‚  â”œâ”€ åé¦ˆå­˜å‚¨ (Insight Storage)
â”‚  â”œâ”€ åé¦ˆåˆ†äº« (Share Management)
â”‚  â””â”€ åé¦ˆåˆ†æ (Analytics)
â”‚
â”œâ”€ ç¤¾ç¾¤æ¨¡å— (Community Module)
â”‚  â”œâ”€ è¯„è®ºç®¡ç† (Comment Management)
â”‚  â”œâ”€ ç‚¹èµç³»ç»Ÿ (Like System)
â”‚  â”œâ”€ ç”¨æˆ·äº’åŠ¨ (User Interaction)
â”‚  â””â”€ å†…å®¹å®¡æ ¸ (Content Moderation)
â”‚
â”œâ”€ æƒé™æ¨¡å— (Permission Module)
â”‚  â”œâ”€ æƒé™è¯·æ±‚ (Permission Request)
â”‚  â”œâ”€ æƒé™å®¡æ‰¹ (Permission Review)
â”‚  â”œâ”€ æƒé™ç¼“å­˜ (Permission Cache)
â”‚  â””â”€ æƒé™å®¡è®¡ (Permission Audit)
â”‚
â”œâ”€ åå°ç®¡ç†æ¨¡å— (Admin Module - v2.0)
â”‚  â”œâ”€ è¯¾ç¨‹ç®¡ç† (Course Management)
â”‚  â”œâ”€ ç”¨æˆ·ç®¡ç† (User Management)
â”‚  â”œâ”€ æ•°æ®åˆ†æ (Data Analytics)
â”‚  â””â”€ æ¶ˆæ¯æ¨é€ (Message Push)
â”‚
â””â”€ åŸºç¡€è®¾æ–½æ¨¡å— (Infrastructure)
   â”œâ”€ è®¤è¯æœåŠ¡ (Auth Service)
   â”œâ”€ æ—¥å¿—æœåŠ¡ (Logging)
   â”œâ”€ ç›‘æ§å‘Šè­¦ (Monitoring)
   â”œâ”€ ç¼“å­˜æœåŠ¡ (Caching)
   â””â”€ æ¶ˆæ¯é˜Ÿåˆ— (Message Queue)
```

---

# 3 å‰ç«¯æŠ€æœ¯æ¶æ„

## 3.1 æŠ€æœ¯æ ˆé€‰å‹

| æŠ€æœ¯ | é€‰å‹ | ç†ç”± |
|------|------|------|
| **æ¡†æ¶** | å¾®ä¿¡å°ç¨‹åºåŸç”Ÿ + Taroæ¡†æ¶ | åŸç”Ÿç¨³å®šï¼ŒTaroæ”¯æŒå¤šç«¯å¤ç”¨ |
| **UIç»„ä»¶** | Vant Weapp / NutUI | è½»é‡ã€æ–‡æ¡£å®Œå–„ã€é€‚é…å°ç¨‹åº |
| **çŠ¶æ€ç®¡ç†** | Pinia (Vue3é£æ ¼) | ç®€æ´ã€ç±»å‹å®‰å…¨ã€æ˜“ç»´æŠ¤ |
| **ç½‘ç»œè¯·æ±‚** | Axios + è‡ªå®šä¹‰æ‹¦æˆªå™¨ | æ”¯æŒè¯·æ±‚/å“åº”æ‹¦æˆªï¼Œé”™è¯¯å¤„ç† |
| **æœ¬åœ°å­˜å‚¨** | wx.getStorage + IndexedDB | å°ç¨‹åºåŸç”Ÿå­˜å‚¨æ–¹æ¡ˆ |
| **æ‰“åŒ…å·¥å…·** | Webpack 5 | æ”¯æŒä»£ç åˆ†å‰²ã€tree-shaking |
| **CSSé¢„å¤„ç†** | SCSS/LESS | æ ·å¼å¤ç”¨ã€å˜é‡ç®¡ç† |
| **å•å…ƒæµ‹è¯•** | Jest + Testing Library | ç»„ä»¶æµ‹è¯•è¦†ç›–ç‡ > 80% |
| **æ„å»ºéƒ¨ç½²** | CI/CD (GitHub Actions) | è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒ |

## 3.2 å‰ç«¯é¡¹ç›®ç»“æ„

```
wechat-miniapp-morning-reading/
â”œâ”€ src/
â”‚  â”œâ”€ pages/                          # é¡µé¢ç›®å½•
â”‚  â”‚  â”œâ”€ index/                       # é¦–é¡µ
â”‚  â”‚  â”‚  â”œâ”€ index.wxml
â”‚  â”‚  â”‚  â”œâ”€ index.scss
â”‚  â”‚  â”‚  â””â”€ index.js
â”‚  â”‚  â”œâ”€ courses/                     # è¯¾ç¨‹åˆ—è¡¨
â”‚  â”‚  â”œâ”€ course-detail/               # è¯¾ç¨‹è¯¦æƒ…
â”‚  â”‚  â”œâ”€ checkin/                     # æ‰“å¡é¡µé¢
â”‚  â”‚  â”œâ”€ profile/                     # ä¸ªäººä¸»é¡µ
â”‚  â”‚  â”œâ”€ profile-others/              # ä»–äººä¸»é¡µ
â”‚  â”‚  â”œâ”€ insights/                    # å°å‡¡çœ‹è§åˆ—è¡¨
â”‚  â”‚  â”œâ”€ insight-detail/              # åé¦ˆè¯¦æƒ…
â”‚  â”‚  â””â”€ share/                       # åˆ†äº«å¡ç‰‡
â”‚  â”‚
â”‚  â”œâ”€ components/                     # å¯å¤ç”¨ç»„ä»¶
â”‚  â”‚  â”œâ”€ course-card/                 # è¯¾ç¨‹å¡ç‰‡
â”‚  â”‚  â”œâ”€ course-list-item/            # è¯¾ç¨‹åˆ—è¡¨é¡¹
â”‚  â”‚  â”œâ”€ comment-item/                # è¯„è®ºé¡¹
â”‚  â”‚  â”œâ”€ permission-request/          # æƒé™è¯·æ±‚
â”‚  â”‚  â”œâ”€ progress-bar/                # è¿›åº¦æ¡
â”‚  â”‚  â”œâ”€ user-avatar/                 # ç”¨æˆ·å¤´åƒ
â”‚  â”‚  â”œâ”€ loading-skeleton/            # éª¨æ¶å±
â”‚  â”‚  â””â”€ toast/                       # æç¤ºæ¡†
â”‚  â”‚
â”‚  â”œâ”€ services/                       # APIæœåŠ¡
â”‚  â”‚  â”œâ”€ api.ts                       # APIåŸºç±»
â”‚  â”‚  â”œâ”€ user.service.ts              # ç”¨æˆ·æœåŠ¡
â”‚  â”‚  â”œâ”€ course.service.ts            # è¯¾ç¨‹æœåŠ¡
â”‚  â”‚  â”œâ”€ checkin.service.ts           # æ‰“å¡æœåŠ¡
â”‚  â”‚  â”œâ”€ comment.service.ts           # è¯„è®ºæœåŠ¡
â”‚  â”‚  â”œâ”€ insight.service.ts           # åé¦ˆæœåŠ¡
â”‚  â”‚  â””â”€ permission.service.ts        # æƒé™æœåŠ¡
â”‚  â”‚
â”‚  â”œâ”€ store/                          # çŠ¶æ€ç®¡ç†
â”‚  â”‚  â”œâ”€ modules/
â”‚  â”‚  â”‚  â”œâ”€ user.store.ts             # ç”¨æˆ·çŠ¶æ€
â”‚  â”‚  â”‚  â”œâ”€ course.store.ts           # è¯¾ç¨‹çŠ¶æ€
â”‚  â”‚  â”‚  â”œâ”€ ui.store.ts               # UIçŠ¶æ€
â”‚  â”‚  â”‚  â””â”€ cache.store.ts            # ç¼“å­˜çŠ¶æ€
â”‚  â”‚  â””â”€ index.ts
â”‚  â”‚
â”‚  â”œâ”€ utils/                          # å·¥å…·å‡½æ•°
â”‚  â”‚  â”œâ”€ request.ts                   # è¯·æ±‚æ‹¦æˆªå™¨
â”‚  â”‚  â”œâ”€ storage.ts                   # å­˜å‚¨å·¥å…·
â”‚  â”‚  â”œâ”€ date.ts                      # æ—¶é—´å·¥å…·
â”‚  â”‚  â”œâ”€ validator.ts                 # è¡¨å•éªŒè¯
â”‚  â”‚  â”œâ”€ formatter.ts                 # æ•°æ®æ ¼å¼åŒ–
â”‚  â”‚  â””â”€ auth.ts                      # è®¤è¯å·¥å…·
â”‚  â”‚
â”‚  â”œâ”€ styles/                         # å…¨å±€æ ·å¼
â”‚  â”‚  â”œâ”€ variables.scss               # CSSå˜é‡
â”‚  â”‚  â”œâ”€ mixins.scss                  # SCSSæ··å…¥
â”‚  â”‚  â””â”€ reset.scss                   # é‡ç½®æ ·å¼
â”‚  â”‚
â”‚  â”œâ”€ config/                         # é…ç½®æ–‡ä»¶
â”‚  â”‚  â”œâ”€ api.config.ts                # APIé…ç½®
â”‚  â”‚  â”œâ”€ app.config.ts                # åº”ç”¨é…ç½®
â”‚  â”‚  â””â”€ constants.ts                 # å¸¸é‡å®šä¹‰
â”‚  â”‚
â”‚  â””â”€ app.ts                          # åº”ç”¨ä¸»æ–‡ä»¶
â”‚
â”œâ”€ tests/                             # æµ‹è¯•æ–‡ä»¶
â”‚  â”œâ”€ unit/
â”‚  â”‚  â”œâ”€ services/
â”‚  â”‚  â”œâ”€ utils/
â”‚  â”‚  â””â”€ store/
â”‚  â””â”€ integration/
â”‚
â”œâ”€ .github/workflows/                 # CI/CDé…ç½®
â”‚  â”œâ”€ build.yml
â”‚  â”œâ”€ test.yml
â”‚  â””â”€ deploy.yml
â”‚
â”œâ”€ dist/                              # æ„å»ºè¾“å‡º
â”œâ”€ .eslintrc                          # ESLinté…ç½®
â”œâ”€ .prettierrc                        # ä»£ç æ ¼å¼åŒ–
â”œâ”€ tsconfig.json                      # TypeScripté…ç½®
â”œâ”€ package.json
â””â”€ README.md
```

## 3.3 æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### è¯·æ±‚æ‹¦æˆªå™¨è®¾è®¡

```typescript
// src/utils/request.ts
class HttpClient {
  private baseURL = process.env.API_BASE_URL
  private timeout = 10000
  
  // è¯·æ±‚æ‹¦æˆª
  async request(config: RequestConfig) {
    // 1. æ£€æŸ¥tokenï¼Œè‡ªåŠ¨åˆ·æ–°è¿‡æœŸtoken
    const token = await this.getValidToken()
    config.headers = {
      ...config.headers,
      'Authorization': `Bearer ${token}`,
      'X-Client-Version': APP_VERSION
    }
    
    // 2. æ·»åŠ é€šç”¨å‚æ•°
    config.data = {
      ...config.data,
      _ts: Date.now(),
      _platform: 'wechat-mini'
    }
    
    // 3. å‘èµ·è¯·æ±‚
    try {
      const response = await wx.request(config)
      return this.handleResponse(response)
    } catch (error) {
      return this.handleError(error)
    }
  }
  
  // å“åº”æ‹¦æˆª
  private handleResponse(response: any) {
    const { statusCode, data } = response
    
    if (statusCode === 401) {
      // tokenå¤±æ•ˆï¼Œè§¦å‘é‡æ–°ç™»å½•
      this.emit('TOKEN_EXPIRED')
      throw new AuthError('Tokenå·²è¿‡æœŸ')
    }
    
    if (statusCode >= 500) {
      // æœåŠ¡å™¨é”™è¯¯
      reportError(data)
      throw new ServerError(data.message)
    }
    
    if (data.code !== 0) {
      // ä¸šåŠ¡é”™è¯¯
      throw new BusinessError(data.message, data.code)
    }
    
    return data.data
  }
}

export const http = new HttpClient()
```

### çŠ¶æ€ç®¡ç†è®¾è®¡

```typescript
// src/store/modules/course.store.ts
import { defineStore } from 'pinia'

export const useCourseStore = defineStore('course', {
  state: () => ({
    // ç”¨æˆ·å·²æŠ¥åçš„è¯¾ç¨‹åˆ—è¡¨
    enrolledCourses: [] as Course[],
    // å½“å‰æŸ¥çœ‹çš„è¯¾ç¨‹
    currentCourse: null as Course | null,
    // è¯¾ç¨‹å†…å®¹ç¼“å­˜
    sectionCache: new Map<number, Section>(),
    // æ‰“å¡ç»Ÿè®¡
    statistics: {} as CourseStats,
    // åŠ è½½çŠ¶æ€
    loading: false,
    error: null as string | null
  }),
  
  getters: {
    // è·å–å¾…æ‰“å¡è¯¾ç¨‹
    pendingCourses(): Course[] {
      return this.enrolledCourses.filter(c => 
        c.current_progress < c.total_sections
      )
    },
    
    // è·å–å·²å®Œæˆè¯¾ç¨‹
    completedCourses(): Course[] {
      return this.enrolledCourses.filter(c => 
        c.current_progress === c.total_sections
      )
    },
    
    // æ€»ä½“è¿›åº¦
    overallProgress(): number {
      const total = this.enrolledCourses.length
      if (total === 0) return 0
      return Math.round(
        this.enrolledCourses.reduce((sum, c) => sum + c.current_progress, 0) / 
        this.enrolledCourses.reduce((sum, c) => sum + c.total_sections, 0) * 100
      )
    }
  },
  
  actions: {
    // è·å–å·²æŠ¥åè¯¾ç¨‹
    async fetchEnrolledCourses() {
      this.loading = true
      try {
        const courses = await courseService.getEnrolledCourses()
        this.enrolledCourses = courses
      } catch (err) {
        this.error = err.message
      } finally {
        this.loading = false
      }
    },
    
    // è·å–è¯¾ç¨‹è¯¦æƒ…ï¼ˆå¸¦ç¼“å­˜ï¼‰
    async getCourseDetail(courseId: number) {
      // ä¼˜å…ˆä»ç¼“å­˜è·å–
      if (this.sectionCache.has(courseId)) {
        return this.sectionCache.get(courseId)
      }
      
      const section = await courseService.getCourseDetail(courseId)
      this.sectionCache.set(courseId, section)
      return section
    },
    
    // æ¸…é™¤ç¼“å­˜
    clearCache() {
      this.sectionCache.clear()
    }
  }
})
```

### ç»„ä»¶åŒ–UIè®¾è®¡

```typescript
// src/components/course-card/CourseCard.wxml
<view class="course-card" bindtap="onTap">
  <image 
    class="course-image" 
    src="{{ course.image_url }}"
    mode="aspectFill"
  />
  <view class="course-content">
    <view class="course-header">
      <text class="course-emoji">{{ course.emoji }}</text>
      <text class="course-title">{{ course.title }}</text>
    </view>
    
    <view class="course-meta">
      <text class="meta-item">
        {{ course.start_date }} - {{ course.end_date }}
      </text>
      <text class="meta-item">
        {{ current_progress }}/{{ total_sections }}
      </text>
    </view>
    
    <view class="progress-section">
      <view class="progress-bar">
        <view 
          class="progress-fill" 
          style="width: {{ progress_percentage }}%"
        />
      </view>
      <text class="progress-text">{{ progress_percentage }}%</text>
    </view>
    
    <view class="action-button">
      <button class="btn-primary" wx:if="{{ !completed }}">
        å»è¡¥å¡
      </button>
      <text class="status-completed" wx:else>å·²å®Œæˆ âœ“</text>
    </view>
  </view>
</view>

// src/components/course-card/CourseCard.ts
Component({
  properties: {
    course: { type: Object },
    onTap: { type: Function }
  },
  
  data: {
    progress_percentage: 0
  },
  
  lifetimes: {
    attached() {
      this.calculateProgress()
    }
  },
  
  methods: {
    calculateProgress() {
      const { current_progress, total_sections } = this.data.course
      const percentage = Math.round(
        (current_progress / total_sections) * 100
      )
      this.setData({ progress_percentage: percentage })
    },
    
    onTap() {
      this.triggerEvent('tap', this.data.course)
    }
  }
})
```

---

# 4 åç«¯æŠ€æœ¯æ¶æ„

## 4.1 æŠ€æœ¯æ ˆé€‰å‹

| æŠ€æœ¯ | é€‰å‹ | ç†ç”± |
|------|------|------|
| **æ¡†æ¶** | Spring Boot 3 + Spring Cloud | ç”Ÿæ€å®Œå–„ã€æ”¯æŒå¾®æœåŠ¡ã€æ€§èƒ½ä¼˜å¼‚ |
| **è¯­è¨€** | Java 17 | é•¿æœŸæ”¯æŒç‰ˆæœ¬ã€æ€§èƒ½å¥½ã€ç”Ÿæ€ä¸°å¯Œ |
| **API** | Spring Web MVC | RESTful APIå¼€å‘æ ‡å‡† |
| **æ•°æ®åº“** | MySQL 8.0 | ACIDäº‹åŠ¡ã€é«˜å¯ç”¨æ–¹æ¡ˆæˆç†Ÿ |
| **ç¼“å­˜** | Redis 7 | é«˜æ€§èƒ½å†…å­˜æ•°æ®åº“ã€æ”¯æŒå¤šç§æ•°æ®ç»“æ„ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | RabbitMQ 3.12 | å¯é æŠ•é€’ã€æ”¯æŒäº‹åŠ¡ã€é›†ç¾¤åŒ– |
| **æœç´¢å¼•æ“** | Elasticsearch 8 | å…¨æ–‡æœç´¢ã€æ—¥å¿—åˆ†æã€èšåˆæŸ¥è¯¢ |
| **ORM** | MyBatis-Plus | é«˜æ•ˆæ•°æ®è®¿é—®ã€ä»£ç ç”Ÿæˆ |
| **éªŒè¯æ¡†æ¶** | Validation API | å‚æ•°éªŒè¯ã€å›½é™…åŒ– |
| **æ—¥å¿—** | SLF4J + Logback | ç»“æ„åŒ–æ—¥å¿—ã€æ”¯æŒå¼‚æ­¥å†™å…¥ |
| **å•å…ƒæµ‹è¯•** | JUnit5 + Mockito | å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80% |
| **é›†æˆæµ‹è¯•** | TestContainers | å®¹å™¨åŒ–æµ‹è¯•æ•°æ®åº“å’Œä¸­é—´ä»¶ |
| **æ–‡æ¡£** | Springdoc OpenAPI | è‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£ |

## 4.2 åç«¯é¡¹ç›®ç»“æ„

```
morning-reading-backend/
â”œâ”€ src/main/java/com/morningreading/
â”‚  â”œâ”€ MorningReadingApplication.java   # å¯åŠ¨ç±»
â”‚  â”‚
â”‚  â”œâ”€ controller/                      # æ§åˆ¶å±‚
â”‚  â”‚  â”œâ”€ AuthController.java           # è®¤è¯
â”‚  â”‚  â”œâ”€ UserController.java           # ç”¨æˆ·
â”‚  â”‚  â”œâ”€ CourseController.java         # è¯¾ç¨‹
â”‚  â”‚  â”œâ”€ CheckInController.java        # æ‰“å¡
â”‚  â”‚  â”œâ”€ CommentController.java        # è¯„è®º
â”‚  â”‚  â”œâ”€ InsightController.java        # åé¦ˆ
â”‚  â”‚  â””â”€ PermissionController.java     # æƒé™
â”‚  â”‚
â”‚  â”œâ”€ service/                         # ä¸šåŠ¡é€»è¾‘å±‚
â”‚  â”‚  â”œâ”€ AuthService.java              # è®¤è¯æœåŠ¡
â”‚  â”‚  â”œâ”€ UserService.java              # ç”¨æˆ·æœåŠ¡
â”‚  â”‚  â”œâ”€ CourseService.java            # è¯¾ç¨‹æœåŠ¡
â”‚  â”‚  â”œâ”€ CheckInService.java           # æ‰“å¡æœåŠ¡
â”‚  â”‚  â”œâ”€ CommentService.java           # è¯„è®ºæœåŠ¡
â”‚  â”‚  â”œâ”€ InsightService.java           # åé¦ˆæœåŠ¡
â”‚  â”‚  â”œâ”€ PermissionService.java        # æƒé™æœåŠ¡
â”‚  â”‚  â”œâ”€ AiInsightService.java         # AIåé¦ˆç”Ÿæˆ
â”‚  â”‚  â””â”€ NotificationService.java      # é€šçŸ¥æœåŠ¡
â”‚  â”‚
â”‚  â”œâ”€ repository/                      # æ•°æ®è®¿é—®å±‚
â”‚  â”‚  â”œâ”€ UserRepository.java           # ç”¨æˆ·æ•°æ®
â”‚  â”‚  â”œâ”€ CourseRepository.java         # è¯¾ç¨‹æ•°æ®
â”‚  â”‚  â”œâ”€ CheckInRepository.java        # æ‰“å¡æ•°æ®
â”‚  â”‚  â”œâ”€ CommentRepository.java        # è¯„è®ºæ•°æ®
â”‚  â”‚  â”œâ”€ InsightRepository.java        # åé¦ˆæ•°æ®
â”‚  â”‚  â””â”€ PermissionRepository.java     # æƒé™æ•°æ®
â”‚  â”‚
â”‚  â”œâ”€ entity/                          # æ•°æ®å®ä½“
â”‚  â”‚  â”œâ”€ User.java
â”‚  â”‚  â”œâ”€ Course.java
â”‚  â”‚  â”œâ”€ CheckIn.java
â”‚  â”‚  â”œâ”€ Comment.java
â”‚  â”‚  â”œâ”€ Insight.java
â”‚  â”‚  â”œâ”€ Permission.java
â”‚  â”‚  â”œâ”€ UserCourse.java               # ç”¨æˆ·è¯¾ç¨‹å…³ç³»
â”‚  â”‚  â””â”€ PermissionRequest.java        # æƒé™è¯·æ±‚
â”‚  â”‚
â”‚  â”œâ”€ dto/                             # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚  â”‚  â”œâ”€ request/
â”‚  â”‚  â”‚  â”œâ”€ SignUpRequest.java
â”‚  â”‚  â”‚  â”œâ”€ CheckInRequest.java
â”‚  â”‚  â”‚  â”œâ”€ CommentRequest.java
â”‚  â”‚  â”‚  â””â”€ PermissionRequest.java
â”‚  â”‚  â””â”€ response/
â”‚  â”‚     â”œâ”€ UserResponse.java
â”‚  â”‚     â”œâ”€ CourseResponse.java
â”‚  â”‚     â”œâ”€ CheckInResponse.java
â”‚  â”‚     â””â”€ InsightResponse.java
â”‚  â”‚
â”‚  â”œâ”€ exception/                       # å¼‚å¸¸å¤„ç†
â”‚  â”‚  â”œâ”€ BusinessException.java
â”‚  â”‚  â”œâ”€ ValidationException.java
â”‚  â”‚  â”œâ”€ AuthorizationException.java
â”‚  â”‚  â”œâ”€ GlobalExceptionHandler.java   # å…¨å±€å¼‚å¸¸å¤„ç†
â”‚  â”‚  â””â”€ ErrorCode.java                # é”™è¯¯ç å®šä¹‰
â”‚  â”‚
â”‚  â”œâ”€ config/                          # é…ç½®ç±»
â”‚  â”‚  â”œâ”€ MybatisPlusConfig.java        # MyBatisé…ç½®
â”‚  â”‚  â”œâ”€ RedisConfig.java              # Redisé…ç½®
â”‚  â”‚  â”œâ”€ RabbitMqConfig.java           # RabbitMQé…ç½®
â”‚  â”‚  â”œâ”€ ElasticsearchConfig.java      # ESé…ç½®
â”‚  â”‚  â”œâ”€ SecurityConfig.java           # å®‰å…¨é…ç½®
â”‚  â”‚  â”œâ”€ CorsConfig.java               # CORSé…ç½®
â”‚  â”‚  â”œâ”€ OpenApiConfig.java            # Swaggeré…ç½®
â”‚  â”‚  â””â”€ AsyncConfig.java              # å¼‚æ­¥é…ç½®
â”‚  â”‚
â”‚  â”œâ”€ security/                        # å®‰å…¨è®¤è¯
â”‚  â”‚  â”œâ”€ JwtTokenProvider.java         # JWTç”Ÿæˆå’ŒéªŒè¯
â”‚  â”‚  â”œâ”€ JwtAuthenticationFilter.java  # JWTè¿‡æ»¤å™¨
â”‚  â”‚  â”œâ”€ WechatAuthService.java        # å¾®ä¿¡è®¤è¯
â”‚  â”‚  â””â”€ CustomUserDetailsService.java # ç”¨æˆ·è¯¦æƒ…åŠ è½½
â”‚  â”‚
â”‚  â”œâ”€ utils/                           # å·¥å…·ç±»
â”‚  â”‚  â”œâ”€ JwtUtils.java                 # JWTå·¥å…·
â”‚  â”‚  â”œâ”€ DateUtils.java                # æ—¥æœŸå·¥å…·
â”‚  â”‚  â”œâ”€ EncryptUtils.java             # åŠ å¯†å·¥å…·
â”‚  â”‚  â”œâ”€ HttpClientUtils.java          # HTTPå·¥å…·
â”‚  â”‚  â”œâ”€ BeanCopyUtils.java            # Beanè½¬æ¢
â”‚  â”‚  â””â”€ ValidationUtils.java          # éªŒè¯å·¥å…·
â”‚  â”‚
â”‚  â”œâ”€ enums/                           # æšä¸¾å®šä¹‰
â”‚  â”‚  â”œâ”€ GenderEnum.java
â”‚  â”‚  â”œâ”€ CheckInStatusEnum.java
â”‚  â”‚  â”œâ”€ PermissionStatusEnum.java
â”‚  â”‚  â””â”€ CommentStatusEnum.java
â”‚  â”‚
â”‚  â”œâ”€ async/                           # å¼‚æ­¥ä»»åŠ¡
â”‚  â”‚  â”œâ”€ AsyncTaskService.java
â”‚  â”‚  â”œâ”€ InsightGenerationTask.java    # åé¦ˆç”Ÿæˆä»»åŠ¡
â”‚  â”‚  â”œâ”€ PushNotificationTask.java     # æ¶ˆæ¯æ¨é€
â”‚  â”‚  â””â”€ DataAnalysisTask.java         # æ•°æ®åˆ†æ
â”‚  â”‚
â”‚  â”œâ”€ cache/                           # ç¼“å­˜ç­–ç•¥
â”‚  â”‚  â”œâ”€ CacheKeyBuilder.java          # ç¼“å­˜é”®ç”Ÿæˆ
â”‚  â”‚  â”œâ”€ RedisCacheManager.java        # ç¼“å­˜ç®¡ç†
â”‚  â”‚  â””â”€ CacheAspect.java              # ç¼“å­˜åˆ‡é¢
â”‚  â”‚
â”‚  â”œâ”€ mq/                              # æ¶ˆæ¯é˜Ÿåˆ—
â”‚  â”‚  â”œâ”€ CheckInEventPublisher.java    # äº‹ä»¶å‘å¸ƒ
â”‚  â”‚  â”œâ”€ CheckInEventListener.java     # äº‹ä»¶ç›‘å¬
â”‚  â”‚  â”œâ”€ InsightGenerationConsumer.java# åé¦ˆæ¶ˆè´¹
â”‚  â”‚  â””â”€ NotificationConsumer.java     # é€šçŸ¥æ¶ˆè´¹
â”‚  â”‚
â”‚  â””â”€ interceptor/                     # æ‹¦æˆªå™¨
â”‚     â”œâ”€ RequestLoggingInterceptor.java# è¯·æ±‚æ—¥å¿—
â”‚     â”œâ”€ PerformanceInterceptor.java   # æ€§èƒ½ç›‘æ§
â”‚     â””â”€ SecurityInterceptor.java      # å®‰å…¨æ‹¦æˆª
â”‚
â”œâ”€ src/main/resources/
â”‚  â”œâ”€ application.yml                  # åº”ç”¨é…ç½®
â”‚  â”œâ”€ application-dev.yml              # å¼€å‘é…ç½®
â”‚  â”œâ”€ application-prod.yml             # ç”Ÿäº§é…ç½®
â”‚  â”œâ”€ logback-spring.xml               # æ—¥å¿—é…ç½®
â”‚  â”œâ”€ db/migration/                    # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚  â”‚  â”œâ”€ V1_0__init_schema.sql
â”‚  â”‚  â”œâ”€ V1_1__add_indexes.sql
â”‚  â”‚  â””â”€ V1_2__add_audit_log.sql
â”‚  â””â”€ i18n/                            # å›½é™…åŒ–èµ„æº
â”‚
â”œâ”€ src/test/java/com/morningreading/
â”‚  â”œâ”€ service/
â”‚  â”‚  â”œâ”€ UserServiceTest.java
â”‚  â”‚  â”œâ”€ CheckInServiceTest.java
â”‚  â”‚  â””â”€ PermissionServiceTest.java
â”‚  â”œâ”€ controller/
â”‚  â”‚  â””â”€ CheckInControllerTest.java
â”‚  â”œâ”€ repository/
â”‚  â”‚  â””â”€ CheckInRepositoryTest.java
â”‚  â””â”€ integration/
â”‚     â””â”€ CheckInIntegrationTest.java
â”‚
â”œâ”€ .github/workflows/                  # CI/CD
â”‚  â”œâ”€ build.yml
â”‚  â”œâ”€ test.yml
â”‚  â””â”€ deploy.yml
â”‚
â”œâ”€ pom.xml
â”œâ”€ README.md
â””â”€ docker-compose.yml
```

## 4.3 æ ¸å¿ƒä¸šåŠ¡å®ç°

### æ‰“å¡æœåŠ¡è®¾è®¡

```java
// src/main/java/com/morningreading/service/CheckInService.java
@Service
@Slf4j
public class CheckInService {
  
  @Autowired
  private CheckInRepository checkInRepository;
  @Autowired
  private SectionRepository sectionRepository;
  @Autowired
  private RabbitTemplate rabbitTemplate;
  @Autowired
  private RedisTemplate<String, Object> redisTemplate;
  @Autowired
  private InsightService insightService;
  
  /**
   * æäº¤æ‰“å¡
   * ä¸šåŠ¡è§„åˆ™ï¼š
   * 1. åŒä¸€ç”¨æˆ·åŒä¸€sectionåªèƒ½æ‰“å¡ä¸€æ¬¡ï¼ˆé™¤è¡¥å¡å¤–ï¼‰
   * 2. æ‰“å¡æ—¶é—´é™åˆ¶åœ¨6:00-8:00ï¼ˆå»ºè®®ï¼‰
   * 3. å¼‚æ­¥ç”ŸæˆAIåé¦ˆ
   */
  @Transactional
  public CheckInResponse submitCheckIn(CheckInRequest request, Long userId) {
    // 1. éªŒè¯ç”¨æˆ·å’Œè¯¾ç¨‹æœ‰æ•ˆæ€§
    Section section = sectionRepository.findById(request.getSectionId())
        .orElseThrow(() -> new BusinessException("è¯¾ç¨‹ä¸å­˜åœ¨"));
    
    // 2. æ£€æŸ¥æ˜¯å¦å·²æ‰“å¡ï¼ˆåˆ†å¸ƒå¼é”é˜²å¹¶å‘ï¼‰
    String lockKey = String.format("checkin:lock:%d:%d", userId, section.getId());
    boolean acquired = tryAcquireLock(lockKey, 5); // 5ç§’è¶…æ—¶
    
    if (!acquired) {
      throw new BusinessException("æ‰“å¡å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
    }
    
    try {
      // æ£€æŸ¥é‡å¤æ‰“å¡
      CheckIn existingCheckIn = checkInRepository
          .findByUserIdAndSectionId(userId, section.getId());
      
      if (existingCheckIn != null && !request.isMakeUp()) {
        throw new BusinessException("å·²æ‰“å¡è¿‡è¯¥è¯¾ç¨‹");
      }
      
      // 3. åˆ›å»ºæ‰“å¡è®°å½•
      CheckIn checkIn = new CheckIn();
      checkIn.setUserId(userId);
      checkIn.setSectionId(section.getId());
      checkIn.setUserCourseId(request.getUserCourseId());
      checkIn.setContent(request.getContent());
      checkIn.setCheckInTime(LocalDateTime.now());
      checkIn.setIsMakeUp(request.isMakeUp());
      
      // åˆ¤æ–­æ‰“å¡æ˜¯å¦æ™šå¡ï¼ˆè¶…è¿‡8:00ï¼‰
      int hour = LocalDateTime.now().getHour();
      if (hour > 8) {
        checkIn.setIsLate(true);
      }
      
      // 4. ä¿å­˜æ‰“å¡è®°å½•
      CheckIn savedCheckIn = checkInRepository.save(checkIn);
      
      // 5. å‘å¸ƒå¼‚æ­¥ä»»åŠ¡ï¼šç”ŸæˆAIåé¦ˆ
      rabbitTemplate.convertAndSend(
          "checkin.event",
          new CheckInEvent(
              savedCheckIn.getId(),
              userId,
              section.getId(),
              request.getContent()
          )
      );
      
      // 6. æ›´æ–°ç”¨æˆ·è¿›åº¦ç¼“å­˜
      updateUserProgressCache(userId, section.getCourseId());
      
      return CheckInResponse.fromEntity(savedCheckIn);
      
    } finally {
      releaseLock(lockKey);
    }
  }
  
  /**
   * è·å–ç”¨æˆ·æ‰“å¡ç»Ÿè®¡
   */
  @Cacheable(
      value = "checkin:stats",
      key = "#userId",
      unless = "#result == null"
  )
  public CheckInStats getUserStats(Long userId) {
    List<CheckIn> checkIns = checkInRepository.findByUserId(userId);
    
    CheckInStats stats = new CheckInStats();
    stats.setTotalCheckIns(checkIns.size());
    stats.setMakeUpCount(checkIns.stream()
        .filter(CheckIn::getIsMakeUp)
        .count());
    stats.setLateCount(checkIns.stream()
        .filter(CheckIn::getIsLate)
        .count());
    
    // è®¡ç®—è¿ç»­æ‰“å¡
    stats.setConsecutiveDays(calculateConsecutiveDays(userId));
    
    return stats;
  }
  
  /**
   * åˆ†å¸ƒå¼é”å®ç°ï¼ˆåŸºäºRedisï¼‰
   */
  private boolean tryAcquireLock(String lockKey, long timeoutSeconds) {
    String lockValue = UUID.randomUUID().toString();
    Boolean success = redisTemplate.opsForValue()
        .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(timeoutSeconds));
    return Boolean.TRUE.equals(success);
  }
  
  private void releaseLock(String lockKey) {
    redisTemplate.delete(lockKey);
  }
}
```

### AIåé¦ˆç”ŸæˆæœåŠ¡

```java
// src/main/java/com/morningreading/service/AiInsightService.java
@Service
@Slf4j
public class AiInsightService {
  
  @Autowired
  private InsightRepository insightRepository;
  @Autowired
  private OpenAIClient openAIClient;
  @Autowired
  private RedisTemplate<String, Object> redisTemplate;
  
  /**
   * ç”Ÿæˆä¸ªæ€§åŒ–åé¦ˆ
   * æµç¨‹ï¼š
   * 1. è·å–ç”¨æˆ·æ‰“å¡å†…å®¹
   * 2. è°ƒç”¨OpenAI/Claudeç”Ÿæˆåé¦ˆ
   * 3. å­˜å‚¨åé¦ˆç»“æœ
   * 4. å‘é€ç”¨æˆ·é€šçŸ¥
   */
  public void generateInsight(Long userId, Long sectionId, String content) {
    try {
      // 1. è·å–è¯¾ç¨‹å†…å®¹å’Œç”¨æˆ·ä¿¡æ¯
      Section section = sectionRepository.findById(sectionId)
          .orElseThrow();
      User user = userRepository.findById(userId)
          .orElseThrow();
      
      // 2. æ„å»ºåé¦ˆç”Ÿæˆçš„æç¤ºè¯
      String prompt = buildPrompt(user, section, content);
      
      // 3. è°ƒç”¨AIæœåŠ¡
      String aiResponse = openAIClient.chat(prompt);
      
      // 4. è§£æå’Œæ ¼å¼åŒ–åé¦ˆ
      String formattedInsight = formatInsight(aiResponse);
      
      // 5. ä¿å­˜åé¦ˆ
      Insight insight = new Insight();
      insight.setUserId(userId);
      insight.setSectionId(sectionId);
      insight.setContent(formattedInsight);
      insight.setCreatedAt(LocalDateTime.now());
      
      insightRepository.save(insight);
      
      // 6. æ¸…é™¤ç¼“å­˜
      redisTemplate.delete(String.format("insight:user:%d", userId));
      
      // 7. å‘é€é€šçŸ¥ï¼ˆå¼‚æ­¥ï¼‰
      notificationService.sendInsightNotification(userId, sectionId);
      
    } catch (Exception e) {
      log.error("AIåé¦ˆç”Ÿæˆå¤±è´¥: userId={}, sectionId={}", userId, sectionId, e);
      // é™çº§å¤„ç†ï¼šä½¿ç”¨æ¨¡æ¿åé¦ˆ
      fallbackInsight(userId, sectionId, content);
    }
  }
  
  /**
   * æ„å»ºåé¦ˆç”Ÿæˆçš„æç¤ºè¯
   */
  private String buildPrompt(User user, Section section, String content) {
    return String.format("""
        è¯·ä¸ºä»¥ä¸‹å­¦å‘˜ç”Ÿæˆä¸€æ¡æ¸©æš–ã€é¼“åŠ±æ€§çš„å­¦ä¹ åé¦ˆï¼š
        
        å­¦å‘˜ä¿¡æ¯ï¼š
        - å§“åï¼š%s
        - å¹´é¾„ï¼š%d
        - åŠ å…¥åŸå› ï¼š%s
        
        è¯¾ç¨‹ä¿¡æ¯ï¼š
        - è¯¾ç¨‹ï¼š%s
        - ç¬¬%då¤©
        - ä¸»é¢˜ï¼š%s
        
        å­¦å‘˜æ‰“å¡å†…å®¹ï¼š
        %s
        
        è¯·ç”Ÿæˆä¸€æ¡100-200å­—çš„ä¸ªæ€§åŒ–åé¦ˆï¼ŒåŒ…æ‹¬ï¼š
        1. å¯¹å­¦å‘˜å­¦ä¹ çš„è®¤å¯å’Œé¼“åŠ±
        2. å¯¹å†…å®¹ç†è§£çš„ç‚¹è¯„
        3. å¯¹åç»­å­¦ä¹ çš„å»ºè®®
        
        è¦æ±‚ï¼šæ¸©æš–ã€ä¸“ä¸šã€é¼“åŠ±æ€§å¼º
        """,
        user.getRealName(),
        user.getAge(),
        user.getJoinReason(),
        section.getCourseTitle(),
        section.getDayNumber(),
        section.getTitle(),
        content
    );
  }
  
  /**
   * é™çº§å¤„ç†ï¼šä½¿ç”¨æ¨¡æ¿åé¦ˆ
   */
  private void fallbackInsight(Long userId, Long sectionId, String content) {
    String templateInsight = String.format("""
        äº²çˆ±çš„å­¦å‘˜ï¼Œæ„Ÿè°¢ä½ çš„åšæŒï¼
        
        ä»Šå¤©çš„å­¦ä¹ å†…å®¹å¾ˆå……å®ï¼Œä½ çš„æ‰“å¡è®°å½•æ˜¾ç¤ºäº†å¯¹å­¦ä¹ çš„é‡è§†ã€‚
        
        ç»§ç»­ä¿æŒè¿™ä»½çƒ­æƒ…ï¼Œæ¯ä¸€æ­¥çš„åšæŒéƒ½åœ¨å¡‘é€ æ›´å¥½çš„ä½ ã€‚
        åŠ æ²¹ï¼ğŸ’ª
        """);
    
    Insight insight = new Insight();
    insight.setUserId(userId);
    insight.setSectionId(sectionId);
    insight.setContent(templateInsight);
    insight.setIsTemplate(true); // æ ‡è®°ä¸ºæ¨¡æ¿åé¦ˆ
    insightRepository.save(insight);
  }
}
```

### æƒé™ç®¡ç†æœåŠ¡

```java
// src/main/java/com/morningreading/service/PermissionService.java
@Service
@Slf4j
public class PermissionService {
  
  @Autowired
  private PermissionRepository permissionRepository;
  @Autowired
  private PermissionRequestRepository permissionRequestRepository;
  @Autowired
  private RedisTemplate<String, Object> redisTemplate;
  
  /**
   * ç”³è¯·æŸ¥çœ‹ä»–äººåé¦ˆ
   * ä¸šåŠ¡è§„åˆ™ï¼š
   * 1. åŒä¸€ç”¨æˆ·å¯¹åŒä¸€åé¦ˆæœ€å¤šä¸€ä¸ªå¾…å¤„ç†çš„æƒé™è¯·æ±‚
   * 2. ç”³è¯·çŠ¶æ€ï¼špending -> accepted/rejected
   */
  @Transactional
  public void requestPermission(Long requestorId, Long insightId) {
    Insight insight = insightRepository.findById(insightId)
        .orElseThrow(() -> new BusinessException("åé¦ˆä¸å­˜åœ¨"));
    
    Long ownerId = insight.getUserId();
    
    if (requestorId.equals(ownerId)) {
      throw new BusinessException("ä¸èƒ½ç”³è¯·æŸ¥çœ‹è‡ªå·±çš„åé¦ˆ");
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¾…å¤„ç†çš„è¯·æ±‚
    PermissionRequest existing = permissionRequestRepository
        .findByRequestorIdAndInsightIdAndStatus(
            requestorId, 
            insightId, 
            PermissionStatus.PENDING
        );
    
    if (existing != null) {
      throw new BusinessException("å·²æœ‰å¾…å¤„ç†çš„æƒé™è¯·æ±‚");
    }
    
    // åˆ›å»ºæƒé™è¯·æ±‚
    PermissionRequest request = new PermissionRequest();
    request.setRequestorId(requestorId);
    request.setOwnerId(ownerId);
    request.setInsightId(insightId);
    request.setStatus(PermissionStatus.PENDING);
    request.setRequestedAt(LocalDateTime.now());
    request.setExpiresAt(LocalDateTime.now().plusDays(7));
    
    permissionRequestRepository.save(request);
    
    // å‘é€é€šçŸ¥ç»™åé¦ˆæ‰€æœ‰è€…
    notificationService.sendPermissionRequest(ownerId, requestorId, insightId);
  }
  
  /**
   * å®¡æ‰¹æƒé™è¯·æ±‚
   */
  @Transactional
  public void reviewPermissionRequest(Long requestId, Boolean approved) {
    PermissionRequest request = permissionRequestRepository
        .findById(requestId)
        .orElseThrow();
    
    if (!request.getStatus().equals(PermissionStatus.PENDING)) {
      throw new BusinessException("è¯·æ±‚å·²è¿‡æœŸæˆ–å·²å¤„ç†");
    }
    
    PermissionStatus newStatus = approved 
        ? PermissionStatus.ACCEPTED 
        : PermissionStatus.REJECTED;
    
    request.setStatus(newStatus);
    request.setReviewedAt(LocalDateTime.now());
    permissionRequestRepository.save(request);
    
    if (approved) {
      // æ¸…é™¤ç¼“å­˜ï¼šå¯¹æ–¹ç°åœ¨å¯ä»¥æŸ¥çœ‹è¯¥åé¦ˆ
      invalidatePermissionCache(
          request.getRequestorId(),
          request.getOwnerId(),
          request.getInsightId()
      );
    }
    
    // å‘é€å®¡æ‰¹ç»“æœé€šçŸ¥
    notificationService.sendPermissionReview(
        request.getRequestorId(),
        approved
    );
  }
  
  /**
   * æ£€æŸ¥æƒé™ï¼šç”¨æˆ·æ˜¯å¦å¯ä»¥æŸ¥çœ‹è¯¥åé¦ˆ
   * ç¼“å­˜ç­–ç•¥ï¼šæƒé™æ£€æŸ¥ç»“æœç¼“å­˜5åˆ†é’Ÿ
   */
  @Cacheable(
      value = "permission:check",
      key = "#requestorId + ':' + #insightId",
      unless = "#result == false"
  )
  public boolean canViewInsight(Long requestorId, Long insightId) {
    Insight insight = insightRepository.findById(insightId)
        .orElseThrow();
    
    // è‡ªå·±çš„åé¦ˆå¯ä»¥æŸ¥çœ‹
    if (insight.getUserId().equals(requestorId)) {
      return true;
    }
    
    // æ£€æŸ¥æƒé™è®°å½•
    PermissionRequest permission = permissionRequestRepository
        .findByRequestorIdAndInsightIdAndStatus(
            requestorId,
            insightId,
            PermissionStatus.ACCEPTED
        );
    
    return permission != null;
  }
  
  /**
   * æ¸…é™¤æƒé™ç¼“å­˜
   */
  private void invalidatePermissionCache(
      Long requestorId, 
      Long ownerId, 
      Long insightId) {
    String cacheKey = String.format(
        "permission:check:%d:%d",
        requestorId,
        insightId
    );
    redisTemplate.delete(cacheKey);
  }
}
```

---

# 5 æ•°æ®åº“æ¶æ„è®¾è®¡

## 5.1 æ ¸å¿ƒæ•°æ®æ¨¡å‹

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE `users` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `wechat_id` VARCHAR(100) UNIQUE NOT NULL COMMENT 'å¾®ä¿¡OpenID',
  `wechat_unionid` VARCHAR(100) UNIQUE COMMENT 'å¾®ä¿¡UnionID',
  `nickname` VARCHAR(64) NOT NULL COMMENT 'ç”¨æˆ·æ˜µç§°',
  `real_name` VARCHAR(64) COMMENT 'çœŸå®å§“å',
  `avatar_url` VARCHAR(512) COMMENT 'å¤´åƒURL',
  `signature` VARCHAR(200) COMMENT 'ä¸ªäººç­¾å',
  `age` TINYINT COMMENT 'å¹´é¾„',
  `gender` VARCHAR(20) COMMENT 'æ€§åˆ« (male/female/unknown)',
  `phone` VARCHAR(20) COMMENT 'æ‰‹æœºå·',
  `email` VARCHAR(100) COMMENT 'é‚®ç®±',
  `province` VARCHAR(50) COMMENT 'çœä»½',
  `city` VARCHAR(50) COMMENT 'åŸå¸‚',
  `address` VARCHAR(255) COMMENT 'è¯¦ç»†åœ°å€',
  `referrer_name` VARCHAR(64) COMMENT 'æ¨èäººå§“å',
  `join_reason` TEXT COMMENT 'åŠ å…¥åŸå› ',
  `status` VARCHAR(20) DEFAULT 'active' COMMENT 'ç”¨æˆ·çŠ¶æ€',
  `last_login_at` DATETIME COMMENT 'æœ€åç™»å½•æ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` DATETIME COMMENT 'è½¯åˆ é™¤',
  
  INDEX `idx_wechat_id` (`wechat_id`),
  INDEX `idx_created_at` (`created_at`),
  INDEX `idx_status` (`status`)
) COMMENT='ç”¨æˆ·è¡¨';

-- è¯¾ç¨‹è¡¨
CREATE TABLE `courses` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è¯¾ç¨‹ID',
  `title` VARCHAR(255) NOT NULL COMMENT 'è¯¾ç¨‹æ ‡é¢˜',
  `description` TEXT COMMENT 'è¯¾ç¨‹æè¿°',
  `emoji` VARCHAR(10) COMMENT 'è¯¾ç¨‹emoji',
  `cover_image_url` VARCHAR(512) COMMENT 'è¯¾ç¨‹å°é¢',
  `author` VARCHAR(64) COMMENT 'è®²å¸ˆåç§°',
  `status` VARCHAR(20) DEFAULT 'draft' COMMENT 'è¯¾ç¨‹çŠ¶æ€ (draft/published/archived)',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX `idx_status` (`status`)
) COMMENT='è¯¾ç¨‹è¡¨';

-- è¯¾ç¨‹æœŸæ¬¡è¡¨
CREATE TABLE `course_periods` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æœŸæ¬¡ID',
  `course_id` BIGINT NOT NULL COMMENT 'è¯¾ç¨‹ID',
  `period_number` INT NOT NULL COMMENT 'æœŸæ¬¡å· (å¦‚ç¬¬8æœŸ)',
  `start_date` DATE NOT NULL COMMENT 'å¼€å§‹æ—¥æœŸ',
  `end_date` DATE NOT NULL COMMENT 'ç»“æŸæ—¥æœŸ',
  `status` VARCHAR(20) DEFAULT 'open' COMMENT 'çŠ¶æ€ (draft/open/closed/archived)',
  `max_capacity` INT DEFAULT 5000 COMMENT 'æœ€å¤§å®¹é‡',
  `enrollment_count` INT DEFAULT 0 COMMENT 'æŠ¥åäººæ•°',
  `registration_start` DATETIME COMMENT 'æŠ¥åå¼€å§‹æ—¶é—´',
  `registration_end` DATETIME COMMENT 'æŠ¥åç»“æŸæ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_course_period` (`course_id`, `period_number`),
  INDEX `idx_status` (`status`),
  INDEX `idx_start_date` (`start_date`)
) COMMENT='è¯¾ç¨‹æœŸæ¬¡è¡¨';

-- ç”¨æˆ·è¯¾ç¨‹æŠ¥åè¡¨
CREATE TABLE `user_courses` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æŠ¥åID',
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `period_id` BIGINT NOT NULL COMMENT 'æœŸæ¬¡ID',
  `status` VARCHAR(20) DEFAULT 'active' COMMENT 'çŠ¶æ€ (active/completed/dropped)',
  `total_sections` INT DEFAULT 0 COMMENT 'è¯¥æœŸæ¬¡æ€»è¯¾èŠ‚æ•°',
  `completed_sections` INT DEFAULT 0 COMMENT 'å·²å®Œæˆè¯¾èŠ‚æ•°',
  `joined_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `completed_at` DATETIME COMMENT 'å®Œæˆæ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_user_period` (`user_id`, `period_id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_status` (`status`)
) COMMENT='ç”¨æˆ·è¯¾ç¨‹æŠ¥åå…³ç³»è¡¨';

-- è¯¾ç¨‹å†…å®¹è¡¨
CREATE TABLE `sections` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è¯¾èŠ‚ID',
  `course_id` BIGINT NOT NULL COMMENT 'è¯¾ç¨‹ID',
  `period_id` BIGINT NOT NULL COMMENT 'æœŸæ¬¡ID',
  `day_number` INT NOT NULL COMMENT 'ç¬¬å‡ å¤© (1-23)',
  `title` VARCHAR(255) NOT NULL COMMENT 'è¯¾èŠ‚æ ‡é¢˜',
  `content` LONGTEXT COMMENT 'è¯¾ç¨‹å†…å®¹ (HTMLæ ¼å¼)',
  `five_steps` JSON COMMENT 'äº”æ­¥å­¦ä¹ æ³•å†…å®¹ {é™ä¸€é™, é—®ä¸€é—®, è¯»ä¸€è¯», æƒ³ä¸€æƒ³, è®°ä¸€è®°}',
  `lesson_date` DATE COMMENT 'è¯¥è¯¾èŠ‚çš„è¯¾ç¨‹æ—¥æœŸ',
  `publish_at` DATETIME COMMENT 'å‘å¸ƒæ—¶é—´',
  `status` VARCHAR(20) DEFAULT 'draft' COMMENT 'çŠ¶æ€ (draft/published)',
  `checkin_count` INT DEFAULT 0 COMMENT 'æ‰“å¡äººæ•°',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_period_day` (`period_id`, `day_number`),
  INDEX `idx_course_id` (`course_id`),
  INDEX `idx_lesson_date` (`lesson_date`),
  INDEX `idx_status` (`status`)
) COMMENT='è¯¾ç¨‹å†…å®¹ï¼ˆå•å…ƒï¼‰è¡¨';

-- æ‰“å¡è®°å½•è¡¨
CREATE TABLE `checkins` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ‰“å¡ID',
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `section_id` BIGINT NOT NULL COMMENT 'è¯¾èŠ‚ID',
  `user_course_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·è¯¾ç¨‹ID',
  `content` TEXT NOT NULL COMMENT 'æ‰“å¡æ—¥è®°å†…å®¹',
  `checkin_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'æ‰“å¡æ—¶é—´',
  `is_late` BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦æ™šå¡ (è¶…è¿‡8:00)',
  `is_makeup` BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦è¡¥å¡',
  `status` VARCHAR(20) DEFAULT 'submitted' COMMENT 'çŠ¶æ€',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_user_section` (`user_id`, `section_id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_section_id` (`section_id`),
  INDEX `idx_checkin_time` (`checkin_time`)
) COMMENT='æ‰“å¡è®°å½•è¡¨';

-- ä¸ªæ€§åŒ–åé¦ˆè¡¨
CREATE TABLE `insights` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'åé¦ˆID',
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `section_id` BIGINT NOT NULL COMMENT 'è¯¾èŠ‚ID',
  `content` LONGTEXT NOT NULL COMMENT 'åé¦ˆå†…å®¹',
  `is_template` BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä½¿ç”¨æ¨¡æ¿åé¦ˆ',
  `ai_model` VARCHAR(50) COMMENT 'ä½¿ç”¨çš„AIæ¨¡å‹ (gpt-4/claudeç­‰)',
  `share_count` INT DEFAULT 0 COMMENT 'åˆ†äº«æ¬¡æ•°',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_user_section` (`user_id`, `section_id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_section_id` (`section_id`),
  INDEX `idx_created_at` (`created_at`)
) COMMENT='ä¸ªæ€§åŒ–åé¦ˆè¡¨';

-- æƒé™è¯·æ±‚è¡¨
CREATE TABLE `permission_requests` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æƒé™è¯·æ±‚ID',
  `requestor_id` BIGINT NOT NULL COMMENT 'ç”³è¯·è€…ç”¨æˆ·ID',
  `owner_id` BIGINT NOT NULL COMMENT 'åé¦ˆæ‰€æœ‰è€…ç”¨æˆ·ID',
  `insight_id` BIGINT NOT NULL COMMENT 'åé¦ˆID',
  `status` VARCHAR(20) DEFAULT 'pending' COMMENT 'çŠ¶æ€ (pending/accepted/rejected)',
  `requested_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ç”³è¯·æ—¶é—´',
  `reviewed_at` DATETIME COMMENT 'å®¡æ‰¹æ—¶é—´',
  `expires_at` DATETIME COMMENT 'è¿‡æœŸæ—¶é—´ (7å¤©å)',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_request` (`requestor_id`, `insight_id`, `status`),
  INDEX `idx_owner_id` (`owner_id`),
  INDEX `idx_requestor_id` (`requestor_id`),
  INDEX `idx_status` (`status`),
  INDEX `idx_expires_at` (`expires_at`)
) COMMENT='æƒé™è¯·æ±‚è¡¨';

-- è¯„è®ºè¡¨
CREATE TABLE `comments` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è¯„è®ºID',
  `user_id` BIGINT NOT NULL COMMENT 'è¯„è®ºç”¨æˆ·ID',
  `section_id` BIGINT NOT NULL COMMENT 'è¯¾èŠ‚ID',
  `parent_comment_id` BIGINT COMMENT 'çˆ¶è¯„è®ºID (å›å¤æ—¶)',
  `content` TEXT NOT NULL COMMENT 'è¯„è®ºå†…å®¹',
  `like_count` INT DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
  `status` VARCHAR(20) DEFAULT 'published' COMMENT 'çŠ¶æ€ (draft/published/deleted)',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX `idx_section_id` (`section_id`),
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_parent_comment_id` (`parent_comment_id`),
  INDEX `idx_created_at` (`created_at`)
) COMMENT='è¯„è®ºè¡¨';

-- ç‚¹èµè®°å½•è¡¨
CREATE TABLE `likes` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç‚¹èµID',
  `user_id` BIGINT NOT NULL COMMENT 'ç‚¹èµç”¨æˆ·ID',
  `comment_id` BIGINT NOT NULL COMMENT 'è¢«ç‚¹èµè¯„è®ºID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE KEY `uk_user_comment` (`user_id`, `comment_id`),
  INDEX `idx_comment_id` (`comment_id`)
) COMMENT='ç‚¹èµè®°å½•è¡¨';

-- æ“ä½œå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE `audit_logs` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ—¥å¿—ID',
  `user_id` BIGINT COMMENT 'æ“ä½œç”¨æˆ·ID',
  `operation` VARCHAR(50) COMMENT 'æ“ä½œç±»å‹ (CREATE/UPDATE/DELETE)',
  `entity_type` VARCHAR(50) COMMENT 'æ“ä½œå®ä½“ç±»å‹',
  `entity_id` BIGINT COMMENT 'æ“ä½œå®ä½“ID',
  `changes` JSON COMMENT 'å˜æ›´å†…å®¹ {before, after}',
  `ip_address` VARCHAR(50) COMMENT 'æ“ä½œIP',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_operation` (`operation`),
  INDEX `idx_entity_type` (`entity_type`),
  INDEX `idx_created_at` (`created_at`)
) COMMENT='æ“ä½œå®¡è®¡æ—¥å¿—è¡¨';
```

## 5.2 æ•°æ®åº“è®¾è®¡åŸåˆ™

### æ€§èƒ½ä¼˜åŒ–
- **åˆ†è¡¨ç­–ç•¥**ï¼šå½“ç”¨æˆ·è¡¨è¶…è¿‡1000ä¸‡æ¡è®°å½•æ—¶ï¼ŒæŒ‰ç…§user_id % 8è¿›è¡Œåˆ†è¡¨
- **ç´¢å¼•è®¾è®¡**ï¼šå¤åˆç´¢å¼•éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™ï¼Œé¿å…ç´¢å¼•å†—ä½™
- **åˆ†åŒºç­–ç•¥**ï¼šcheckinsè¡¨æŒ‰æœˆä»½åˆ†åŒºï¼Œä¿æŒæ¯ä¸ªåˆ†åŒºåœ¨1000ä¸‡æ¡ä»¥å†…

### æ•°æ®ä¸€è‡´æ€§
- **äº‹åŠ¡éš”ç¦»**ï¼šä½¿ç”¨REPEATABLE READéš”ç¦»çº§åˆ«
- **åˆ†å¸ƒå¼é”**ï¼šå…³é”®ä¸šåŠ¡æ“ä½œï¼ˆæ‰“å¡ã€æƒé™å®¡æ‰¹ï¼‰ä½¿ç”¨Redisåˆ†å¸ƒå¼é”
- **è½¯åˆ é™¤**ï¼šç”¨æˆ·ã€è¯¾ç¨‹ç­‰å…³é”®æ•°æ®é‡‡ç”¨è½¯åˆ é™¤ï¼Œä¿ç•™å®Œæ•´å†å²

### å¤‡ä»½ä¸æ¢å¤
- **å¤‡ä»½ç­–ç•¥**ï¼šæ¯å¤©å‡Œæ™¨2:00æ‰§è¡Œå…¨é‡å¤‡ä»½ï¼Œæ¯å°æ—¶æ‰§è¡Œå¢é‡å¤‡ä»½
- **å¤‡ä»½å­˜å‚¨**ï¼šåŒæ­¥å¤‡ä»½åˆ°ä¸åŒåœ°åŸŸçš„OSSæœåŠ¡
- **æ¢å¤RTO**ï¼šâ‰¤ 1å°æ—¶ï¼›RPOï¼šâ‰¤ 5åˆ†é’Ÿ

---

# 6 ç¼“å­˜ä¸å­˜å‚¨ç­–ç•¥

## 6.1 Redisç¼“å­˜æ¶æ„

```
ç¼“å­˜åˆ†å±‚ï¼š
L1ç¼“å­˜ (æœ¬åœ°ç¼“å­˜)
  - çƒ­ç‚¹æ•°æ®ï¼šç”¨æˆ·ä¿¡æ¯ã€è¯¾ç¨‹åˆ—è¡¨
  - TTLï¼š5-10åˆ†é’Ÿ
  - å†…å­˜ï¼š100MB

L2ç¼“å­˜ (Redisé›†ç¾¤)
  - ç”¨æˆ·æ•°æ®ã€è¯¾ç¨‹æ•°æ®ã€æƒé™æ•°æ®
  - TTLï¼š1-24å°æ—¶
  - å®¹é‡ï¼š10GB

L3ç¼“å­˜ (CDN)
  - é™æ€èµ„æºã€å›¾ç‰‡
  - TTLï¼š7-30å¤©
  - å…¨çƒåŠ é€Ÿ
```

### ç¼“å­˜é”®è®¾è®¡

```
# ç”¨æˆ·ç›¸å…³
user:{userId}                           # ç”¨æˆ·ä¿¡æ¯
user:{userId}:courses                   # ç”¨æˆ·å·²æŠ¥åè¯¾ç¨‹
user:{userId}:stats                     # ç”¨æˆ·æ‰“å¡ç»Ÿè®¡
user:{userId}:insights                  # ç”¨æˆ·åé¦ˆåˆ—è¡¨

# è¯¾ç¨‹ç›¸å…³
course:{courseId}                       # è¯¾ç¨‹è¯¦æƒ…
course:{courseId}:sections              # è¯¾ç¨‹æ‰€æœ‰å•å…ƒ
section:{sectionId}                     # å•å…ƒè¯¦æƒ…
section:{sectionId}:comments            # å•å…ƒè¯„è®º

# æƒé™ç›¸å…³
permission:check:{userId}:{insightId}  # æƒé™æ£€æŸ¥ç»“æœ

# æ’è¡Œæ¦œç›¸å…³
leaderboard:day:{date}                  # æ—¥æ’è¡Œæ¦œ
leaderboard:week:{weekNo}               # å‘¨æ’è¡Œæ¦œ

# ä¸´æ—¶æ•°æ®
temp:checkin:lock:{userId}:{sectionId} # æ‰“å¡é” (5ç§’)
temp:upload:token:{userId}              # ä¸Šä¼ token (30åˆ†é’Ÿ)

# è®¡æ•°å™¨
counter:checkin:{date}                  # æ¯æ—¥æ‰“å¡æ•°
counter:comment:{sectionId}             # è¯„è®ºæ•°
```

### ç¼“å­˜å¤±æ•ˆç­–ç•¥

```java
// ä¸»åŠ¨å¤±æ•ˆ
@CachEvict(value = "user:courses", key = "#userId")
public void invalidateUserCourses(Long userId) {}

// è¢«åŠ¨å¤±æ•ˆï¼ˆTTLï¼‰
- ç”¨æˆ·ä¿¡æ¯ï¼š1å°æ—¶
- è¯¾ç¨‹æ•°æ®ï¼š6å°æ—¶
- æƒé™æ•°æ®ï¼š5åˆ†é’Ÿï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰
- æ’è¡Œæ¦œï¼šå®æ—¶æ›´æ–°

// ç¼“å­˜é¢„çƒ­
- å¯åŠ¨æ—¶åŠ è½½çƒ­ç‚¹è¯¾ç¨‹
- æ¯æ—¥å‡Œæ™¨é¢„åŠ è½½å…¨å¤©è¯¾ç¨‹
- æƒé™å˜æ›´æ—¶ä¸»åŠ¨æ›´æ–°ç¼“å­˜
```

## 6.2 æ–‡ä»¶å­˜å‚¨ç­–ç•¥

### å¯¹è±¡å­˜å‚¨(OSS)

```
bucket: morning-reading-prod

ç»“æ„ï¼š
â”œâ”€ avatars/{userId}/{timestamp}.jpg           # ç”¨æˆ·å¤´åƒ
â”œâ”€ insights/{userId}/{insightId}/share.jpg   # åé¦ˆåˆ†äº«å¡ç‰‡
â”œâ”€ courses/{courseId}/cover.jpg              # è¯¾ç¨‹å°é¢
â”œâ”€ courses/{courseId}/content/*.jpg          # è¯¾ç¨‹å†…å®¹å›¾ç‰‡
â”œâ”€ temp/upload/{userId}/{fileId}             # ä¸´æ—¶ä¸Šä¼ 
â””â”€ logs/{date}/{hour}/                        # æ—¥å¿—å­˜å‚¨

è®¿é—®ç­–ç•¥ï¼š
- å…¬å¼€æ–‡ä»¶ï¼šCDNåŠ é€Ÿ
- ç§æœ‰æ–‡ä»¶ï¼šä¸´æ—¶ç­¾åURL (1å°æ—¶æœ‰æ•ˆæœŸ)
- å¤´åƒå›¾ç‰‡ï¼šç¼©ç•¥å›¾ç”Ÿæˆ (100x100, 200x200)

è‡ªåŠ¨åˆ é™¤ç­–ç•¥ï¼š
- ä¸´æ—¶æ–‡ä»¶ï¼š7å¤©åè‡ªåŠ¨åˆ é™¤
- å·²åˆ é™¤ç”¨æˆ·æ–‡ä»¶ï¼š30å¤©åè‡ªåŠ¨åˆ é™¤
```

---

# 7 æ¶ˆæ¯é˜Ÿåˆ—ä¸å¼‚æ­¥å¤„ç†

## 7.1 æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”Ÿäº§è€…        â”‚
â”‚  CheckInService â”‚
â”‚  UserService    â”‚
â”‚  PermissionSvc  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ å‘å¸ƒäº‹ä»¶
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RabbitMQ (3èŠ‚ç‚¹é›†ç¾¤)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Exchange: direct         â”‚
â”‚ - checkin.event.ex       â”‚
â”‚ - insight.event.ex       â”‚
â”‚ - notification.ex        â”‚
â”‚                          â”‚
â”‚ Queue:                   â”‚
â”‚ - checkin.queue          â”‚
â”‚ - insight.generation.q   â”‚
â”‚ - notification.queue     â”‚
â”‚ - email.queue            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚          â”‚          â”‚
    â–¼          â–¼          â–¼          â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚åé¦ˆç”Ÿæˆ â”‚ â”‚æ•°æ®åˆ†æ â”‚ â”‚æ¨é€é€šçŸ¥ â”‚ â”‚é‚®ä»¶å‘é€ â”‚
 â”‚Consumer â”‚ â”‚Consumerâ”‚ â”‚Consumerâ”‚ â”‚Consumerâ”‚
 â”‚(å¼‚æ­¥)  â”‚ â”‚(å¼‚æ­¥)  â”‚ â”‚(å¼‚æ­¥)  â”‚ â”‚(å¼‚æ­¥)  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº‹ä»¶å®šä¹‰

```java
// æ‰“å¡äº‹ä»¶
@Data
public class CheckInEvent {
  private Long checkInId;
  private Long userId;
  private Long sectionId;
  private String content;
  private LocalDateTime checkInTime;
  private Boolean isMakeUp;
}

// åé¦ˆç”Ÿæˆäº‹ä»¶
@Data
public class InsightGeneratedEvent {
  private Long insightId;
  private Long userId;
  private Long sectionId;
  private String aiModel;
}

// æƒé™è¯·æ±‚äº‹ä»¶
@Data
public class PermissionRequestEvent {
  private Long requestId;
  private Long requestorId;
  private Long ownerId;
  private Long insightId;
}
```

### æ¶ˆè´¹è€…å®ç°

```java
// src/main/java/com/morningreading/mq/CheckInEventListener.java
@Component
@Slf4j
public class CheckInEventListener {
  
  @Autowired
  private AiInsightService aiInsightService;
  @Autowired
  private DataAnalysisService dataAnalysisService;
  @Autowired
  private NotificationService notificationService;
  
  /**
   * ç›‘å¬æ‰“å¡äº‹ä»¶
   * 1. å¼‚æ­¥ç”ŸæˆAIåé¦ˆ
   * 2. æ›´æ–°æ•°æ®åˆ†æ
   * 3. å‘é€ç”¨æˆ·é€šçŸ¥
   */
  @RabbitListener(
      queues = "checkin.queue",
      ackMode = AcknowledgeMode.AUTO
  )
  public void onCheckIn(CheckInEvent event) {
    try {
      log.info("å¤„ç†æ‰“å¡äº‹ä»¶: checkInId={}", event.getCheckInId());
      
      // 1. ç”ŸæˆAIåé¦ˆ
      aiInsightService.generateInsight(
          event.getUserId(),
          event.getSectionId(),
          event.getContent()
      );
      
      // 2. æ›´æ–°æ‰“å¡ç»Ÿè®¡
      dataAnalysisService.recordCheckInMetrics(event);
      
      // 3. å‘é€é€šçŸ¥
      notificationService.sendCheckInSuccess(event.getUserId());
      
      log.info("æ‰“å¡äº‹ä»¶å¤„ç†å®Œæˆ: checkInId={}", event.getCheckInId());
      
    } catch (Exception e) {
      log.error("æ‰“å¡äº‹ä»¶å¤„ç†å¤±è´¥", e);
      // ä¸å†é‡è¯•ï¼Œè®°å½•å¤±è´¥æ—¥å¿—ç”¨äºäººå·¥å¤„ç†
      recordFailedEvent(event, e);
    }
  }
  
  /**
   * è®°å½•å¤±è´¥äº‹ä»¶ç”¨äºé‡æ–°å¤„ç†
   */
  private void recordFailedEvent(CheckInEvent event, Exception e) {
    // ä¿å­˜åˆ°æ•°æ®åº“æˆ–ä¸“ç”¨æ—¥å¿—ç³»ç»Ÿ
  }
}
```

## 7.2 å¼‚æ­¥ä»»åŠ¡è°ƒåº¦

```yaml
# å®šæ—¶ä»»åŠ¡é…ç½®
scheduled-tasks:
  # æ¯æ—¥5:50å‘é€æ‰“å¡æé†’
  - task: SendCheckInReminder
    cron: "0 50 5 * * ?"
    
  # æ¯å°æ—¶æ¸…ç†è¿‡æœŸæƒé™è¯·æ±‚
  - task: CleanupExpiredPermissions
    cron: "0 0 * * * ?"
    
  # æ¯æ—¥å‡Œæ™¨2:00ç”Ÿæˆæ•°æ®æŠ¥è¡¨
  - task: GenerateDailyReport
    cron: "0 0 2 * * ?"
    
  # æ¯å‘¨ä¸€å‡Œæ™¨3:00ç”Ÿæˆå‘¨æŠ¥
  - task: GenerateWeeklyReport
    cron: "0 0 3 ? * MON"
    
  # æ¯å¤©æ›´æ–°æ’è¡Œæ¦œ
  - task: UpdateLeaderboard
    cron: "0 0 0 * * ?"
```

---

# 8 APIç½‘å…³ä¸è·¯ç”±

## 8.1 ç½‘å…³æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯è¯·æ±‚ (HTTPS)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Nginxè´Ÿè½½å‡è¡¡ (4èŠ‚ç‚¹)          â”‚
â”‚  - è¯·æ±‚åˆ†é…                          â”‚
â”‚  - SSLç»ˆæ­¢                           â”‚
â”‚  - é™æµ (åŸºäºIP/ç”¨æˆ·)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Gateway (Kong / Spring Cloud)  â”‚
â”‚  - è·¯ç”±è½¬å‘                          â”‚
â”‚  - è®¤è¯éªŒè¯ (JWT)                    â”‚
â”‚  - è¯·æ±‚/å“åº”è½¬æ¢                     â”‚
â”‚  - æ—¥å¿—è®°å½•                          â”‚
â”‚  - ç›‘æ§å‘Šè­¦                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚             â”‚
    â–¼                     â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·æœåŠ¡ â”‚ â”‚è¯¾ç¨‹æœåŠ¡  â”‚ â”‚æƒé™æœåŠ¡   â”‚ ...
â”‚:8001   â”‚ â”‚:8002    â”‚ â”‚:8003     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 8.2 è·¯ç”±è§„åˆ™

```
# ç”¨æˆ·è®¤è¯ç›¸å…³
POST   /api/auth/login                -> auth-service:8001
POST   /api/auth/logout               -> auth-service:8001
POST   /api/auth/refresh-token        -> auth-service:8001
GET    /api/auth/wechat-config        -> auth-service:8001

# ç”¨æˆ·ç›¸å…³
GET    /api/users/me                  -> user-service:8002
PUT    /api/users/me                  -> user-service:8002
GET    /api/users/:userId/profile     -> user-service:8002
GET    /api/users/me/courses          -> course-service:8003

# è¯¾ç¨‹ç›¸å…³
GET    /api/courses/open-periods      -> course-service:8003
GET    /api/courses/:courseId         -> course-service:8003
GET    /api/courses/:courseId/sections -> course-service:8003
POST   /api/users/me/signup           -> course-service:8003

# æ‰“å¡ç›¸å…³
POST   /api/checkins                  -> checkin-service:8004
GET    /api/checkins/today            -> checkin-service:8004
GET    /api/users/me/checkins/stats   -> checkin-service:8004

# åé¦ˆç›¸å…³
GET    /api/insights/:insightId       -> insight-service:8005
GET    /api/users/me/insights         -> insight-service:8005
POST   /api/insights/:insightId/share -> insight-service:8005

# æƒé™ç›¸å…³
POST   /api/permissions/requests      -> permission-service:8006
GET    /api/permissions/requests/incoming -> permission-service:8006
POST   /api/permissions/requests/:id/accept -> permission-service:8006
POST   /api/permissions/requests/:id/reject -> permission-service:8006

# ç¤¾ç¾¤è¯„è®º
POST   /api/sections/:sectionId/comments -> community-service:8007
GET    /api/sections/:sectionId/comments -> community-service:8007
POST   /api/comments/:commentId/like     -> community-service:8007
```

## 8.3 é™æµç­–ç•¥

```java
@Component
public class RateLimitingFilter {
  
  private static final RateLimiter limiter = 
      RateLimiter.create(100.0); // æ¯ç§’100ä¸ªè¯·æ±‚
  
  @Around("@annotation(RateLimit)")
  public Object rateLimit(ProceedingJoinPoint pjp) throws Throwable {
    if (!limiter.tryAcquire()) {
      throw new RateLimitException("è¯·æ±‚è¿‡äºé¢‘ç¹");
    }
    return pjp.proceed();
  }
}

// æ›´ç»†ç²’åº¦çš„é™æµï¼šåŸºäºç”¨æˆ·
@RedisRateLimiter(
    value = 10,              // 10ä¸ªè¯·æ±‚
    unit = TimeUnit.MINUTES  // æ¯10åˆ†é’Ÿ
)
public ResponseEntity<?> submitCheckIn(@RequestBody CheckInRequest req) {
  // ...
}
```

---

# 9 è®¤è¯ä¸æƒé™ä½“ç³»

## 9.1 JWTè®¤è¯æµç¨‹

```
1. å¾®ä¿¡æˆæƒ
   Client -> /api/auth/login?code=CODE -> Backend
   Backendè°ƒç”¨å¾®ä¿¡æ¥å£ï¼š
   GET https://api.weixin.qq.com/sns/jscode2session?
       appid=APPID&secret=SECRET&js_code=CODE&grant_type=authorization_code

2. è·å–ä»¤ç‰Œ
   è¿”å›ï¼š
   {
     "session_key": "...",
     "openid": "...",
     "unionid": "..."
   }

3. ç”ŸæˆJWT
   Backendç”ŸæˆJWT Token:
   {
     "sub": "userId",
     "iss": "morning-reading",
     "aud": "wechat-client",
     "exp": TIMESTAMP,
     "iat": TIMESTAMP,
     "permissions": ["READ_PROFILE", "WRITE_CHECKIN", ...]
   }

4. è¿”å›Tokenç»™Client
   {
     "access_token": "eyJhbGc...",
     "refresh_token": "eyJhbGc...",
     "expires_in": 3600
   }

5. åˆ·æ–°Token
   Clientåœ¨Tokenè¿‡æœŸå‰è°ƒç”¨:
   POST /api/auth/refresh-token
   Header: Authorization: Bearer {refresh_token}
```

## 9.2 æƒé™æ¨¡å‹

```
RBAC (Role-Based Access Control)
â”œâ”€ è§’è‰² (Roles)
â”‚  â”œâ”€ ROLE_USER (å­¦å‘˜)
â”‚  â”œâ”€ ROLE_ADMIN (ç®¡ç†å‘˜)
â”‚  â””â”€ ROLE_SUPER_ADMIN (è¶…ç®¡)
â”‚
â”œâ”€ æƒé™ (Permissions)
â”‚  â”œâ”€ READ_PROFILE
â”‚  â”œâ”€ WRITE_PROFILE
â”‚  â”œâ”€ READ_COURSES
â”‚  â”œâ”€ WRITE_CHECKIN
â”‚  â”œâ”€ READ_INSIGHTS
â”‚  â”œâ”€ WRITE_COMMENTS
â”‚  â”œâ”€ READ_PERMISSION_REQUESTS
â”‚  â”œâ”€ APPROVE_PERMISSION_REQUESTS
â”‚  â””â”€ ADMIN_ACCESS
â”‚
â””â”€ æƒé™æ˜ å°„ (Permission Mapping)
   ROLE_USER:
     - READ_PROFILE (è‡ªå·±çš„)
     - WRITE_PROFILE (è‡ªå·±çš„)
     - READ_COURSES
     - WRITE_CHECKIN
     - READ_INSIGHTS (è‡ªå·±çš„æˆ–å·²æˆæƒ)
     - WRITE_COMMENTS
     - READ_PERMISSION_REQUESTS
     - APPROVE_PERMISSION_REQUESTS
     
   ROLE_ADMIN:
     - æ‰€æœ‰USERæƒé™
     - READ_USERS (ä»»ä½•ç”¨æˆ·)
     - MANAGE_COURSES
     - MANAGE_SECTIONS
     - WRITE_ANNOUNCEMENTS
     
   ROLE_SUPER_ADMIN:
     - æ‰€æœ‰æƒé™
```

## 9.3 æƒé™æ£€æŸ¥å®ç°

```java
// åŸºäºæ³¨è§£çš„æƒé™æ£€æŸ¥
@PreAuthorize("hasRole('USER')")
public ResponseEntity<?> getUserProfile() {}

// æ–¹æ³•çº§æƒé™æ£€æŸ¥
@PreAuthorize("@permissionService.canViewInsight(#userId, #insightId)")
public ResponseEntity<?> getInsight(Long userId, Long insightId) {}

// æ•°æ®çº§æƒé™æ£€æŸ¥
@PostAuthorize("@permissionService.canViewUser(returnObject, principal.userId)")
public User getUser(Long userId) {}
```

---

# 10 å®‰å…¨ä¸éšç§ä¿æŠ¤

## 10.1 æ•°æ®åŠ å¯†ç­–ç•¥

### ä¼ è¾“å®‰å…¨
- **HTTPS/TLS**: æ‰€æœ‰APIé€šä¿¡ä½¿ç”¨TLS 1.3
- **è¯ä¹¦å›ºå®š**: å®¢æˆ·ç«¯å›ºå®šæœåŠ¡å™¨è¯ä¹¦ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»
- **å®‰å…¨å¤´**: 
  ```
  Strict-Transport-Security: max-age=31536000
  X-Content-Type-Options: nosniff
  X-Frame-Options: DENY
  Content-Security-Policy: ...
  ```

### å­˜å‚¨åŠ å¯†
```java
// æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨
@Entity
public class User {
  @Column
  @Encrypted(algorithm = "AES256")
  private String phone;
  
  @Column
  @Encrypted(algorithm = "AES256")
  private String email;
  
  @Column
  @Hashed(algorithm = "BCRYPT")
  private String passwordHash;
}

// åŠ å¯†å¯†é’¥ç®¡ç†
- ä¸»å¯†é’¥å­˜å‚¨åœ¨AWS KMSæˆ–HashiCorp Vault
- æ¯ä¸ªåº”ç”¨å®ä¾‹æœ‰ç‹¬ç«‹çš„å¯†é’¥
- å®šæœŸè½®æ¢å¯†é’¥
```

## 10.2 éšç§ä¿æŠ¤

### ç”¨æˆ·æ•°æ®éšç§
```
ä¸ªäººä¿¡æ¯åˆ†ç±»ï¼š
â”œâ”€ å…¬å¼€ä¿¡æ¯ (Public)
â”‚  - æ˜µç§°
â”‚  - å¤´åƒ
â”‚  - ä¸ªäººç­¾å
â”‚
â”œâ”€ åŠå…¬å¼€ä¿¡æ¯ (Semi-Public)
â”‚  - æ‰“å¡ç»Ÿè®¡
â”‚  - å®Œæˆè¯¾ç¨‹æ•°
â”‚  - è¯„è®ºå’Œç‚¹èµ
â”‚
â””â”€ ç§å¯†ä¿¡æ¯ (Private)
   - çœŸå®å§“å
   - æ‰‹æœºå·ã€é‚®ç®±
   - åœ°å€ä¿¡æ¯
   - ä¸ªæ€§åŒ–åé¦ˆï¼ˆéœ€æƒé™ï¼‰
   - æ‰“å¡è¯¦ç»†å†…å®¹
```

### åé¦ˆéšç§æ§åˆ¶
```
æƒé™ç­‰çº§ï¼š
1. ç§å¯† (Private) - ä»…è‡ªå·±å¯è§
   - é»˜è®¤çŠ¶æ€
   - ä»–äººéœ€ç´¢è¦æƒé™

2. æœ‹å‹å¯è§ (Friends) - å·²æˆæƒç”¨æˆ·å¯è§
   - éœ€è¦approveæƒé™è¯·æ±‚

3. å…¬å¼€ (Public) - æ‰€æœ‰ç”¨æˆ·å¯è§
   - v2.0åŠŸèƒ½ï¼Œæš‚æœªå®ç°

æƒé™æœ‰æ•ˆæœŸï¼š
- ä¸€æ—¦æˆæƒï¼Œæ°¸ä¹…æœ‰æ•ˆ
- åé¦ˆæ‰€æœ‰è€…å¯éšæ—¶å–æ¶ˆæˆæƒ
- æƒé™è¯·æ±‚7å¤©æœªå¤„ç†è‡ªåŠ¨è¿‡æœŸ
```

### GDPRåˆè§„
```
ç”¨æˆ·æƒåˆ©ï¼š
- çŸ¥æƒ…æƒï¼šç”¨æˆ·å¯æŸ¥çœ‹è‡ªå·±çš„æ‰€æœ‰æ•°æ®
- è®¿é—®æƒï¼šç”¨æˆ·å¯å¯¼å‡ºè‡ªå·±çš„æ•°æ®
- åˆ é™¤æƒï¼šç”¨æˆ·å¯ç”³è¯·åˆ é™¤è´¦æˆ·å’Œæ•°æ®ï¼ˆ30å¤©åæ‰§è¡Œï¼‰
- æ›´æ­£æƒï¼šç”¨æˆ·å¯ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯
- æºå¸¦æƒï¼šç”¨æˆ·å¯å¯¼å‡ºæ•°æ®ä¸ºæ ‡å‡†æ ¼å¼

æ•°æ®æœ€å°åŒ–ï¼š
- ä»…æ”¶é›†å¿…è¦çš„ä¿¡æ¯
- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- åŒ¿ååŒ–å¤„ç†åˆ†ææ•°æ®
```

---

# 11 æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

## 11.1 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

### ä»£ç åˆ†å‰²
```javascript
// æŒ‰é¡µé¢åˆ†å‰²
const HomePage = lazy(() => import('./pages/Home'))
const CheckInPage = lazy(() => import('./pages/CheckIn'))

// è·¯ç”±çº§ä»£ç åˆ†å‰²
const routes = [
  {
    path: '/home',
    component: lazy(() => import('./pages/Home')),
    name: 'Home'
  },
  {
    path: '/courses',
    component: lazy(() => import('./pages/Courses')),
    name: 'Courses'
  }
]
```

### èµ„æºä¼˜åŒ–
- **å›¾ç‰‡å‹ç¼©**: WebPæ ¼å¼ï¼Œæä¾›å¤šç§å°ºå¯¸ (100x100, 200x200, 400x400)
- **æ‡’åŠ è½½**: éé¦–å±å›¾ç‰‡å»¶è¿ŸåŠ è½½
- **ç¼“å­˜**: é™æ€èµ„æºä½¿ç”¨CDNï¼Œè®¾ç½®é•¿æœŸç¼“å­˜ç­–ç•¥
- **é¢„åŠ è½½**: é¢„åŠ è½½å…³é”®èµ„æº (å­—ä½“ã€å…³é”®è„šæœ¬)

### æ¸²æŸ“ä¼˜åŒ–
```javascript
// è™šæ‹Ÿåˆ—è¡¨ï¼šå¤„ç†å¤§åˆ—è¡¨æ€§èƒ½
<VirtualScroll
  items={comments}
  itemHeight={80}
  bufferSize={5}
/>

// éª¨æ¶å±ï¼šé¦–å±åŠ è½½ä¼˜åŒ–
<Skeleton loading={loading}>
  <CourseCard course={course} />
</Skeleton>

// é˜²æŠ–å’ŒèŠ‚æµ
const handleScroll = throttle(() => {
  loadMoreComments()
}, 1000)

const handleInput = debounce((value) => {
  searchCourses(value)
}, 500)
```

## 11.2 åç«¯æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–
```sql
-- æŸ¥è¯¢ä¼˜åŒ–ï¼šä½¿ç”¨prepared statement
SELECT * FROM users WHERE id = ? AND status = ?

-- æ‰¹é‡æ’å…¥ä¼˜åŒ–
INSERT INTO checkins (user_id, section_id, content) VALUES
  (?, ?, ?), (?, ?, ?), (?, ?, ?)

-- é¿å…N+1æŸ¥è¯¢ï¼šä½¿ç”¨JOIN
SELECT u.*, c.* FROM users u
JOIN user_courses uc ON u.id = uc.user_id
JOIN course_periods cp ON uc.period_id = cp.id
WHERE u.id = ?

-- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–ï¼šé¿å…å¤§OFFSET
SELECT * FROM comments 
WHERE section_id = ? AND id > ?
ORDER BY id DESC
LIMIT 20

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_section ON checkins(user_id, section_id);
CREATE INDEX idx_insight_user ON insights(user_id, created_at DESC);
```

### ç¼“å­˜ä¼˜åŒ–
```java
// ç¼“å­˜é¢„çƒ­ï¼šå¯åŠ¨æ—¶åŠ è½½çƒ­ç‚¹æ•°æ®
@Component
public class CacheWarmUp implements ApplicationRunner {
  @Override
  public void run(ApplicationArguments args) throws Exception {
    // é¢„åŠ è½½å½“å‰æœŸæ¬¡çš„æ‰€æœ‰è¯¾ç¨‹
    List<CoursePeriod> periods = courseService.getCurrentPeriods();
    for (CoursePeriod period : periods) {
      List<Section> sections = sectionService.getSections(period.getId());
      cache.put(String.format("sections:%d", period.getId()), sections);
    }
  }
}

// ç¼“å­˜ç©¿é€é˜²æŠ¤ï¼šå¸ƒéš†è¿‡æ»¤å™¨
@Bean
public BloomFilter<Long> userBloomFilter() {
  BloomFilter<Long> filter = BloomFilter.create(
      Funnels.longFunnel(),
      10_000_000L,  // 1000ä¸‡ç”¨æˆ·
      0.01          // 1%è¯¯å·®ç‡
  );
  
  // é¢„åŠ è½½æ‰€æœ‰ç”¨æˆ·ID
  userRepository.getAllIds().forEach(filter::put);
  return filter;
}
```

### APIå“åº”ä¼˜åŒ–
```java
// è¿”å›å­—æ®µé€‰æ‹©ï¼šé¿å…è¿‡åº¦è¿”å›
@GetMapping("/users/{id}")
public ResponseEntity<?> getUser(
    @PathVariable Long id,
    @RequestParam(defaultValue = "") String fields
) {
  User user = userService.getUser(id);
  
  if (!fields.isEmpty()) {
    // åªè¿”å›æŒ‡å®šå­—æ®µ
    return ResponseEntity.ok(filterFields(user, fields));
  }
  
  return ResponseEntity.ok(user);
}

// å“åº”å‹ç¼©ï¼šå¯ç”¨gzip
server:
  compression:
    enabled: true
    min-response-size: 1024
    mime-types: application/json,text/html,text/xml
```

---

# 12 ç›‘æ§ã€æ—¥å¿—ä¸å‘Šè­¦

## 12.1 ç›‘æ§ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åº”ç”¨ç¨‹åº (Java/Node.js)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŒ‡æ ‡é‡‡é›†å™¨ (Prometheus Client)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ æ¯15ç§’é‡‡é›†ä¸€æ¬¡
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Prometheus (æ—¶é—´åºåˆ—æ•°æ®åº“)          â”‚
â”‚    â”œâ”€ å­˜å‚¨å‘¨æœŸï¼š15å¤©                    â”‚
â”‚    â”œâ”€ æ•°æ®ç‚¹æ•°ï¼šç™¾ä¸‡+                   â”‚
â”‚    â””â”€ ç£ç›˜å ç”¨ï¼š50GB                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚
    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Grafana     â”‚  â”‚  AlertManagerâ”‚
â”‚  (ä»ªè¡¨æ¿)    â”‚  â”‚  (å‘Šè­¦è§„åˆ™)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æŒ‡æ ‡

#### ä¸šåŠ¡æŒ‡æ ‡
```
# ç”¨æˆ·æŒ‡æ ‡
- DAU (æ—¥æ´»ç”¨æˆ·)ï¼štarget > 10,000
- MAU (æœˆæ´»ç”¨æˆ·)ï¼štarget > 30,000
- æ–°ç”¨æˆ·è½¬åŒ–ç‡ï¼štarget > 75%
- ç”¨æˆ·ç•™å­˜ç‡ (7æ—¥)ï¼štarget > 60%

# æ‰“å¡æŒ‡æ ‡
- æ—¥æ‰“å¡æ•°ï¼šè¡¡é‡æ´»è·ƒåº¦
- æ‰“å¡å®Œæˆç‡ï¼štarget > 70%
- å¹³å‡æ‰“å¡ç”¨æ—¶ï¼šè¡¡é‡ä½“éªŒ

# ç¤¾ç¾¤æŒ‡æ ‡
- è¯„è®ºäº’åŠ¨ç‡ï¼šæœ‰è¯„è®ºçš„è¯¾ç¨‹æ¯”ä¾‹
- å¹³å‡è¯„è®ºæ•°/è¯¾ç¨‹
- æƒé™è¯·æ±‚æ•°å’Œæ‰¹å‡†ç‡
```

#### æŠ€æœ¯æŒ‡æ ‡
```yaml
APIæ€§èƒ½:
  response_time_p50: < 100ms
  response_time_p95: < 300ms
  response_time_p99: < 500ms
  error_rate: < 0.1%

æ•°æ®åº“:
  query_time_p99: < 200ms
  connection_pool_usage: < 80%
  replication_lag: < 1s
  slow_query_count: < 10/min

ç¼“å­˜:
  hit_rate: > 80%
  memory_usage: < 80%
  eviction_rate: < 1%

é˜Ÿåˆ—:
  queue_depth: < 10,000
  consumer_lag: < 5s
  error_rate: < 0.1%

ç³»ç»Ÿ:
  cpu_usage: < 70%
  memory_usage: < 80%
  disk_usage: < 85%
  network_bandwidth: < 70%
```

## 12.2 æ—¥å¿—ç³»ç»Ÿ

```yaml
# æ—¥å¿—æ”¶é›†æ¶æ„
Applications
  â”œâ”€ Javaåº”ç”¨ (Logback)
  â”œâ”€ Nodeåº”ç”¨ (Winston)
  â””â”€ Nginx (JSONæ ¼å¼)
         â”‚
         â–¼
    Filebeat / Fluentd
    (æ—¥å¿—é‡‡é›†)
         â”‚
         â–¼
    Elasticsearch (æ—¥å¿—å­˜å‚¨)
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
  Kibana    Splunk
  (åˆ†æ)    (åˆ†æ)
```

### æ—¥å¿—çº§åˆ«å®šä¹‰

```java
// ERRORï¼šç³»ç»Ÿé”™è¯¯ï¼Œéœ€è¦ç«‹å³å¤„ç†
log.error("æ•°æ®åº“è¿æ¥å¤±è´¥", exception)

// WARNï¼šæ½œåœ¨é—®é¢˜ï¼Œéœ€è¦å…³æ³¨
log.warn("ç¼“å­˜å‘½ä¸­ç‡ä½: {}%", hitRate)

// INFOï¼šå…³é”®ä¸šåŠ¡äº‹ä»¶
log.info("ç”¨æˆ·æ‰“å¡: userId={}, sectionId={}", userId, sectionId)

// DEBUGï¼šè°ƒè¯•ä¿¡æ¯
log.debug("ç¼“å­˜é”®: {}", cacheKey)

// TRACEï¼šéå¸¸è¯¦ç»†çš„è¿½è¸ª
log.trace("è¿›å…¥æ–¹æ³•: {}", methodName)
```

### å®¡è®¡æ—¥å¿—

```java
// å…³é”®æ“ä½œå®¡è®¡
@Audit(action = "æƒé™æ‰¹å‡†", category = "æƒé™ç®¡ç†")
public void approvePermissionRequest(Long requestId) {
  // è®°å½•æ“ä½œï¼šè°ã€ä»€ä¹ˆæ—¶é—´ã€åšäº†ä»€ä¹ˆã€ç»“æœæ˜¯ä»€ä¹ˆ
  auditLog.record(new AuditEntry(
      userId: getCurrentUserId(),
      action: "APPROVE_PERMISSION",
      entity: "PermissionRequest",
      entityId: requestId,
      changes: {
        status: "PENDING" -> "ACCEPTED"
      },
      timestamp: now(),
      ipAddress: getClientIP()
  ));
}
```

## 12.3 å‘Šè­¦è§„åˆ™

```yaml
å‘Šè­¦è§„åˆ™:
  - name: APIResponseTimeHigh
    expr: api_response_time_p99 > 500
    for: 2m
    severity: warning
    action: å‘é€Slacké€šçŸ¥
    
  - name: ErrorRateHigh
    expr: api_error_rate > 0.01
    for: 1m
    severity: critical
    action: å‘é€é’‰é’‰ã€Slackã€çŸ­ä¿¡
    
  - name: DatabaseSlow
    expr: db_query_time_p99 > 200
    for: 5m
    severity: warning
    action: è®°å½•æ—¥å¿—ï¼Œå‘é€å‘Šè­¦
    
  - name: CacheHitRateLow
    expr: cache_hit_rate < 0.7
    for: 10m
    severity: info
    action: å‘é€æ¯æ—¥æŠ¥å‘Š
    
  - name: QueueBacklog
    expr: mq_queue_depth > 50000
    for: 3m
    severity: critical
    action: å‘é€PagerDutyã€Slacké€šçŸ¥
```

---

# 13 éƒ¨ç½²æ¶æ„

## 13.1 éƒ¨ç½²æ‹“æ‰‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CDN (é˜¿é‡Œäº‘/CloudFlare)                â”‚
â”‚         - é™æ€èµ„æºåŠ é€Ÿ                              â”‚
â”‚         - DDoSé˜²æŠ¤                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
               â”‚                                   â”‚
         (HTTPS)                              (HTTPS)
               â”‚                                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  åŒ—äº¬åœ°åŸŸ           â”‚          â”‚  ä¸Šæµ·åœ°åŸŸ            â”‚
    â”‚                    â”‚          â”‚                     â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚ â”‚ Nginx LB (2ä¸ª) â”‚ â”‚          â”‚ â”‚ Nginx LB (2ä¸ª) â”‚  â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚          â”‚         â”‚          â”‚          â”‚          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â”‚          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”     â”‚
    â”‚  â–¼             â–¼   â”‚          â”‚   â–¼           â–¼     â”‚
    â”‚ App1 (8001)  App2  â”‚          â”‚  App1 (8001) App2   â”‚
    â”‚ App3 (8002)  App4  â”‚          â”‚  App3 (8002) App4   â”‚
    â”‚ (Kubernetesé›†ç¾¤)   â”‚          â”‚  (Kubernetesé›†ç¾¤)  â”‚
    â”‚                    â”‚          â”‚                     â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚ â”‚ MySQL Master   â”‚ â”‚          â”‚ â”‚ MySQL Slave    â”‚  â”‚
    â”‚ â”‚ (è¯»å†™åˆ†ç¦»)     â”‚ â”‚â—„â”€â”€åŒæ­¥â”€â”€â–ºâ”‚ â”‚ (åªè¯»)         â”‚  â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                    â”‚          â”‚                     â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ Redisé›†ç¾¤ (3ä¸»3ä»ï¼Œè·¨åœ°åŸŸå¤åˆ¶)                  â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                    â”‚          â”‚                     â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚ â”‚ RabbitMQé›†ç¾¤ (3èŠ‚ç‚¹)                         â”‚  â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                    â”‚          â”‚                     â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚ â”‚ Elasticsearché›†ç¾¤ (3èŠ‚ç‚¹ï¼Œç”¨äºæ—¥å¿—å’Œæœç´¢)    â”‚  â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                    â”‚          â”‚                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚          â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚  å¯¹è±¡å­˜å‚¨ (OSS)     â”‚
                    â”‚  - å¤´åƒã€æ–‡ä»¶å­˜å‚¨   â”‚
                    â”‚  - å¤‡ä»½ã€å½’æ¡£       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 13.2 Kuberneteséƒ¨ç½²

```yaml
# morning-reading-backend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: morning-reading-backend
  labels:
    app: morning-reading
    tier: backend
spec:
  replicas: 4
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: morning-reading
      tier: backend
  template:
    metadata:
      labels:
        app: morning-reading
        tier: backend
    spec:
      containers:
      - name: backend
        image: morning-reading-backend:1.0.0
        ports:
        - containerPort: 8080
        
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1024Mi
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
        
        env:
        - name: SPRING_DATASOURCE_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: db.url
        - name: REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: redis.host
      
      # åˆå§‹åŒ–å®¹å™¨ï¼šç­‰å¾…MySQLå°±ç»ª
      initContainers:
      - name: wait-for-db
        image: busybox:1.28
        command: ['sh', '-c', 'until nc -z mysql 3306; do echo waiting for mysql; sleep 2; done']
      
      # èŠ‚ç‚¹äº²å’Œæ€§
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - morning-reading
              topologyKey: kubernetes.io/hostname

---
# æœåŠ¡å®šä¹‰
apiVersion: v1
kind: Service
metadata:
  name: morning-reading-service
spec:
  selector:
    app: morning-reading
    tier: backend
  type: ClusterIP
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080

---
# HPAè‡ªåŠ¨æ‰©å®¹
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: morning-reading-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: morning-reading-backend
  minReplicas: 4
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 4
        periodSeconds: 15
      selectPolicy: Max
```

---

# 14 ç¾éš¾æ¢å¤ä¸é«˜å¯ç”¨

## 14.1 é«˜å¯ç”¨è®¾è®¡

### æ•°æ®åº“é«˜å¯ç”¨

```
MySQLä¸»ä»å¤åˆ¶ + MHA (Master High Availability)
                         
ä¸»åº“ (Master)
  - æ¥æ”¶å†™è¯·æ±‚
  - åŒæ­¥åˆ°ä»åº“
  - æ•…éšœæ—¶MHAè‡ªåŠ¨è½¬ç§»
  
       â†“ ä¸»ä»åŒæ­¥
       
ä»åº“ (Slave 1, 2, 3)
  - æ¥æ”¶è¯»è¯·æ±‚
  - å¼‚æ­¥å¤åˆ¶æ—¥å¿—
  - å®•æœºä¸å½±å“æœåŠ¡

æ•…éšœè½¬ç§»ï¼š
1. MHAç›‘æ§æ£€æµ‹ä¸»åº“å®•æœº
2. é€‰æ‹©æœ€æ–°çš„ä»åº“ä½œä¸ºæ–°ä¸»åº“
3. å…¶ä»–ä»åº“é‡æ–°æŒ‡å‘æ–°ä¸»åº“
4. æ¢å¤æ—§ä¸»åº“åä½œä¸ºæ–°çš„ä»åº“
5. RTO < 30ç§’
```

### ç¼“å­˜é«˜å¯ç”¨

```
Redis Cluster (3ä¸»3ä»)

Master1 (Port 7000)     Master2 (Port 7001)     Master3 (Port 7002)
   â†“                        â†“                        â†“
Slave1 (Port 7003)      Slave2 (Port 7004)      Slave3 (Port 7005)

æ•…éšœå¤„ç†ï¼š
- è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šä¸»èŠ‚ç‚¹å®•æœºï¼Œä»èŠ‚ç‚¹è‡ªåŠ¨å‡çº§
- æ•°æ®æŒä¹…åŒ–ï¼šRDBå¿«ç…§ + AOFæ—¥å¿—
- æ•°æ®æ¢å¤ï¼šæœ€å¤šä¸¢å¤±å‡ ç§’å†…å­˜æ•°æ®
- å¯ç”¨æ€§ï¼šN/N = 100%
```

### åº”ç”¨é«˜å¯ç”¨

```
è´Ÿè½½å‡è¡¡ (Nginx)
   â†“ è½®è¯¢åˆ†å‘
â”Œâ”€â”€â”´â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â–¼     â–¼      â–¼      â–¼
App1  App2  App3   App4 (Kubernetesè‡ªç®¡ç†)

æ¯ä¸ªåº”ç”¨ï¼š
- æ— çŠ¶æ€è®¾è®¡ï¼ˆçŠ¶æ€å­˜åœ¨Redis/DBï¼‰
- å¥åº·æ£€æŸ¥ (5ç§’ä¸€æ¬¡)
- æ•…éšœè‡ªåŠ¨å‰”é™¤
- è‡ªåŠ¨è¡¥å……æ–°å®ä¾‹
- å®•æœºè‡ªåŠ¨è½¬ç§»
- å¯ç”¨æ€§ï¼š99.99%
```

## 14.2 å¤‡ä»½ä¸æ¢å¤ç­–ç•¥

```
å¤‡ä»½æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æºæ•°æ®åº“ (åŒ—äº¬åœ°åŸŸ)              â”‚
â”‚ â”œâ”€ MySQL                          â”‚
â”‚ â”œâ”€ Redis                          â”‚
â”‚ â””â”€ Elasticsearch                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ å¤‡ä»½
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤‡ä»½å­˜å‚¨                         â”‚
â”‚ â”œâ”€ æœ¬åœ°SAN (åŒåŸ)                â”‚
â”‚ â”œâ”€ å¼‚åœ°OSS (ä¸Šæµ·)                â”‚
â”‚ â””â”€ å†·å¤‡å½’æ¡£ (æ·±åœ³)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤‡ä»½ç­–ç•¥ï¼š
- å…¨é‡å¤‡ä»½ï¼šæ¯å‘¨æ—¥å‡Œæ™¨ (5å°æ—¶)
- å¢é‡å¤‡ä»½ï¼šæ¯å¤©å‡Œæ™¨ (30åˆ†é’Ÿ)
- å®æ—¶æ—¥å¿—ï¼šBinlog (ç§’çº§)
- ä¿ç•™å‘¨æœŸï¼š30å¤©å¤‡ä»½ + 7å¤©çƒ­å¤‡

æ¢å¤æµç¨‹ï¼š
1. æ•…éšœæ£€æµ‹ (è‡ªåŠ¨ï¼Œ< 1åˆ†é’Ÿ)
2. å¯åŠ¨æ¢å¤ç¨‹åº (< 5åˆ†é’Ÿ)
3. æ¢å¤åˆ°å¼‚åœ°æ•°æ®ä¸­å¿ƒ
4. åˆ‡æ¢DNS (< 2åˆ†é’Ÿ)
5. RTO: 10åˆ†é’Ÿä»¥å†…
6. RPO: 5åˆ†é’Ÿä»¥å†…
```

---

# 15 é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡

## 15.1 å¾®ä¿¡æœåŠ¡é›†æˆ

```
å¾®ä¿¡å…¬ä¼—å¹³å°æ¥å£ï¼š

1. ç™»å½•æˆæƒ
   https://api.weixin.qq.com/sns/jscode2session
   å‚æ•°ï¼šappid, secret, js_code, grant_type
   è¿”å›ï¼šopenid, session_key, unionid

2. è·å–ç”¨æˆ·ä¿¡æ¯
   ä½¿ç”¨session_keyè§£å¯†encryptedDataè·å–ï¼š
   - nickName (æ˜µç§°)
   - avatarUrl (å¤´åƒ)
   - gender (æ€§åˆ«)
   - province, city

3. æ¶ˆæ¯æ¨é€ (æ¨¡æ¿æ¶ˆæ¯/è®¢é˜…é€šçŸ¥)
   POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send
   
   æ¨¡æ¿IDé…ç½®ï¼š
   - æ‰“å¡æé†’ (mKPXasH3r6wBnLDkFQVFsK-n9vMnqCzQYPKjCYpCIlo)
   - åé¦ˆç”Ÿæˆ (G5dQOpkfFnqfMxIKPL-dFj7xKvwVdGTfqJOI7mLH1Jg)
   - æƒé™è¯·æ±‚ (tK-lVqPxKpZ3Q6tJdFnM8qRsL2vUxYmNpQwErTgUjVo)

4. åˆ†äº«é“¾æ¥
   æ”¯æŒåˆ†äº«å°ç¨‹åºå¡ç‰‡ã€åˆ°æœ‹å‹åœˆã€å¤åˆ¶é“¾æ¥
```

## 15.2 AIæœåŠ¡é›†æˆ

```
APIæä¾›å•†é€‰å‹ï¼š
- OpenAI (GPT-4)ï¼šæœ€å¼ºï¼Œè´¹ç”¨é«˜
- Anthropic Claudeï¼šå¹³è¡¡æ€§èƒ½å’Œæˆæœ¬
- é˜¿é‡Œäº‘å¤§æ¨¡å‹ï¼šæœ¬åœ°åŒ–ï¼Œä½å»¶è¿Ÿ

é›†æˆæ–¹æ¡ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ‰“å¡å†…å®¹ç”Ÿæˆäº‹ä»¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ RabbitMQ
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åé¦ˆç”ŸæˆæœåŠ¡        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ„å»ºPrompt        â”‚
â”‚ 2. è°ƒç”¨AI API       â”‚
â”‚ 3. ç»“æœå­˜å‚¨          â”‚
â”‚ 4. å‘é€é€šçŸ¥          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»“æœç¼“å­˜+æŒä¹…åŒ–      â”‚
â”‚  å‘é€é€šçŸ¥ç»™ç”¨æˆ·      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®¹é”™ç­–ç•¥ï¼š
- è¶…æ—¶è®¾ç½®ï¼š30ç§’è¶…æ—¶
- é‡è¯•æœºåˆ¶ï¼š3æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿
- é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ¨¡æ¿åé¦ˆ
- æˆæœ¬æ§åˆ¶ï¼šæ¯æœˆAPIè°ƒç”¨é…é¢é™åˆ¶
```

## 15.3 æ”¯ä»˜æœåŠ¡é›†æˆï¼ˆé¢„ç•™ï¼‰

```
å¾®ä¿¡æ”¯ä»˜é›†æˆï¼š
GET /api/payments/wechat-config  # è·å–æ”¯ä»˜é…ç½®
POST /api/payments/orders         # åˆ›å»ºè®¢å•
GET  /api/payments/orders/:id     # æŸ¥è¯¢è®¢å•çŠ¶æ€

å›è°ƒå¤„ç†ï¼š
POST /webhook/wechat-payment-callback
  éªŒè¯ç­¾å
  æ›´æ–°è®¢å•çŠ¶æ€
  æ›´æ–°ç”¨æˆ·æƒé™
  å‘é€ç¡®è®¤é€šçŸ¥
```

---

# 16 æŠ€æœ¯æ ˆé€‰å‹æ€»ç»“

## 16.1 æŠ€æœ¯æ ˆå¯¹æ¯”

| ç»„ä»¶ | é€‰å‹ | å¤‡é€‰æ–¹æ¡ˆ | é€‰æ‹©ç†ç”± |
|------|------|---------|---------|
| **å‰ç«¯æ¡†æ¶** | å¾®ä¿¡å°ç¨‹åºåŸç”Ÿ | Flutter/React Native | å¾®ä¿¡ç”Ÿæ€å®Œæ•´ï¼Œå¼€å‘æ•ˆç‡é«˜ |
| **åç«¯æ¡†æ¶** | Spring Boot 3 | Django/FastAPI | Javaç”Ÿæ€æˆç†Ÿï¼Œå›¢é˜Ÿç†Ÿæ‚‰ |
| **æ•°æ®åº“** | MySQL 8.0 | PostgreSQL/MongoDB | ACIDæ”¯æŒï¼Œé«˜å¯ç”¨æ–¹æ¡ˆå®Œå–„ |
| **ç¼“å­˜** | Redis 7 | Memcached | æ”¯æŒä¸°å¯Œæ•°æ®ç»“æ„ï¼ŒæŒä¹…åŒ– |
| **æ¶ˆæ¯é˜Ÿåˆ—** | RabbitMQ | Kafka/Apache Pulsar | å¯é æŠ•é€’ï¼Œæ”¯æŒäº‹åŠ¡ |
| **æœç´¢å¼•æ“** | Elasticsearch 8 | Apache Solr | å…¨æ–‡æœç´¢æ€§èƒ½ä¼˜å¼‚ |
| **ORM** | MyBatis-Plus | Hibernate/JPA | çµæ´»é«˜æ•ˆï¼Œä»£ç ç”Ÿæˆ |
| **å®¹å™¨ç¼–æ’** | Kubernetes | Docker Swarm | ä¸šç•Œæ ‡å‡†ï¼Œç”Ÿæ€ä¸°å¯Œ |
| **ç›‘æ§å‘Šè­¦** | Prometheus + Grafana | DataDog/New Relic | å¼€æºæ–¹æ¡ˆï¼Œæˆæœ¬ä½ |
| **æ—¥å¿—æ”¶é›†** | ELK (Elasticsearch) | Splunk/Datadog | å¼€æºæ–¹æ¡ˆï¼Œæ˜“é›†æˆ |

## 16.2 æ¶æ„æ¼”è¿›è·¯çº¿

```
v1.0 (å½“å‰ï¼Œ2025å¹´12æœˆä¸Šçº¿)
â”œâ”€ å•ä½“åº”ç”¨ + åˆ†å¸ƒå¼DB
â”œâ”€ Redisç¼“å­˜ + CDN
â”œâ”€ RabbitMQå¼‚æ­¥å¤„ç†
â”œâ”€ Kuberneteså®¹å™¨ç¼–æ’
â””â”€ å¯æ”¯æ’‘ï¼š50,000ç”¨æˆ·, 10,000 DAU

v2.0 (2026å¹´2æœˆ)
â”œâ”€ å¾®æœåŠ¡åˆ†ç¦»ï¼ˆç”¨æˆ·ã€è¯¾ç¨‹ã€æ‰“å¡ç­‰ç‹¬ç«‹æœåŠ¡ï¼‰
â”œâ”€ Service Mesh (Istio)
â”œâ”€ åˆ†æç³»ç»Ÿï¼ˆClickhouse + æ•°æ®ä»“åº“ï¼‰
â”œâ”€ æ’è¡Œæ¦œç³»ç»Ÿï¼ˆRedis Sorted Setï¼‰
â”œâ”€ æ¨èç³»ç»Ÿåˆç‰ˆ
â””â”€ å¯æ”¯æ’‘ï¼š200,000ç”¨æˆ·, 50,000 DAU

v3.0 (2026å¹´4æœˆ)
â”œâ”€ äº‘åŸç”Ÿæ¶æ„ï¼ˆServerless forå¼±IOæ“ä½œï¼‰
â”œâ”€ äº‹ä»¶é©±åŠ¨ï¼ˆKafka Streamå¤„ç†ï¼‰
â”œâ”€ MLæ¨èç³»ç»Ÿ
â”œâ”€ ç¤¾äº¤åŠŸèƒ½ï¼ˆå…³æ³¨ã€å°ç»„ï¼‰
â”œâ”€ ç›´æ’­åé¦ˆåŠŸèƒ½
â””â”€ å¯æ”¯æ’‘ï¼š500,000ç”¨æˆ·, 100,000 DAU
```

## 16.3 æŠ€æœ¯å€ºåŠ¡ç®¡ç†

```yaml
å·²çŸ¥æŠ€æœ¯å€ºåŠ¡ï¼š
  1. è¯„è®ºç³»ç»ŸåµŒå¥—å›å¤
     - å½“å‰ï¼šé€’å½’æŸ¥è¯¢N+1é—®é¢˜
     - æ”¹è¿›è®¡åˆ’ï¼šv2.0ä½¿ç”¨Cache-Asideæ¨¡å¼
     - ä¼˜å…ˆçº§ï¼šä¸­
  
  2. æƒé™æ£€æŸ¥æ€§èƒ½
     - å½“å‰ï¼šæ¯æ¬¡æ£€æŸ¥éƒ½æŸ¥è¯¢æ•°æ®åº“
     - æ”¹è¿›è®¡åˆ’ï¼šRedisç¼“å­˜æƒé™è¡¨
     - ä¼˜å…ˆçº§ï¼šé«˜
  
  3. æŠ¥åè¡¨å•éªŒè¯
     - å½“å‰ï¼šå‰åç«¯åˆ†åˆ«éªŒè¯
     - æ”¹è¿›è®¡åˆ’ï¼šç»Ÿä¸€éªŒè¯è§„åˆ™ï¼Œå…±äº«éªŒè¯åº“
     - ä¼˜å…ˆçº§ï¼šä½
  
  4. æ•°æ®åº“è¿æ¥æ± 
     - å½“å‰ï¼šä½¿ç”¨HikariCPé»˜è®¤é…ç½®
     - æ”¹è¿›è®¡åˆ’ï¼šæ ¹æ®å®é™…è´Ÿè½½è°ƒä¼˜
     - ä¼˜å…ˆçº§ï¼šä¸­

å¿è¿˜è®¡åˆ’ï¼š
- æ¯ä¸ªè¿­ä»£åˆ†é…10-15%çš„æ—¶é—´å¤„ç†æŠ€æœ¯å€ºåŠ¡
- ä¼˜å…ˆå¤„ç†å½±å“æ€§èƒ½å’Œå®‰å…¨çš„é—®é¢˜
- å»ºç«‹ä»£ç è´¨é‡é—¨ç¦ï¼ˆSonarQubeï¼‰
```

---

# é™„å½•

## A æŠ€æœ¯è¯æ±‡è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| **RTO** | Recovery Time Objective æ¢å¤æ—¶é—´ç›®æ ‡ |
| **RPO** | Recovery Point Objective æ¢å¤ç‚¹ç›®æ ‡ |
| **QPS** | Queries Per Second æ¯ç§’æŸ¥è¯¢æ•° |
| **P99** | 99ç™¾åˆ†ä½æ•°å“åº”æ—¶é—´ |
| **DAU** | Daily Active Users æ—¥æ´»ç”¨æˆ· |
| **MAU** | Monthly Active Users æœˆæ´»ç”¨æˆ· |
| **N+1æŸ¥è¯¢** | ORMæ¡†æ¶å¸¸è§æ€§èƒ½é—®é¢˜ |
| **ç¼“å­˜ç©¿é€** | ç¼“å­˜å’ŒDBéƒ½æ²¡æœ‰çš„æ•°æ®è®¿é—®é—®é¢˜ |
| **ç¼“å­˜å‡»ç©¿** | çƒ­ç‚¹ç¼“å­˜å¤±æ•ˆå¯¼è‡´çš„DBè¯·æ±‚æ¿€å¢ |
| **ç¼“å­˜é›ªå´©** | å¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆ |

## B éƒ¨ç½²æ¸…å•

```
éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•ï¼š

â–¡ ä»£ç å®¡æŸ¥å®Œæˆ (2äººå®¡æŸ¥)
â–¡ å•å…ƒæµ‹è¯•é€šè¿‡ (è¦†ç›–ç‡ > 80%)
â–¡ é›†æˆæµ‹è¯•é€šè¿‡ (å…¨é‡åœºæ™¯)
â–¡ æ€§èƒ½æµ‹è¯•é€šè¿‡ (P99 < 500ms)
â–¡ å®‰å…¨æ‰«æé€šè¿‡ (æ— é«˜å±æ¼æ´)
â–¡ æ•°æ®åº“è¿ç§»è„šæœ¬éªŒè¯
â–¡ é…ç½®æ–‡ä»¶æ£€æŸ¥ (å¯†é’¥ã€ç¯å¢ƒå˜é‡)
â–¡ ç›‘æ§å‘Šè­¦è§„åˆ™éƒ¨ç½²
â–¡ æ—¥å¿—æ”¶é›†éªŒè¯
â–¡ å¤‡ä»½ç­–ç•¥ç¡®è®¤
â–¡ ç¾éš¾æ¢å¤æ¼”ç»ƒ
â–¡ å›¢é˜ŸåŸ¹è®­å®Œæˆ
â–¡ å‘å¸ƒæ–‡æ¡£å®Œæˆ
â–¡ ç°åº¦å‘å¸ƒè®¡åˆ’åˆ¶å®š
â–¡ å›æ»šæ–¹æ¡ˆå‡†å¤‡

ç°åº¦å‘å¸ƒæ–¹æ¡ˆï¼š
- é‡‘ä¸é›€å‘å¸ƒï¼š5% æµé‡
- å°æµé‡éªŒè¯ï¼šè§‚å¯Ÿ2å°æ—¶æ— å¼‚å¸¸
- é€æ­¥æ‰©å¤§ï¼š10% -> 50% -> 100%
- æ€»è€—æ—¶ï¼š4-6å°æ—¶
```

## C æ¶æ„å†³ç­–è®°å½•

```
ADR-001: é€‰æ‹©Spring Bootè€ŒéDjango
å†³ç­–æ—¥æœŸï¼š2025-10-30
èƒŒæ™¯ï¼šåç«¯æ¡†æ¶é€‰å‹
é€‰é¡¹ï¼š
  1. Spring Boot (Java)
  2. Django (Python)
  3. FastAPI (Python)
  4. Go + Gin

å†³ç­–ï¼šé€‰æ‹©Spring Boot
ç†ç”±ï¼š
  - å›¢é˜ŸJavaæŠ€èƒ½æ·±åš
  - ç”Ÿæ€æˆç†Ÿï¼ˆSpring Cloudã€Spring Securityç­‰ï¼‰
  - æ€§èƒ½ä¼˜å¼‚ï¼ˆé«˜å¹¶å‘èƒ½åŠ›å¼ºï¼‰
  - å¼€æºåº“ä¸°å¯Œ

æƒè¡¡ï¼š
  - ç¼ºç‚¹ï¼šå¯åŠ¨é€Ÿåº¦æ…¢ã€å†…å­˜å ç”¨å¤§
  - æ–¹æ¡ˆï¼šDockeråŒ–éƒ¨ç½²ã€èµ„æºç®¡ç†ä¼˜åŒ–

---

ADR-002: Redisç”¨äºç¼“å­˜è€ŒéMemcached
å†³ç­–æ—¥æœŸï¼š2025-10-30
ç†ç”±ï¼š
  - æ”¯æŒä¸°å¯Œæ•°æ®ç»“æ„ï¼ˆSetã€ZSetç”¨äºæ’è¡Œæ¦œï¼‰
  - å†…ç½®Luaè„šæœ¬æ”¯æŒå¤æ‚æ“ä½œï¼ˆåˆ†å¸ƒå¼é”ï¼‰
  - æŒä¹…åŒ–ï¼ˆRDBã€AOFï¼‰
  - ä¸»ä»å¤åˆ¶å’Œé›†ç¾¤æ”¯æŒ

---

ADR-003: Kubernetesè€ŒéDocker Swarm
å†³ç­–æ—¥æœŸï¼š2025-10-30
ç†ç”±ï¼š
  - ç”Ÿæ€å®Œå–„ï¼ˆIstioã€Prometheusé›†æˆï¼‰
  - è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œæ‰©å±•èƒ½åŠ›å¼º
  - ç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£å……åˆ†
  - äº‘å‚å•†æ”¯æŒï¼ˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ï¼‰
```

---

**æ–‡æ¡£å®Œæˆæ—¥æœŸ**ï¼š2025å¹´10æœˆ30æ—¥

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
1. âœ… æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£å®Œæˆ
2. â³ åç»­ï¼šè¯¦ç»†çš„APIå®ç°æŒ‡å—
3. â³ åç»­ï¼šå‰ç«¯ç»„ä»¶åº“è®¾è®¡
4. â³ åç»­ï¼šæ€§èƒ½æµ‹è¯•æ–¹æ¡ˆ
5. â³ åç»­ï¼šä¸Šçº¿å‘å¸ƒè®¡åˆ’

---

**å®¡æ‰¹**ï¼š
- [ ] äº§å“ç»ç†å®¡æŸ¥
- [ ] æ¶æ„å¸ˆå®¡æŸ¥
- [ ] æŠ€æœ¯è´Ÿè´£äººå®¡æŸ¥
- [ ] CTOæœ€ç»ˆæ‰¹å‡†

---

**END OF DOCUMENT**
