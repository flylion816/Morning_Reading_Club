# æ•°æ®åº“è®¾è®¡ v3.0

## æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**: v3.0
- **äº§å“ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-01-13
- **æ–‡æ¡£çŠ¶æ€**: å·²å‘å¸ƒ

## è¯´æ˜

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬MySQLå’ŒMongoDBä¸¤ç§æ–¹æ¡ˆã€‚åŸºäºã€Š02-æ•°æ®æ¨¡å‹è®¾è®¡v3.0.mdã€‹ï¼Œæä¾›å¯ç›´æ¥æ‰§è¡Œçš„å»ºè¡¨SQLå’ŒSchemaå®šä¹‰ã€‚

---

## ä¸€ã€æŠ€æœ¯é€‰å‹å»ºè®®

### 1.1 MySQLæ–¹æ¡ˆ

**é€‚ç”¨åœºæ™¯**:
- éœ€è¦å¼ºäº‹åŠ¡ä¿è¯
- æ•°æ®å…³ç³»å¤æ‚
- éœ€è¦å¤æ‚çš„JOINæŸ¥è¯¢
- å›¢é˜Ÿç†Ÿæ‚‰å…³ç³»å‹æ•°æ®åº“

**æ¨èç‰ˆæœ¬**: MySQL 8.0+

**ä¼˜ç‚¹**:
- ACIDäº‹åŠ¡ä¿è¯
- æˆç†Ÿçš„ç”Ÿæ€ç³»ç»Ÿ
- å¼ºå¤§çš„æŸ¥è¯¢ä¼˜åŒ–å™¨
- ä¸°å¯Œçš„å·¥å…·æ”¯æŒ

**ç¼ºç‚¹**:
- Schemaç›¸å¯¹å›ºå®š
- æ¨ªå‘æ‰©å±•è¾ƒå¤æ‚
- JSONå­—æ®µæ”¯æŒè¾ƒå¼±

### 1.2 MongoDBæ–¹æ¡ˆï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**:
- æ•°æ®ç»“æ„çµæ´»å¤šå˜
- éœ€è¦å­˜å‚¨åµŒå¥—æ–‡æ¡£
- éœ€è¦æ¨ªå‘æ‰©å±•
- å¿«é€Ÿè¿­ä»£å¼€å‘

**æ¨èç‰ˆæœ¬**: MongoDB 6.0+

**ä¼˜ç‚¹**:
- çµæ´»çš„æ–‡æ¡£æ¨¡å‹
- åŸç”ŸJSONæ”¯æŒ
- æ˜“äºæ¨ªå‘æ‰©å±•
- å¼€å‘æ•ˆç‡é«˜

**ç¼ºç‚¹**:
- å¼±äº‹åŠ¡ä¿è¯ï¼ˆ4.0+å·²æ”¯æŒï¼‰
- JOINæ€§èƒ½è¾ƒå·®
- éœ€è¦careful schemaè®¾è®¡

### 1.3 æœ¬æ–‡æ¡£æ–¹æ¡ˆ

æœ¬æ–‡æ¡£åŒæ—¶æä¾›MySQLå’ŒMongoDBä¸¤ç§æ–¹æ¡ˆï¼š
- **Section II**: MySQLå®Œæ•´å»ºè¡¨SQL
- **Section III**: MongoDB Mongoose Schemaå®šä¹‰

---

## äºŒã€MySQLæ•°æ®åº“è®¾è®¡

### 2.1 æ•°æ®åº“é…ç½®

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS morning_reading_camp
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

USE morning_reading_camp;

-- è®¾ç½®æ—¶åŒº
SET time_zone = '+08:00';
```

### 2.2 ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE `users` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `openid` VARCHAR(64) NOT NULL COMMENT 'å¾®ä¿¡OpenID',
  `unionid` VARCHAR(64) NULL DEFAULT NULL COMMENT 'å¾®ä¿¡UnionID',
  `nickname` VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·æ˜µç§°',
  `avatar` VARCHAR(10) NOT NULL DEFAULT 'ğŸ¦' COMMENT 'å¤´åƒemoji',
  `avatar_url` VARCHAR(500) NULL DEFAULT NULL COMMENT 'å¾®ä¿¡å¤´åƒURL',
  `signature` VARCHAR(200) NULL DEFAULT NULL COMMENT 'ä¸ªæ€§ç­¾å',
  `gender` ENUM('male', 'female', 'unknown') NOT NULL DEFAULT 'unknown' COMMENT 'æ€§åˆ«',
  `country` VARCHAR(50) NULL DEFAULT NULL COMMENT 'å›½å®¶',
  `province` VARCHAR(50) NULL DEFAULT NULL COMMENT 'çœä»½',
  `city` VARCHAR(50) NULL DEFAULT NULL COMMENT 'åŸå¸‚',
  `language` VARCHAR(20) NOT NULL DEFAULT 'zh_CN' COMMENT 'è¯­è¨€',
  `total_checkin_days` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç´¯è®¡æ‰“å¡å¤©æ•°',
  `current_streak` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å½“å‰è¿ç»­æ‰“å¡å¤©æ•°',
  `max_streak` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æœ€é•¿è¿ç»­æ‰“å¡å¤©æ•°',
  `total_completed_periods` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å®Œæˆçš„æœŸæ•°',
  `total_points` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æ€»ç§¯åˆ†',
  `level` TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT 'ç”¨æˆ·ç­‰çº§',
  `role` ENUM('user', 'admin', 'super_admin') NOT NULL DEFAULT 'user' COMMENT 'è§’è‰²',
  `status` ENUM('active', 'banned', 'deleted') NOT NULL DEFAULT 'active' COMMENT 'çŠ¶æ€',
  `last_login_at` DATETIME NULL DEFAULT NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_unionid` (`unionid`),
  KEY `idx_nickname` (`nickname`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';
```

### 2.3 æœŸæ¬¡è¡¨ (periods)

```sql
CREATE TABLE `periods` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'æœŸæ¬¡ID',
  `name` VARCHAR(50) NOT NULL COMMENT 'æœŸæ¬¡åç§°',
  `subtitle` VARCHAR(100) NULL DEFAULT NULL COMMENT 'å‰¯æ ‡é¢˜',
  `title` VARCHAR(100) NOT NULL COMMENT 'å®Œæ•´æ ‡é¢˜',
  `description` TEXT NULL DEFAULT NULL COMMENT 'æœŸæ¬¡ä»‹ç»',
  `icon` VARCHAR(10) NOT NULL DEFAULT 'ğŸ“š' COMMENT 'å›¾æ ‡emoji',
  `cover_color` VARCHAR(100) NULL DEFAULT NULL COMMENT 'å°é¢é¢œè‰²(CSSæ¸å˜)',
  `cover_emoji` VARCHAR(10) NOT NULL DEFAULT 'ğŸ“–' COMMENT 'å°é¢emoji',
  `start_date` DATE NOT NULL COMMENT 'å¼€å§‹æ—¥æœŸ',
  `end_date` DATE NOT NULL COMMENT 'ç»“æŸæ—¥æœŸ',
  `total_days` INT UNSIGNED NOT NULL DEFAULT 23 COMMENT 'æ€»å¤©æ•°',
  `price` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT 'ä»·æ ¼(å…ƒ)',
  `original_price` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT 'åŸä»·',
  `max_enrollment` INT UNSIGNED NULL DEFAULT NULL COMMENT 'æœ€å¤§æŠ¥åäººæ•°',
  `current_enrollment` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å½“å‰æŠ¥åäººæ•°',
  `status` ENUM('not_started', 'ongoing', 'completed') NOT NULL DEFAULT 'not_started' COMMENT 'çŠ¶æ€',
  `is_published` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦å‘å¸ƒ',
  `sort_order` INT NOT NULL DEFAULT 0 COMMENT 'æ’åºæƒé‡',
  `created_by` INT UNSIGNED NULL DEFAULT NULL COMMENT 'åˆ›å»ºäººID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_date_range` (`start_date`, `end_date`),
  KEY `idx_status` (`status`),
  KEY `idx_published_sort` (`is_published`, `sort_order`),
  KEY `idx_created_by` (`created_by`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æœŸæ¬¡è¡¨';
```

### 2.4 è¯¾èŠ‚è¡¨ (sections)

```sql
CREATE TABLE `sections` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'è¯¾èŠ‚ID',
  `period_id` INT UNSIGNED NOT NULL COMMENT 'æ‰€å±æœŸæ¬¡ID',
  `day` INT NOT NULL COMMENT 'ç¬¬å‡ å¤©(0=å¼€è¥è¯)',
  `title` VARCHAR(100) NOT NULL COMMENT 'è¯¾èŠ‚æ ‡é¢˜',
  `subtitle` VARCHAR(200) NULL DEFAULT NULL COMMENT 'å‰¯æ ‡é¢˜',
  `cover_color` VARCHAR(100) NULL DEFAULT NULL COMMENT 'å°é¢é¢œè‰²',
  `cover_emoji` VARCHAR(10) NOT NULL DEFAULT 'ğŸ“–' COMMENT 'å°é¢emoji',
  `start_time` DATETIME NOT NULL COMMENT 'æ‰“å¡å¼€å§‹æ—¶é—´',
  `end_time` DATETIME NOT NULL COMMENT 'æ‰“å¡ç»“æŸæ—¶é—´',
  `meditation` TEXT NULL DEFAULT NULL COMMENT 'é™ä¸€é™å†…å®¹',
  `question` TEXT NULL DEFAULT NULL COMMENT 'é—®ä¸€é—®å†…å®¹',
  `content` LONGTEXT NOT NULL COMMENT 'è¯»ä¸€è¯»å†…å®¹(å¯Œæ–‡æœ¬)',
  `reflection` TEXT NULL DEFAULT NULL COMMENT 'æƒ³ä¸€æƒ³å†…å®¹',
  `action` TEXT NULL DEFAULT NULL COMMENT 'è®°ä¸€è®°å†…å®¹',
  `sort_order` INT NOT NULL DEFAULT 0 COMMENT 'æ’åº',
  `is_published` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦å‘å¸ƒ',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_period_day` (`period_id`, `day`),
  KEY `idx_period_sort` (`period_id`, `sort_order`),
  KEY `idx_time_range` (`start_time`, `end_time`),
  CONSTRAINT `fk_sections_period` FOREIGN KEY (`period_id`) 
    REFERENCES `periods` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è¯¾èŠ‚è¡¨';
```

### 2.5 æ‰“å¡è¡¨ (checkins)

```sql
CREATE TABLE `checkins` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'æ‰“å¡ID',
  `user_id` INT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
  `period_id` INT UNSIGNED NOT NULL COMMENT 'æœŸæ¬¡ID',
  `section_id` INT UNSIGNED NOT NULL COMMENT 'è¯¾èŠ‚ID',
  `content` TEXT NOT NULL COMMENT 'æ‰“å¡å†…å®¹',
  `visibility` ENUM('all', 'admin_only') NOT NULL DEFAULT 'all' COMMENT 'å¯è§èŒƒå›´',
  `like_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
  `comment_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'è¯„è®ºæ•°',
  `status` ENUM('normal', 'deleted', 'hidden') NOT NULL DEFAULT 'normal' COMMENT 'çŠ¶æ€',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_section` (`user_id`, `section_id`),
  KEY `idx_period_created` (`period_id`, `created_at` DESC),
  KEY `idx_section_created` (`section_id`, `created_at` DESC),
  KEY `idx_user_created` (`user_id`, `created_at` DESC),
  CONSTRAINT `fk_checkins_user` FOREIGN KEY (`user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_checkins_period` FOREIGN KEY (`period_id`) 
    REFERENCES `periods` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_checkins_section` FOREIGN KEY (`section_id`) 
    REFERENCES `sections` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ‰“å¡è¡¨';
```

### 2.6 è¯„è®ºè¡¨ (comments)

```sql
CREATE TABLE `comments` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'è¯„è®ºID',
  `checkin_id` INT UNSIGNED NOT NULL COMMENT 'æ‰“å¡ID',
  `user_id` INT UNSIGNED NOT NULL COMMENT 'è¯„è®ºç”¨æˆ·ID',
  `content` TEXT NOT NULL COMMENT 'è¯„è®ºå†…å®¹',
  `like_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
  `reply_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å›å¤æ•°',
  `status` ENUM('normal', 'deleted') NOT NULL DEFAULT 'normal' COMMENT 'çŠ¶æ€',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_checkin_created` (`checkin_id`, `created_at` DESC),
  KEY `idx_user_created` (`user_id`, `created_at` DESC),
  CONSTRAINT `fk_comments_checkin` FOREIGN KEY (`checkin_id`) 
    REFERENCES `checkins` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_comments_user` FOREIGN KEY (`user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è¯„è®ºè¡¨';
```

### 2.7 å›å¤è¡¨ (replies)

```sql
CREATE TABLE `replies` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'å›å¤ID',
  `comment_id` INT UNSIGNED NOT NULL COMMENT 'è¯„è®ºID',
  `user_id` INT UNSIGNED NOT NULL COMMENT 'å›å¤ç”¨æˆ·ID',
  `to_user_id` INT UNSIGNED NULL DEFAULT NULL COMMENT 'è¢«å›å¤ç”¨æˆ·ID',
  `content` TEXT NOT NULL COMMENT 'å›å¤å†…å®¹',
  `like_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
  `status` ENUM('normal', 'deleted') NOT NULL DEFAULT 'normal' COMMENT 'çŠ¶æ€',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_comment_created` (`comment_id`, `created_at` ASC),
  KEY `idx_user_created` (`user_id`, `created_at` DESC),
  KEY `idx_to_user_created` (`to_user_id`, `created_at` DESC),
  CONSTRAINT `fk_replies_comment` FOREIGN KEY (`comment_id`) 
    REFERENCES `comments` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_replies_user` FOREIGN KEY (`user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_replies_to_user` FOREIGN KEY (`to_user_id`) 
    REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å›å¤è¡¨';
```

### 2.8 å°å‡¡çœ‹è§è¡¨ (insights)

```sql
CREATE TABLE `insights` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'å°å‡¡çœ‹è§ID',
  `user_id` INT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
  `checkin_id` INT UNSIGNED NOT NULL COMMENT 'æ‰“å¡ID',
  `section_id` INT UNSIGNED NOT NULL COMMENT 'è¯¾èŠ‚ID',
  `content` TEXT NOT NULL COMMENT 'AIç”Ÿæˆçš„å†…å®¹',
  `visibility` ENUM('private', 'friends', 'public') NOT NULL DEFAULT 'private' COMMENT 'å¯è§èŒƒå›´',
  `view_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æŸ¥çœ‹æ¬¡æ•°',
  `request_count` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç”³è¯·æŸ¥çœ‹æ¬¡æ•°',
  `ai_model` VARCHAR(50) NULL DEFAULT NULL COMMENT 'AIæ¨¡å‹ç‰ˆæœ¬',
  `generated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ç”Ÿæˆæ—¶é—´',
  `status` ENUM('normal', 'deleted') NOT NULL DEFAULT 'normal' COMMENT 'çŠ¶æ€',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_checkin` (`checkin_id`),
  KEY `idx_user_created` (`user_id`, `created_at` DESC),
  KEY `idx_section_created` (`section_id`, `created_at` DESC),
  CONSTRAINT `fk_insights_user` FOREIGN KEY (`user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_insights_checkin` FOREIGN KEY (`checkin_id`) 
    REFERENCES `checkins` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_insights_section` FOREIGN KEY (`section_id`) 
    REFERENCES `sections` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å°å‡¡çœ‹è§è¡¨';
```

### 2.9 æŸ¥çœ‹ç”³è¯·è¡¨ (insight_requests)

```sql
CREATE TABLE `insight_requests` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç”³è¯·ID',
  `insight_id` INT UNSIGNED NOT NULL COMMENT 'å°å‡¡çœ‹è§ID',
  `from_user_id` INT UNSIGNED NOT NULL COMMENT 'ç”³è¯·äººID',
  `to_user_id` INT UNSIGNED NOT NULL COMMENT 'è¢«ç”³è¯·äººID',
  `status` ENUM('pending', 'approved', 'rejected') NOT NULL DEFAULT 'pending' COMMENT 'ç”³è¯·çŠ¶æ€',
  `message` VARCHAR(200) NULL DEFAULT NULL COMMENT 'ç”³è¯·ç•™è¨€',
  `reply_message` VARCHAR(200) NULL DEFAULT NULL COMMENT 'å›å¤ç•™è¨€',
  `processed_at` DATETIME NULL DEFAULT NULL COMMENT 'å¤„ç†æ—¶é—´',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_insight_from_user` (`insight_id`, `from_user_id`),
  KEY `idx_to_user_status` (`to_user_id`, `status`, `created_at` DESC),
  KEY `idx_from_user_status` (`from_user_id`, `status`, `created_at` DESC),
  CONSTRAINT `fk_requests_insight` FOREIGN KEY (`insight_id`) 
    REFERENCES `insights` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_requests_from_user` FOREIGN KEY (`from_user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_requests_to_user` FOREIGN KEY (`to_user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æŸ¥çœ‹ç”³è¯·è¡¨';
```

### 2.10 æŠ¥åè®°å½•è¡¨ (enrollments)

```sql
CREATE TABLE `enrollments` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'æŠ¥åID',
  `user_id` INT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
  `period_id` INT UNSIGNED NOT NULL COMMENT 'æœŸæ¬¡ID',
  `status` ENUM('active', 'completed', 'cancelled') NOT NULL DEFAULT 'active' COMMENT 'çŠ¶æ€',
  `checkin_days` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æ‰“å¡å¤©æ•°',
  `total_days` INT UNSIGNED NOT NULL DEFAULT 23 COMMENT 'æ€»å¤©æ•°',
  `progress` INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å®Œæˆè¿›åº¦(ç™¾åˆ†æ¯”)',
  `last_checkin_at` DATETIME NULL DEFAULT NULL COMMENT 'æœ€åæ‰“å¡æ—¶é—´',
  `completed_at` DATETIME NULL DEFAULT NULL COMMENT 'å®Œæˆæ—¶é—´',
  `cancelled_at` DATETIME NULL DEFAULT NULL COMMENT 'å–æ¶ˆæ—¶é—´',
  `payment_status` ENUM('unpaid', 'paid', 'refunded') NOT NULL DEFAULT 'unpaid' COMMENT 'æ”¯ä»˜çŠ¶æ€',
  `payment_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT 'æ”¯ä»˜é‡‘é¢',
  `payment_at` DATETIME NULL DEFAULT NULL COMMENT 'æ”¯ä»˜æ—¶é—´',
  `order_no` VARCHAR(64) NULL DEFAULT NULL COMMENT 'è®¢å•å·',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_period` (`user_id`, `period_id`),
  KEY `idx_user_status` (`user_id`, `status`, `created_at` DESC),
  KEY `idx_period_status` (`period_id`, `status`, `created_at` DESC),
  KEY `idx_order_no` (`order_no`),
  CONSTRAINT `fk_enrollments_user` FOREIGN KEY (`user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_enrollments_period` FOREIGN KEY (`period_id`) 
    REFERENCES `periods` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æŠ¥åè®°å½•è¡¨';
```

### 2.11 æ–‡ä»¶è¡¨ (files)

```sql
CREATE TABLE `files` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'æ–‡ä»¶ID',
  `user_id` INT UNSIGNED NOT NULL COMMENT 'ä¸Šä¼ ç”¨æˆ·ID',
  `related_type` ENUM('checkin', 'comment', 'reply') NOT NULL COMMENT 'å…³è”ç±»å‹',
  `related_id` INT UNSIGNED NOT NULL COMMENT 'å…³è”ID',
  `file_type` ENUM('image', 'video', 'audio') NOT NULL COMMENT 'æ–‡ä»¶ç±»å‹',
  `original_name` VARCHAR(255) NOT NULL COMMENT 'åŸå§‹æ–‡ä»¶å',
  `file_name` VARCHAR(255) NOT NULL COMMENT 'å­˜å‚¨æ–‡ä»¶å',
  `file_url` VARCHAR(500) NOT NULL COMMENT 'æ–‡ä»¶URL',
  `file_size` INT UNSIGNED NOT NULL COMMENT 'æ–‡ä»¶å¤§å°(å­—èŠ‚)',
  `mime_type` VARCHAR(100) NOT NULL COMMENT 'MIMEç±»å‹',
  `width` INT UNSIGNED NULL DEFAULT NULL COMMENT 'å®½åº¦(å›¾ç‰‡/è§†é¢‘)',
  `height` INT UNSIGNED NULL DEFAULT NULL COMMENT 'é«˜åº¦(å›¾ç‰‡/è§†é¢‘)',
  `duration` INT UNSIGNED NULL DEFAULT NULL COMMENT 'æ—¶é•¿(è§†é¢‘/éŸ³é¢‘,ç§’)',
  `thumbnail_url` VARCHAR(500) NULL DEFAULT NULL COMMENT 'ç¼©ç•¥å›¾URL',
  `status` ENUM('normal', 'deleted') NOT NULL DEFAULT 'normal' COMMENT 'çŠ¶æ€',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_user_created` (`user_id`, `created_at` DESC),
  KEY `idx_related` (`related_type`, `related_id`),
  KEY `idx_file_type` (`file_type`, `created_at` DESC),
  CONSTRAINT `fk_files_user` FOREIGN KEY (`user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ–‡ä»¶è¡¨';
```

### 2.12 ç‚¹èµå…³ç³»è¡¨ (checkin_likes)

```sql
CREATE TABLE `checkin_likes` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç‚¹èµID',
  `user_id` INT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
  `checkin_id` INT UNSIGNED NOT NULL COMMENT 'æ‰“å¡ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_checkin` (`user_id`, `checkin_id`),
  KEY `idx_checkin` (`checkin_id`),
  CONSTRAINT `fk_checkin_likes_user` FOREIGN KEY (`user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_checkin_likes_checkin` FOREIGN KEY (`checkin_id`) 
    REFERENCES `checkins` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ‰“å¡ç‚¹èµè¡¨';
```

### 2.13 è¯„è®ºç‚¹èµè¡¨ (comment_likes)

```sql
CREATE TABLE `comment_likes` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç‚¹èµID',
  `user_id` INT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
  `comment_id` INT UNSIGNED NOT NULL COMMENT 'è¯„è®ºID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_comment` (`user_id`, `comment_id`),
  KEY `idx_comment` (`comment_id`),
  CONSTRAINT `fk_comment_likes_user` FOREIGN KEY (`user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_comment_likes_comment` FOREIGN KEY (`comment_id`) 
    REFERENCES `comments` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è¯„è®ºç‚¹èµè¡¨';
```

### 2.14 å›å¤ç‚¹èµè¡¨ (reply_likes)

```sql
CREATE TABLE `reply_likes` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç‚¹èµID',
  `user_id` INT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
  `reply_id` INT UNSIGNED NOT NULL COMMENT 'å›å¤ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_reply` (`user_id`, `reply_id`),
  KEY `idx_reply` (`reply_id`),
  CONSTRAINT `fk_reply_likes_user` FOREIGN KEY (`user_id`) 
    REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_reply_likes_reply` FOREIGN KEY (`reply_id`) 
    REFERENCES `replies` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å›å¤ç‚¹èµè¡¨';
```

---

## ä¸‰ã€MongoDBæ•°æ®åº“è®¾è®¡

### 3.1 Mongoose Schemaå®šä¹‰

#### 3.1.1 ç”¨æˆ·Schema (User)

```javascript
// models/User.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const UserSchema = new Schema({
  openid: {
    type: String,
    required: true,
    unique: true,
    maxlength: 64
  },
  unionid: {
    type: String,
    maxlength: 64,
    default: null
  },
  nickname: {
    type: String,
    required: true,
    maxlength: 50
  },
  avatar: {
    type: String,
    maxlength: 10,
    default: 'ğŸ¦'
  },
  avatarUrl: {
    type: String,
    maxlength: 500,
    default: null
  },
  signature: {
    type: String,
    maxlength: 200,
    default: null
  },
  gender: {
    type: String,
    enum: ['male', 'female', 'unknown'],
    default: 'unknown'
  },
  country: {
    type: String,
    maxlength: 50,
    default: null
  },
  province: {
    type: String,
    maxlength: 50,
    default: null
  },
  city: {
    type: String,
    maxlength: 50,
    default: null
  },
  language: {
    type: String,
    maxlength: 20,
    default: 'zh_CN'
  },
  totalCheckinDays: {
    type: Number,
    default: 0,
    min: 0
  },
  currentStreak: {
    type: Number,
    default: 0,
    min: 0
  },
  maxStreak: {
    type: Number,
    default: 0,
    min: 0
  },
  totalCompletedPeriods: {
    type: Number,
    default: 0,
    min: 0
  },
  totalPoints: {
    type: Number,
    default: 0,
    min: 0
  },
  level: {
    type: Number,
    default: 1,
    min: 1
  },
  role: {
    type: String,
    enum: ['user', 'admin', 'super_admin'],
    default: 'user'
  },
  status: {
    type: String,
    enum: ['active', 'banned', 'deleted'],
    default: 'active'
  },
  lastLoginAt: {
    type: Date,
    default: null
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
UserSchema.index({ openid: 1 }, { unique: true });
UserSchema.index({ unionid: 1 });
UserSchema.index({ nickname: 1 });
UserSchema.index({ createdAt: 1 });

// è™šæ‹Ÿå­—æ®µ
UserSchema.virtual('avatarText').get(function() {
  return this.avatar || this.nickname.charAt(0);
});

module.exports = mongoose.model('User', UserSchema);
```

#### 3.1.2 æœŸæ¬¡Schema (Period)

```javascript
// models/Period.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const PeriodSchema = new Schema({
  name: {
    type: String,
    required: true,
    maxlength: 50
  },
  subtitle: {
    type: String,
    maxlength: 100,
    default: null
  },
  title: {
    type: String,
    required: true,
    maxlength: 100
  },
  description: {
    type: String,
    default: null
  },
  icon: {
    type: String,
    maxlength: 10,
    default: 'ğŸ“š'
  },
  coverColor: {
    type: String,
    maxlength: 100,
    default: null
  },
  coverEmoji: {
    type: String,
    maxlength: 10,
    default: 'ğŸ“–'
  },
  startDate: {
    type: Date,
    required: true
  },
  endDate: {
    type: Date,
    required: true
  },
  totalDays: {
    type: Number,
    default: 23,
    min: 1
  },
  price: {
    type: Number,
    default: 0,
    min: 0
  },
  originalPrice: {
    type: Number,
    default: 0,
    min: 0
  },
  maxEnrollment: {
    type: Number,
    default: null,
    min: 0
  },
  currentEnrollment: {
    type: Number,
    default: 0,
    min: 0
  },
  status: {
    type: String,
    enum: ['not_started', 'ongoing', 'completed'],
    default: 'not_started'
  },
  isPublished: {
    type: Boolean,
    default: false
  },
  sortOrder: {
    type: Number,
    default: 0
  },
  createdBy: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    default: null
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
PeriodSchema.index({ startDate: 1, endDate: 1 });
PeriodSchema.index({ status: 1 });
PeriodSchema.index({ isPublished: 1, sortOrder: 1 });

// è™šæ‹Ÿå­—æ®µ
PeriodSchema.virtual('dateRange').get(function() {
  const start = this.startDate.toISOString().slice(5, 10).replace('-', '-');
  const end = this.endDate.toISOString().slice(5, 10).replace('-', '-');
  return `${start} è‡³ ${end}`;
});

module.exports = mongoose.model('Period', PeriodSchema);
```

#### 3.1.3 è¯¾èŠ‚Schema (Section)

```javascript
// models/Section.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const SectionSchema = new Schema({
  periodId: {
    type: Schema.Types.ObjectId,
    ref: 'Period',
    required: true
  },
  day: {
    type: Number,
    required: true,
    min: 0
  },
  title: {
    type: String,
    required: true,
    maxlength: 100
  },
  subtitle: {
    type: String,
    maxlength: 200,
    default: null
  },
  coverColor: {
    type: String,
    maxlength: 100,
    default: null
  },
  coverEmoji: {
    type: String,
    maxlength: 10,
    default: 'ğŸ“–'
  },
  startTime: {
    type: Date,
    required: true
  },
  endTime: {
    type: Date,
    required: true
  },
  meditation: {
    type: String,
    default: null
  },
  question: {
    type: String,
    default: null
  },
  content: {
    type: String,
    required: true
  },
  reflection: {
    type: String,
    default: null
  },
  action: {
    type: String,
    default: null
  },
  sortOrder: {
    type: Number,
    default: 0
  },
  isPublished: {
    type: Boolean,
    default: false
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
SectionSchema.index({ periodId: 1, day: 1 });
SectionSchema.index({ periodId: 1, sortOrder: 1 });
SectionSchema.index({ startTime: 1, endTime: 1 });

module.exports = mongoose.model('Section', SectionSchema);
```

#### 3.1.4 æ‰“å¡Schema (Checkin)

```javascript
// models/Checkin.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const CheckinSchema = new Schema({
  userId: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  periodId: {
    type: Schema.Types.ObjectId,
    ref: 'Period',
    required: true
  },
  sectionId: {
    type: Schema.Types.ObjectId,
    ref: 'Section',
    required: true
  },
  content: {
    type: String,
    required: true
  },
  images: [{
    type: String,
    maxlength: 500
  }],
  videos: [{
    type: String,
    maxlength: 500
  }],
  voices: [{
    type: String,
    maxlength: 500
  }],
  visibility: {
    type: String,
    enum: ['all', 'admin_only'],
    default: 'all'
  },
  likeCount: {
    type: Number,
    default: 0,
    min: 0
  },
  commentCount: {
    type: Number,
    default: 0,
    min: 0
  },
  status: {
    type: String,
    enum: ['normal', 'deleted', 'hidden'],
    default: 'normal'
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
CheckinSchema.index({ userId: 1, sectionId: 1 }, { unique: true });
CheckinSchema.index({ periodId: 1, createdAt: -1 });
CheckinSchema.index({ sectionId: 1, createdAt: -1 });
CheckinSchema.index({ userId: 1, createdAt: -1 });

module.exports = mongoose.model('Checkin', CheckinSchema);
```

#### 3.1.5 è¯„è®ºSchema (Comment)

```javascript
// models/Comment.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const CommentSchema = new Schema({
  checkinId: {
    type: Schema.Types.ObjectId,
    ref: 'Checkin',
    required: true
  },
  userId: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  content: {
    type: String,
    required: true
  },
  likeCount: {
    type: Number,
    default: 0,
    min: 0
  },
  replyCount: {
    type: Number,
    default: 0,
    min: 0
  },
  status: {
    type: String,
    enum: ['normal', 'deleted'],
    default: 'normal'
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
CommentSchema.index({ checkinId: 1, createdAt: -1 });
CommentSchema.index({ userId: 1, createdAt: -1 });

module.exports = mongoose.model('Comment', CommentSchema);
```

#### 3.1.6 å›å¤Schema (Reply)

```javascript
// models/Reply.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const ReplySchema = new Schema({
  commentId: {
    type: Schema.Types.ObjectId,
    ref: 'Comment',
    required: true
  },
  userId: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  toUserId: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    default: null
  },
  content: {
    type: String,
    required: true
  },
  likeCount: {
    type: Number,
    default: 0,
    min: 0
  },
  status: {
    type: String,
    enum: ['normal', 'deleted'],
    default: 'normal'
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
ReplySchema.index({ commentId: 1, createdAt: 1 });
ReplySchema.index({ userId: 1, createdAt: -1 });
ReplySchema.index({ toUserId: 1, createdAt: -1 });

module.exports = mongoose.model('Reply', ReplySchema);
```

#### 3.1.7 å°å‡¡çœ‹è§Schema (Insight)

```javascript
// models/Insight.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const InsightSchema = new Schema({
  userId: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  checkinId: {
    type: Schema.Types.ObjectId,
    ref: 'Checkin',
    required: true,
    unique: true
  },
  sectionId: {
    type: Schema.Types.ObjectId,
    ref: 'Section',
    required: true
  },
  content: {
    type: String,
    required: true
  },
  visibility: {
    type: String,
    enum: ['private', 'friends', 'public'],
    default: 'private'
  },
  viewCount: {
    type: Number,
    default: 0,
    min: 0
  },
  requestCount: {
    type: Number,
    default: 0,
    min: 0
  },
  aiModel: {
    type: String,
    maxlength: 50,
    default: null
  },
  generatedAt: {
    type: Date,
    default: Date.now
  },
  status: {
    type: String,
    enum: ['normal', 'deleted'],
    default: 'normal'
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
InsightSchema.index({ checkinId: 1 }, { unique: true });
InsightSchema.index({ userId: 1, createdAt: -1 });
InsightSchema.index({ sectionId: 1, createdAt: -1 });

// è™šæ‹Ÿå­—æ®µ
InsightSchema.virtual('preview').get(function() {
  return this.content.substring(0, 50) + (this.content.length > 50 ? '...' : '');
});

module.exports = mongoose.model('Insight', InsightSchema);
```

#### 3.1.8 æŸ¥çœ‹ç”³è¯·Schema (InsightRequest)

```javascript
// models/InsightRequest.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const InsightRequestSchema = new Schema({
  insightId: {
    type: Schema.Types.ObjectId,
    ref: 'Insight',
    required: true
  },
  fromUserId: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  toUserId: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  status: {
    type: String,
    enum: ['pending', 'approved', 'rejected'],
    default: 'pending'
  },
  message: {
    type: String,
    maxlength: 200,
    default: null
  },
  replyMessage: {
    type: String,
    maxlength: 200,
    default: null
  },
  processedAt: {
    type: Date,
    default: null
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
InsightRequestSchema.index({ insightId: 1, fromUserId: 1 }, { unique: true });
InsightRequestSchema.index({ toUserId: 1, status: 1, createdAt: -1 });
InsightRequestSchema.index({ fromUserId: 1, status: 1, createdAt: -1 });

module.exports = mongoose.model('InsightRequest', InsightRequestSchema);
```

#### 3.1.9 æŠ¥åè®°å½•Schema (Enrollment)

```javascript
// models/Enrollment.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const EnrollmentSchema = new Schema({
  userId: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  periodId: {
    type: Schema.Types.ObjectId,
    ref: 'Period',
    required: true
  },
  status: {
    type: String,
    enum: ['active', 'completed', 'cancelled'],
    default: 'active'
  },
  checkinDays: {
    type: Number,
    default: 0,
    min: 0
  },
  totalDays: {
    type: Number,
    default: 23,
    min: 1
  },
  progress: {
    type: Number,
    default: 0,
    min: 0,
    max: 100
  },
  lastCheckinAt: {
    type: Date,
    default: null
  },
  completedAt: {
    type: Date,
    default: null
  },
  cancelledAt: {
    type: Date,
    default: null
  },
  paymentStatus: {
    type: String,
    enum: ['unpaid', 'paid', 'refunded'],
    default: 'unpaid'
  },
  paymentAmount: {
    type: Number,
    default: 0,
    min: 0
  },
  paymentAt: {
    type: Date,
    default: null
  },
  orderNo: {
    type: String,
    maxlength: 64,
    default: null
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
EnrollmentSchema.index({ userId: 1, periodId: 1 }, { unique: true });
EnrollmentSchema.index({ userId: 1, status: 1, createdAt: -1 });
EnrollmentSchema.index({ periodId: 1, status: 1, createdAt: -1 });
EnrollmentSchema.index({ orderNo: 1 });

// è™šæ‹Ÿå­—æ®µ
EnrollmentSchema.virtual('isCompleted').get(function() {
  return this.progress >= 100;
});

module.exports = mongoose.model('Enrollment', EnrollmentSchema);
```

#### 3.1.10 æ–‡ä»¶Schema (File)

```javascript
// models/File.js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const FileSchema = new Schema({
  userId: {
    type: Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  relatedType: {
    type: String,
    enum: ['checkin', 'comment', 'reply'],
    required: true
  },
  relatedId: {
    type: Schema.Types.ObjectId,
    required: true
  },
  fileType: {
    type: String,
    enum: ['image', 'video', 'audio'],
    required: true
  },
  originalName: {
    type: String,
    required: true,
    maxlength: 255
  },
  fileName: {
    type: String,
    required: true,
    maxlength: 255
  },
  fileUrl: {
    type: String,
    required: true,
    maxlength: 500
  },
  fileSize: {
    type: Number,
    required: true,
    min: 0
  },
  mimeType: {
    type: String,
    required: true,
    maxlength: 100
  },
  width: {
    type: Number,
    default: null,
    min: 0
  },
  height: {
    type: Number,
    default: null,
    min: 0
  },
  duration: {
    type: Number,
    default: null,
    min: 0
  },
  thumbnailUrl: {
    type: String,
    maxlength: 500,
    default: null
  },
  status: {
    type: String,
    enum: ['normal', 'deleted'],
    default: 'normal'
  }
}, {
  timestamps: true,
  versionKey: false
});

// ç´¢å¼•
FileSchema.index({ userId: 1, createdAt: -1 });
FileSchema.index({ relatedType: 1, relatedId: 1 });
FileSchema.index({ fileType: 1, createdAt: -1 });

module.exports = mongoose.model('File', FileSchema);
```

---

## å››ã€æ•°æ®å­—å…¸

### 4.1 æšä¸¾å€¼å®šä¹‰

```javascript
// constants/enums.js

module.exports = {
  // æ€§åˆ«
  Gender: {
    MALE: 'male',
    FEMALE: 'female',
    UNKNOWN: 'unknown'
  },

  // ç”¨æˆ·è§’è‰²
  UserRole: {
    USER: 'user',
    ADMIN: 'admin',
    SUPER_ADMIN: 'super_admin'
  },

  // ç”¨æˆ·çŠ¶æ€
  UserStatus: {
    ACTIVE: 'active',
    BANNED: 'banned',
    DELETED: 'deleted'
  },

  // æœŸæ¬¡çŠ¶æ€
  PeriodStatus: {
    NOT_STARTED: 'not_started',
    ONGOING: 'ongoing',
    COMPLETED: 'completed'
  },

  // æ‰“å¡å¯è§æ€§
  CheckinVisibility: {
    ALL: 'all',
    ADMIN_ONLY: 'admin_only'
  },

  // æ‰“å¡çŠ¶æ€
  CheckinStatus: {
    NORMAL: 'normal',
    DELETED: 'deleted',
    HIDDEN: 'hidden'
  },

  // è¯„è®º/å›å¤çŠ¶æ€
  CommentStatus: {
    NORMAL: 'normal',
    DELETED: 'deleted'
  },

  // å°å‡¡çœ‹è§å¯è§æ€§
  InsightVisibility: {
    PRIVATE: 'private',
    FRIENDS: 'friends',
    PUBLIC: 'public'
  },

  // å°å‡¡çœ‹è§çŠ¶æ€
  InsightStatus: {
    NORMAL: 'normal',
    DELETED: 'deleted'
  },

  // ç”³è¯·çŠ¶æ€
  RequestStatus: {
    PENDING: 'pending',
    APPROVED: 'approved',
    REJECTED: 'rejected'
  },

  // æŠ¥åçŠ¶æ€
  EnrollmentStatus: {
    ACTIVE: 'active',
    COMPLETED: 'completed',
    CANCELLED: 'cancelled'
  },

  // æ”¯ä»˜çŠ¶æ€
  PaymentStatus: {
    UNPAID: 'unpaid',
    PAID: 'paid',
    REFUNDED: 'refunded'
  },

  // æ–‡ä»¶å…³è”ç±»å‹
  FileRelatedType: {
    CHECKIN: 'checkin',
    COMMENT: 'comment',
    REPLY: 'reply'
  },

  // æ–‡ä»¶ç±»å‹
  FileType: {
    IMAGE: 'image',
    VIDEO: 'video',
    AUDIO: 'audio'
  },

  // æ–‡ä»¶çŠ¶æ€
  FileStatus: {
    NORMAL: 'normal',
    DELETED: 'deleted'
  }
};
```

---

## äº”ã€åˆå§‹åŒ–æ•°æ®

### 5.1 MySQLåˆå§‹åŒ–è„šæœ¬

```sql
-- init_data.sql

-- æ’å…¥ç®¡ç†å‘˜è´¦å·
INSERT INTO `users` (
  `openid`, `nickname`, `avatar`, `role`, `status`, `created_at`, `updated_at`
) VALUES (
  'ADMIN_OPENID_12345', 'ç®¡ç†å‘˜', 'ğŸ‘¨â€ğŸ’¼', 'admin', 'active', NOW(), NOW()
);

-- æ’å…¥ç¤ºä¾‹æœŸæ¬¡(æ ¹æ®å®é™…éœ€æ±‚æ·»åŠ )
-- å‚è€ƒ miniprogram/mock/courses.js ä¸­çš„æ•°æ®

-- ç¤ºä¾‹ï¼šæ’å…¥ç¬¬8æœŸ
INSERT INTO `periods` (
  `id`, `name`, `subtitle`, `title`, `icon`, `cover_color`, `cover_emoji`,
  `start_date`, `end_date`, `total_days`, `status`, `is_published`, `sort_order`,
  `created_at`, `updated_at`
) VALUES (
  8, 'å‹‡æ•¢çš„å¿ƒ', 'ä¸ƒä¸ªä¹ æƒ¯æ™¨è¯»è¥', 'å‹‡æ•¢çš„å¿ƒ - ä¸ƒä¸ªä¹ æƒ¯æ™¨è¯»è¥', 
  'â›°ï¸', 'linear-gradient(135deg, #4a90e2 0%, #357abd 100%)', 'ğŸ”ï¸',
  '2025-10-11', '2025-11-13', 23, 'ongoing', 1, 100,
  NOW(), NOW()
);
```

### 5.2 MongoDBåˆå§‹åŒ–è„šæœ¬

```javascript
// scripts/initData.js
const mongoose = require('mongoose');
const User = require('../models/User');
const Period = require('../models/Period');

async function initData() {
  try {
    await mongoose.connect(process.env.MONGODB_URI);

    // åˆ›å»ºç®¡ç†å‘˜è´¦å·
    const admin = await User.create({
      openid: 'ADMIN_OPENID_12345',
      nickname: 'ç®¡ç†å‘˜',
      avatar: 'ğŸ‘¨â€ğŸ’¼',
      role: 'admin',
      status: 'active'
    });

    console.log('Admin created:', admin._id);

    // åˆ›å»ºç¤ºä¾‹æœŸæ¬¡
    const period = await Period.create({
      name: 'å‹‡æ•¢çš„å¿ƒ',
      subtitle: 'ä¸ƒä¸ªä¹ æƒ¯æ™¨è¯»è¥',
      title: 'å‹‡æ•¢çš„å¿ƒ - ä¸ƒä¸ªä¹ æƒ¯æ™¨è¯»è¥',
      icon: 'â›°ï¸',
      coverColor: 'linear-gradient(135deg, #4a90e2 0%, #357abd 100%)',
      coverEmoji: 'ğŸ”ï¸',
      startDate: new Date('2025-10-11'),
      endDate: new Date('2025-11-13'),
      totalDays: 23,
      status: 'ongoing',
      isPublished: true,
      sortOrder: 100,
      createdBy: admin._id
    });

    console.log('Period created:', period._id);

    console.log('Initialization completed!');
    process.exit(0);
  } catch (error) {
    console.error('Initialization error:', error);
    process.exit(1);
  }
}

initData();
```

---

## å…­ã€æ•°æ®åº“ç»´æŠ¤

### 6.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- å®šæœŸåˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯(MySQL)
ANALYZE TABLE users, periods, sections, checkins, comments;

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SHOW INDEX FROM checkins;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SHOW VARIABLES LIKE 'slow_query_log';
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;
```

```javascript
// MongoDBç´¢å¼•åˆ†æ
db.checkins.getIndexes();
db.checkins.stats();
db.checkins.explain("executionStats").find({ userId: ObjectId("...") });
```

### 6.2 æ•°æ®å¤‡ä»½

```bash
# MySQLå¤‡ä»½
mysqldump -u root -p morning_reading_camp > backup_$(date +%Y%m%d).sql

# MySQLæ¢å¤
mysql -u root -p morning_reading_camp < backup_20250113.sql

# MongoDBå¤‡ä»½
mongodump --uri="mongodb://localhost:27017/morning_reading_camp" --out=/backup/$(date +%Y%m%d)

# MongoDBæ¢å¤
mongorestore --uri="mongodb://localhost:27017/morning_reading_camp" /backup/20250113
```

### 6.3 æ•°æ®æ¸…ç†

```sql
-- æ¸…ç†è¶…è¿‡6ä¸ªæœˆçš„å·²åˆ é™¤æ•°æ®(MySQL)
DELETE FROM users WHERE status = 'deleted' AND updated_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);
DELETE FROM checkins WHERE status = 'deleted' AND updated_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);
```

```javascript
// MongoDBæ•°æ®æ¸…ç†
db.users.deleteMany({ 
  status: 'deleted', 
  updatedAt: { $lt: new Date(Date.now() - 180 * 24 * 60 * 60 * 1000) }
});
```

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.1 æŸ¥è¯¢ä¼˜åŒ–

1. **ä½¿ç”¨è¦†ç›–ç´¢å¼•**: æŸ¥è¯¢å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­
2. **é¿å…SELECT ***: åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
3. **ä½¿ç”¨LIMIT**: é™åˆ¶è¿”å›ç»“æœæ•°é‡
4. **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨æ‰¹é‡æ’å…¥/æ›´æ–°
5. **åˆç†ä½¿ç”¨JOIN**: é¿å…è¿‡å¤šJOINï¼Œè€ƒè™‘åèŒƒå¼åŒ–

### 7.2 ç¼“å­˜ç­–ç•¥

```javascript
// Redisç¼“å­˜ç¤ºä¾‹
const redis = require('redis');
const client = redis.createClient();

// ç¼“å­˜æœŸæ¬¡åˆ—è¡¨(15åˆ†é’Ÿ)
async function getPeriodsWithCache() {
  const cacheKey = 'periods:list';
  const cached = await client.get(cacheKey);
  
  if (cached) {
    return JSON.parse(cached);
  }
  
  const periods = await Period.find({ isPublished: true }).sort({ sortOrder: 1 });
  await client.setEx(cacheKey, 900, JSON.stringify(periods));
  
  return periods;
}

// ç¼“å­˜ç”¨æˆ·ä¿¡æ¯(5åˆ†é’Ÿ)
async function getUserWithCache(userId) {
  const cacheKey = `user:${userId}`;
  const cached = await client.get(cacheKey);
  
  if (cached) {
    return JSON.parse(cached);
  }
  
  const user = await User.findById(userId);
  await client.setEx(cacheKey, 300, JSON.stringify(user));
  
  return user;
}
```

### 7.3 åˆ†é¡µæŸ¥è¯¢

```javascript
// åŸºäºæ¸¸æ ‡çš„åˆ†é¡µ(æ¨è)
async function getCheckinsCursor(lastId, limit = 20) {
  const query = lastId ? { _id: { $lt: lastId } } : {};
  const checkins = await Checkin.find(query)
    .sort({ _id: -1 })
    .limit(limit)
    .populate('userId', 'nickname avatar')
    .lean();
  
  return checkins;
}

// åŸºäºé¡µç çš„åˆ†é¡µ
async function getCheckins Page(page = 1, pageSize = 20) {
  const skip = (page - 1) * pageSize;
  const [checkins, total] = await Promise.all([
    Checkin.find()
      .sort({ createdAt: -1 })
      .skip(skip)
      .limit(pageSize)
      .populate('userId', 'nickname avatar')
      .lean(),
    Checkin.countDocuments()
  ]);
  
  return {
    items: checkins,
    pagination: {
      page,
      pageSize,
      total,
      totalPages: Math.ceil(total / pageSize)
    }
  };
}
```

---

## å…«ã€æ•°æ®å®‰å…¨

### 8.1 SQLæ³¨å…¥é˜²æŠ¤(MySQL)

```javascript
// ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
const mysql = require('mysql2/promise');

// âŒ ä¸å®‰å…¨
const query = `SELECT * FROM users WHERE openid = '${openid}'`;

// âœ… å®‰å…¨
const [rows] = await connection.execute(
  'SELECT * FROM users WHERE openid = ?',
  [openid]
);
```

### 8.2 NoSQLæ³¨å…¥é˜²æŠ¤(MongoDB)

```javascript
// âŒ ä¸å®‰å…¨
const user = await User.findOne({ openid: req.body.openid });

// âœ… å®‰å…¨
const { openid } = req.body;
if (typeof openid !== 'string') {
  throw new Error('Invalid openid');
}
const user = await User.findOne({ openid });
```

### 8.3 æ•æ„Ÿæ•°æ®åŠ å¯†

```javascript
const crypto = require('crypto');

// åŠ å¯†OpenID(å¦‚æœéœ€è¦)
function encryptOpenId(openid) {
  const cipher = crypto.createCipheriv(
    'aes-256-cbc',
    Buffer.from(process.env.ENCRYPTION_KEY, 'hex'),
    Buffer.from(process.env.ENCRYPTION_IV, 'hex')
  );
  
  let encrypted = cipher.update(openid, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  return encrypted;
}

// è§£å¯†OpenID
function decryptOpenId(encrypted) {
  const decipher = crypto.createDecipheriv(
    'aes-256-cbc',
    Buffer.from(process.env.ENCRYPTION_KEY, 'hex'),
    Buffer.from(process.env.ENCRYPTION_IV, 'hex')
  );
  
  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  
  return decrypted;
}
```

---

## é™„å½•Aï¼šå®Œæ•´å»ºåº“è„šæœ¬

è§æ–‡æ¡£å¼€å¤´çš„MySQLå»ºè¡¨SQLç« èŠ‚(Section II)ã€‚

## é™„å½•Bï¼šMongooseè¿æ¥é…ç½®

```javascript
// config/database.js
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    const options = {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      maxPoolSize: 10,
      minPoolSize: 2,
      socketTimeoutMS: 45000,
      serverSelectionTimeoutMS: 5000,
      family: 4
    };

    await mongoose.connect(process.env.MONGODB_URI, options);

    console.log('MongoDB connected successfully');

    // è¿æ¥é”™è¯¯å¤„ç†
    mongoose.connection.on('error', (err) => {
      console.error('MongoDB connection error:', err);
    });

    // æ–­å¼€è¿æ¥å¤„ç†
    mongoose.connection.on('disconnected', () => {
      console.warn('MongoDB disconnected');
    });

    // è¿›ç¨‹é€€å‡ºæ—¶å…³é—­è¿æ¥
    process.on('SIGINT', async () => {
      await mongoose.connection.close();
      console.log('MongoDB connection closed through app termination');
      process.exit(0);
    });

  } catch (error) {
    console.error('MongoDB connection failed:', error);
    process.exit(1);
  }
};

module.exports = connectDB;
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0  
**æœ€åæ›´æ–°**: 2025-01-13  
**æ–‡æ¡£çŠ¶æ€**: å·²å®Œæˆ
