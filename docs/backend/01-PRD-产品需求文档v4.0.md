# 七个习惯晨读营 - 产品需求文档 v4.0

## 文档信息

| 项目     | 内容                           |
| -------- | ------------------------------ |
| 文档版本 | v4.0                           |
| 创建日期 | 2026-02-27                     |
| 作者     | Backend Team + Claude Code     |
| 项目名称 | 七个习惯晨读营小程序           |
| 前端版本 | v1.0 (18个页面)                |
| 后端版本 | v1.0 (RESTful API + WebSocket) |
| 管理后台 | v1.0 (Vue 3 + Element Plus)    |
| 文档状态 | 已实现 ✅                      |

## 一、产品概述

### 1.1 产品定位

七个习惯晨读营是基于《高效能人士的七个习惯》书籍的晨读打卡小程序，旨在帮助用户通过21-23天的持续晨读和打卡，养成阅读习惯，理解并实践七个习惯的核心理念。

### 1.2 核心价值

- **习惯养成**：通过每日打卡机制，帮助用户养成晨读习惯
- **深度学习**：提供系统化的五步学习法（入静、带问题学习、阅读、反思、行动）
- **AI反馈**：通过"小凡看见"功能，为用户提供个性化的AI反馈和鼓励
- **社群互动**：支持打卡分享、评论互动、排行榜等社交功能
- **进度追踪**：可视化展示学习进度和连续打卡天数

### 1.3 用户角色

| 角色       | 描述                 | 权限                             |
| ---------- | -------------------- | -------------------------------- |
| 未登录用户 | 未进行微信授权的访客 | 只能浏览首页期次列表             |
| 普通用户   | 已登录但未报名的用户 | 可浏览所有公开内容，不能参与打卡 |
| 学员       | 已报名某期课程的用户 | 可打卡、查看课程内容、参与互动   |
| 管理员     | 课程运营管理人员     | 可查看所有用户数据、管理课程内容 |

### 1.4 产品架构（v4.0 更新）

```
七个习惯晨读营小程序（完整体系）
├── 用户与认证模块 ✅ 已实现
│   ├── 微信一键登录（生产）
│   ├── 测试账号快捷登录（开发）
│   ├── 隐私政策与用户协议
│   └── JWT token 自动刷新（AccessToken 2小时 / RefreshToken 30天）
├── 课程模块 ✅ 已实现
│   ├── 期次管理
│   ├── 课节管理
│   ├── 课程内容展示
│   └── 五步学习法
├── 打卡模块 ✅ 已实现
│   ├── 创建打卡
│   ├── 打卡记录
│   ├── 连续打卡统计
│   └── 打卡日历
├── 报名与支付模块 ✅ 已实现
│   ├── 报名流程（可取消）
│   ├── 微信支付（Mock）
│   ├── 支付记录
│   └── 费用: 99元/期
├── 小凡看见模块 ✅ 已实现
│   ├── AI反馈生成（Mock 模板）
│   ├── 查看权限管理
│   ├── 申请/授权流程
│   └── 反馈列表展示
├── 通知模块 ✅ 已实现
│   ├── WebSocket 实时通知
│   ├── 通知列表
│   ├── 通知已读/归档
│   └── 支持批量删除
├── 社交互动模块 ✅ 已实现
│   ├── 评论系统
│   ├── 点赞功能
│   ├── 排行榜
│   └── 成员列表
└── 分享模块 ✅ 已实现
    ├── 小凡看见分享
    ├── 课程分享
    └── 个人成就分享
```

## 二、功能需求详述

### 2.1 首页（期次列表）

**页面路径**: `/pages/index/index`

#### 2.1.1 页面结构

- 顶部Banner：显示欢迎语和Slogan
- 用户信息卡片：已登录时显示头像、昵称
- 期次列表：展示所有可用的晨读营期次

#### 2.1.2 功能需求

**F-001: 期次列表展示**

| 字段     | 说明                                                     |
| -------- | -------------------------------------------------------- |
| 需求描述 | 展示所有晨读营期次，包括进行中、未报名、已结束的期次     |
| 显示内容 | 期次名称、图标、日期范围、状态、进度                     |
| 排序规则 | 按开始时间倒序（最新的在前）                             |
| 状态标识 | ongoing(进行中)、not_enrolled(未报名)、completed(已结束) |

### 2.2 登录页（新增 v4.0）✅ 已实现

**页面路径**: `/pages/login/login`

#### 2.2.1 页面结构

- 欢迎标题：晨读营 - 在晨光中，遇见更好的自己
- 微信一键登录按钮
- 测试账号快捷登录（仅开发环境）
- 隐私政策与用户协议链接

#### 2.2.2 功能需求

**F-031: 微信登录** ✅ 已实现

| 步骤 | 说明                                    |
| ---- | --------------------------------------- |
| 触发 | 点击"微信一键登录"按钮                  |
| 授权 | 调用wx.getUserProfile获取用户信息       |
| 登录 | 调用登录接口（Mock模式或生产模式）      |
| 保存 | 保存token和用户信息到本地存储和全局变量 |
| 刷新 | 更新页面状态，加载用户数据              |

**F-032: 测试账号登录** ✅ 已实现（仅开发环境）

| 账号       | 密码    | 用途    |
| ---------- | ------- | ------- |
| admin1     | test123 | 管理员1 |
| test_user1 | test123 | 测试1   |
| test_user2 | test123 | 测试2   |
| test_user3 | test123 | 测试3   |

### 2.3 课程列表页（课节列表）

**页面路径**: `/pages/courses/courses`

_此页面内容同 v3.0，已实现_ ✅

### 2.4 课程详情页

**页面路径**: `/pages/course-detail/course-detail`

_此页面内容同 v3.0，已实现_ ✅

### 2.5 打卡页面

**页面路径**: `/pages/checkin/checkin`

_此页面内容同 v3.0，已实现_ ✅

### 2.6 个人中心页面

**页面路径**: `/pages/profile/profile`

**关键改进 v4.0**：

- ✅ onLoad：未登录时 wx.reLaunch 跳转到 /pages/login/login
- ✅ onShow：优先检查 localStorage token，token 存在则恢复 globalData 而不跳转（防止频繁跳转）
- ✅ app.js onShow：每次 App 显示时重新调用 checkLoginStatus() 同步状态

_其他功能同 v3.0，已实现_ ✅

### 2.7 小凡看见列表页

**页面路径**: `/pages/insights/insights`

_此页面内容同 v3.0，已实现_ ✅

### 2.8 小凡看见详情页

**页面路径**: `/pages/insight-detail/insight-detail`

_此页面内容同 v3.0，已实现_ ✅

### 2.9 分享页面

**页面路径**: `/pages/share/share`

_此页面内容同 v3.0，已实现_ ✅

### 2.10 排行榜页面

**页面路径**: `/pages/ranking/ranking`

_此页面内容同 v3.0，已实现_ ✅

### 2.11 成员列表页

**页面路径**: `/pages/members/members`

_此页面内容同 v3.0，已实现_ ✅

### 2.12 打卡记录页

**页面路径**: `/pages/checkin-records/checkin-records`

_此页面内容同 v3.0，已实现_ ✅

### 2.13 他人主页

**页面路径**: `/pages/profile-others/profile-others`

_此页面内容同 v3.0，已实现_ ✅

### 2.14 报名页面（新增 v4.0）✅ 已实现

**页面路径**: `/pages/enrollment/enrollment`

#### 2.14.1 页面结构

- 期次信息卡片：展示期次名称、日期、费用
- 报名表单：确认报名信息
- 支付按钮：进行支付
- 已报名提示：如果已报名则显示已报名状态

#### 2.14.2 功能需求

**F-033: 报名页面展示** ✅ 已实现

| 功能     | 说明                       |
| -------- | -------------------------- |
| 期次信息 | 展示期次名称、日期、费用   |
| 报名表单 | 显示用户信息和报名确认按钮 |
| 支付入口 | 跳转到支付页面             |

### 2.15 支付页面（新增 v4.0）✅ 已实现

**页面路径**: `/pages/payment/payment`

#### 2.15.1 页面结构

- 订单信息：期次名称、费用
- 支付方式选择：微信支付
- 支付按钮
- 支付记录列表

#### 2.15.2 功能需求

**F-034: 支付流程** ✅ 已实现（Mock）

| 步骤         | 说明                        |
| ------------ | --------------------------- |
| 创建支付单   | 调用 /payments/create API   |
| 调用微信支付 | Mock 支付流程（非真实支付） |
| 支付成功     | 后端创建 enrollment 记录    |
| 页面跳转     | 返回首页并刷新期次状态      |

### 2.16 通知页面（新增 v4.0）✅ 已实现

**页面路径**: `/pages/notifications/notifications`

#### 2.16.1 页面结构

- 通知列表：展示所有通知
- 通知操作：标记已读、归档、删除

#### 2.16.2 功能需求

**F-035: WebSocket 实时通知** ✅ 已实现

| 功能     | 说明                                       |
| -------- | ------------------------------------------ |
| 连接建立 | 用户登录后自动建立 WebSocket 连接          |
| 通知推送 | 打卡回复、小凡看见生成、权限申请等实时推送 |
| 红点提醒 | tabBar 通知图标显示未读数                  |

**F-036: 通知管理** ✅ 已实现

| 功能     | 说明             |
| -------- | ---------------- |
| 已读标记 | 点击标记为已读   |
| 批量归档 | 支持批量归档操作 |
| 批量删除 | 支持批量删除操作 |
| 通知列表 | 显示所有历史通知 |

### 2.17 隐私政策页面（新增 v4.0）✅ 已实现

**页面路径**: `/pages/privacy-policy/privacy-policy`

| 内容 | 说明                       |
| ---- | -------------------------- |
| 标题 | 隐私政策                   |
| 内容 | 详细的数据收集和使用说明   |
| 同意 | 用户同意按钮（登录前展示） |

### 2.18 用户协议页面（新增 v4.0）✅ 已实现

**页面路径**: `/pages/user-agreement/user-agreement`

| 内容 | 说明                       |
| ---- | -------------------------- |
| 标题 | 用户协议                   |
| 内容 | 详细的服务条款和使用规则   |
| 同意 | 用户同意按钮（登录前展示） |

## 三、业务规则（v4.0 更新）

### 3.1 用户认证规则（更新）

| 规则编号 | 规则描述                                                                       |
| -------- | ------------------------------------------------------------------------------ |
| BR-001   | 用户必须通过微信授权才能登录                                                   |
| BR-002   | **AccessToken 有效期 2小时 / RefreshToken 有效期 30天** ✅ 更正                |
| BR-003   | request.js 自动拦截 401，使用 refreshToken 换新 token                          |
| BR-004   | 未登录用户只能浏览首页和公开内容                                               |
| BR-037   | **开发环境支持4个测试账号快捷登录（无需微信授权）** ✅ 新增                    |
| BR-038   | **profile.js 每次显示时检查 localStorage token，token 有效则恢复状态** ✅ 新增 |

### 3.2 课程报名规则（更新）

| 规则编号 | 规则描述                                       |
| -------- | ---------------------------------------------- |
| BR-005   | 用户必须先报名才能参与该期课程                 |
| BR-006   | 已报名的期次才能进行打卡                       |
| BR-007   | 每个用户可以同时报名多个期次                   |
| BR-008   | **支持通过 API 取消报名** ✅ 更正              |
| BR-033   | **报名费用 99元/期（Mock 微信支付）** ✅ 新增  |
| BR-034   | **支付成功后自动创建 enrollment 记录** ✅ 新增 |

### 3.3 打卡规则

| 规则编号 | 规则描述                                  |
| -------- | ----------------------------------------- |
| BR-009   | 每个课节只能打卡一次                      |
| BR-010   | 打卡时间范围：课节startTime到endTime      |
| BR-011   | 超过endTime后不能打卡，只能补卡（需审核） |
| BR-012   | 打卡内容不能为空                          |
| BR-013   | 图片最多9张，视频最多9个                  |
| BR-014   | 打卡成功后自动生成小凡看见（AI反馈）      |

### 3.4 小凡看见规则

| 规则编号 | 规则描述                           |
| -------- | ---------------------------------- |
| BR-015   | 小凡看见默认仅本人可见             |
| BR-016   | 用户可以设置某条小凡看见为公开     |
| BR-017   | 查看他人的小凡看见需要申请权限     |
| BR-018   | 权限申请需要被申请人同意后才能查看 |
| BR-019   | 一次权限申请只对一条小凡看见有效   |

### 3.5 评论互动规则

| 规则编号 | 规则描述                     |
| -------- | ---------------------------- |
| BR-020   | 只有已登录用户才能评论和点赞 |
| BR-021   | 评论内容不能为空             |
| BR-022   | 支持二级回复（评论的回复）   |
| BR-023   | 点赞可以取消                 |
| BR-024   | 用户可以删除自己的评论       |

### 3.6 排行榜规则

| 规则编号 | 规则描述                         |
| -------- | -------------------------------- |
| BR-025   | 排行榜按打卡次数降序排列         |
| BR-026   | 打卡次数相同时按最新打卡时间排序 |
| BR-027   | 支持多个时间维度的排行榜         |
| BR-028   | 当前用户在列表中高亮显示         |

### 3.7 数据可见性规则

| 规则编号 | 规则描述                                         |
| -------- | ------------------------------------------------ |
| BR-029   | 打卡可见范围：all(全员可见)、admin(仅管理员可见) |
| BR-030   | 设置为admin的打卡不在课程详情页显示              |
| BR-031   | 公开的小凡看见显示在广场                         |
| BR-032   | 私密的小凡看见只在个人中心显示                   |

### 3.8 通知规则（新增 v4.0）

| 规则编号 | 规则描述                               |
| -------- | -------------------------------------- |
| BR-035   | **WebSocket 实时推送通知** ✅ 新增     |
| BR-036   | **通知支持已读/归档/批量删除** ✅ 新增 |

## 四、数据流转

### 4.1 用户登录流程

```
1. 用户点击登录按钮
   ↓
2. 调用 wx.getUserProfile 获取用户信息
   ↓
3. 调用 wx.login 获取 code
   ↓
4. 将 code 和 userInfo 发送到后端 /auth/login
   ↓
5. 后端验证 code，生成 access_token 和 refresh_token
   ↓
6. 前端保存 token 到本地存储和全局变量
   ↓
7. 更新页面状态，加载用户数据
```

### 4.2 打卡流程

```
1. 用户在课程详情页点击"打卡"按钮
   ↓
2. 跳转到打卡页面，加载课程内容
   ↓
3. 用户输入打卡内容，选择可见范围，上传附件
   ↓
4. 点击提交，验证内容是否为空
   ↓
5. 调用 /checkins 接口提交打卡数据
   ↓
6. 后端创建打卡记录，触发AI生成小凡看见
   ↓
7. 前端保存打卡记录到本地存储（用于离线展示）
   ↓
8. 显示打卡成功提示，返回上一页
   ↓
9. 课程详情页刷新，显示新的打卡记录
```

### 4.3 小凡看见生成流程

```
1. 用户提交打卡
   ↓
2. 后端接收打卡数据
   ↓
3. 触发AI生成流程（异步）
   ↓
4. AI分析打卡内容，生成个性化反馈（当前使用Mock模板）
   ↓
5. 保存小凡看见记录到数据库
   ↓
6. 用户在个人中心查看小凡看见
```

### 4.4 权限申请流程

```
1. 用户A在他人主页看到用户B的小凡看见（标记为私密）
   ↓
2. 用户A点击"申请查看"按钮
   ↓
3. 弹出申请对话框，输入申请理由
   ↓
4. 调用 /insights/{id}/request 接口提交申请
   ↓
5. 后端创建权限申请记录
   ↓
6. 用户B在个人中心收到权限申请通知
   ↓
7. 用户B点击"同意"或"拒绝"
   ↓
8. 调用 /insights/requests/{id}/approve 或 reject 接口
   ↓
9. 更新申请状态
   ↓
10. 如果同意，用户A可以查看该条小凡看见
```

### 4.5 评论互动流程

```
1. 用户在课程详情页看到打卡记录
   ↓
2. 点击"回复"按钮
   ↓
3. 输入评论内容
   ↓
4. 调用 /comments 接口提交评论
   ↓
5. 后端创建评论记录
   ↓
6. 前端更新评论列表
   ↓
7. 其他用户可以看到新评论
   ↓
8. 其他用户可以点赞或回复该评论
```

### 4.6 报名与支付流程（新增 v4.0）✅ 已实现

```
1. 用户点击期次卡片中的"报名"按钮
   ↓
2. 跳转到报名页，展示期次信息和费用（99元）
   ↓
3. 用户点击确认支付
   ↓
4. 跳转到支付页面
   ↓
5. 调用 /payments/create 创建支付单
   ↓
6. 调用 Mock 微信支付（真实支付待接入）
   ↓
7. 支付成功后后端创建 enrollment 记录
   ↓
8. 跳转回首页，期次状态更新为"已报名"
   ↓
9. 用户可以开始参与课程打卡
```

### 4.7 WebSocket 通知流程（新增 v4.0）✅ 已实现

```
1. 用户登录后建立 WebSocket 连接
   ↓
2. 其他用户对我的打卡评论/点赞
   ↓
3. 后端通过 WebSocket 推送通知
   ↓
4. 前端显示红点提醒（tabBar 图标）
   ↓
5. 用户进入通知页查看详情
   ↓
6. 标记已读或归档
   ↓
7. 支持批量删除
```

## 五、系统架构（v4.0 更新）

### 5.1 技术栈

| 组件           | 技术                 | 说明                                                  |
| -------------- | -------------------- | ----------------------------------------------------- |
| **小程序前端** | 微信小程序原生       | 18个页面，无第三方框架                                |
| **管理后台**   | Vue 3 + Element Plus | 数据库管理、内容运营、用户管理                        |
| **后端 API**   | Node.js + Express    | RESTful API + WebSocket                               |
| **主数据库**   | MongoDB              | 所有业务数据（users, periods, checkins, insights 等） |
| **备份数据库** | MySQL                | 通过 Redis 异步双写保证数据备份                       |
| **缓存/队列**  | Redis                | 同步队列（51+个操作的异步事件）、会话缓存             |
| **AI 反馈**    | Mock 模板            | 当前使用预设模板，待接入真实 AI（OpenAI / Claude）    |
| **实时通知**   | WebSocket            | 打卡评论、小凡看见生成等实时推送                      |

### 5.2 系统模块

#### 前端模块（小程序 18 个页面）✅ 已实现

| 页面         | 路径                                   | 状态                   |
| ------------ | -------------------------------------- | ---------------------- |
| 首页         | /pages/index/index                     | ✅ 已实现              |
| 登录页       | /pages/login/login                     | ✅ 已实现              |
| 课程列表     | /pages/courses/courses                 | ✅ 已实现              |
| 课程详情     | /pages/course-detail/course-detail     | ✅ 已实现              |
| 打卡页面     | /pages/checkin/checkin                 | ✅ 已实现              |
| 个人中心     | /pages/profile/profile                 | ✅ 已实现（v4.0 增强） |
| 小凡看见列表 | /pages/insights/insights               | ✅ 已实现              |
| 小凡看见详情 | /pages/insight-detail/insight-detail   | ✅ 已实现              |
| 分享页面     | /pages/share/share                     | ✅ 已实现              |
| 排行榜       | /pages/ranking/ranking                 | ✅ 已实现              |
| 成员列表     | /pages/members/members                 | ✅ 已实现              |
| 打卡记录     | /pages/checkin-records/checkin-records | ✅ 已实现              |
| 他人主页     | /pages/profile-others/profile-others   | ✅ 已实现              |
| 报名页面     | /pages/enrollment/enrollment           | ✅ 已实现（v4.0 新增） |
| 支付页面     | /pages/payment/payment                 | ✅ 已实现（v4.0 新增） |
| 通知页面     | /pages/notifications/notifications     | ✅ 已实现（v4.0 新增） |
| 隐私政策     | /pages/privacy-policy/privacy-policy   | ✅ 已实现（v4.0 新增） |
| 用户协议     | /pages/user-agreement/user-agreement   | ✅ 已实现（v4.0 新增） |

#### 后端模块（Node.js）✅ 已实现

| 模块             | 功能                             | 状态              |
| ---------------- | -------------------------------- | ----------------- |
| Auth API         | 登录、授权、token 管理           | ✅ 已实现         |
| User API         | 用户信息、个人资料、统计数据     | ✅ 已实现         |
| Period API       | 期次列表、期次详情               | ✅ 已实现         |
| Section API      | 课节列表、课节详情               | ✅ 已实现         |
| Checkin API      | 打卡创建、打卡列表、打卡统计     | ✅ 已实现         |
| Insight API      | 小凡看见生成、权限管理、列表展示 | ✅ 已实现         |
| Comment API      | 评论创建、回复、点赞             | ✅ 已实现         |
| Enrollment API   | 报名、取消报名、状态查询         | ✅ 已实现         |
| Payment API      | 支付单创建、支付状态管理         | ✅ 已实现（Mock） |
| Notification API | 通知推送、列表查询、状态管理     | ✅ 已实现         |
| Ranking API      | 排行榜计算、多维度排名           | ✅ 已实现         |
| WebSocket        | 实时通知、连接管理               | ✅ 已实现         |

#### 管理后台模块（Vue 3）✅ 已实现

| 功能         | 说明                     | 状态      |
| ------------ | ------------------------ | --------- |
| 用户管理     | 查看所有用户、统计数据   | ✅ 已实现 |
| 期次管理     | 创建、编辑、删除期次     | ✅ 已实现 |
| 课节管理     | 创建、编辑、删除课节     | ✅ 已实现 |
| 小凡看见管理 | 查看、编辑、删除小凡看见 | ✅ 已实现 |
| 评论管理     | 审核、删除评论           | ✅ 已实现 |
| 数据库管理   | 备份、对比、恢复         | ✅ 已实现 |
| 权限管理     | 角色配置、权限控制       | ✅ 已实现 |

## 六、功能完成度（v4.0）

### 6.1 已完全实现的功能（90%+）✅

| 功能类别       | 具体功能                               | 实现度  |
| -------------- | -------------------------------------- | ------- |
| **用户认证**   | 微信登录、测试账号登录、token 刷新     | ✅ 100% |
| **课程管理**   | 期次列表、课节列表、课程详情           | ✅ 100% |
| **打卡系统**   | 创建打卡、打卡列表、统计数据、日历展示 | ✅ 100% |
| **小凡看见**   | 自动生成、权限管理、列表展示           | ✅ 100% |
| **社交互动**   | 评论、回复、点赞、排行榜、成员列表     | ✅ 100% |
| **报名与支付** | 报名流程、Mock 支付、订单管理          | ✅ 100% |
| **实时通知**   | WebSocket 连接、实时推送、通知列表     | ✅ 100% |
| **分享功能**   | 小凡看见分享、课程分享                 | ✅ 100% |
| **数据存储**   | MongoDB 存储、Redis 缓存、MySQL 备份   | ✅ 100% |
| **管理后台**   | 用户管理、内容运营、数据库管理         | ✅ 100% |

### 6.2 待实现或计划功能（10%）⏳

| 功能         | 说明                                         | 计划  |
| ------------ | -------------------------------------------- | ----- |
| 真实微信支付 | 当前为 Mock，待接入真实微信支付接口          | v5.0+ |
| 真实 AI 反馈 | 当前使用预设模板，待接入 OpenAI / Claude API | v5.0+ |
| 语音打卡     | 支持用户语音录入打卡内容                     | v5.0+ |
| 文件上传     | 支持更多附件类型上传                         | v5.0+ |
| 直播功能     | 课程直播和录播回放                           | v6.0+ |
| 多语言支持   | 国际化（中英日等）                           | v6.0+ |

## 七、数据流与架构细节

### 7.1 OAuth 与认证流程

```
微信端                    小程序                   后端服务器
  |                         |                         |
  |--1. 用户点击登录-------->|                         |
  |                         |--2. wx.login----------->|
  |                         |<--code返回-------------|
  |<--3. 微信授权弹窗--------|                         |
  |--4. 用户授权同意-------->|                         |
  |                         |--5. getUserProfile---->|
  |                         |<--userInfo返回---------|
  |                         |--6. POST /auth/login---|
  |                         |  (code + userInfo)    |
  |                         |<--token返回-----------|
  |                         |                         |
最终: 前端保存 token 到 localStorage 和 globalData
```

### 7.2 数据同步架构

```
小程序 API 调用    ->  Node.js 后端   ->  MongoDB (主库)
                           |
                           v
                      Redis List (同步队列)
                           |
                           v
                      异步 Sync Worker
                           |
                           v
                      MySQL (备份库)
```

**特点**: 51+ 个数据修改操作都通过 publishSyncEvent() 异步同步到 MySQL，确保数据一致性。

## 八、部署与环境配置

### 8.1 环境分离

| 环境 | 配置文件        | 用途     | API 地址                       |
| ---- | --------------- | -------- | ------------------------------ |
| dev  | .env.dev        | 本地开发 | http://localhost:3000          |
| prod | .env.production | 生产环境 | https://api.morningreading.com |

### 8.2 部署准备状态（2026-02-27）

| 检查项          | 状态 | 说明                         |
| --------------- | ---- | ---------------------------- |
| 隐私政策        | ✅   | 已创建独立页面               |
| 用户协议        | ✅   | 已创建独立页面               |
| CORS 配置       | ✅   | 已加强安全                   |
| .env.production | ✅   | 已配置完整                   |
| JWT 密钥        | ✅   | 已生成                       |
| 代码质量        | ✅   | 已审查                       |
| 数据库备份      | ✅   | 已验证                       |
| 部署指南        | ✅   | 已编写（docs/DEPLOYMENT.md） |

**部署就绪度**: 90%+ ✅

## 九、技术规范

### 9.1 前端规范

| 项目     | 规范                                  |
| -------- | ------------------------------------- |
| 框架     | 微信小程序原生（不使用第三方框架）    |
| 组件库   | WeUI 小程序版                         |
| 状态管理 | globalData + localStorage             |
| API 通信 | wx.request + 自定义 request.js 拦截器 |
| 代码规范 | ESLint + Prettier                     |

### 9.2 后端规范

| 项目     | 规范                                           |
| -------- | ---------------------------------------------- |
| 框架     | Node.js + Express                              |
| 数据库   | MongoDB (Mongoose ODM) + MySQL (Sequelize ORM) |
| 缓存     | Redis                                          |
| API 风格 | RESTful + WebSocket                            |
| 代码规范 | ESLint + Prettier                              |
| 测试     | Jest（单元测试）                               |

### 9.3 管理后台规范

| 项目     | 规范               |
| -------- | ------------------ |
| 框架     | Vue 3 + TypeScript |
| UI 库    | Element Plus       |
| 状态管理 | Pinia              |
| 打包工具 | Vite               |
| 代码规范 | ESLint + Prettier  |

## 十、产品路线图

### v1.0（当前版本，已完成）✅

- ✅ 微信登录与认证
- ✅ 课程浏览与打卡
- ✅ AI 反馈（Mock）
- ✅ 社群互动
- ✅ 排行榜与成员列表
- ✅ 报名与支付（Mock）
- ✅ WebSocket 实时通知
- ✅ 管理后台

### v2.0（计划功能）⏳

- [ ] 真实微信支付接入
- [ ] 真实 AI 反馈接入（OpenAI / Claude）
- [ ] 语音打卡功能
- [ ] 学习小组功能
- [ ] 积分和勋章系统
- [ ] 多种课程类型

### v3.0（扩展功能）⏳

- [ ] 开发 Web 端
- [ ] 开发 App 端
- [ ] 直播与录播功能
- [ ] 1对1 辅导
- [ ] 开放 API
- [ ] 多语言支持

## 十一、文档对应关系

| 文件                 | 用途               | 最后更新   |
| -------------------- | ------------------ | ---------- |
| CLAUDE.md            | 开发指南和快速参考 | 2026-02-27 |
| DEVELOPMENT.md       | 开发流程和规范     | 2026-02-27 |
| MINIPROGRAM_GUIDE.md | 小程序开发指南     | 2026-02-27 |
| GIT_WORKFLOW.md      | Git 工作流程       | 2026-02-27 |
| BUG_FIXES.md         | Bug 修复经验库     | 2026-02-27 |
| DEPLOYMENT.md        | 部署指南           | 2026-02-27 |
| 本文件               | 产品需求文档 v4.0  | 2026-02-27 |

---

## 附录

### A1 页面路由完整表（v4.0）

| 页面名称     | 路由路径                               | 参数           | v4.0新增 |
| ------------ | -------------------------------------- | -------------- | -------- |
| 首页         | /pages/index/index                     | -              |          |
| 登录页       | /pages/login/login                     | -              | ✅ 新增  |
| 课程列表     | /pages/courses/courses                 | periodId, name |          |
| 课程详情     | /pages/course-detail/course-detail     | id             |          |
| 打卡页面     | /pages/checkin/checkin                 | courseId       |          |
| 个人中心     | /pages/profile/profile                 | -              |          |
| 小凡看见列表 | /pages/insights/insights               | -              |          |
| 小凡看见详情 | /pages/insight-detail/insight-detail   | id             |          |
| 分享页面     | /pages/share/share                     | insightId      |          |
| 排行榜       | /pages/ranking/ranking                 | periodId       |          |
| 成员列表     | /pages/members/members                 | periodId       |          |
| 打卡记录     | /pages/checkin-records/checkin-records | -              |          |
| 他人主页     | /pages/profile-others/profile-others   | userId         |          |
| 报名页面     | /pages/enrollment/enrollment           | periodId       | ✅ 新增  |
| 支付页面     | /pages/payment/payment                 | enrollmentId   | ✅ 新增  |
| 通知页面     | /pages/notifications/notifications     | -              | ✅ 新增  |
| 隐私政策     | /pages/privacy-policy/privacy-policy   | -              | ✅ 新增  |
| 用户协议     | /pages/user-agreement/user-agreement   | -              | ✅ 新增  |

### A2 关键 API 端点

**认证相关**

- POST /api/v1/auth/login - 微信登录
- POST /api/v1/auth/refresh - Token 刷新
- GET /api/v1/auth/verify - Token 验证

**课程相关**

- GET /api/v1/periods - 获取期次列表
- GET /api/v1/periods/:id - 获取期次详情
- GET /api/v1/sections/:periodId - 获取课节列表
- GET /api/v1/sections/:id - 获取课节详情

**打卡相关**

- POST /api/v1/checkins - 创建打卡
- GET /api/v1/checkins - 获取打卡列表
- GET /api/v1/users/stats - 获取用户统计

**小凡看见相关**

- GET /api/v1/insights - 获取小凡看见列表
- GET /api/v1/insights/:id - 获取小凡看见详情
- POST /api/v1/insights/:id/request - 申请查看权限
- POST /api/v1/insights/requests/:id/approve - 批准申请

**报名与支付相关**

- POST /api/v1/enrollments - 报名课程
- DELETE /api/v1/enrollments/:id - 取消报名
- POST /api/v1/payments/create - 创建支付单
- GET /api/v1/payments/:id - 获取支付状态

**通知相关**

- GET /api/v1/notifications - 获取通知列表
- PUT /api/v1/notifications/:id/read - 标记已读
- POST /api/v1/notifications/archive - 批量归档
- DELETE /api/v1/notifications - 批量删除

### A3 术语表（v4.0）

| 术语       | 说明                                   |
| ---------- | -------------------------------------- |
| 期次       | 晨读营的一期活动，包含23天的课程       |
| 课节       | 期次下的单个课程，对应某一天的学习内容 |
| 打卡       | 用户完成当天学习后提交的学习记录       |
| 小凡看见   | AI根据用户打卡内容生成的个性化反馈     |
| 五步学习法 | 入静、带问题学习、阅读、反思、行动     |
| 连续打卡   | 连续多天完成打卡的天数                 |
| 补卡       | 超过时间窗口后的打卡，需要特殊审核     |
| 报名       | 用户选择课程并支付费用成为学员         |
| 小凡       | AI 反馈助手，为用户提供个性化建议      |

---

**文档版本历史**

| 版本 | 日期       | 主要更新                                                 |
| ---- | ---------- | -------------------------------------------------------- |
| v3.0 | 2025-11-13 | 初版产品需求文档（12个页面）                             |
| v4.0 | 2026-02-27 | ✅ 增加6个页面、报名与支付、WebSocket通知、token时效更正 |

**文档结束**

本文档为《七个习惯晨读营》小程序 v4.0 的完整产品需求文档，涵盖 18 个前端页面、完整的后端 API 和管理后台功能。所有功能已在 v1.0 中实现，部署准备就绪度达到 90%+。
