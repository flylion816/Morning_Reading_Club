# 系统架构设计 v3.0

## 文档信息

- **文档版本**: v3.0
- **产品版本**: v1.0
- **创建日期**: 2025-01-13
- **文档状态**: 已发布

## 说明

本文档描述晨读营小程序后端系统的整体架构设计，包括技术选型、模块划分、部署方案、安全设计、性能优化等。

---

## 一、系统架构概览

### 1.1 整体架构图（文字描述）

```
┌────────────────────────────────────────────────────────────────┐
│                          客户端层                               │
│  ┌──────────────┐         ┌──────────────┐                    │
│  │ 微信小程序   │         │ 管理后台     │                    │
│  └──────┬───────┘         └──────┬───────┘                    │
└─────────┼────────────────────────┼────────────────────────────┘
          │                        │
          │  HTTPS                 │  HTTPS
          │                        │
┌─────────┼────────────────────────┼────────────────────────────┐
│         ▼                        ▼                             │
│  ┌──────────────────────────────────────────┐                 │
│  │            Nginx (反向代理/负载均衡)      │                 │
│  └──────────────┬────────────────────────────┘                 │
│                 │                                               │
│  ┌──────────────┼────────────────────────────┐                 │
│  │              ▼          应用服务层          │                 │
│  │   ┌────────────────────────────────┐      │                 │
│  │   │      Node.js + Express         │      │                 │
│  │   │                                │      │                 │
│  │   │  ┌──────┐  ┌──────┐  ┌──────┐ │      │                 │
│  │   │  │ 认证 │  │ 用户 │  │ 期次 │ │      │                 │
│  │   │  │ 模块 │  │ 模块 │  │ 模块 │ │      │                 │
│  │   │  └──────┘  └──────┘  └──────┘ │      │                 │
│  │   │                                │      │                 │
│  │   │  ┌──────┐  ┌──────┐  ┌──────┐ │      │                 │
│  │   │  │ 打卡 │  │ 评论 │  │ AI   │ │      │                 │
│  │   │  │ 模块 │  │ 模块 │  │ 模块 │ │      │                 │
│  │   │  └──────┘  └──────┘  └──────┘ │      │                 │
│  │   └────────────┬───────────────────┘      │                 │
│  └────────────────┼──────────────────────────┘                 │
└───────────────────┼────────────────────────────────────────────┘
                    │
       ┌────────────┼────────────┐
       │            ▼            │
       │  ┌──────────────────┐  │
       │  │   Redis (缓存)   │  │
       │  └──────────────────┘  │
       │                        │
       │  ┌──────────────────┐  │
       │  │  MongoDB/MySQL   │  │
       │  │   (主数据库)     │  │
       │  └──────────────────┘  │
       │                        │
       │    数据存储层           │
       └────────────────────────┘
                    │
       ┌────────────┼────────────┐
       │            ▼            │
       │  ┌──────────────────┐  │
       │  │  腾讯云 COS      │  │
       │  │  (对象存储)      │  │
       │  └──────────────────┘  │
       │                        │
       │  ┌──────────────────┐  │
       │  │  微信 API        │  │
       │  │  (登录/支付)     │  │
       │  └──────────────────┘  │
       │                        │
       │  ┌──────────────────┐  │
       │  │  AI API          │  │
       │  │  (OpenAI/文心)   │  │
       │  └──────────────────┘  │
       │                        │
       │    第三方服务层         │
       └────────────────────────┘
```

### 1.2 技术栈

**后端框架**: Node.js 18+ + Express 4.x
**数据库**: MongoDB 6.0 (推荐) 或 MySQL 8.0
**缓存**: Redis 7.0
**文件存储**: 腾讯云 COS
**部署**: Docker + Docker Compose
**CI/CD**: GitHub Actions
**监控**: PM2 + 日志系统

---

## 二、技术选型

### 2.1 编程语言和框架

**Node.js + Express**

优势:
- JavaScript全栈，前后端技术栈统一
- 异步I/O，高并发处理能力强
- NPM生态丰富，开发效率高
- 部署简单，资源占用少

技术栈:
```javascript
{
  "dependencies": {
    "express": "^4.18.2",           // Web框架
    "mongoose": "^8.0.0",           // MongoDB ORM
    "jsonwebtoken": "^9.0.2",       // JWT认证
    "bcryptjs": "^2.4.3",           // 密码加密
    "joi": "^17.11.0",              // 数据验证
    "multer": "^1.4.5-lts.1",       // 文件上传
    "axios": "^1.6.2",              // HTTP客户端
    "redis": "^4.6.11",             // Redis客户端
    "winston": "^3.11.0",           // 日志
    "dotenv": "^16.3.1",            // 环境变量
    "helmet": "^7.1.0",             // 安全头
    "cors": "^2.8.5",               // 跨域
    "compression": "^1.7.4",        // 响应压缩
    "rate-limiter-flexible": "^3.0.5" // 限流
  },
  "devDependencies": {
    "nodemon": "^3.0.2",            // 开发热重载
    "jest": "^29.7.0",              // 测试框架
    "supertest": "^6.3.3",          // API测试
    "eslint": "^8.55.0",            // 代码检查
    "prettier": "^3.1.1"            // 代码格式化
  }
}
```

### 2.2 数据库选择

**推荐: MongoDB 6.0**

选择理由:
1. **灵活的文档模型**: 适合快速迭代，schema可以随需求演进
2. **原生JSON支持**: 与Node.js无缝对接
3. **横向扩展**: 支持分片，方便未来扩容
4. **丰富的查询**: 支持复杂查询和聚合
5. **事务支持**: 4.0+版本支持多文档事务

使用场景:
- 用户数据（灵活的个人信息）
- 打卡内容（富文本、嵌入图片链接）
- 评论回复（嵌套结构）
- 小凡看见（AI生成的长文本）

**备选: MySQL 8.0**

适用场景:
- 需要强ACID保证
- 复杂的多表JOIN查询
- 团队更熟悉关系型数据库

### 2.3 缓存方案

**Redis 7.0**

使用场景:
1. **会话缓存**: JWT Token黑名单
2. **数据缓存**: 
   - 期次列表（15分钟）
   - 课节内容（30分钟）
   - 用户信息（5分钟）
3. **计数器**: 
   - 点赞数、评论数实时计数
   - 排行榜数据
4. **限流**: API请求频率限制
5. **消息队列**: 异步任务（如AI生成）

### 2.4 文件存储

**腾讯云 COS (Cloud Object Storage)**

选择理由:
- 微信官方推荐，集成方便
- CDN加速，访问快速
- 按量付费，成本低
- 安全可靠，99.95%可用性

存储策略:
- 图片: 自动生成缩略图（宽度800px）
- 视频: 原始文件 + 封面图
- 音频: 原始文件
- 路径规则: `/{type}/{year}/{month}/{day}/{filename}`

---

## 三、系统模块设计

### 3.1 核心模块

```
backend/
├── src/
│   ├── modules/
│   │   ├── auth/              # 认证模块
│   │   │   ├── auth.controller.js
│   │   │   ├── auth.service.js
│   │   │   ├── auth.routes.js
│   │   │   └── auth.middleware.js
│   │   │
│   │   ├── user/              # 用户模块
│   │   │   ├── user.model.js
│   │   │   ├── user.controller.js
│   │   │   ├── user.service.js
│   │   │   ├── user.routes.js
│   │   │   └── user.validation.js
│   │   │
│   │   ├── period/            # 期次模块
│   │   │   ├── period.model.js
│   │   │   ├── period.controller.js
│   │   │   ├── period.service.js
│   │   │   └── period.routes.js
│   │   │
│   │   ├── section/           # 课节模块
│   │   ├── checkin/           # 打卡模块
│   │   ├── comment/           # 评论模块
│   │   ├── insight/           # 小凡看见模块
│   │   ├── file/              # 文件上传模块
│   │   ├── notification/      # 通知模块
│   │   └── admin/             # 管理员模块
│   │
│   ├── config/                # 配置
│   │   ├── database.js
│   │   ├── redis.js
│   │   ├── wechat.js
│   │   └── ai.js
│   │
│   ├── middleware/            # 中间件
│   │   ├── auth.js
│   │   ├── errorHandler.js
│   │   ├── validator.js
│   │   ├── rateLimiter.js
│   │   └── logger.js
│   │
│   ├── utils/                 # 工具函数
│   │   ├── response.js
│   │   ├── jwt.js
│   │   ├── upload.js
│   │   ├── wechat.js
│   │   └── ai.js
│   │
│   ├── jobs/                  # 定时任务
│   │   ├── updatePeriodStatus.js
│   │   ├── syncCounters.js
│   │   └── cleanupOldData.js
│   │
│   ├── app.js                 # Express应用
│   └── server.js              # 服务器入口
│
├── tests/                     # 测试
│   ├── unit/
│   └── integration/
│
├── .env.example               # 环境变量示例
├── .eslintrc.js              # ESLint配置
├── .prettierrc.js            # Prettier配置
├── package.json
├── Dockerfile
└── docker-compose.yml
```

### 3.2 模块职责

**认证模块 (auth)**:
- 微信登录
- JWT Token生成和验证
- Token刷新
- 权限验证

**用户模块 (user)**:
- 用户CRUD
- 用户统计信息
- 用户打卡历史

**期次模块 (period)**:
- 期次管理
- 报名/取消报名
- 期次状态更新

**课节模块 (section)**:
- 课节管理
- 今日任务查询
- 课节内容获取

**打卡模块 (checkin)**:
- 创建打卡
- 打卡列表查询
- 点赞/评论

**小凡看见模块 (insight)**:
- AI生成反馈
- 查看权限管理
- 申请/审批流程

**文件模块 (file)**:
- 文件上传
- 图片压缩
- 云存储管理

---

## 四、数据流设计

### 4.1 请求处理流程

```
客户端请求
  ↓
Nginx (SSL终止、负载均衡)
  ↓
Express中间件链
  ↓
1. CORS处理 (cors)
  ↓
2. 安全头设置 (helmet)
  ↓
3. 请求日志 (morgan/winston)
  ↓
4. 请求体解析 (express.json)
  ↓
5. 身份认证 (authMiddleware)
  ↓
6. 权限验证 (permissionMiddleware)
  ↓
7. 限流检查 (rateLimiter)
  ↓
8. 参数验证 (validator)
  ↓
路由处理器 (Controller)
  ↓
业务逻辑层 (Service)
  ↓
┌─────────┬─────────┬─────────┐
│         │         │         │
▼         ▼         ▼         ▼
Redis   MongoDB   微信API    AI API
缓存     数据库     第三方     第三方
  ↓         ↓         ↓         ↓
└─────────┴─────────┴─────────┘
  ↓
处理结果
  ↓
响应格式化 (responseFormatter)
  ↓
错误处理 (errorHandler)
  ↓
返回客户端
```

### 4.2 缓存策略

**缓存层级**:

```
L1: 应用内存缓存 (热点数据，1分钟)
  ↓ miss
L2: Redis缓存 (常用数据，5-30分钟)
  ↓ miss
L3: 数据库 (持久化数据)
```

**缓存更新策略**:

1. **Cache Aside (旁路缓存)**
```javascript
async function getUser(userId) {
  // 1. 查询缓存
  let user = await redis.get(`user:${userId}`);
  
  if (user) {
    return JSON.parse(user);
  }
  
  // 2. 缓存未命中，查询数据库
  user = await User.findById(userId);
  
  // 3. 写入缓存
  await redis.setex(
    `user:${userId}`, 
    300, // 5分钟
    JSON.stringify(user)
  );
  
  return user;
}

async function updateUser(userId, data) {
  // 1. 更新数据库
  const user = await User.findByIdAndUpdate(userId, data, { new: true });
  
  // 2. 删除缓存（或更新缓存）
  await redis.del(`user:${userId}`);
  
  return user;
}
```

2. **Write Through (写穿透)**
```javascript
async function createCheckin(data) {
  // 1. 写入数据库
  const checkin = await Checkin.create(data);
  
  // 2. 同时写入缓存
  await redis.setex(
    `checkin:${checkin.id}`,
    600, // 10分钟
    JSON.stringify(checkin)
  );
  
  // 3. 清除列表缓存
  await redis.del(`checkins:list:${data.periodId}`);
  
  return checkin;
}
```

---

## 五、安全设计

### 5.1 身份认证

**JWT Token机制**:

```javascript
// 生成Token
function generateToken(user) {
  const payload = {
    userId: user.id,
    openid: user.openid,
    role: user.role
  };
  
  const accessToken = jwt.sign(payload, process.env.JWT_SECRET, {
    expiresIn: '2h'
  });
  
  const refreshToken = jwt.sign(payload, process.env.JWT_REFRESH_SECRET, {
    expiresIn: '30d'
  });
  
  return { accessToken, refreshToken };
}

// 验证Token
function verifyToken(token) {
  try {
    return jwt.verify(token, process.env.JWT_SECRET);
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      throw new Error('Token已过期');
    }
    throw new Error('Token无效');
  }
}
```

### 5.2 权限控制

**RBAC (基于角色的访问控制)**:

```javascript
// 角色定义
const Roles = {
  USER: 'user',
  ADMIN: 'admin',
  SUPER_ADMIN: 'super_admin'
};

// 权限定义
const Permissions = {
  // 用户权限
  'user:read:own': [Roles.USER, Roles.ADMIN, Roles.SUPER_ADMIN],
  'user:update:own': [Roles.USER, Roles.ADMIN, Roles.SUPER_ADMIN],
  
  // 管理员权限
  'user:read:all': [Roles.ADMIN, Roles.SUPER_ADMIN],
  'user:update:all': [Roles.ADMIN, Roles.SUPER_ADMIN],
  'user:ban': [Roles.SUPER_ADMIN],
  
  // 内容权限
  'period:create': [Roles.ADMIN, Roles.SUPER_ADMIN],
  'section:create': [Roles.ADMIN, Roles.SUPER_ADMIN]
};

// 权限中间件
function requirePermission(permission) {
  return (req, res, next) => {
    const userRole = req.user.role;
    
    if (!Permissions[permission]?.includes(userRole)) {
      return res.status(403).json({
        code: 403,
        message: '无权限访问'
      });
    }
    
    next();
  };
}

// 使用
router.post('/periods', 
  authMiddleware, 
  requirePermission('period:create'),
  createPeriod
);
```

### 5.3 数据验证

**输入验证**:

```javascript
const Joi = require('joi');

// 定义验证schema
const createCheckinSchema = Joi.object({
  sectionId: Joi.number().integer().required(),
  content: Joi.string().min(10).max(5000).required(),
  images: Joi.array().items(Joi.string().uri()).max(9),
  videos: Joi.array().items(Joi.string().uri()).max(3),
  voices: Joi.array().items(Joi.string().uri()).max(1),
  visibility: Joi.string().valid('all', 'admin_only').default('all')
});

// 验证中间件
function validate(schema) {
  return (req, res, next) => {
    const { error, value } = schema.validate(req.body, {
      abortEarly: false,
      stripUnknown: true
    });
    
    if (error) {
      const details = error.details.map(d => ({
        field: d.path.join('.'),
        message: d.message
      }));
      
      return res.status(400).json({
        code: 400,
        message: '参数验证失败',
        error: { type: 'VALIDATION_ERROR', details }
      });
    }
    
    req.body = value;
    next();
  };
}

// 使用
router.post('/checkins',
  authMiddleware,
  validate(createCheckinSchema),
  createCheckin
);
```

### 5.4 SQL/NoSQL注入防护

**MongoDB注入防护**:

```javascript
// ❌ 不安全
const user = await User.findOne({ openid: req.body.openid });

// ✅ 安全 - 验证输入类型
const openid = String(req.body.openid);
if (typeof openid !== 'string') {
  throw new Error('Invalid openid');
}
const user = await User.findOne({ openid });

// ✅ 更安全 - 使用验证库
const { openid } = await validateInput(req.body, {
  openid: Joi.string().required()
});
const user = await User.findOne({ openid });
```

### 5.5 XSS防护

```javascript
const helmet = require('helmet');
const xss = require('xss');

// 设置安全头
app.use(helmet());

// 内容清理
function sanitizeHtml(dirty) {
  return xss(dirty, {
    whiteList: {
      p: [],
      br: [],
      strong: [],
      em: []
    }
  });
}

// 使用
async function createCheckin(req, res) {
  const content = sanitizeHtml(req.body.content);
  // ...
}
```

### 5.6 CSRF防护

```javascript
// 对于小程序API，使用JWT Token已足够
// 对于管理后台，可以使用CSRF Token

const csrf = require('csurf');

// 管理后台路由
const adminRouter = express.Router();
adminRouter.use(csrf({ cookie: true }));

adminRouter.get('/admin/form', (req, res) => {
  res.render('form', { csrfToken: req.csrfToken() });
});
```

### 5.7 限流防护

```javascript
const { RateLimiterRedis } = require('rate-limiter-flexible');

// 配置限流器
const rateLimiter = new RateLimiterRedis({
  storeClient: redisClient,
  keyPrefix: 'ratelimit',
  points: 100, // 请求次数
  duration: 60, // 时间窗口（秒）
  blockDuration: 60 // 封禁时长（秒）
});

// 限流中间件
async function rateLimitMiddleware(req, res, next) {
  try {
    const key = req.user?.id || req.ip;
    await rateLimiter.consume(key);
    next();
  } catch (error) {
    res.status(429).json({
      code: 429,
      message: '请求过于频繁，请稍后再试'
    });
  }
}

// 不同接口不同限制
const strictRateLimiter = new RateLimiterRedis({
  storeClient: redisClient,
  keyPrefix: 'ratelimit:strict',
  points: 10,
  duration: 60
});

// 使用
app.use('/api', rateLimitMiddleware);
app.post('/auth/login', strictRateLimitMiddleware, login);
```

---

## 六、性能优化

### 6.1 数据库优化

**索引策略**:

```javascript
// 用户模型索引
UserSchema.index({ openid: 1 }, { unique: true });
UserSchema.index({ nickname: 1 });
UserSchema.index({ createdAt: -1 });

// 打卡模型索引
CheckinSchema.index({ userId: 1, sectionId: 1 }, { unique: true });
CheckinSchema.index({ periodId: 1, createdAt: -1 });
CheckinSchema.index({ sectionId: 1, createdAt: -1 });

// 复合索引用于排序和筛选
CheckinSchema.index({ periodId: 1, visibility: 1, createdAt: -1 });
```

**查询优化**:

```javascript
// ❌ 不优化
const checkins = await Checkin.find({ periodId: 8 });
for (const checkin of checkins) {
  const user = await User.findById(checkin.userId);
  checkin.userName = user.nickname;
}

// ✅ 使用populate
const checkins = await Checkin.find({ periodId: 8 })
  .populate('userId', 'nickname avatar')
  .lean();

// ✅ 使用聚合
const checkins = await Checkin.aggregate([
  { $match: { periodId: 8 } },
  {
    $lookup: {
      from: 'users',
      localField: 'userId',
      foreignField: '_id',
      as: 'user'
    }
  },
  { $unwind: '$user' },
  {
    $project: {
      content: 1,
      userName: '$user.nickname',
      userAvatar: '$user.avatar'
    }
  }
]);
```

### 6.2 API响应优化

**字段投影**:

```javascript
// 只返回需要的字段
async function getUserList(req, res) {
  const users = await User.find()
    .select('id nickname avatar totalCheckinDays')
    .lean();
  
  res.json({ code: 200, data: users });
}
```

**分页优化**:

```javascript
// 基于游标的分页（推荐）
async function getCheckins(req, res) {
  const { lastId, limit = 20 } = req.query;
  
  const query = lastId ? { _id: { $lt: lastId } } : {};
  
  const checkins = await Checkin.find(query)
    .sort({ _id: -1 })
    .limit(Number(limit))
    .lean();
  
  res.json({
    code: 200,
    data: {
      items: checkins,
      nextCursor: checkins[checkins.length - 1]?._id
    }
  });
}
```

### 6.3 CDN加速

```javascript
// 静态资源使用CDN
const CDN_BASE = 'https://cdn.example.com';

function toCdnUrl(path) {
  return `${CDN_BASE}${path}`;
}

// 文件上传后返回CDN链接
async function uploadFile(file) {
  const cosUrl = await uploadToCOS(file);
  const cdnUrl = toCdnUrl(cosUrl);
  return cdnUrl;
}
```

### 6.4 响应压缩

```javascript
const compression = require('compression');

app.use(compression({
  threshold: 1024, // 大于1KB才压缩
  filter: (req, res) => {
    if (req.headers['x-no-compression']) {
      return false;
    }
    return compression.filter(req, res);
  }
}));
```

---

## 七、部署方案

### 7.1 Docker配置

**Dockerfile**:

```dockerfile
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制package文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY src ./src

# 暴露端口
EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD node healthcheck.js

# 启动应用
CMD ["node", "src/server.js"]
```

**docker-compose.yml**:

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongo:27017/morning_reading
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mongo
      - redis
    restart: unless-stopped
    networks:
      - app-network

  mongo:
    image: mongo:6
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    restart: unless-stopped
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - app-network

volumes:
  mongo-data:
  redis-data:

networks:
  app-network:
    driver: bridge
```

### 7.2 Nginx配置

```nginx
upstream backend {
    least_conn;
    server app1:3000;
    server app2:3000;
    server app3:3000;
}

server {
    listen 80;
    server_name api.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Gzip压缩
    gzip on;
    gzip_types text/plain application/json;
    gzip_min_length 1000;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # API路由
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 健康检查
    location /health {
        access_log off;
        proxy_pass http://backend;
    }
}
```

### 7.3 PM2配置

**ecosystem.config.js**:

```javascript
module.exports = {
  apps: [{
    name: 'morning-reading-api',
    script: './src/server.js',
    instances: 'max', // 使用所有CPU核心
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    merge_logs: true,
    max_memory_restart: '500M',
    
    // 自动重启
    watch: false,
    autorestart: true,
    max_restarts: 10,
    min_uptime: '10s',
    
    // 优雅退出
    kill_timeout: 5000,
    listen_timeout: 3000
  }]
};
```

### 7.4 环境变量

**.env.example**:

```env
# 应用配置
NODE_ENV=production
PORT=3000
API_BASE_URL=https://api.example.com

# 数据库
MONGODB_URI=mongodb://localhost:27017/morning_reading
REDIS_URL=redis://localhost:6379

# JWT
JWT_SECRET=your-secret-key-here
JWT_REFRESH_SECRET=your-refresh-secret-here
JWT_EXPIRES_IN=2h
JWT_REFRESH_EXPIRES_IN=30d

# 微信
WECHAT_APPID=your-appid
WECHAT_SECRET=your-secret

# 腾讯云 COS
COS_SECRET_ID=your-secret-id
COS_SECRET_KEY=your-secret-key
COS_BUCKET=your-bucket
COS_REGION=ap-guangzhou

# AI服务
AI_API_KEY=your-api-key
AI_API_BASE_URL=https://api.openai.com

# 日志
LOG_LEVEL=info
```

---

## 八、监控和日志

### 8.1 日志系统

```javascript
const winston = require('winston');

// 创建logger
const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    // 错误日志
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error',
      maxsize: 10485760, // 10MB
      maxFiles: 10
    }),
    // 综合日志
    new winston.transports.File({
      filename: 'logs/combined.log',
      maxsize: 10485760,
      maxFiles: 10
    })
  ]
});

// 开发环境输出到控制台
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}

module.exports = logger;
```

### 8.2 性能监控

```javascript
// 请求时间监控
app.use((req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    
    logger.info('API Request', {
      method: req.method,
      url: req.url,
      status: res.statusCode,
      duration,
      userId: req.user?.id
    });
    
    // 慢请求告警
    if (duration > 1000) {
      logger.warn('Slow API Request', {
        method: req.method,
        url: req.url,
        duration
      });
    }
  });
  
  next();
});
```

### 8.3 错误追踪

```javascript
// 全局错误处理
app.use((err, req, res, next) => {
  // 记录错误
  logger.error('Unhandled Error', {
    error: {
      message: err.message,
      stack: err.stack
    },
    request: {
      method: req.method,
      url: req.url,
      body: req.body,
      userId: req.user?.id
    }
  });
  
  // 返回错误响应
  res.status(err.statusCode || 500).json({
    code: err.code || 500,
    message: process.env.NODE_ENV === 'production' 
      ? '服务器内部错误' 
      : err.message
  });
});
```

---

## 九、CI/CD流程

**GitHub Actions配置**:

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build Docker image
        run: docker build -t morning-reading-api .
      
      - name: Push to registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push morning-reading-api
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /app
            docker-compose pull
            docker-compose up -d
```

---

**文档版本**: v3.0  
**最后更新**: 2025-01-13  
**文档状态**: 已完成

