# 七个习惯晨读营 - 产品需求文档 v3.0

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v3.0 |
| 创建日期 | 2025-11-13 |
| 作者 | Backend Team |
| 项目名称 | 七个习惯晨读营小程序 |
| 前端版本 | v1.0 |
| 文档状态 | 待评审 |

## 一、产品概述

### 1.1 产品定位

七个习惯晨读营是基于《高效能人士的七个习惯》书籍的晨读打卡小程序，旨在帮助用户通过21-23天的持续晨读和打卡，养成阅读习惯，理解并实践七个习惯的核心理念。

### 1.2 核心价值

- **习惯养成**：通过每日打卡机制，帮助用户养成晨读习惯
- **深度学习**：提供系统化的五步学习法（入静、带问题学习、阅读、反思、行动）
- **AI反馈**：通过"小凡看见"功能，为用户提供个性化的AI反馈和鼓励
- **社群互动**：支持打卡分享、评论互动、排行榜等社交功能
- **进度追踪**：可视化展示学习进度和连续打卡天数

### 1.3 用户角色

| 角色 | 描述 | 权限 |
|------|------|------|
| 未登录用户 | 未进行微信授权的访客 | 只能浏览首页期次列表 |
| 普通用户 | 已登录但未报名的用户 | 可浏览所有公开内容，不能参与打卡 |
| 学员 | 已报名某期课程的用户 | 可打卡、查看课程内容、参与互动 |
| 管理员 | 课程运营管理人员 | 可查看所有用户数据、管理课程内容 |

### 1.4 产品架构

```
七个习惯晨读营小程序
├── 用户模块
│   ├── 微信登录/授权
│   ├── 用户信息管理
│   └── 个人中心
├── 课程模块
│   ├── 期次管理
│   ├── 课节管理
│   ├── 课程内容展示
│   └── 五步学习法
├── 打卡模块
│   ├── 创建打卡
│   ├── 打卡记录
│   ├── 连续打卡统计
│   └── 打卡日历
├── 小凡看见模块
│   ├── AI反馈生成
│   ├── 查看权限管理
│   ├── 申请/授权流程
│   └── 反馈列表展示
├── 社交互动模块
│   ├── 评论系统
│   ├── 点赞功能
│   ├── 排行榜
│   └── 成员列表
└── 分享模块
    ├── 小凡看见分享
    ├── 课程分享
    └── 个人成就分享
```

## 二、功能需求详述

### 2.1 首页（期次列表）

**页面路径**: `/pages/index/index`

#### 2.1.1 页面结构

- 顶部Banner：显示欢迎语和Slogan
- 用户信息卡片：已登录时显示头像、昵称
- 期次列表：展示所有可用的晨读营期次

#### 2.1.2 功能需求

**F-001: 期次列表展示**

| 字段 | 说明 |
|------|------|
| 需求描述 | 展示所有晨读营期次，包括进行中、未报名、已结束的期次 |
| 显示内容 | 期次名称、图标、日期范围、状态、进度 |
| 排序规则 | 按开始时间倒序（最新的在前） |
| 状态标识 | ongoing(进行中)、not_enrolled(未报名)、completed(已结束) |

**F-002: 期次卡片交互**

| 交互 | 行为 |
|------|------|
| 点击期次卡片 | 跳转到该期次的课节列表页 |
| 下拉刷新 | 重新加载期次列表 |
| 点击头像 | 跳转到个人中心 |

**F-003: 未登录状态**

- 用户未登录时，仍可浏览期次列表
- 点击需要权限的功能时，引导用户登录

#### 2.1.3 数据结构

```javascript
// 期次数据结构
{
  id: 8,                          // 期次ID
  name: '勇敢的心',                 // 期次名称
  subtitle: '七个习惯晨读营',        // 副标题
  title: '勇敢的心 - 七个习惯晨读营', // 完整标题
  icon: '⛰️',                      // 期次图标emoji
  color: 'linear-gradient(...)',   // 背景渐变色
  startDate: '2025/10/11',         // 开始日期
  endDate: '2025/11/13',           // 结束日期
  dateRange: '10-11 至 11-13',     // 日期范围文本
  status: 'ongoing',               // 状态
  statusText: '进行中 0/23',        // 状态文本
  checkedDays: 0,                  // 已打卡天数
  totalDays: 23,                   // 总天数
  progress: 0,                     // 进度百分比
  isEnrolled: true                 // 是否已报名
}
```

### 2.2 课程列表页（课节列表）

**页面路径**: `/pages/courses/courses`

#### 2.2.1 页面结构

- 顶部：期次信息卡片（名称、日期、进度）
- 功能按钮区：排行榜、成员列表
- 课节列表：展示该期次的所有课节

#### 2.2.2 功能需求

**F-004: 课节列表展示**

| 字段 | 说明 |
|------|------|
| 需求描述 | 展示某期次下的所有课节，包括开营词和每日课程 |
| 显示内容 | 课节标题、天数、日期范围、打卡人数、打卡状态 |
| 排序规则 | 按天数升序（从第0天到第N天） |
| 特殊标识 | 开营词显示为第0天，其他课节显示为第N天 |

**F-005: 课节卡片交互**

| 交互 | 行为 |
|------|------|
| 点击课节卡片 | 跳转到课程详情页 |
| 已打卡标识 | 显示绿色对勾图标 |
| 未打卡标识 | 显示灰色未打卡状态 |

**F-006: 快捷功能**

| 功能 | 说明 |
|------|------|
| 排行榜入口 | 点击跳转到排行榜页面 |
| 成员列表入口 | 点击跳转到成员列表页面 |
| 返回首页 | 点击返回期次列表 |

#### 2.2.3 数据结构

```javascript
// 课节数据结构
{
  id: 801,                          // 课节ID
  periodId: 8,                      // 所属期次ID
  title: '开营词',                   // 课节标题
  day: 0,                           // 第几天（0表示开营词）
  startTime: '2025/10/10 05:59:00', // 开始时间
  endTime: '2025/10/12 05:59:59',   // 结束时间
  dateRange: '10-10 至 10-12',      // 日期范围
  checkinCount: 2,                  // 打卡人数
  isCheckedIn: false                // 当前用户是否已打卡
}
```

### 2.3 课程详情页

**页面路径**: `/pages/course-detail/course-detail`

#### 2.3.1 页面结构

- 顶部：课程封面、标题、日期
- 进度日历：21/23天打卡日历
- 学习内容：五步学习法内容展示
- 打卡按钮：创建打卡入口
- 社群互动区：打卡记录和评论列表

#### 2.3.2 功能需求

**F-007: 五步学习法展示**

五步学习法是本产品的核心学习模式，包括：

| 步骤 | 名称 | 说明 | 字段名 |
|------|------|------|--------|
| 第一步 | 入静 | 学习前的冥想引导 | meditation |
| 第二步 | 带问题学习 | 学习前的思考问题 | question |
| 第三步 | 阅读 | 核心课程内容（富文本） | content |
| 第四步 | 反思 | 引导用户反思的问题 | reflection |
| 第五步 | 行动 | 具体行动建议 | action |

**F-008: 打卡日历**

| 功能 | 说明 |
|------|------|
| 日历展示 | 显示23天的打卡日历网格 |
| 状态标识 | 已打卡显示绿色对勾，未打卡显示灰色 |
| 统计信息 | 显示已打卡天数/总天数 |
| 点击交互 | 点击某天可查看当天的打卡详情（待实现） |

**F-009: 打卡记录展示**

| 功能 | 说明 |
|------|------|
| 记录来源 | 合并本地打卡记录和初始评论数据 |
| 显示内容 | 用户头像、昵称、打卡内容、时间、点赞数 |
| 排序规则 | 按时间倒序（最新的在前） |
| 去重规则 | 使用ID去重，本地记录优先 |

**F-010: 评论互动**

| 功能 | 说明 |
|------|------|
| 点赞评论 | 点击爱心图标可点赞/取消点赞 |
| 回复评论 | 点击回复按钮可回复评论 |
| 点赞回复 | 可对回复进行点赞 |
| 二级回复 | 可回复某条回复（显示@用户名） |
| 查看头像 | 点击用户头像跳转到他人主页 |

**F-011: 创建打卡**

| 功能 | 说明 |
|------|------|
| 打卡入口 | 点击底部"打卡"按钮进入打卡页 |
| 权限控制 | 只有已报名的学员才能打卡 |
| 时间限制 | 每个课节在指定时间范围内可打卡 |

#### 2.3.3 数据结构

```javascript
// 课程详情数据结构
{
  id: 1,
  title: '第一天 品德成功论',
  period: 1,
  startDate: '2025/11/10',
  endDate: '2025/12/03',
  currentDay: 4,                    // 当前学习到第几天
  isEnrolled: true,                 // 是否已报名
  description: '21天养成阅读习惯',

  // 五步学习法内容
  meditation: '开始学习之前，给自己1分钟的时间...',
  question: '带着问题学习：品德成功论和个性成功论有什么区别？',
  content: '<p>纵观历史，成功学著作有两种截然不同的思想体系...</p>',
  reflection: '上文中，哪一句话特别触动我？引起了我哪些感触？',
  action: '把感触记录在日记中，与营友们分享你的收获。',

  // 评论列表
  comments: [
    {
      id: 1,
      userId: 101,
      userName: '阿泰',
      avatarText: '泰',              // 头像显示的文字
      avatarColor: '#4a90e2',        // 头像背景色
      content: '非常优秀！对双赢品德的理解非常深入！',
      likeCount: 0,
      createTime: '1小时前',
      isLiked: false,                // 当前用户是否已点赞
      replies: []                    // 回复列表
    }
  ]
}
```

### 2.4 打卡页面

**页面路径**: `/pages/checkin/checkin`

#### 2.4.1 页面结构

- 课程信息：课程标题、日期
- 学习内容：可折叠展示五步学习法
- 打卡表单：日记输入框
- 可见范围选择：全员可见/仅管理员可见
- 附件上传：图片、视频、语音、文件
- 底部按钮：取消、提交

#### 2.4.2 功能需求

**F-012: 学习内容展示**

| 功能 | 说明 |
|------|------|
| 默认状态 | 默认折叠，只显示部分内容 |
| 展开/收起 | 点击按钮可展开或收起全部内容 |
| 内容同步 | 显示与课程详情页相同的五步学习法内容 |

**F-013: 打卡内容输入**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| diaryContent | String | 是 | 打卡日记内容 |
| visibility | Enum | 是 | 可见范围：all(全员)/admin(仅管理员) |
| images | Array | 否 | 图片列表，最多9张 |
| videos | Array | 否 | 视频列表，最多9个 |
| voices | Array | 否 | 语音列表 |

**F-014: 附件上传**

| 类型 | 限制 | 说明 |
|------|------|------|
| 图片 | 最多9张 | 支持相机拍摄和相册选择 |
| 视频 | 最多9个，单个最长60秒 | 支持相机录制和相册选择 |
| 语音 | 待开发 | 录音功能 |
| 文件 | 待开发 | 微信文件选择 |

**F-015: 提交打卡**

| 步骤 | 说明 |
|------|------|
| 验证 | 检查打卡内容是否为空 |
| 提交 | 调用打卡接口提交数据 |
| 本地存储 | 保存打卡记录到本地存储 |
| 反馈 | 显示打卡成功提示 |
| 跳转 | 自动返回上一页 |

#### 2.4.3 数据结构

```javascript
// 打卡提交数据
{
  courseId: 1,                    // 课程ID（实际是sectionId）
  sectionId: 1,                   // 课节ID
  content: '今天学习了品德成功论...', // 打卡内容
  visibility: 'all',              // 可见范围
  images: [],                     // 图片URL数组
  videos: [],                     // 视频URL数组
  voices: []                      // 语音URL数组
}

// 打卡记录数据（保存到本地）
{
  id: 1669876543210,              // 打卡记录ID（时间戳）
  userId: 1,                      // 用户ID
  userName: '我',                  // 用户昵称
  avatarText: '我',                // 头像文字
  avatarColor: '#4a90e2',         // 头像颜色
  content: '今天学习了品德成功论...', // 打卡内容
  likeCount: 0,                   // 点赞数
  createTime: '刚刚',              // 创建时间
  isLiked: false,                 // 是否已点赞
  replies: [],                    // 回复列表
  courseId: 1,                    // 课程ID
  courseTitle: '第一天 品德成功论',  // 课程标题
  timestamp: 1669876543210        // 时间戳（用于排序）
}
```

### 2.5 个人中心页面

**页面路径**: `/pages/profile/profile`

#### 2.5.1 页面结构

- 未登录状态：微信登录按钮
- 已登录状态：
  - 用户信息卡片：头像、昵称、签名、统计数据
  - 今日课节：当前期次的今日课节快捷入口
  - 小凡看见：最近3条小凡看见记录
  - 权限请求：收到的查看小凡看见的申请

#### 2.5.2 功能需求

**F-016: 微信登录**

| 步骤 | 说明 |
|------|------|
| 触发 | 点击"微信一键登录"按钮 |
| 授权 | 调用wx.getUserProfile获取用户信息 |
| 登录 | 调用登录接口（Mock模式或生产模式） |
| 保存 | 保存token和用户信息到本地存储和全局变量 |
| 刷新 | 更新页面状态，加载用户数据 |

**F-017: 用户信息展示**

| 字段 | 说明 |
|------|------|
| 头像 | 显示emoji头像或微信头像 |
| 昵称 | 用户昵称 |
| 签名 | 个性签名 |
| 统计数据 | 总天数、已打卡天数、进度、连续天数、小凡看见数 |

**F-018: 今日课节展示**

| 功能 | 说明 |
|------|------|
| 自动识别 | 自动识别当前期次的今日课节 |
| 显示内容 | 课节标题、期次信息、封面样式 |
| 点击跳转 | 点击跳转到课程详情页 |
| 快捷打卡 | 点击"创建打卡"按钮快速进入打卡页 |

**F-019: 小凡看见展示**

| 功能 | 说明 |
|------|------|
| 显示数量 | 最多显示3条最近的小凡看见 |
| 显示内容 | 天数、标题、预览文本 |
| 点击跳转 | 点击跳转到小凡看见详情页 |
| 查看更多 | 点击"全部"跳转到小凡看见列表页 |

**F-020: 权限请求处理**

| 功能 | 说明 |
|------|------|
| 请求来源 | 其他用户申请查看我的小凡看见 |
| 显示内容 | 申请人头像、昵称、申请时间 |
| 同意授权 | 点击"同意"按钮，更新请求状态为approved |
| 拒绝申请 | 点击"拒绝"按钮，更新请求状态为rejected |
| 状态存储 | 使用本地存储key: insight_requests |

#### 2.5.3 数据结构

```javascript
// 用户信息
{
  id: 1,
  nickname: '晨读营用户',
  avatar: '🦁',                   // emoji头像
  signature: '天天开心，觉知当下！'
}

// 用户统计信息
{
  totalDays: 23,                 // 课程总天数
  checkedDays: 4,                // 已打卡天数
  progress: 17,                  // 进度百分比
  continuousDays: 4,             // 连续打卡天数
  totalInsights: 2               // 小凡看见总数
}

// 今日课节
{
  id: 802,
  title: '第一天 品德成功论',
  periodId: 8,
  periodTitle: '勇敢的心 - 七个习惯晨读营',
  coverColor: '#4a90e2',
  coverEmoji: '🏔️',
  isCheckedIn: false
}

// 权限请求
{
  id: 1669876543210,             // 请求ID
  fromUserId: 1,                 // 申请人ID
  fromUserName: '阿泰',           // 申请人昵称
  fromUserAvatar: '泰',           // 申请人头像文字
  avatarColor: '#4a90e2',        // 头像颜色
  toUserId: 2,                   // 被申请人ID（当前用户）
  toUserName: '我',               // 被申请人昵称
  time: '2小时前',                // 申请时间
  status: 'pending'              // 状态：pending/approved/rejected
}
```

### 2.6 小凡看见列表页

**页面路径**: `/pages/insights/insights`

#### 2.6.1 页面结构

- 标题：小凡看见
- 列表：小凡看见卡片列表

#### 2.6.2 功能需求

**F-021: 小凡看见列表展示**

| 功能 | 说明 |
|------|------|
| 数据来源 | 当前用户的所有小凡看见记录 |
| 显示内容 | 天数、标题、预览文本、日期 |
| 排序规则 | 按日期倒序（最新的在前） |
| 点击跳转 | 点击卡片跳转到详情页 |

#### 2.6.3 数据结构

```javascript
// 小凡看见列表项
{
  id: 1,
  dayNumber: 1,                   // 第几天
  title: '品德成功论',             // 标题
  preview: '感谢你的分享，听你娓娓道来...', // 预览文本
  date: '2025-11-11',             // 日期
  content: '<p>完整的HTML内容...</p>' // 完整内容（在详情页显示）
}
```

### 2.7 小凡看见详情页

**页面路径**: `/pages/insight-detail/insight-detail`

#### 2.7.1 页面结构

- 顶部：天数、标题、日期
- 内容区：富文本内容展示
- 底部按钮：点赞、分享

#### 2.7.2 功能需求

**F-022: 内容展示**

| 功能 | 说明 |
|------|------|
| 富文本渲染 | 使用rich-text组件渲染HTML内容 |
| 样式支持 | 支持段落、加粗、颜色等样式 |

**F-023: 互动功能**

| 功能 | 说明 |
|------|------|
| 点赞 | 点击点赞按钮（待实现后端接口） |
| 分享 | 点击分享按钮跳转到分享页 |

### 2.8 分享页面

**页面路径**: `/pages/share/share`

#### 2.8.1 页面结构

- 分享卡片：小凡看见内容的可视化卡片
- 分享按钮：生成图片、转发好友、分享朋友圈

#### 2.8.2 功能需求

**F-024: 分享卡片生成**

| 功能 | 说明 |
|------|------|
| 卡片内容 | 天数、标题、部分内容、用户信息 |
| 样式设计 | 美观的卡片设计，适合分享 |
| 生成图片 | 使用Canvas生成分享图片 |

**F-025: 分享渠道**

| 渠道 | 说明 |
|------|------|
| 转发好友 | 使用小程序分享功能 |
| 分享朋友圈 | 使用小程序分享到朋友圈功能 |
| 保存图片 | 保存分享图片到相册 |

### 2.9 排行榜页面

**页面路径**: `/pages/ranking/ranking`

#### 2.9.1 页面结构

- Tab切换：总榜、本周、上周、今日、昨日
- 当前用户排名：浮动显示当前用户的排名信息
- 排行榜列表：展示用户排名

#### 2.9.2 功能需求

**F-026: 排行榜展示**

| 功能 | 说明 |
|------|------|
| 排名维度 | 按打卡次数排名 |
| 时间维度 | 支持总榜、本周、上周、今日、昨日 |
| 显示内容 | 排名、用户头像、昵称、打卡次数 |
| 高亮当前用户 | 在列表中高亮显示当前用户 |

**F-027: Tab切换**

| 功能 | 说明 |
|------|------|
| 切换交互 | 点击Tab切换排行榜维度 |
| 数据刷新 | 切换后重新加载对应维度的数据 |

#### 2.9.3 数据结构

```javascript
// 排行榜数据
{
  rank: 1,                       // 排名
  userId: 2000,                  // 用户ID
  userName: '张三',               // 用户昵称
  avatarText: '三',               // 头像文字
  avatarColor: '#4a90e2',        // 头像颜色
  checkinCount: 30               // 打卡次数
}

// 当前用户排名信息
{
  userId: 1000,
  userName: '我',
  avatarText: '我',
  avatarColor: '#4a90e2',
  rank: 5,                       // 当前排名
  checkinCount: 12               // 打卡次数
}

// 参与人数
participantCount: 156
```

### 2.10 成员列表页

**页面路径**: `/pages/members/members`

#### 2.10.1 页面结构

- 成员总数：显示当前期次的成员总数
- 成员列表：展示所有成员

#### 2.10.2 功能需求

**F-028: 成员列表展示**

| 功能 | 说明 |
|------|------|
| 数据范围 | 显示当前期次的所有成员 |
| 显示内容 | 用户头像、昵称、加入日期 |
| 排序规则 | 按加入时间倒序（最新加入的在前） |

#### 2.10.3 数据结构

```javascript
// 成员数据
{
  userId: 2000,                  // 用户ID
  userName: '张三',               // 用户昵称
  avatarText: '三',               // 头像文字
  avatarColor: '#4a90e2',        // 头像颜色
  joinDate: '2025-11-01'         // 加入日期
}
```

### 2.11 打卡记录页

**页面路径**: `/pages/checkin-records/checkin-records`

#### 2.11.1 页面结构

- 标题：我的打卡记录
- 列表：打卡记录列表

#### 2.11.2 功能需求

**F-029: 打卡记录展示**

| 功能 | 说明 |
|------|------|
| 数据来源 | 从本地存储读取：all_checkins |
| 显示内容 | 课程标题、打卡内容、打卡时间 |
| 排序规则 | 按打卡时间倒序 |

### 2.12 他人主页

**页面路径**: `/pages/profile-others/profile-others`

#### 2.12.1 页面结构

- 用户信息：头像、昵称、签名
- 统计数据：打卡天数、连续天数等
- 打卡记录：该用户的公开打卡记录

#### 2.12.2 功能需求

**F-030: 他人信息展示**

| 功能 | 说明 |
|------|------|
| 数据来源 | 根据userId获取用户信息 |
| 显示内容 | 用户基本信息和统计数据 |
| 权限控制 | 只显示公开的信息 |

## 三、业务规则

### 3.1 用户认证规则

| 规则编号 | 规则描述 |
|---------|---------|
| BR-001 | 用户必须通过微信授权才能登录 |
| BR-002 | 登录后生成JWT token，有效期7天 |
| BR-003 | Token过期后需要使用refresh_token刷新 |
| BR-004 | 未登录用户只能浏览首页和公开内容 |

### 3.2 课程报名规则

| 规则编号 | 规则描述 |
|---------|---------|
| BR-005 | 用户必须先报名才能参与该期课程 |
| BR-006 | 已报名的期次才能进行打卡 |
| BR-007 | 每个用户可以同时报名多个期次 |
| BR-008 | 报名后不能取消（除非管理员操作） |

### 3.3 打卡规则

| 规则编号 | 规则描述 |
|---------|---------|
| BR-009 | 每个课节只能打卡一次 |
| BR-010 | 打卡时间范围：课节startTime到endTime |
| BR-011 | 超过endTime后不能打卡，只能补卡（需审核） |
| BR-012 | 打卡内容不能为空 |
| BR-013 | 图片最多9张，视频最多9个 |
| BR-014 | 打卡成功后自动生成小凡看见（AI反馈） |

### 3.4 小凡看见规则

| 规则编号 | 规则描述 |
|---------|---------|
| BR-015 | 小凡看见默认仅本人可见 |
| BR-016 | 用户可以设置某条小凡看见为公开 |
| BR-017 | 查看他人的小凡看见需要申请权限 |
| BR-018 | 权限申请需要被申请人同意后才能查看 |
| BR-019 | 一次权限申请只对一条小凡看见有效 |

### 3.5 评论互动规则

| 规则编号 | 规则描述 |
|---------|---------|
| BR-020 | 只有已登录用户才能评论和点赞 |
| BR-021 | 评论内容不能为空 |
| BR-022 | 支持二级回复（评论的回复） |
| BR-023 | 点赞可以取消 |
| BR-024 | 用户可以删除自己的评论 |

### 3.6 排行榜规则

| 规则编号 | 规则描述 |
|---------|---------|
| BR-025 | 排行榜按打卡次数降序排列 |
| BR-026 | 打卡次数相同时按最新打卡时间排序 |
| BR-027 | 支持多个时间维度的排行榜 |
| BR-028 | 当前用户在列表中高亮显示 |

### 3.7 数据可见性规则

| 规则编号 | 规则描述 |
|---------|---------|
| BR-029 | 打卡可见范围：all(全员可见)、admin(仅管理员可见) |
| BR-030 | 设置为admin的打卡不在课程详情页显示 |
| BR-031 | 公开的小凡看见显示在广场 |
| BR-032 | 私密的小凡看见只在个人中心显示 |

## 四、数据流转

### 4.1 用户登录流程

```
1. 用户点击登录按钮
   ↓
2. 调用 wx.getUserProfile 获取用户信息
   ↓
3. 调用 wx.login 获取 code
   ↓
4. 将 code 和 userInfo 发送到后端 /auth/login
   ↓
5. 后端验证 code，生成 access_token 和 refresh_token
   ↓
6. 前端保存 token 到本地存储和全局变量
   ↓
7. 更新页面状态，加载用户数据
```

### 4.2 打卡流程

```
1. 用户在课程详情页点击"打卡"按钮
   ↓
2. 跳转到打卡页面，加载课程内容
   ↓
3. 用户输入打卡内容，选择可见范围，上传附件
   ↓
4. 点击提交，验证内容是否为空
   ↓
5. 调用 /checkins 接口提交打卡数据
   ↓
6. 后端创建打卡记录，触发AI生成小凡看见
   ↓
7. 前端保存打卡记录到本地存储（用于离线展示）
   ↓
8. 显示打卡成功提示，返回上一页
   ↓
9. 课程详情页刷新，显示新的打卡记录
```

### 4.3 小凡看见生成流程

```
1. 用户提交打卡
   ↓
2. 后端接收打卡数据
   ↓
3. 触发AI生成流程（异步）
   ↓
4. AI分析打卡内容，生成个性化反馈
   ↓
5. 保存小凡看见记录到数据库
   ↓
6. 用户在个人中心查看小凡看见
```

### 4.4 权限申请流程

```
1. 用户A在他人主页看到用户B的小凡看见（标记为私密）
   ↓
2. 用户A点击"申请查看"按钮
   ↓
3. 弹出申请对话框，输入申请理由
   ↓
4. 调用 /insights/{id}/request 接口提交申请
   ↓
5. 后端创建权限申请记录
   ↓
6. 用户B在个人中心收到权限申请通知
   ↓
7. 用户B点击"同意"或"拒绝"
   ↓
8. 调用 /insights/requests/{id}/approve 或 reject 接口
   ↓
9. 更新申请状态
   ↓
10. 如果同意，用户A可以查看该条小凡看见
```

### 4.5 评论互动流程

```
1. 用户在课程详情页看到打卡记录
   ↓
2. 点击"回复"按钮
   ↓
3. 输入评论内容
   ↓
4. 调用 /comments 接口提交评论
   ↓
5. 后端创建评论记录
   ↓
6. 前端更新评论列表
   ↓
7. 其他用户可以看到新评论
   ↓
8. 其他用户可以点赞或回复该评论
```

## 五、数据存储（本地存储）

### 5.1 本地存储键值表

当前v1.0版本使用微信小程序本地存储，以下是所有使用的存储键：

| 键名 | 数据类型 | 说明 | 使用位置 |
|------|---------|------|---------|
| token | String | JWT访问令牌 | auth.service.js, request.js |
| refreshToken | String | JWT刷新令牌 | auth.service.js |
| userInfo | Object | 用户信息对象 | auth.service.js, user.service.js, profile.js |
| checkins_{courseId} | Array | 某个课程的打卡记录列表 | checkin.js, course-detail.js |
| all_checkins | Array | 所有打卡记录列表 | checkin.js, checkin-records.js |
| insight_requests | Array | 小凡看见权限申请列表 | profile.js |

### 5.2 存储数据结构

#### 5.2.1 token

```javascript
// 字符串类型
"mock_token_1669876543210"
```

#### 5.2.2 refreshToken

```javascript
// 字符串类型
"mock_refresh_token_1669876543210"
```

#### 5.2.3 userInfo

```javascript
{
  id: 1,
  nickname: '晨读营用户',
  avatar: '🦁',
  signature: '天天开心，觉知当下！'
}
```

#### 5.2.4 checkins_{courseId}

```javascript
// 数组类型，存储某个课程的打卡记录
[
  {
    id: 1669876543210,
    userId: 1,
    userName: '我',
    avatarText: '我',
    avatarColor: '#4a90e2',
    content: '今天学习了品德成功论...',
    likeCount: 0,
    createTime: '刚刚',
    isLiked: false,
    replies: [],
    courseId: 1,
    courseTitle: '第一天 品德成功论',
    timestamp: 1669876543210
  }
]
```

#### 5.2.5 all_checkins

```javascript
// 数组类型，存储所有打卡记录（用于打卡记录页）
// 数据结构同 checkins_{courseId}
```

#### 5.2.6 insight_requests

```javascript
// 数组类型，存储权限申请记录
[
  {
    id: 1669876543210,
    fromUserId: 1,
    fromUserName: '阿泰',
    fromUserAvatar: '泰',
    avatarColor: '#4a90e2',
    toUserId: 2,
    toUserName: '我',
    time: '2小时前',
    status: 'pending'  // pending/approved/rejected
  }
]
```

## 六、用户故事

### 6.1 用户登录

**作为**未登录用户
**我想要**使用微信一键登录
**以便于**快速开始使用小程序

**验收标准**：
- 点击登录按钮后弹出微信授权对话框
- 授权成功后自动登录
- 登录成功后显示用户信息
- Token保存到本地存储
- 全局状态更新

### 6.2 浏览课程

**作为**已登录用户
**我想要**浏览所有期次和课节
**以便于**了解课程内容和选择学习

**验收标准**：
- 首页显示所有期次列表
- 点击期次进入课节列表
- 课节列表显示所有课节
- 显示打卡状态和打卡人数

### 6.3 学习打卡

**作为**已报名学员
**我想要**完成每日打卡
**以便于**记录学习心得和保持学习习惯

**验收标准**：
- 查看完整的五步学习法内容
- 输入打卡日记
- 选择可见范围
- 上传图片/视频附件
- 提交成功后显示在课程详情页
- 保存到本地存储

### 6.4 查看小凡看见

**作为**已打卡用户
**我想要**查看AI生成的个性化反馈
**以便于**获得鼓励和深入思考

**验收标准**：
- 打卡后自动生成小凡看见
- 在个人中心显示最近3条
- 点击查看完整内容
- 支持点赞和分享

### 6.5 社群互动

**作为**课程学员
**我想要**与其他学员互动
**以便于**交流学习心得和相互鼓励

**验收标准**：
- 查看他人打卡记录
- 评论和回复
- 点赞评论
- 查看排行榜
- 查看成员列表

### 6.6 分享成果

**作为**课程学员
**我想要**分享我的小凡看见
**以便于**展示学习成果和邀请朋友

**验收标准**：
- 生成精美分享卡片
- 转发给微信好友
- 分享到朋友圈
- 保存图片到相册

## 七、非功能需求

### 7.1 性能需求

| 指标 | 要求 |
|------|------|
| 页面加载时间 | < 2秒 |
| 接口响应时间 | < 1秒 |
| 列表滚动流畅度 | 60fps |
| 图片加载 | 支持懒加载 |
| 本地存储大小 | < 10MB |

### 7.2 兼容性需求

| 项目 | 要求 |
|------|------|
| 微信版本 | >= 7.0.0 |
| 基础库版本 | >= 2.10.0 |
| iOS版本 | >= 10.0 |
| Android版本 | >= 5.0 |

### 7.3 可用性需求

| 项目 | 要求 |
|------|------|
| 界面友好度 | 简洁直观，符合微信设计规范 |
| 操作便捷性 | 主要功能在3步内完成 |
| 错误提示 | 清晰友好的错误提示 |
| 帮助文档 | 提供新手引导 |

### 7.4 安全需求

| 项目 | 要求 |
|------|------|
| 用户认证 | JWT token认证 |
| 数据传输 | HTTPS加密 |
| 敏感信息 | 不在本地存储敏感信息 |
| 权限控制 | 严格的接口权限控制 |

### 7.5 可维护性需求

| 项目 | 要求 |
|------|------|
| 代码规范 | 遵循ESLint规范 |
| 注释完整度 | 关键函数必须有注释 |
| 模块化 | 按功能模块划分 |
| 日志记录 | 关键操作记录日志 |

## 八、约束条件

### 8.1 技术约束

- 必须使用微信小程序平台
- 前端使用原生小程序开发（不使用框架）
- 后端推荐使用Node.js + Express/Koa
- 数据库推荐使用MySQL + MongoDB（混合）
- AI功能使用第三方API（如OpenAI、Claude等）

### 8.2 业务约束

- 课程内容由管理员统一维护
- 每期课程时长固定为23天
- 打卡时间窗口固定为48小时
- 小凡看见默认私密，需用户主动设置公开
- 不支持退款和退课

### 8.3 资源约束

- 开发周期：2个月
- 团队规模：3-5人
- 服务器成本：< 1000元/月
- 第三方API成本：< 500元/月

## 九、风险和假设

### 9.1 风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 微信审核不通过 | 高 | 中 | 提前准备审核材料，遵守平台规范 |
| AI接口不稳定 | 中 | 中 | 准备备用方案，缓存机制 |
| 用户增长过快 | 中 | 低 | 准备弹性扩容方案 |
| 数据安全问题 | 高 | 低 | 严格的安全措施和备份策略 |

### 9.2 假设

- 用户具备基本的微信小程序使用能力
- 用户有稳定的网络连接
- 用户愿意授权微信登录
- 用户对AI反馈感兴趣
- 课程内容对用户有价值

## 十、后续规划

### 10.1 v2.0 规划

- [ ] 支持多种课程类型（不限于七个习惯）
- [ ] 增加视频课程
- [ ] 支持语音打卡
- [ ] 增加学习小组功能
- [ ] 增加积分和勋章系统
- [ ] 支持课程付费

### 10.2 v3.0 规划

- [ ] 开发Web端
- [ ] 开发App端
- [ ] 增加直播功能
- [ ] 增加1对1辅导功能
- [ ] 开放API给第三方
- [ ] 支持多语言

## 十一、附录

### 11.1 术语表

| 术语 | 说明 |
|------|------|
| 期次 | 晨读营的一期活动，包含23天的课程 |
| 课节 | 期次下的单个课程，对应某一天的学习内容 |
| 打卡 | 用户完成当天学习后提交的学习记录 |
| 小凡看见 | AI根据用户打卡内容生成的个性化反馈 |
| 五步学习法 | 入静、带问题学习、阅读、反思、行动 |
| 连续打卡 | 连续多天完成打卡的天数 |
| 补卡 | 超过时间窗口后的打卡，需要特殊审核 |

### 11.2 页面路由表

| 页面名称 | 路由路径 | 参数 |
|---------|---------|------|
| 首页 | /pages/index/index | - |
| 课程列表 | /pages/courses/courses | periodId, name |
| 课程详情 | /pages/course-detail/course-detail | id |
| 打卡页面 | /pages/checkin/checkin | courseId |
| 个人中心 | /pages/profile/profile | - |
| 小凡看见列表 | /pages/insights/insights | - |
| 小凡看见详情 | /pages/insight-detail/insight-detail | id |
| 分享页面 | /pages/share/share | insightId |
| 排行榜 | /pages/ranking/ranking | periodId |
| 成员列表 | /pages/members/members | periodId |
| 打卡记录 | /pages/checkin-records/checkin-records | - |
| 他人主页 | /pages/profile-others/profile-others | userId |

### 11.3 参考资料

- 微信小程序官方文档：https://developers.weixin.qq.com/miniprogram/dev/framework/
- 微信小程序设计规范：https://developers.weixin.qq.com/miniprogram/design/
- RESTful API设计规范：https://restfulapi.net/
- JWT认证机制：https://jwt.io/

---

**文档结束**

本文档详细描述了《七个习惯晨读营》小程序v1.0的所有功能需求，基于前端实际代码分析得出。后续的数据模型设计、数据库设计和API接口设计将基于本文档展开。
