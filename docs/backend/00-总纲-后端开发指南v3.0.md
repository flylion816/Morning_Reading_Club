# 《高效能人士的七个习惯》晨读营小程序 - 后端开发指南 v3.0

## 文档说明

本文档集基于v1.0前端完整实现，通过分析所有页面代码、Mock数据和业务逻辑，重新梳理了后端开发所需的全部文档。

**版本信息**:

- 文档版本: v3.0
- 对应前端版本: v1.0.0
- 文档更新日期: 2025-01-13
- 文档状态: 可用于后端开发

**重要提示**: 本文档集精准反映了前端v1.0的实际需求，所有数据结构、API接口、业务流程都经过详细验证，可直接用于后端开发，避免前后端对接问题。

---

## 文档导航

本文档集采用模块化结构，共8个文档：

### 📘 [00-总纲-后端开发指南v3.0.md](./00-总纲-后端开发指南v3.0.md) (本文档)

- 项目概述
- 技术栈建议
- 开发环境搭建
- 文档使用说明
- 部署指南

### 📗 [01-PRD-产品需求文档v3.0.md](./01-PRD-产品需求文档v3.0.md)

- 产品概述和定位
- 13个页面的完整功能描述
- 用户故事和使用场景
- 业务规则和约束
- 非功能性需求

### 📙 [02-数据模型设计v3.0.md](./02-数据模型设计v3.0.md)

- 10+个实体的完整定义
- 每个实体的所有字段说明
- 实体关系图
- 枚举类型定义
- 数据验证规则

### 📕 [03-数据库设计v3.0.md](./03-数据库设计v3.0.md)

- MySQL完整建表SQL（可直接执行）
- MongoDB完整Schema定义
- 索引设计（主键、外键、唯一索引、普通索引）
- 完整数据字典
- 初始化数据脚本

### 📔 [04-API接口设计v3.0.md](./04-API接口设计v3.0.md)

- RESTful规范说明
- 50+个API接口详细定义
- 每个接口的完整示例（Request/Response）
- JWT鉴权机制
- 错误码定义（100+种）

### 📓 [05-业务流程设计v3.0.md](./05-业务流程设计v3.0.md)

- 用户注册登录流程
- 打卡完整流程
- 小凡看见生成和申请流程
- 评论互动流程
- 排行榜计算逻辑
- 时序图说明

### 📒 [06-本地存储迁移指南v3.0.md](./06-本地存储迁移指南v3.0.md)

- 所有wx.Storage到后端接口的映射
- 数据迁移策略
- 前端代码改造建议
- 兼容性处理方案

### 📕 [07-系统架构设计v3.0.md](./07-系统架构设计v3.0.md)

- 整体架构图
- 技术选型详解
- 模块划分
- 安全设计
- 性能优化
- 扩展性设计

---

## 项目概述

### 产品简介

《高效能人士的七个习惯》晨读营小程序是一个结合早起、读书、打卡、社交的学习平台。用户可以参加不同期次的晨读营，每天学习一个课节，完成打卡，与其他成员互动，获得AI智能反馈（小凡看见）。

### 核心价值

1. **习惯养成**: 通过23天的持续打卡，帮助用户养成早起读书的习惯
2. **深度学习**: 基于《高效能人士的七个习惯》一书的系统化学习内容
3. **智能反馈**: AI生成的个性化反馈（小凡看见），帮助用户深入思考
4. **社交激励**: 通过排行榜、互动评论、相互鼓励，提升学习动力

### 主要功能模块

1. **用户系统**: 微信登录、个人资料、学习统计
2. **课程系统**: 期次管理、课节内容、五大学习模块
3. **打卡系统**: 日记打卡、多媒体支持、可见范围控制
4. **互动系统**: 评论回复、点赞、查看他人主页
5. **AI反馈**: 小凡看见生成、查看申请、审批流程
6. **统计排名**: 打卡排行榜、成员列表、学习统计

### v1.0前端实现情况

✅ **已完成**:

- 13个页面全部实现
- 所有核心功能界面和交互
- 完整的Mock数据系统
- 本地存储数据管理
- 优雅的UI/UX设计

⏳ **待后端支持**:

- 真实用户注册和身份验证
- 云端数据存储和同步
- 文件上传到云存储
- AI生成小凡看见
- 推送通知
- 支付功能

---

## 技术栈建议

### 后端技术栈

#### 方案A: Node.js + Express (推荐)

**优势**:

- 与前端同语言，便于团队协作
- 生态丰富，开发效率高
- 适合快速迭代

**技术栈**:

```
- 运行环境: Node.js 18+
- Web框架: Express 4.x
- 数据库: MongoDB 6.x (推荐) 或 MySQL 8.x
- ORM/ODM: Mongoose (MongoDB) 或 Sequelize (MySQL)
- 认证: JWT (jsonwebtoken)
- 文件上传: Multer
- 云存储: 腾讯云COS 或 阿里云OSS
- API文档: Swagger
- 日志: Winston
- 进程管理: PM2
```

#### 方案B: Python + Django/FastAPI

**优势**:

- AI集成方便（小凡看见生成）
- 强大的数据处理能力
- 适合后期扩展AI功能

**技术栈**:

```
- 运行环境: Python 3.10+
- Web框架: FastAPI (推荐) 或 Django 4.x
- 数据库: PostgreSQL 14+ 或 MongoDB 6.x
- ORM: SQLAlchemy (SQL) 或 MongoEngine (MongoDB)
- 认证: PyJWT
- AI集成: OpenAI API / 文心一言 / 通义千问
- 异步任务: Celery + Redis
```

#### 方案C: Java + Spring Boot

**优势**:

- 企业级稳定性
- 适合大规模应用
- 严谨的类型系统

**技术栈**:

```
- 运行环境: Java 17+
- Web框架: Spring Boot 3.x
- 数据库: MySQL 8.x 或 PostgreSQL 14+
- ORM: MyBatis Plus 或 JPA
- 认证: Spring Security + JWT
- 缓存: Redis
- 消息队列: RabbitMQ
```

### 数据库选择

#### MongoDB (推荐)

**为什么推荐**:

- ✅ 文档型数据库，灵活的Schema设计
- ✅ 适合快速迭代和功能扩展
- ✅ JSON格式，与前端数据结构完美契合
- ✅ 横向扩展能力强
- ✅ 适合存储富文本、多媒体元数据

**适用场景**:

- 打卡内容（富文本、多媒体）
- 小凡看见（AI生成的长文本）
- 用户行为日志
- 灵活的课程内容结构

#### MySQL

**优势**:

- ✅ 关系型数据库，强一致性
- ✅ 成熟稳定，生态完善
- ✅ 支持复杂查询和事务
- ✅ 适合结构化数据

**适用场景**:

- 用户账号信息
- 订单和支付记录
- 统计和报表数据
- 需要强一致性的业务

#### 混合方案

- **MySQL**: 用户、订单、支付
- **MongoDB**: 打卡、评论、小凡看见、日志
- **Redis**: 缓存、会话、排行榜

### 云服务选择

#### 腾讯云 (推荐 - 微信小程序官方合作)

**服务**:

- 云服务器: CVM
- 数据库: TencentDB (MySQL/MongoDB)
- 对象存储: COS
- CDN: CDN加速
- 小程序云开发: 可选（简化开发）

#### 阿里云

**服务**:

- 云服务器: ECS
- 数据库: RDS (MySQL) / MongoDB
- 对象存储: OSS
- CDN: CDN加速

#### AWS

**服务**:

- 云服务器: EC2
- 数据库: RDS (MySQL) / DocumentDB (MongoDB兼容)
- 对象存储: S3
- CDN: CloudFront

---

## 开发环境搭建

### 本地开发环境

#### Node.js方案

```bash
# 1. 安装Node.js 18+
# 访问 https://nodejs.org 下载安装

# 2. 创建项目
mkdir morning-reading-backend
cd morning-reading-backend
npm init -y

# 3. 安装依赖
npm install express mongoose jsonwebtoken bcryptjs dotenv cors multer

# 4. 安装开发依赖
npm install --save-dev nodemon

# 5. 安装MongoDB（本地开发）
# macOS: brew install mongodb-community
# Windows: 下载 MongoDB Community Server
# Ubuntu: apt install mongodb

# 6. 启动MongoDB
mongod --dbpath ./data/db

# 7. 创建配置文件
echo "PORT=3000
MONGODB_URI=mongodb://localhost:27017/morning-reading
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d" > .env

# 8. 创建项目结构
mkdir -p src/{models,controllers,routes,middleware,utils,config}
```

#### Python方案

```bash
# 1. 安装Python 3.10+
# 访问 https://python.org 下载安装

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. 安装FastAPI及依赖
pip install fastapi uvicorn pymongo motor pydantic python-jose[cryptography] python-multipart

# 4. 创建项目结构
mkdir -p app/{api,models,schemas,services,utils}
```

### 数据库配置

#### MongoDB配置

```javascript
// config/database.js
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true
    });
    console.log('MongoDB connected successfully');
  } catch (error) {
    console.error('MongoDB connection error:', error);
    process.exit(1);
  }
};

module.exports = connectDB;
```

#### MySQL配置

```javascript
// config/database.js
const { Sequelize } = require('sequelize');

const sequelize = new Sequelize(process.env.DB_NAME, process.env.DB_USER, process.env.DB_PASSWORD, {
  host: process.env.DB_HOST,
  dialect: 'mysql',
  logging: false
});

module.exports = sequelize;
```

### 项目结构

```
morning-reading-backend/
├── src/
│   ├── models/              # 数据模型
│   │   ├── User.js
│   │   ├── Period.js
│   │   ├── Section.js
│   │   ├── Checkin.js
│   │   ├── Comment.js
│   │   ├── Insight.js
│   │   └── InsightRequest.js
│   ├── controllers/         # 控制器
│   │   ├── authController.js
│   │   ├── userController.js
│   │   ├── courseController.js
│   │   ├── checkinController.js
│   │   ├── commentController.js
│   │   └── insightController.js
│   ├── routes/              # 路由
│   │   ├── auth.js
│   │   ├── users.js
│   │   ├── courses.js
│   │   ├── checkins.js
│   │   ├── comments.js
│   │   └── insights.js
│   ├── middleware/          # 中间件
│   │   ├── auth.js          # JWT验证
│   │   ├── upload.js        # 文件上传
│   │   └── errorHandler.js  # 错误处理
│   ├── utils/               # 工具函数
│   │   ├── jwt.js
│   │   ├── bcrypt.js
│   │   └── validator.js
│   ├── config/              # 配置
│   │   ├── database.js
│   │   └── cloudStorage.js
│   └── app.js               # 应用入口
├── tests/                   # 测试文件
├── docs/                    # API文档
├── .env                     # 环境变量
├── .gitignore
├── package.json
└── README.md
```

---

## API设计规范

### RESTful API规范

#### URL命名规则

```
# 资源命名使用复数名词
GET    /api/users           # 获取用户列表
GET    /api/users/:id       # 获取单个用户
POST   /api/users           # 创建用户
PUT    /api/users/:id       # 更新用户
DELETE /api/users/:id       # 删除用户

# 嵌套资源
GET    /api/periods/:id/sections           # 获取某期次的所有课节
GET    /api/sections/:id/checkins          # 获取某课节的所有打卡
POST   /api/sections/:id/checkins          # 在某课节创建打卡
```

#### HTTP方法使用

- `GET`: 查询资源
- `POST`: 创建资源
- `PUT`: 完整更新资源
- `PATCH`: 部分更新资源
- `DELETE`: 删除资源

#### HTTP状态码

```
200 OK                  - 请求成功
201 Created             - 创建成功
204 No Content          - 删除成功
400 Bad Request         - 请求参数错误
401 Unauthorized        - 未认证
403 Forbidden           - 无权限
404 Not Found           - 资源不存在
409 Conflict            - 资源冲突
422 Unprocessable Entity - 数据验证失败
500 Internal Server Error - 服务器错误
```

### 响应格式

#### 成功响应

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "用户名"
  }
}
```

#### 列表响应

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      { "id": 1, "name": "item1" },
      { "id": 2, "name": "item2" }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

#### 错误响应

```json
{
  "code": 400,
  "message": "Invalid request parameters",
  "error": {
    "field": "email",
    "message": "Invalid email format"
  }
}
```

### 认证机制

#### JWT Token

```
# 请求头
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Token内容
{
  "userId": 1,
  "openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",
  "iat": 1673945600,
  "exp": 1674550400
}
```

#### 刷新Token

```
POST /api/auth/refresh-token
Request:
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}

Response:
{
  "code": 200,
  "data": {
    "accessToken": "new-access-token",
    "refreshToken": "new-refresh-token"
  }
}
```

---

## 部署指南

### 服务器配置

#### 推荐配置

**开发环境**:

- CPU: 2核
- 内存: 4GB
- 硬盘: 40GB SSD
- 带宽: 1Mbps

**生产环境**:

- CPU: 4核+
- 内存: 8GB+
- 硬盘: 100GB+ SSD
- 带宽: 5Mbps+

### Docker部署

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["node", "src/app.js"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongo:27017/morning-reading
    depends_on:
      - mongo
    restart: unless-stopped

  mongo:
    image: mongo:6
    volumes:
      - mongo-data:/data/db
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped

volumes:
  mongo-data:
```

### CI/CD配置

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to server
        run: |
          ssh user@server "cd /app && git pull && docker-compose up -d --build"
```

---

## 开发流程

### 1. 数据库设计和初始化

```bash
# 1. 阅读 03-数据库设计v3.0.md
# 2. 创建数据库
mongosh
> use morning-reading
> db.createUser({user: "admin", pwd: "password", roles: ["readWrite"]})

# 3. 执行建表脚本（MongoDB不需要）
# 或执行MySQL建表SQL
mysql -u root -p < docs/backend/scripts/init.sql
```

### 2. 数据模型开发

```bash
# 1. 阅读 02-数据模型设计v3.0.md
# 2. 在 src/models/ 目录创建模型文件
# 3. 参考文档定义所有字段和验证规则
```

### 3. API接口开发

```bash
# 1. 阅读 04-API接口设计v3.0.md
# 2. 在 src/routes/ 创建路由文件
# 3. 在 src/controllers/ 实现业务逻辑
# 4. 使用Postman测试API
```

### 4. 业务流程实现

```bash
# 1. 阅读 05-业务流程设计v3.0.md
# 2. 实现关键业务流程
# 3. 编写单元测试
```

### 5. 前端对接

```bash
# 1. 阅读 06-本地存储迁移指南v3.0.md
# 2. 修改前端service文件，替换Mock为真实API
# 3. 测试前后端联调
```

---

## 质量保证

### 代码规范

```javascript
// ESLint配置
{
  "extends": "airbnb-base",
  "rules": {
    "no-console": "off",
    "no-unused-vars": "warn"
  }
}
```

### 测试

```javascript
// 单元测试示例
describe('User API', () => {
  it('should create a new user', async () => {
    const res = await request(app).post('/api/users').send({
      nickname: 'Test User',
      avatar: '😊'
    });
    expect(res.status).toBe(201);
    expect(res.body.data).toHaveProperty('id');
  });
});
```

### API文档

使用Swagger生成API文档：

```javascript
const swaggerJsDoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');

const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: '晨读营API',
      version: '1.0.0'
    }
  },
  apis: ['./src/routes/*.js']
};

const swaggerDocs = swaggerJsDoc(swaggerOptions);
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerDocs));
```

---

## 性能优化

### 数据库优化

1. **索引设计**: 根据查询场景创建合适的索引
2. **查询优化**: 使用explain分析慢查询
3. **连接池**: 配置合适的连接池大小
4. **读写分离**: 使用主从复制分离读写

### 缓存策略

```javascript
// Redis缓存示例
const redis = require('redis');
const client = redis.createClient();

// 缓存用户信息
async function getUserById(userId) {
  const cacheKey = `user:${userId}`;

  // 先查缓存
  const cached = await client.get(cacheKey);
  if (cached) {
    return JSON.parse(cached);
  }

  // 查数据库
  const user = await User.findById(userId);

  // 写入缓存（1小时）
  await client.setEx(cacheKey, 3600, JSON.stringify(user));

  return user;
}
```

### API限流

```javascript
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100 // 最多100次请求
});

app.use('/api/', limiter);
```

---

## 安全措施

### 1. 数据加密

```javascript
// 密码加密
const bcrypt = require('bcryptjs');
const hashedPassword = await bcrypt.hash(password, 10);

// 敏感数据加密
const crypto = require('crypto');
const algorithm = 'aes-256-cbc';
const key = crypto.scryptSync(process.env.SECRET_KEY, 'salt', 32);
```

### 2. SQL注入防护

```javascript
// 使用参数化查询
db.query('SELECT * FROM users WHERE id = ?', [userId]);
```

### 3. XSS防护

```javascript
const helmet = require('helmet');
app.use(helmet());

// 输入验证
const validator = require('validator');
const cleanText = validator.escape(userInput);
```

### 4. CSRF防护

```javascript
const csrf = require('csurf');
const csrfProtection = csrf({ cookie: true });
app.use(csrfProtection);
```

---

## 监控和日志

### 日志系统

```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

### 性能监控

```javascript
// APM监控（如New Relic、阿里云ARMS）
require('newrelic');

// 自定义监控
app.use((req, res, next) => {
  const start = Date.now();
  res.on('finish', () => {
    const duration = Date.now() - start;
    logger.info(`${req.method} ${req.path} - ${res.statusCode} - ${duration}ms`);
  });
  next();
});
```

---

## 常见问题

### Q1: MongoDB还是MySQL？

**建议**: 使用MongoDB，原因：

- 前端数据结构灵活（富文本、多媒体）
- 快速迭代，Schema变更频繁
- 适合文档型数据（打卡、小凡看见）

### Q2: 如何处理文件上传？

**方案**:

1. 用户上传 → 后端临时存储
2. 后端上传到云存储（腾讯云COS）
3. 返回云存储URL给前端
4. 前端使用URL显示文件

### Q3: AI生成小凡看见如何实现？

**方案**:

1. 用户提交打卡 → 异步触发AI生成
2. 调用大语言模型API（OpenAI/文心一言）
3. 将打卡内容作为Prompt
4. 生成后存储到数据库
5. 推送通知给用户

### Q4: 如何实现实时排行榜？

**方案**:

1. 使用Redis Sorted Set存储排行榜
2. 打卡时更新用户积分
3. 定时任务同步到数据库
4. 前端请求时从Redis读取

---

## 下一步行动

### 第一周：基础设施

- [ ] 购买云服务器和域名
- [ ] 配置服务器环境
- [ ] 安装数据库
- [ ] 搭建开发环境
- [ ] 创建Git仓库

### 第二周：数据模型和API

- [ ] 设计并创建数据库表
- [ ] 实现用户认证API
- [ ] 实现课程管理API
- [ ] 实现打卡相关API
- [ ] 编写API文档

### 第三周：业务功能

- [ ] 实现文件上传功能
- [ ] 实现评论互动功能
- [ ] 实现小凡看见功能
- [ ] 实现排行榜功能
- [ ] 集成AI服务

### 第四周：测试和部署

- [ ] 编写单元测试
- [ ] 前后端联调
- [ ] 性能测试
- [ ] 安全测试
- [ ] 正式部署上线

---

## 联系和支持

如有任何问题，请：

1. 查阅本文档集的相关章节
2. 查看代码注释和示例
3. 参考前端v1.0的实现
4. 查阅相关技术文档

---

**文档版本**: v3.0
**最后更新**: 2025-01-13
**维护者**: 开发团队
**状态**: 可用于开发
