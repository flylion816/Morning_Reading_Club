# 业务流程设计 v3.0

## 文档信息

- **文档版本**: v3.0
- **产品版本**: v1.0
- **创建日期**: 2025-01-13
- **文档状态**: 已发布

## 说明

本文档详细描述系统的核心业务流程，包括用户注册、打卡、互动、小凡看见等完整流程。

---

## 一、用户注册与登录流程

### 1.1 微信登录流程

```
┌─────────┐          ┌──────────┐          ┌─────────┐          ┌──────────┐
│ 小程序  │          │ 后端服务 │          │ 数据库  │          │ 微信服务 │
└────┬────┘          └────┬─────┘          └────┬────┘          └────┬─────┘
     │                    │                     │                     │
     │ 1. wx.login()      │                     │                     │
     │───────────────────>│                     │                     │
     │                    │                     │                     │
     │ 2. 返回 code       │                     │                     │
     │<───────────────────│                     │                     │
     │                    │                     │                     │
     │ 3. POST /auth/wechat/login              │                     │
     │    { code: "xxx" } │                     │                     │
     │───────────────────>│                     │                     │
     │                    │                     │                     │
     │                    │ 4. code2Session     │                     │
     │                    │────────────────────────────────────────>│
     │                    │                     │                     │
     │                    │ 5. 返回 openid, session_key             │
     │                    │<────────────────────────────────────────│
     │                    │                     │                     │
     │                    │ 6. 查询用户         │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 7. 返回用户信息     │                     │
     │                    │<────────────────────│                     │
     │                    │                     │                     │
     │                    │ 8. 如果是新用户，创建用户记录            │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 9. 生成 JWT Token   │                     │
     │                    │                     │                     │
     │ 10. 返回 Token & 用户信息                │                     │
     │<───────────────────│                     │                     │
     │                    │                     │                     │
     │ 11. 保存 Token     │                     │                     │
     │                    │                     │                     │
```

**详细步骤**:

1. **小程序端调用 wx.login()**
   - 获取临时登录凭证 code
   - code 有效期 5 分钟

2. **小程序发送 code 到后端**
   - POST /auth/wechat/login
   - 请求体: `{ code: "061YaF100..." }`

3. **后端调用微信 code2Session 接口**
   - URL: `https://api.weixin.qq.com/sns/jscode2session`
   - 参数: appid, secret, js_code, grant_type
   - 返回: openid, session_key, unionid(可选)

4. **后端根据 openid 查询用户**
   - 如果用户存在: 更新 lastLoginAt
   - 如果用户不存在: 创建新用户
     - openid: 来自微信
     - nickname: 默认"微信用户"
     - avatar: 默认"🦁"
     - role: "user"
     - status: "active"

5. **生成 JWT Token**
   - Access Token: 有效期 2 小时
   - Refresh Token: 有效期 30 天
   - Payload: userId, openid, role

6. **返回登录结果**

   ```json
   {
     "code": 200,
     "message": "登录成功",
     "data": {
       "accessToken": "eyJhbG...",
       "refreshToken": "eyJhbG...",
       "expiresIn": 7200,
       "user": {
         "id": 1,
         "openid": "o6_bmjr...",
         "nickname": "微信用户",
         "avatar": "🦁",
         "role": "user",
         "isNewUser": true
       }
     }
   }
   ```

7. **小程序保存 Token**
   - 使用 wx.setStorageSync('accessToken', token)
   - 使用 wx.setStorageSync('refreshToken', refreshToken)
   - 使用 wx.setStorageSync('userInfo', user)

**新用户引导流程**:

```
如果 isNewUser === true:
  1. 显示欢迎页面
  2. 引导完善个人信息（昵称、头像、签名）
  3. PATCH /users/me 更新信息
  4. 引导浏览期次列表
  5. 引导报名第一个期次
```

---

## 二、期次报名流程

### 2.1 浏览期次列表

```
用户操作: 进入首页/期次列表页
  ↓
小程序: GET /periods?status=ongoing&isPublished=true
  ↓
后端: 查询数据库
  ↓
返回: 期次列表（包含报名状态、进度等）
  ↓
小程序: 展示期次卡片
  - 期次名称、图标、时间范围
  - 当前报名人数
  - 如果已报名：显示进度、打卡天数
  - 如果未报名：显示报名按钮
```

### 2.2 报名期次流程

```
┌─────────┐          ┌──────────┐          ┌─────────┐          ┌──────────┐
│ 用户    │          │ 后端服务 │          │ 数据库  │          │ 微信支付 │
└────┬────┘          └────┬─────┘          └────┬────┘          └────┬─────┘
     │                    │                     │                     │
     │ 1. 点击报名按钮    │                     │                     │
     │                    │                     │                     │
     │ 2. POST /periods/8/enroll               │                     │
     │───────────────────>│                     │                     │
     │                    │                     │                     │
     │                    │ 3. 验证报名资格     │                     │
     │                    │  - 检查是否已报名   │                     │
     │                    │  - 检查期次状态     │                     │
     │                    │  - 检查报名人数     │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 4. 创建报名记录     │                     │
     │                    │    status: active   │                     │
     │                    │    paymentStatus: unpaid                 │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 5. 更新期次报名人数 │                     │
     │                    │    currentEnrollment++                   │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 6. 如果需要支付     │                     │
     │                    │    调用微信统一下单 │                     │
     │                    │────────────────────────────────────────>│
     │                    │                     │                     │
     │                    │ 7. 返回支付参数     │                     │
     │                    │<────────────────────────────────────────│
     │                    │                     │                     │
     │ 8. 返回报名结果 & 支付信息               │                     │
     │<───────────────────│                     │                     │
     │                    │                     │                     │
     │ 9. 调起微信支付    │                     │                     │
     │────────────────────────────────────────────────────────────>│
     │                    │                     │                     │
     │ 10. 支付完成回调   │                     │                     │
     │────────────────────>│                     │                     │
     │                    │                     │                     │
     │                    │ 11. 更新支付状态    │                     │
     │                    │     paymentStatus: paid                  │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │ 12. 报名成功提示   │                     │                     │
     │                    │                     │                     │
```

**详细步骤**:

1. **用户点击报名**
   - 显示期次详情弹窗
   - 展示价格、时间、内容介绍
   - 确认报名

2. **前端验证**
   - 检查是否已登录
   - 检查期次状态（未开始或进行中才能报名）

3. **后端验证报名资格**

   ```javascript
   // 检查是否已报名
   const existingEnrollment = await Enrollment.findOne({
     userId,
     periodId
   });
   if (existingEnrollment) {
     throw new Error('已经报名过该期次');
   }

   // 检查期次状态
   const period = await Period.findById(periodId);
   if (period.status === 'completed') {
     throw new Error('期次已结束，不能报名');
   }

   // 检查报名人数
   if (period.maxEnrollment && period.currentEnrollment >= period.maxEnrollment) {
     throw new Error('报名人数已满');
   }
   ```

4. **创建报名记录**

   ```javascript
   const enrollment = await Enrollment.create({
     userId,
     periodId,
     status: 'active',
     checkinDays: 0,
     totalDays: period.totalDays,
     progress: 0,
     paymentStatus: period.price > 0 ? 'unpaid' : 'paid',
     paymentAmount: period.price,
     orderNo: generateOrderNo()
   });
   ```

5. **如果需要支付**
   - 调用微信统一下单接口
   - 返回支付参数给小程序
   - 小程序调起微信支付

6. **支付回调处理**

   ```javascript
   // 微信支付回调
   app.post('/payments/wechat/callback', async (req, res) => {
     // 验证签名
     const isValid = verifyWechatSign(req.body);

     if (isValid) {
       // 更新订单状态
       await Enrollment.updateOne(
         { orderNo: req.body.out_trade_no },
         {
           paymentStatus: 'paid',
           paymentAt: new Date()
         }
       );

       // 发送报名成功通知
       await sendEnrollmentNotification(enrollment);
     }

     res.json({ code: 'SUCCESS', message: '成功' });
   });
   ```

7. **报名成功处理**
   - 更新期次报名人数
   - 发送报名成功通知
   - 返回报名结果

**免费报名流程**:

如果 period.price === 0:

- 跳过支付步骤
- 直接设置 paymentStatus = 'paid'
- 立即返回报名成功

---

## 三、打卡完整流程

### 3.1 打卡前置流程

```
用户进入首页/个人中心
  ↓
GET /sections/today (获取今日任务)
  ↓
后端查询:
  1. 查询用户的所有active报名
  2. 查询这些期次中，当前时间在打卡范围内的课节
  3. 检查用户是否已打卡
  ↓
返回今日任务列表
  ↓
小程序展示:
  - 课节标题、封面、时间范围
  - 已打卡人数
  - 打卡按钮（如果未打卡）
  - 已打卡标识（如果已打卡）
```

### 3.2 打卡主流程

```
┌─────────┐          ┌──────────┐          ┌─────────┐          ┌──────────┐
│ 用户    │          │ 后端服务 │          │ 数据库  │          │ AI服务   │
└────┬────┘          └────┬─────┘          └────┬────┘          └────┬─────┘
     │                    │                     │                     │
     │ 1. 点击打卡按钮    │                     │                     │
     │                    │                     │                     │
     │ 2. 进入打卡页面    │                     │                     │
     │    GET /sections/802                    │                     │
     │───────────────────>│                     │                     │
     │                    │                     │                     │
     │                    │ 3. 查询课节内容     │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │ 4. 返回课节内容    │                     │                     │
     │    (静一静、问一问、读一读、想一想、记一记)                   │
     │<───────────────────│                     │                     │
     │                    │                     │                     │
     │ 5. 用户阅读内容    │                     │                     │
     │    完成冥想、思考  │                     │                     │
     │                    │                     │                     │
     │ 6. 填写打卡内容    │                     │                     │
     │    - 输入文字      │                     │                     │
     │    - 上传图片(可选)│                     │                     │
     │    - 录制语音(可选)│                     │                     │
     │    - 选择可见性    │                     │                     │
     │                    │                     │                     │
     │ 7. 如果有图片/语音 │                     │                     │
     │    POST /upload/image                   │                     │
     │───────────────────>│                     │                     │
     │                    │                     │                     │
     │                    │ 8. 上传到云存储     │                     │
     │                    │    (腾讯云COS)      │                     │
     │                    │                     │                     │
     │ 9. 返回文件URL     │                     │                     │
     │<───────────────────│                     │                     │
     │                    │                     │                     │
     │ 10. 提交打卡       │                     │                     │
     │     POST /checkins │                     │                     │
     │     {              │                     │                     │
     │       sectionId: 802,                    │                     │
     │       content: "...",                    │                     │
     │       images: [...],                     │                     │
     │       visibility: "all"                  │                     │
     │     }              │                     │                     │
     │───────────────────>│                     │                     │
     │                    │                     │                     │
     │                    │ 11. 验证打卡资格    │                     │
     │                    │   - 检查是否已打卡  │                     │
     │                    │   - 检查打卡时间    │                     │
     │                    │   - 检查是否报名    │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 12. 创建打卡记录    │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 13. 创建文件关联    │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 14. 更新用户统计    │                     │
     │                    │   - totalCheckinDays++                   │
     │                    │   - currentStreak计算                    │
     │                    │   - maxStreak更新   │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 15. 更新报名进度    │                     │
     │                    │   - checkinDays++   │                     │
     │                    │   - progress计算    │                     │
     │                    │   - lastCheckinAt更新                    │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 16. 更新课节打卡数  │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │ 17. 返回打卡结果   │                     │                     │
     │<───────────────────│                     │                     │
     │                    │                     │                     │
     │ 18. 显示打卡成功   │                     │                     │
     │     提示生成小凡看见                     │                     │
     │                    │                     │                     │
     │ 19. 用户点击生成   │                     │                     │
     │     POST /insights │                     │                     │
     │     {              │                     │                     │
     │       checkinId: 1,                      │                     │
     │       visibility: "private"              │                     │
     │     }              │                     │                     │
     │───────────────────>│                     │                     │
     │                    │                     │                     │
     │                    │ 20. 调用AI服务生成  │                     │
     │                    │────────────────────────────────────────>│
     │                    │                     │                     │
     │                    │ 21. 返回AI生成内容  │                     │
     │                    │<────────────────────────────────────────│
     │                    │                     │                     │
     │                    │ 22. 保存小凡看见    │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │ 23. 返回小凡看见   │                     │                     │
     │<───────────────────│                     │                     │
     │                    │                     │                     │
     │ 24. 显示小凡看见   │                     │                     │
     │     打卡流程完成   │                     │                     │
     │                    │                     │                     │
```

**打卡验证逻辑**:

```javascript
// 1. 检查是否已打卡
const existingCheckin = await Checkin.findOne({
  userId,
  sectionId
});
if (existingCheckin) {
  throw new Error('已经打卡过该课节', 40906);
}

// 2. 检查打卡时间
const section = await Section.findById(sectionId);
const now = new Date();
if (now < section.startTime || now > section.endTime) {
  throw new Error('不在打卡时间范围内', 40905);
}

// 3. 检查是否报名
const enrollment = await Enrollment.findOne({
  userId,
  periodId: section.periodId,
  status: 'active'
});
if (!enrollment) {
  throw new Error('未报名该期次', 40301);
}

// 4. 验证内容
if (!content || content.length < 10) {
  throw new Error('打卡内容至少10个字符', 40001);
}
```

**连续打卡天数计算**:

```javascript
async function updateUserStreak(userId) {
  const user = await User.findById(userId);
  const lastCheckin = await Checkin.findOne({ userId }).sort({ createdAt: -1 }).skip(1); // 跳过刚创建的打卡

  if (!lastCheckin) {
    // 第一次打卡
    user.currentStreak = 1;
    user.maxStreak = 1;
  } else {
    const daysDiff = getDaysDiff(lastCheckin.createdAt, new Date());

    if (daysDiff === 1) {
      // 连续打卡
      user.currentStreak += 1;
      user.maxStreak = Math.max(user.maxStreak, user.currentStreak);
    } else if (daysDiff > 1) {
      // 中断，重新开始
      user.currentStreak = 1;
    }
    // daysDiff === 0 表示同一天多次打卡，不更新连续天数
  }

  user.totalCheckinDays += 1;
  await user.save();
}
```

---

## 四、互动流程（评论、点赞）

### 4.1 浏览打卡广场

```
用户进入打卡广场/首页feed流
  ↓
GET /checkins?periodId=8&page=1&pageSize=20
  ↓
后端查询:
  1. 查询符合条件的打卡记录
  2. 关联查询用户信息
  3. 查询当前用户的点赞状态
  4. 计算时间格式化
  ↓
返回打卡列表
  ↓
小程序展示:
  - 用户头像、昵称
  - 打卡内容、图片
  - 点赞数、评论数
  - 点赞按钮、评论按钮
```

### 4.2 点赞流程

```
┌─────────┐          ┌──────────┐          ┌─────────┐          ┌──────────┐
│ 用户    │          │ 后端服务 │          │ 数据库  │          │ 通知服务 │
└────┬────┘          └────┬─────┘          └────┬────┘          └────┬─────┘
     │                    │                     │                     │
     │ 1. 点击点赞按钮    │                     │                     │
     │    POST /checkins/1/like                │                     │
     │    { action: "like" }                   │                     │
     │───────────────────>│                     │                     │
     │                    │                     │                     │
     │                    │ 2. 检查是否已点赞   │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 3. 如果未点赞       │                     │
     │                    │    创建点赞记录     │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 4. 更新打卡点赞数   │                     │
     │                    │    likeCount++      │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 5. 创建通知         │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 6. 发送通知（异步） │                     │
     │                    │────────────────────────────────────────>│
     │                    │                     │                     │
     │ 7. 返回点赞结果    │                     │                     │
     │    { isLiked: true, likeCount: 6 }      │                     │
     │<───────────────────│                     │                     │
     │                    │                     │                     │
     │ 8. 更新UI          │                     │                     │
     │    - 按钮变红色    │                     │                     │
     │    - 点赞数+1      │                     │                     │
     │                    │                     │                     │
```

**点赞逻辑实现**:

```javascript
async function toggleLike(userId, checkinId, action) {
  const existingLike = await CheckinLike.findOne({ userId, checkinId });

  if (action === 'like') {
    if (existingLike) {
      // 已经点赞，无需操作
      return { isLiked: true, alreadyLiked: true };
    }

    // 开启事务
    const session = await mongoose.startSession();
    await session.startTransaction();

    try {
      // 创建点赞记录
      await CheckinLike.create([{ userId, checkinId }], { session });

      // 更新点赞数
      await Checkin.updateOne({ _id: checkinId }, { $inc: { likeCount: 1 } }, { session });

      // 创建通知（如果不是自己的打卡）
      const checkin = await Checkin.findById(checkinId);
      if (checkin.userId.toString() !== userId) {
        await Notification.create(
          [
            {
              userId: checkin.userId,
              type: 'like',
              fromUserId: userId,
              relatedType: 'checkin',
              relatedId: checkinId
            }
          ],
          { session }
        );
      }

      await session.commitTransaction();

      return { isLiked: true, likeCount: checkin.likeCount + 1 };
    } catch (error) {
      await session.abortTransaction();
      throw error;
    } finally {
      session.endSession();
    }
  } else if (action === 'unlike') {
    // 取消点赞逻辑
    // ...类似实现
  }
}
```

### 4.3 评论流程

```
用户点击评论按钮
  ↓
进入打卡详情页
  ↓
GET /checkins/1 (获取打卡详情)
GET /checkins/1/comments (获取评论列表)
  ↓
展示打卡内容和评论列表
  ↓
用户输入评论内容
  ↓
POST /checkins/1/comments
{
  "content": "写得很好！"
}
  ↓
后端验证并创建评论:
  1. 验证内容不为空
  2. 创建评论记录
  3. 更新打卡评论数 (commentCount++)
  4. 创建通知
  ↓
返回评论结果
  ↓
小程序更新UI:
  - 评论列表添加新评论
  - 评论数+1
  - 清空输入框
```

### 4.4 回复流程

```
用户点击评论的回复按钮
  ↓
输入回复内容
  ↓
POST /comments/1/replies
{
  "content": "谢谢你的鼓励！",
  "toUserId": 2
}
  ↓
后端处理:
  1. 创建回复记录
  2. 更新评论回复数 (replyCount++)
  3. 创建通知（通知评论者）
  4. 如果是回复某人，也通知被回复者
  ↓
返回回复结果
  ↓
小程序更新UI:
  - 评论下方展开回复列表
  - 添加新回复
  - 回复数+1
```

---

## 五、小凡看见流程

### 5.1 生成小凡看见

```
┌─────────┐          ┌──────────┐          ┌─────────┐          ┌──────────┐
│ 用户    │          │ 后端服务 │          │ 数据库  │          │ AI服务   │
└────┬────┘          └────┬─────┘          └────┬────┘          └────┬─────┘
     │                    │                     │                     │
     │ 1. 打卡成功后      │                     │                     │
     │    显示生成小凡看见按钮                  │                     │
     │                    │                     │                     │
     │ 2. 点击生成按钮    │                     │                     │
     │    POST /insights  │                     │                     │
     │    {               │                     │                     │
     │      checkinId: 1, │                     │                     │
     │      visibility: "private"               │                     │
     │    }               │                     │                     │
     │───────────────────>│                     │                     │
     │                    │                     │                     │
     │ 3. 显示加载动画    │                     │                     │
     │                    │                     │                     │
     │                    │ 4. 验证权限         │                     │
     │                    │   - 检查是否自己的打卡                    │
     │                    │   - 检查是否已生成  │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 5. 获取打卡内容     │                     │
     │                    │    和课节内容       │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │                    │ 6. 构建AI提示词     │                     │
     │                    │    Prompt = {       │                     │
     │                    │      课节内容,      │                     │
     │                    │      用户打卡内容,  │                     │
     │                    │      生成要求       │                     │
     │                    │    }                │                     │
     │                    │                     │                     │
     │                    │ 7. 调用AI API       │                     │
     │                    │────────────────────────────────────────>│
     │                    │                     │                     │
     │                    │                     │      ┌──────────┐  │
     │                    │                     │      │ AI处理   │  │
     │                    │                     │      │ - 理解内容│ │
     │                    │                     │      │ - 生成反馈│ │
     │                    │                     │      └──────────┘  │
     │                    │                     │                     │
     │                    │ 8. 返回AI生成内容   │                     │
     │                    │<────────────────────────────────────────│
     │                    │                     │                     │
     │                    │ 9. 保存小凡看见     │                     │
     │                    │    - userId         │                     │
     │                    │    - checkinId      │                     │
     │                    │    - sectionId      │                     │
     │                    │    - content (AI生成)                    │
     │                    │    - visibility     │                     │
     │                    │    - aiModel        │                     │
     │                    │────────────────────>│                     │
     │                    │                     │                     │
     │ 10. 返回小凡看见   │                     │                     │
     │<───────────────────│                     │                     │
     │                    │                     │                     │
     │ 11. 展示小凡看见   │                     │                     │
     │     - 打字机效果展示                     │                     │
     │     - 显示可见性设置                     │                     │
     │                    │                     │                     │
```

**AI提示词构建**:

```javascript
function buildInsightPrompt(section, checkin) {
  return `
你是小凡，一位温暖、智慧的AI陪伴者。你的任务是为用户的晨读打卡提供个性化的反馈。

【今日课节】
标题: ${section.title}
内容摘要: ${section.content.substring(0, 500)}...

【用户分享】
${checkin.content}

【生成要求】
1. 以第一人称"我"的视角，代表小凡与用户对话
2. 从用户的分享中，找到1-2个值得深入探讨的点
3. 用温暖、共情的语言给予反馈和鼓励
4. 提出1-2个启发性问题，帮助用户深入思考
5. 字数控制在150-300字
6. 语言风格：温暖、真诚、有深度，避免说教

请生成小凡看见的内容：
`;
}
```

**AI生成示例**:

```
从你的分享中，小凡看见了你对"品德成功论"的深刻理解。你提到的"真正的成功是由内而外的"，这让我想起史蒂芬·柯维所说的，品德是一个人的根基，而技巧只是枝叶。

我特别注意到你说"过去总是追求外在的认可"，这是一个很重要的觉察。你现在开始思考什么才是真正重要的，这本身就是成长的开始。

想请教你一个问题：在你的生活中，有哪些时刻让你感受到"由内而外"的力量？或者，有没有什么具体的实践，可以帮助你建立品德的根基？

期待你的继续探索。
```

### 5.2 查看小凡看见流程

```
用户进入个人中心
  ↓
GET /users/me/insights (获取小凡看见列表)
  ↓
展示按章节分组的小凡看见卡片
  - 第一天、第二天...
  - 每个卡片显示预览
  ↓
点击某个卡片
  ↓
GET /insights/:id (获取完整内容)
  ↓
展示小凡看见详情:
  - 课节标题
  - 完整内容
  - 可见性设置
  - 查看次数
  - 申请查看次数
```

### 5.3 申请查看他人小凡看见

```
用户在打卡详情页看到:
  "该打卡有小凡看见（需要申请查看）"
  ↓
点击申请查看按钮
  ↓
POST /insights/:id/request
{
  "message": "想看看你的感悟"
}
  ↓
后端处理:
  1. 验证小凡看见可见性（必须是friends）
  2. 检查是否已申请
  3. 创建申请记录
  4. 创建通知（通知被申请人）
  5. 更新小凡看见申请次数
  ↓
返回申请结果
  ↓
显示"申请已发送，等待对方同意"
  ↓
被申请人收到通知
  ↓
进入个人中心-收到的申请
  ↓
GET /insight-requests/received (获取申请列表)
  ↓
展示申请列表:
  - 申请人信息
  - 申请留言
  - 同意/拒绝按钮
  ↓
点击同意/拒绝
  ↓
PATCH /insight-requests/:id
{
  "status": "approved",
  "replyMessage": "可以的"
}
  ↓
后端处理:
  1. 更新申请状态
  2. 设置处理时间
  3. 创建通知（通知申请人）
  ↓
申请人收到通知
  ↓
可以查看小凡看见内容
```

---

## 六、排行榜计算流程

### 6.1 打卡排行榜

```
计算逻辑:
  ↓
实时计算（用户请求时）:
  1. 查询该期次的所有报名记录
  2. 按 checkinDays 降序排序
  3. 如果天数相同，按 lastCheckinAt 升序（早打卡的排前面）
  4. 计算排名（rank = index + 1）
  5. 查找当前用户的排名
  ↓
缓存策略:
  - 使用Redis缓存排行榜数据
  - 缓存key: rankings:checkins:period:{periodId}
  - 缓存时间: 1分钟
  - 用户打卡时，清除对应期次的缓存
  ↓
返回排行榜数据
```

**实现代码**:

```javascript
async function getCheckinRankings(periodId, userId, page = 1, pageSize = 50) {
  const cacheKey = `rankings:checkins:period:${periodId}`;

  // 尝试从缓存获取
  let rankings = await redis.get(cacheKey);

  if (!rankings) {
    // 查询数据库
    const enrollments = await Enrollment.find({
      periodId,
      status: { $in: ['active', 'completed'] }
    })
      .populate('userId', 'nickname avatar')
      .sort({ checkinDays: -1, lastCheckinAt: 1 })
      .lean();

    // 计算排名
    rankings = enrollments.map((enrollment, index) => ({
      rank: index + 1,
      userId: enrollment.userId._id,
      userName: enrollment.userId.nickname,
      userAvatar: enrollment.userId.avatar,
      checkinDays: enrollment.checkinDays,
      totalDays: enrollment.totalDays,
      progress: Math.round((enrollment.checkinDays / enrollment.totalDays) * 100),
      currentStreak: enrollment.currentStreak || 0
    }));

    // 缓存结果
    await redis.setex(cacheKey, 60, JSON.stringify(rankings));
  } else {
    rankings = JSON.parse(rankings);
  }

  // 查找当前用户排名
  const myRank = rankings.find(r => r.userId.toString() === userId);

  // 分页
  const start = (page - 1) * pageSize;
  const items = rankings.slice(start, start + pageSize);

  return {
    myRank,
    items,
    pagination: {
      page,
      pageSize,
      total: rankings.length,
      totalPages: Math.ceil(rankings.length / pageSize)
    }
  };
}
```

### 6.2 积分排行榜

```
计算逻辑:
  ↓
查询所有用户:
  1. 按 totalPoints 降序排序
  2. 如果积分相同，按 totalCheckinDays 降序
  3. 如果还相同，按 createdAt 升序（早注册的排前面）
  ↓
缓存策略:
  - 缓存key: rankings:points:global
  - 缓存时间: 5分钟
  - 用户积分变化时，清除缓存
  ↓
返回排行榜数据
```

---

## 七、数据同步与一致性

### 7.1 计数器同步

```
问题: likeCount, commentCount 等计数器字段与实际数据不一致

解决方案:
  ↓
方案1: 实时同步（推荐）
  - 使用数据库事务
  - 创建/删除时，同步更新计数器
  - 优点: 数据一致性强
  - 缺点: 性能略低
  ↓
方案2: Redis + 定时同步
  - 点赞/评论时，更新Redis计数器
  - 定时任务（每分钟）同步到数据库
  - 优点: 性能高
  - 缺点: 可能短暂不一致
  ↓
方案3: 混合方案
  - 热门数据使用Redis
  - 普通数据使用实时同步
```

**实时同步示例**:

```javascript
// 创建评论时
async function createComment(data) {
  const session = await mongoose.startSession();
  await session.startTransaction();

  try {
    // 创建评论
    const comment = await Comment.create([data], { session });

    // 更新打卡评论数
    await Checkin.updateOne({ _id: data.checkinId }, { $inc: { commentCount: 1 } }, { session });

    await session.commitTransaction();
    return comment[0];
  } catch (error) {
    await session.abortTransaction();
    throw error;
  } finally {
    session.endSession();
  }
}

// 删除评论时
async function deleteComment(commentId) {
  const session = await mongoose.startSession();
  await session.startTransaction();

  try {
    const comment = await Comment.findById(commentId);

    // 软删除评论
    await Comment.updateOne({ _id: commentId }, { status: 'deleted' }, { session });

    // 更新打卡评论数
    await Checkin.updateOne(
      { _id: comment.checkinId },
      { $inc: { commentCount: -1 } },
      { session }
    );

    await session.commitTransaction();
  } catch (error) {
    await session.abortTransaction();
    throw error;
  } finally {
    session.endSession();
  }
}
```

### 7.2 定时任务

```
任务列表:
  ↓
1. 更新期次状态（每小时执行）
   - 检查开始时间，更新 status = 'ongoing'
   - 检查结束时间，更新 status = 'completed'
  ↓
2. 计算完成进度（每天凌晨执行）
   - 遍历所有active报名
   - 计算 progress = (checkinDays / totalDays) * 100
   - 如果progress >= 80 && 期次已结束，更新status = 'completed'
  ↓
3. 清理过期数据（每周执行）
   - 删除6个月前的已删除记录
   - 清理未使用的文件
  ↓
4. 同步计数器（每分钟执行，如使用Redis方案）
   - 从Redis读取计数器
   - 批量更新到数据库
  ↓
5. 生成数据统计报表（每天执行）
   - 用户增长统计
   - 打卡统计
   - 活跃度统计
```

**定时任务实现**:

```javascript
const cron = require('node-cron');

// 每小时更新期次状态
cron.schedule('0 * * * *', async () => {
  console.log('Running: Update period status');

  const now = new Date();

  // 更新为进行中
  await Period.updateMany(
    {
      status: 'not_started',
      startDate: { $lte: now }
    },
    { status: 'ongoing' }
  );

  // 更新为已完成
  await Period.updateMany(
    {
      status: 'ongoing',
      endDate: { $lt: now }
    },
    { status: 'completed' }
  );
});

// 每天凌晨计算完成进度
cron.schedule('0 0 * * *', async () => {
  console.log('Running: Calculate enrollment progress');

  const activeEnrollments = await Enrollment.find({ status: 'active' });

  for (const enrollment of activeEnrollments) {
    const progress = Math.round((enrollment.checkinDays / enrollment.totalDays) * 100);

    enrollment.progress = progress;

    // 检查是否完成
    const period = await Period.findById(enrollment.periodId);
    if (progress >= 80 && period.status === 'completed') {
      enrollment.status = 'completed';
      enrollment.completedAt = new Date();

      // 更新用户完成期数
      await User.updateOne({ _id: enrollment.userId }, { $inc: { totalCompletedPeriods: 1 } });
    }

    await enrollment.save();
  }
});
```

---

## 八、异常处理流程

### 8.1 网络异常

```
小程序端:
  ↓
请求失败
  ↓
判断错误类型:
  - 网络断开: 显示"网络连接失败"
  - 超时: 显示"请求超时，请重试"
  - 服务器错误: 显示"服务暂时不可用"
  ↓
提供重试按钮
  ↓
自动重试（最多3次）
  - 第1次: 立即重试
  - 第2次: 2秒后重试
  - 第3次: 5秒后重试
  ↓
如果仍然失败:
  - 保存到本地（如打卡内容）
  - 提示用户稍后会自动上传
  - 网络恢复后自动重试
```

### 8.2 支付异常

```
场景1: 支付中断
  用户取消支付
  ↓
  返回报名页面
  ↓
  订单状态保持unpaid
  ↓
  可以重新发起支付

场景2: 支付成功但回调失败
  微信支付成功
  ↓
  回调失败（网络问题）
  ↓
  订单状态仍为unpaid
  ↓
  定时任务检查订单状态
  ↓
  调用微信查询接口
  ↓
  如果已支付，更新订单状态

场景3: 重复支付
  用户多次点击支付
  ↓
  后端检查订单状态
  ↓
  如果已支付，直接返回成功
  ↓
  如果未支付，继续支付流程
```

### 8.3 数据冲突

```
场景: 并发打卡
  两个请求同时打卡同一课节
  ↓
  数据库层面:
    使用唯一索引 (userId, sectionId)
  ↓
  第一个请求: 创建成功
  第二个请求: 违反唯一约束，抛出错误
  ↓
  后端捕获错误:
    判断是重复打卡错误
  ↓
  返回友好提示:
    "您已经打卡过该课节"
```

---

**文档版本**: v3.0  
**最后更新**: 2025-01-13  
**文档状态**: 已完成
