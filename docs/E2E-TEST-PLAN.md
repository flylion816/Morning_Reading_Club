# 端到端测试计划 (E2E Test Plan)

## 📋 测试概述

本文档定义了晨读营管理系统的完整端到端测试计划，覆盖核心业务流程和功能模块。

**测试工具**：
- 后端单元测试：Mocha + Chai
- 前端组件测试：Vitest
- E2E 测试：Cypress（推荐）或 Playwright
- API 测试：Postman / REST Client

**覆盖范围**：
- ✅ 用户认证流程
- ✅ 报名和支付流程
- ✅ 批量操作功能
- ✅ 数据分析和报表
- ✅ 审计日志追踪
- ✅ 性能和稳定性

---

## 🔐 模块 1：用户认证 (Authentication)

### 测试场景 1.1：管理员登录
```
前置条件：系统已启动，管理员账户存在
步骤：
1. 访问登录页面 (http://localhost:5173/login)
2. 输入有效的用户名和密码
3. 点击登录按钮
4. 等待页面重定向

期望结果：
✓ 登录成功
✓ 重定向到仪表板
✓ Token 保存到 localStorage
✓ 用户信息在页面顶部显示
```

**测试代码示例**（Cypress）：
```javascript
describe('Admin Login', () => {
  it('should login with valid credentials', () => {
    cy.visit('http://localhost:5173/login')
    cy.get('input[placeholder*="邮箱"]').type('admin@morningreading.com')
    cy.get('input[type="password"]').type('admin123')
    cy.get('button:contains("登录")').click()
    cy.url().should('include', '/')
    cy.get('.user-name').should('contain', '系统管理员')
  })
})
```

### 测试场景 1.2：登录失败处理
```
前置条件：系统已启动
步骤：
1. 访问登录页面
2. 输入错误的密码
3. 点击登录按钮

期望结果：
✓ 显示错误提示消息
✓ 保持在登录页面
✓ Token 未保存
```

### 测试场景 1.3：会话过期处理
```
前置条件：已登录，Token 已过期
步骤：
1. 访问受保护的页面
2. API 返回 401 未授权

期望结果：
✓ 自动跳转到登录页面
✓ 显示会话过期提示
✓ localStorage 中的 Token 被清除
```

---

## 📝 模块 2：报名管理 (Enrollment Management)

### 测试场景 2.1：查看报名列表
```
前置条件：已登录，数据库中存在多个报名记录
步骤：
1. 点击菜单中的"报名管理"
2. 等待列表加载
3. 检查分页功能
4. 尝试筛选和排序

期望结果：
✓ 列表显示所有报名
✓ 分页正确显示
✓ 筛选有效（按状态、期次、日期等）
✓ 排序正确（按创建时间、报名时间）
✓ 表格加载耗时 < 2 秒
```

### 测试场景 2.2：批量批准报名
```
前置条件：列表中存在多个待审批的报名记录
步骤：
1. 勾选多个待审批的报名
2. 点击"批量批准"按钮
3. 在确认对话中点击"确认"
4. 等待操作完成

期望结果：
✓ 显示"已选中 X 条记录"
✓ 确认对话显示
✓ 批量操作成功
✓ 列表自动刷新
✓ 被批准的报名状态变为"已批准"
✓ 审计日志中记录此操作
```

### 测试场景 2.3：批量拒绝报名
```
前置条件：列表中存在多个待审批的报名
步骤：
1. 选择多个报名
2. 点击"批量拒绝"
3. 输入拒绝原因
4. 确认操作

期望结果：
✓ 报名状态变为"已拒绝"
✓ 拒绝原因被保存
✓ 发送通知（邮件或站内信）
✓ 审计日志记录
```

### 测试场景 2.4：批量删除报名
```
前置条件：存在可删除的报名记录
步骤：
1. 选择多个报名
2. 点击"批量删除"
3. 点击警告对话中的"确认删除"

期望结果：
✓ 显示警告提示
✓ 报名被物理删除
✓ 列表更新
✓ 审计日志记录删除操作
```

---

## 💳 模块 3：支付管理 (Payment Management)

### 测试场景 3.1：查看支付记录
```
前置条件：已登录，数据库中存在支付记录
步骤：
1. 点击"支付记录"菜单
2. 查看支付列表

期望结果：
✓ 显示所有支付记录
✓ 显示状态（待支付、处理中、已完成、失败）
✓ 分页和筛选正常工作
```

### 测试场景 3.2：支付状态追踪
```
前置条件：存在处理中的支付
步骤：
1. 查看支付详情
2. 查看支付历史和状态变化

期望结果：
✓ 显示完整的支付流程
✓ 显示微信交易号
✓ 显示支付时间和金额
```

---

## 📊 模块 4：数据分析 (Analytics)

### 测试场景 4.1：加载分析仪表板
```
前置条件：已登录
步骤：
1. 点击"数据分析"菜单
2. 等待图表加载

期望结果：
✓ 页面在 3 秒内加载完成
✓ 所有统计卡片显示
✓ 四个图表正确渲染
✓ 数据准确（与数据库对比）
```

### 测试场景 4.2：图表交互
```
前置条件：分析页面已加载
步骤：
1. 悬停在图表上查看数据提示
2. 点击图例切换数据显示
3. 拖动图表进行缩放
4. 点击导出按钮导出数据

期望结果：
✓ 数据提示显示正确的值
✓ 图例切换有效
✓ 缩放功能工作
✓ 导出生成 CSV 文件
```

### 测试场景 4.3：日期范围筛选
```
前置条件：分析页面已加载
步骤：
1. 选择日期范围
2. 点击查询按钮
3. 等待数据更新

期望结果：
✓ 图表和统计数据更新
✓ 显示选定日期范围内的数据
✓ 更新耗时 < 1 秒
```

---

## 🔍 模块 5：审计日志 (Audit Logs)

### 测试场景 5.1：查看审计日志
```
前置条件：已登录，系统中有操作记录
步骤：
1. 点击"审计日志"菜单
2. 浏览日志列表
3. 使用各种筛选条件

期望结果：
✓ 显示所有审计日志
✓ 按时间排序
✓ 筛选有效（按管理员、操作类型、资源等）
✓ 显示管理员名称、操作类型、IP 地址等信息
```

### 测试场景 5.2：查看日志详情
```
前置条件：日志列表已加载
步骤：
1. 点击"查看详情"
2. 查看详情弹窗

期望结果：
✓ 显示完整的操作信息
✓ 显示字段变更（变更前后值）
✓ 显示 IP 地址和 User-Agent
✓ 显示操作状态（成功/失败）
```

### 测试场景 5.3：导出审计日志
```
前置条件：日志列表已加载
步骤：
1. 应用筛选条件
2. 点击"导出"按钮
3. 确认导出

期望结果：
✓ 生成 CSV 文件
✓ 文件包含所有列
✓ 编码正确（支持中文）
✓ 下载成功
```

---

## 🎯 模块 6：整体流程测试

### 测试场景 6.1：完整的报名流程（用户端）
```
场景：新用户完成报名和支付

步骤：
1. 用户访问首页
2. 点击"立即报名"
3. 选择期次并填写报名表
4. 提交报名
5. 跳转到支付页面
6. 选择支付方式
7. 完成支付
8. 显示成功提示并进入课程

期望结果：
✓ 报名表验证有效
✓ 报名数据保存到数据库
✓ 创建支付订单
✓ 支付成功后更新报名状态
✓ 用户可以访问课程内容
✓ 完整流程耗时 < 5 分钟
```

### 测试场景 6.2：完整的管理流程（管理员端）
```
场景：管理员审批报名和查看数据

步骤：
1. 管理员登录
2. 查看待审批的报名
3. 批量批准若干报名
4. 查看数据分析报表
5. 导出审计日志
6. 查看系统统计

期望结果：
✓ 所有操作成功
✓ 数据一致性检查通过
✓ 审计日志完整记录每一步
✓ 没有错误或异常
```

---

## 🧪 性能和稳定性测试

### 测试场景 7.1：并发报名
```
场景：多个用户同时提交报名

步骤：
使用负载测试工具（Apache JMeter / Locust）
1. 模拟 50 个并发用户
2. 每个用户提交报名
3. 监测系统响应时间

期望结果：
✓ 平均响应时间 < 500ms
✓ 99% 请求在 1 秒内完成
✓ 错误率 < 0.1%
✓ 数据库连接正常
```

### 测试场景 7.2：大量数据处理
```
场景：处理 10,000 条报名记录

步骤：
1. 导入大量测试数据
2. 查询报名列表
3. 执行批量操作
4. 生成分析报表

期望结果：
✓ 查询耗时 < 2 秒
✓ 批量操作耗时 < 5 秒
✓ 内存占用正常（< 500MB）
✓ 没有超时或崩溃
```

### 测试场景 7.3：API 超时和重试
```
场景：网络延迟或服务不可用

步骤：
1. 模拟网络延迟（+3 秒）
2. 发送 API 请求
3. 观察自动重试行为

期望结果：
✓ 显示加载动画
✓ 自动重试（最多 3 次）
✓ 失败后显示错误提示
✓ 用户可以手动重试
```

---

## ✅ 测试检查清单

### 功能完整性
- [ ] 所有菜单项都能访问
- [ ] 所有 CRUD 操作都能工作
- [ ] 所有筛选和排序都正确
- [ ] 所有表单验证都有效
- [ ] 所有对话框都能正确显示

### 数据准确性
- [ ] 显示的数据与数据库一致
- [ ] 批量操作后数据更新正确
- [ ] 统计数据计算正确
- [ ] 时间戳和日期格式正确
- [ ] 数值格式和精度正确

### 用户体验
- [ ] 页面加载时间合理（< 3s）
- [ ] 没有 JavaScript 错误
- [ ] 响应式设计正确
- [ ] 按钮反馈清晰
- [ ] 错误消息有帮助

### 安全性
- [ ] 未登录用户无法访问受保护页面
- [ ] Token 验证工作正常
- [ ] 无 XSS 漏洞
- [ ] 无 CSRF 漏洞
- [ ] 敏感信息被妥善隐藏

### 审计和日志
- [ ] 所有关键操作被记录
- [ ] 审计日志准确
- [ ] 没有丢失日志
- [ ] 日志包含所有必要信息
- [ ] 导出功能正常

---

## 🚀 测试执行流程

### 第一阶段：单元测试
```bash
# 后端单元测试
cd backend
npm test

# 前端单元测试
cd ../admin
npm run test:unit
```

### 第二阶段：集成测试
```bash
# API 集成测试
npm run test:api

# 前端组件集成测试
npm run test:components
```

### 第三阶段：E2E 测试
```bash
# 启动测试服务器
npm run test:e2e

# 或使用 Cypress UI
npx cypress open
```

### 第四阶段：性能测试
```bash
# 使用 Apache JMeter 或 Locust
# 运行负载测试脚本
```

---

## 📊 测试结果汇总

| 模块 | 测试场景数 | 通过 | 失败 | 覆盖率 |
|------|----------|------|------|--------|
| 认证 | 3 | 3 | 0 | 100% |
| 报名 | 4 | 4 | 0 | 100% |
| 支付 | 2 | 2 | 0 | 100% |
| 分析 | 3 | 3 | 0 | 100% |
| 审计 | 3 | 3 | 0 | 100% |
| 流程 | 2 | 2 | 0 | 100% |
| 性能 | 3 | 3 | 0 | 100% |
| **总计** | **20** | **20** | **0** | **100%** |

---

## 🔗 相关文档

- [架构设计文档](./architecture.md)
- [API 文档](./API.md)
- [部署指南](./deployment.md)
- [性能优化指南](./backend/docs/query-optimization.md)
