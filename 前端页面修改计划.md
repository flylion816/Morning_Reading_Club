# 前端页面修改计划

## 概述
将三个前端页面的 Mock 数据替换为真实 API 数据。

## 需要修改的三个页面

### 1. ranking.js (排行榜页面)

**当前状态**：使用 Mock 函数 `generateMockRanking()` 生成假数据

**修改步骤**：

```javascript
// 1. 导入服务
const rankingService = require('../../services/ranking.service');
const { getAvatarColorByUserId } = require('../../utils/formatters');

// 2. 修改 onLoad
Page({
  data: {
    periodId: '',      // 从期次参数获取
    ranking: {
      list: [],
      currentUser: null,
      total: 0
    },
    loading: true,
    currentTab: 'all'  // 当前tab
  },

  onLoad(options) {
    this.periodId = options.periodId;
    this.loadRanking('all');
  },

  // 3. 新增 loadRanking 方法
  async loadRanking(timeRange) {
    this.setData({
      loading: true,
      currentTab: timeRange
    });

    try {
      const res = await rankingService.getPeriodRanking(this.periodId, {
        timeRange,
        page: 1,
        limit: 20
      });

      // 转换数据：添加 avatarColor 和头像文字
      const list = res.data.list.map(item => ({
        ...item,
        avatarColor: getAvatarColorByUserId(item.userId),
        avatarText: item.nickname.charAt(item.nickname.length - 1)
      }));

      const currentUser = res.data.currentUser ? {
        ...res.data.currentUser,
        avatarColor: getAvatarColorByUserId(res.data.currentUser.userId),
        avatarText: res.data.currentUser.nickname.charAt(res.data.currentUser.nickname.length - 1)
      } : null;

      this.setData({
        ranking: {
          list,
          currentUser,
          total: res.data.total
        },
        loading: false
      });
    } catch (error) {
      wx.showToast({
        title: '加载排行榜失败',
        icon: 'none'
      });
      this.setData({ loading: false });
    }
  },

  // 4. Tab切换处理（修改现有的 handleTabChange）
  handleTabChange(e) {
    const tab = e.currentTarget.dataset.tab;
    this.loadRanking(tab);
  }
});
```

**WXML 修改**：
- 将 `item.checkinCount` 显示为 `item.checkinCount`（保持不变）
- 将 `currentUser.rank` 显示为 `currentUser.rank`
- 确保数据绑定正确

---

### 2. members.js (成员列表页面)

**当前状态**：使用 Mock 函数 `generateMockMembers()` 生成假数据

**修改步骤**：

```javascript
// 1. 导入服务
const enrollmentService = require('../../services/enrollment.service');
const { getAvatarColorByUserId } = require('../../utils/formatters');

// 2. 修改 data
Page({
  data: {
    periodId: '',
    members: [],
    totalMembers: 0,
    loading: true,
    page: 1,
    limit: 20
  },

  onLoad(options) {
    this.periodId = options.periodId;
    this.loadMembers();
  },

  // 3. 新增 loadMembers 方法
  async loadMembers(reset = true) {
    if (reset) {
      this.setData({ page: 1, loading: true });
    }

    try {
      const res = await enrollmentService.getPeriodMembers(this.periodId, {
        page: this.data.page,
        limit: this.data.limit
      });

      // 转换数据
      const members = res.data.list.map(item => ({
        userId: item.userId,
        nickname: item.nickname,
        avatar: item.avatar,
        avatarUrl: item.avatarUrl,
        avatarColor: getAvatarColorByUserId(item.userId),
        avatarText: item.nickname.charAt(item.nickname.length - 1),
        enrolledAt: new Date(item.enrolledAt).toLocaleDateString('zh-CN')
      }));

      this.setData({
        members: reset ? members : [...this.data.members, ...members],
        totalMembers: res.data.total,
        loading: false
      });
    } catch (error) {
      wx.showToast({
        title: '加载成员列表失败',
        icon: 'none'
      });
      this.setData({ loading: false });
    }
  },

  // 4. 上拉加载更多
  onReachBottom() {
    if (this.data.page * this.data.limit < this.data.totalMembers) {
      this.setData({ page: this.data.page + 1 });
      this.loadMembers(false);
    }
  }
});
```

---

### 3. checkin-records.js (打卡记录页面)

**当前状态**：使用 localStorage 和 Mock 日历数据

**修改步骤**：

```javascript
// 1. 导入服务
const checkinService = require('../../services/checkin.service');

// 2. 修改 data
Page({
  data: {
    stats: {
      diaryCount: 0,
      featuredCount: 0,
      likeCount: 0,
      totalDays: 0,
      consecutiveDays: 0
    },
    calendar: {
      year: 0,
      month: 0,
      checkinDays: []
    },
    checkinRecords: [],
    currentYear: 0,
    currentMonth: 0,
    loading: true
  },

  onLoad() {
    const now = new Date();
    this.setData({
      currentYear: now.getFullYear(),
      currentMonth: now.getMonth() + 1
    });
    this.loadCheckinsWithStats();
  },

  // 3. 新增 loadCheckinsWithStats 方法
  async loadCheckinsWithStats() {
    this.setData({ loading: true });

    try {
      const res = await checkinService.getUserCheckinsWithStats({
        page: 1,
        limit: 50,
        year: this.data.currentYear,
        month: this.data.currentMonth
      });

      // 格式化时间
      const records = res.data.list.map(item => ({
        ...item,
        createTime: new Date(item.createdAt).toLocaleString('zh-CN')
      }));

      this.setData({
        stats: res.data.stats,
        calendar: res.data.calendar,
        checkinRecords: records,
        loading: false
      });
    } catch (error) {
      console.error('加载打卡记录失败:', error);
      wx.showToast({
        title: '加载失败',
        icon: 'none'
      });
      this.setData({ loading: false });
    }
  },

  // 4. 月份切换
  handlePrevMonth() {
    let { currentYear, currentMonth } = this.data;
    currentMonth--;
    if (currentMonth < 1) {
      currentMonth = 12;
      currentYear--;
    }
    this.setData({ currentYear, currentMonth });
    this.loadCheckinsWithStats();
  },

  handleNextMonth() {
    let { currentYear, currentMonth } = this.data;
    currentMonth++;
    if (currentMonth > 12) {
      currentMonth = 1;
      currentYear++;
    }
    this.setData({ currentYear, currentMonth });
    this.loadCheckinsWithStats();
  }
});
```

---

## WXML 修改建议

### ranking.wxml
- 替换 `item.checkinCount` 为实时数据
- 确保当前用户排名正确显示

### members.wxml
- 将 `joinDate` 改为 `enrolledAt`
- 确保日期格式正确

### checkin-records.wxml
- 将日历 `calendarDays` 改为 `calendar.checkinDays`
- 将统计数据绑定到 `stats` 对象

---

## 关键数据转换

所有页面都需要：
1. **avatarColor 和 avatarText**：使用 `getAvatarColorByUserId()` 生成
2. **日期格式化**：使用 `.toLocaleString()` 或 `.toLocaleDateString()`
3. **ID 映射**：后端返回的 `_id` 应映射到 `userId`

---

## 后端初始化脚本

执行顺序（在项目根目录）：
```bash
# 1. 初始化 Enrollment 数据
node backend/scripts/init-enrollments.js

# 2. 更新 Checkin 数据（添加 likeCount 和 isFeatured）
node backend/scripts/update-checkins.js
```

---

## 测试检查清单

- [ ] 排行榜加载正确，tab 切换正常
- [ ] 成员列表显示当前期次的成员
- [ ] 打卡记录显示真实数据，日历准确
- [ ] 所有头像颜色一致（同用户）
- [ ] 日期格式正确
- [ ] 数据统计准确
- [ ] 分页加载工作正常
- [ ] 错误处理正确

---

**完成时间**：预计 1-2 小时
**优先级**：高
**依赖关系**：需要后端初始化脚本执行
