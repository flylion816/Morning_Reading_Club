# 晨读营小程序 - 本地测试环境启动指南

## 📋 目录
- [快速启动](#快速启动)
- [详细步骤](#详细步骤)
- [环境验证](#环境验证)
- [常见问题](#常见问题)
- [服务管理](#服务管理)

---

## 🚀 快速启动

如果环境已经配置好，执行以下命令即可：

```bash
# 1. 启动 Docker（如果未运行）
open -a Docker

# 2. 等待 Docker 启动（约10-15秒）
# 检查 Docker 是否就绪
docker info

# 3. 启动 MongoDB 容器
docker start morning-reading-mongodb

# 4. 启动后端服务
cd "/Users/pica_1/我的坚果云/flylion/AI项目开发/七个习惯晨读营/backend"
npm run dev

# 5. 打开微信开发者工具
# 项目路径: /Users/pica_1/我的坚果云/flylion/AI项目开发/七个习惯晨读营/miniprogram
```

---

## 📖 详细步骤

### 步骤 1: 启动 Docker

**命令**：
```bash
open -a Docker
```

**说明**：
- 这会启动 Docker Desktop 应用程序
- 等待 Docker 图标在菜单栏显示并稳定（不再转圈）
- 通常需要 10-15 秒启动时间

**验证 Docker 启动**：
```bash
# 等待 Docker 完全启动
timeout=30
while [ $timeout -gt 0 ]; do
  docker info >/dev/null 2>&1 && echo "✅ Docker 已启动" && break
  sleep 2
  timeout=$((timeout-2))
done
```

**预期输出**：
```
✅ Docker 已启动
```

---

### 步骤 2: 启动 MongoDB 容器

#### 2.1 检查容器是否存在

```bash
docker ps -a | grep morning-reading-mongodb
```

**预期输出**（容器已存在）：
```
d1b5c443cd13   mongo:6   "docker-entrypoint.s…"   7 days ago   Exited   morning-reading-mongodb
```

#### 2.2 启动现有容器

**如果容器已存在**：
```bash
docker start morning-reading-mongodb
```

**预期输出**：
```
morning-reading-mongodb
```

#### 2.3 创建新容器（首次使用）

**如果容器不存在**，需要创建：
```bash
docker run -d \
  --name morning-reading-mongodb \
  -p 27017:27017 \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=admin123 \
  -e MONGO_INITDB_DATABASE=morning_reading \
  mongo:latest
```

**参数说明**：
- `-d`：后台运行
- `--name morning-reading-mongodb`：容器名称
- `-p 27017:27017`：端口映射（主机端口:容器端口）
- `-e MONGO_INITDB_ROOT_USERNAME=admin`：管理员用户名
- `-e MONGO_INITDB_ROOT_PASSWORD=admin123`：管理员密码
- `-e MONGO_INITDB_DATABASE=morning_reading`：初始数据库名
- `mongo:latest`：使用最新版 MongoDB 镜像

**注意事项**：
- ⚠️ 首次运行会下载 MongoDB 镜像（约 700MB），需要几分钟
- ⚠️ 确保端口 27017 没有被其他程序占用

#### 2.4 验证 MongoDB 运行状态

```bash
# 检查容器状态
docker ps | grep mongo

# 预期输出：
# d1b5c443cd13   mongo:6   "docker-entrypoint.s…"   Up 2 minutes   0.0.0.0:27017->27017/tcp   morning-reading-mongodb
```

```bash
# 测试 MongoDB 连接
docker exec morning-reading-mongodb mongosh --eval "db.adminCommand('ping')"

# 预期输出：
# { ok: 1 }
```

```bash
# 查看数据库中的期次数量
docker exec morning-reading-mongodb mongosh morning_reading \
  --authenticationDatabase admin \
  -u admin \
  -p admin123 \
  --eval "db.periods.countDocuments()" \
  --quiet

# 预期输出：
# 4
```

---

### 步骤 3: 启动后端 Node.js 服务

#### 3.1 切换到后端目录

```bash
cd "/Users/pica_1/我的坚果云/flylion/AI项目开发/七个习惯晨读营/backend"
```

#### 3.2 检查端口占用

```bash
# 检查端口 3000 是否被占用
lsof -i :3000
```

**如果端口被占用**，先杀掉进程：
```bash
lsof -ti:3000 | xargs kill -9
```

#### 3.3 启动开发服务器

```bash
npm run dev
```

**预期输出**：
```
> morning-reading-backend@1.0.0 dev
> nodemon src/server.js

[nodemon] 3.1.11
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node src/server.js`
✅ MongoDB connected successfully
🚀 Server is running on http://localhost:3000
📚 API Base URL: http://localhost:3000/api/v1
🏥 Health check: http://localhost:3000/health
📝 Environment: development
```

**注意事项**：
- ⚠️ 可能会看到 MySQL 连接错误，这是正常的（项目主要使用 MongoDB）
- ⚠️ 可能会看到重复索引警告，不影响功能
- ✅ 只要看到"MongoDB connected successfully"和"Server is running"即表示启动成功

#### 3.4 后台运行（可选）

如果需要后台运行，可以使用 `nohup` 或 `pm2`：

```bash
# 方法1: 使用 nohup
nohup npm run dev > /tmp/backend.log 2>&1 &

# 方法2: 使用 pm2（需要先安装 pm2）
npm install -g pm2
pm2 start src/server.js --name morning-reading-backend
pm2 logs morning-reading-backend  # 查看日志
```

---

### 步骤 4: 验证后端服务

#### 4.1 健康检查

```bash
curl -s http://localhost:3000/health | json_pp
```

**预期输出**：
```json
{
   "status" : "ok",
   "timestamp" : 1763693827109
}
```

#### 4.2 测试 API 端点

```bash
# 测试期次列表（需要认证，预期返回 401）
curl -s "http://localhost:3000/api/v1/periods/" | json_pp
```

**预期输出**：
```json
{
   "code" : 401,
   "message" : "未提供认证令牌",
   "timestamp" : 1763693875455
}
```

**说明**：返回 401 表示 API 路由正常工作，只是需要登录认证。

---

### 步骤 5: 启动前端小程序

#### 5.1 打开微信开发者工具

```bash
# macOS 可以用命令行打开（如果已安装命令行工具）
open -a "微信开发者工具"
```

或手动打开微信开发者工具应用。

#### 5.2 导入项目

- 点击"导入项目"或"打开项目"
- 选择目录：
  ```
  /Users/pica_1/我的坚果云/flylion/AI项目开发/七个习惯晨读营/miniprogram
  ```
- AppID：使用测试号或真实 AppID

#### 5.3 配置开发设置

在微信开发者工具中：

1. 点击右上角"详情"
2. 勾选以下选项：
   - ✅ **不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书**
   - ✅ **不校验安全域名、TLS版本以及HTTPS证书**
   - ✅ **不校验 Bussiness Domain**

3. 在"本地设置"中：
   - ✅ **启用ES6转ES5**
   - ✅ **启用增强编译**
   - ✅ **启用调试基础库2.x版本**

#### 5.4 验证前端配置

确认 `miniprogram/config/env.js` 配置正确：

```javascript
const currentEnv = 'dev';
const envConfig = {
  dev: {
    apiBaseUrl: 'http://localhost:3000/api/v1',  // ✅ 指向本地后端
    enableDebug: true,
    useMock: false  // ✅ 关闭 Mock，使用真实后端
  }
};
```

---

## ✅ 环境验证

### 验证清单

执行以下命令验证所有服务正常：

```bash
echo "=== 环境验证 ==="
echo ""
echo "1. Docker 状态:"
docker info > /dev/null 2>&1 && echo "✅ Docker 运行中" || echo "❌ Docker 未运行"

echo ""
echo "2. MongoDB 状态:"
docker ps | grep morning-reading-mongodb > /dev/null && echo "✅ MongoDB 容器运行中" || echo "❌ MongoDB 容器未运行"

echo ""
echo "3. MongoDB 连接:"
docker exec morning-reading-mongodb mongosh --eval "db.adminCommand('ping')" 2>/dev/null | grep "ok: 1" > /dev/null && echo "✅ MongoDB 连接正常" || echo "❌ MongoDB 连接失败"

echo ""
echo "4. 后端服务:"
curl -s http://localhost:3000/health > /dev/null && echo "✅ 后端服务运行中" || echo "❌ 后端服务未运行"

echo ""
echo "5. 数据库数据:"
count=$(docker exec morning-reading-mongodb mongosh morning_reading --authenticationDatabase admin -u admin -p admin123 --eval "db.periods.countDocuments()" --quiet 2>&1)
echo "期次数量: $count"

echo ""
echo "=== 验证完成 ==="
```

**预期输出**：
```
=== 环境验证 ===

1. Docker 状态:
✅ Docker 运行中

2. MongoDB 状态:
✅ MongoDB 容器运行中

3. MongoDB 连接:
✅ MongoDB 连接正常

4. 后端服务:
✅ 后端服务运行中

5. 数据库数据:
期次数量: 4

=== 验证完成 ===
```

---

## 🔧 服务管理

### 停止所有服务

```bash
# 1. 停止后端服务
lsof -ti:3000 | xargs kill

# 2. 停止 MongoDB 容器
docker stop morning-reading-mongodb

# 3. 停止 Docker（可选）
# 在菜单栏点击 Docker 图标 -> Quit Docker Desktop
```

### 重启服务

```bash
# 重启 MongoDB
docker restart morning-reading-mongodb

# 重启后端（如果在运行）
lsof -ti:3000 | xargs kill
cd "/Users/pica_1/我的坚果云/flylion/AI项目开发/七个习惯晨读营/backend"
npm run dev
```

### 查看日志

```bash
# 查看 MongoDB 日志
docker logs morning-reading-mongodb

# 查看后端日志（如果使用 pm2）
pm2 logs morning-reading-backend

# 查看 Docker 所有容器
docker ps -a
```

### 清理环境（谨慎使用）

```bash
# 删除 MongoDB 容器（会丢失数据！）
docker stop morning-reading-mongodb
docker rm morning-reading-mongodb

# 删除 MongoDB 镜像
docker rmi mongo:latest

# 删除所有停止的容器
docker container prune

# 删除未使用的镜像
docker image prune
```

---

## ❓ 常见问题

### Q1: Docker 启动失败

**问题**：执行 `docker info` 报错 "Cannot connect to the Docker daemon"

**解决方案**：
1. 确认 Docker Desktop 已安装
2. 手动打开 Docker Desktop 应用
3. 等待 Docker 图标在菜单栏稳定（不转圈）
4. 重新执行命令

---

### Q2: MongoDB 容器无法启动

**问题**：执行 `docker start morning-reading-mongodb` 失败

**可能原因**：
- 端口 27017 被占用
- 容器不存在
- Docker 资源不足

**解决方案**：

```bash
# 检查端口占用
lsof -i:27017

# 如果有占用，杀掉进程
lsof -ti:27017 | xargs kill -9

# 检查容器是否存在
docker ps -a | grep mongo

# 如果不存在，重新创建
docker run -d \
  --name morning-reading-mongodb \
  -p 27017:27017 \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=admin123 \
  mongo:latest
```

---

### Q3: 后端服务端口被占用

**问题**：`Error: listen EADDRINUSE: address already in use :::3000`

**解决方案**：

```bash
# 查找占用端口的进程
lsof -i:3000

# 杀掉进程
lsof -ti:3000 | xargs kill -9

# 重新启动
npm run dev
```

---

### Q4: 前端无法连接后端

**问题**：小程序请求报错 "request:fail"

**检查清单**：
1. 确认后端服务已启动（访问 http://localhost:3000/health）
2. 确认 `miniprogram/config/env.js` 中 `apiBaseUrl` 为 `http://localhost:3000/api/v1`
3. 确认微信开发者工具已勾选"不校验合法域名"
4. 确认 `useMock` 为 `false`

---

### Q5: MongoDB 数据丢失

**问题**：数据库中没有期次数据

**解决方案**：

```bash
# 重新执行初始化脚本
cd "/Users/pica_1/我的坚果云/flylion/AI项目开发/七个习惯晨读营/backend"

# 初始化 MongoDB 数据
npm run init:mongodb

# 或执行特定脚本
node scripts/init-periods.js
node scripts/init-sections.js
node scripts/init-mock-checkins-v2.js
```

---

## 📊 测试数据说明

启动成功后，数据库包含以下测试数据：

### 期次（Periods）
- 智慧之光（2025-10-10 ~ 2025-10-14）
- 勇敢的心（2025-10-17 ~ 2025-10-21）
- 能量之泉（2025-10-24 ~ 2025-10-28）
- 心流之境（2025-10-31 ~ 2025-11-04）

### 用户（Users）
- 阿泰（默认测试用户）
- 王五
- 管理员
- 赵六

### 打卡记录（Checkins）
- 多条来自不同用户的打卡记录
- 分布在不同期次和课节
- 包含完整的打卡内容、心情、时间等信息

---

## 🎯 下一步

环境启动成功后，你可以：

1. **测试登录功能**
   - 在小程序中点击登录
   - 使用 Mock 登录或真实微信登录

2. **浏览期次列表**
   - 查看 4 个期次
   - 点击进入课程详情

3. **查看打卡记录**
   - 在"动态"tab 查看其他用户的打卡
   - 查看完整的打卡内容

4. **测试打卡功能**
   - 创建新的打卡记录
   - 查看打卡历史

5. **个人中心**
   - 查看个人信息
   - 查看打卡统计

---

**最后更新**: 2025-11-21
**维护者**: Claude Code

**相关文档**:
- [CLAUDE.md](./CLAUDE.md) - 开发规范和 Bug 经验库
- [项目统计报告.md](./项目统计报告.md) - 项目代码统计
- [README.md](./README.md) - 项目说明
