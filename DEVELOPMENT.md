# Claude Code 开发指南

本文档为 Claude Code 提供项目开发的重要说明和规范。

## 📋 项目信息

- **项目名称**: 晨读营小程序
- **仓库地址**: https://github.com/flylion816/Morning_Reading_Club
- **项目类型**: 微信小程序
- **技术栈**: 微信小程序原生框架 + Node.js
- **UI框架**: 微信官方样式库 WeUI

## 📂 交流指导原则

### **请用中文回答我的所有问题**

在协助开发时，请遵循以下原则：
- 用审视的目光仔细分析我的需求，指出潜在问题
- 提供在我思考框架之外的建议和最佳实践
- 如果发现明显的错误或不合理的设计，务必纠正我
- 主动提示可能的风险和更好的替代方案

## 🤖 Claude Code 标准工作流程

### ⚠️ **完整开发流程（重要！2025-11-22 确定）**

按照以下顺序执行，**绝对不能跳过任何步骤**：

#### **第 0 步：查询历史问题库**（🆕 新增）

**遇到问题？先查Memory系统**

在开始编码之前，先查看历史问题库能否加快开发：

```bash
# 打开快速查询指南
.claude/memory/quick-reference.md

# 按现象查找（比如："页面空白"、"数据不显示"等）
# 如果是已知问题，可以直接套用解决方案，节省时间
```

**预期效果**：
- ✅ 相似问题 → 2分钟找到答案
- ✅ 新问题 → 正常开发，完成后记录到Memory
- ✅ 重复问题 → 下次秒解

**记录新问题**（解决后）：
- 问题症状 → 记录到对应的 `.claude/memory/issues/*/` 文件
- 更新 quick-reference.md 的"Top 5"部分
- 下次遇到相同问题时可立即应用

---

#### **第 1 步：完成代码实现**
- 编写/修改代码
- 本地保存并确保语法正确
- 不要立即提交到 Git
- 💡 **参考Memory系统中的最佳实践和架构决策**

#### **第 2 步：自己完整的接口测试（关键！）**
使用 `curl` 或 Postman 测试所有 API 端点：

```bash
# 示例：测试登录接口
curl -X POST http://localhost:3000/api/v1/auth/admin/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@morningreading.com","password":"admin123456"}'

# 示例：用返回的 token 测试仪表板接口
curl -H "Authorization: Bearer <token>" \
  http://localhost:3000/api/v1/stats/dashboard
```

**必须验证的内容**：
- ✅ HTTP 状态码（200 vs 401 vs 403 vs 500）
- ✅ 返回数据的结构是否正确
- ✅ 错误消息是否清晰
- ✅ 边界情况处理（无权限、数据不存在等）
- ✅ 前后端数据流是否一致

#### **第 3 步：用例测试（检查清单）**
列出所有要测试的场景，逐一验证：

```
功能：用户登录
用例1: 正确的邮箱和密码 → 返回 token ✅
用例2: 错误的密码 → 返回 401 ✅
用例3: 不存在的邮箱 → 返回 401 ✅
用例4: 空邮箱 → 返回错误提示 ✅

功能：获取仪表板数据
用例1: 已登录的管理员 → 返回数据 ✅
用例2: 已登录的普通用户 → 返回 403 ✅
用例3: 未登录用户 → 返回 401 ✅
```

#### **第 4 步：等待用户测试（重要！）**
- ✅ 告知用户"已完成实现，可以测试"
- ✅ 提供测试账号和说明（如需要）
- ✅ **等待用户反馈：成功 or 问题**
- ❌ 不要在用户未测试时就提交到 GitHub

#### **第 5 步：根据用户反馈修复**
如果用户反馈有问题：
- 回到第 2 步：自己先用 curl 重现问题
- 分析根本原因
- 修复代码
- 再次自测
- 告知用户"已修复，请重新测试"
- 循环直到用户确认无误

#### **第 6 步：用户确认无误后提交 GitHub**
只有在用户说"没问题，搞定了"或"✅ 成功"时，才执行：

```bash
cd "/Users/pica_1/我的坚果云/flylion/AI项目开发/七个习惯晨读营"

# 查看修改状态
git status

# 添加所有修改
git add -A

# 提交(使用规范的 commit message)
git commit -m "feat: 功能描述

详细说明:
- 修改点1
- 修改点2

测试验证: 所有 API 端点已通过测试 ✅

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# 推送到 GitHub
git push https://$(gh auth token)@github.com/flylion816/Morning_Reading_Club.git main
```

#### **第 7 步：更新文档**
如果是重要的 bug 或新的经验教训：
- ✅ 按照模板总结到 CLAUDE.md 的 Bug 修复经验库
- ✅ 包含问题现象、原因、解决方案、经验教训
- ✅ 记录这个过程中遇到的所有坑

#### **整个流程的时间顺序**

```
我的工作：实现 → 自测 ───┐
                        ├─> 提交 GitHub
用户的工作：等待 → 测试 → 反馈 ┘

错误的流程：
实现 → 提交 GitHub → 用户测试 → 有问题 → 再改 → 再提交
（这样 GitHub 历史很乱，且容易遗漏问题）

正确的流程：
实现 → 自测 ✅ → 用户测试 ✅ → 提交 GitHub 一次性完成
（干净的提交，高质量的代码）
```

---

### **重点提醒**

#### ⚠️ 自测 vs 提交的关系
```
❌ 错误：实现 → 直接提交 → 用户测试 → 发现问题 → 再改
        这样导致：
        - 代码反复改动
        - GitHub 历史混乱
        - 浪费用户时间
        - 效率低下

✅ 正确：实现 → 自测完整 → 确认无误 → 提交 → 用户测试（快速通过）
        这样导致：
        - 代码质量高
        - GitHub 历史清晰
        - 用户测试高效
        - 整体效率高
```

#### ⚠️ 自测的工具和范围
- **工具**：使用 curl 或 Postman，不要依赖前端 UI
- **范围**：所有新增和修改的 API 端点
- **深度**：正常场景 + 错误场景 + 边界情况
- **顺序**：优先测试关键路径（认证 → 数据获取 → 修改操作）

#### ⚠️ 提交前的最后检查清单
- [ ] 所有 API 端点都用 curl 测试过？
- [ ] 正常场景和错误场景都验证过？
- [ ] 前后端数据结构一致？
- [ ] 错误信息清晰有用？
- [ ] 已准备好面对用户的任何问题？
- [ ] 如有重要发现，CLAUDE.md 已更新？

---

### **历史教训：2025-11-22 登录问题**

这次 30 分钟的调试就是因为跳过了自测流程：
- ❌ 实现代码后直接让用户测试
- ❌ 没有用 curl 验证 API 响应
- ❌ 前 15 分钟盲目修改，后 15 分钟才系统诊断

如果当时执行了正确的流程：
- ✅ 自己先 curl 测试登录和 dashboard API
- ✅ 发现 401 错误后添加日志追踪
- ✅ 发现 4 个问题的根本原因
- ✅ 修复 → 自验 → 提交（总共 15 分钟）

**效率相差 2 倍**

---

### 重要修改后必须执行的流程

**1. 问题解决后的记录流程**

每次解决完值得记录的问题后:
- ✅ 判断是否值得记录(非平凡的bug、需要调试的问题、小程序特有陷阱)
- ✅ 按照模板总结问题、原因、解决方案、经验教训
- ✅ 更新到本文档的 Bug修复经验库部分
- ✅ 更新"最后更新"日期

**2. 代码提交到 GitHub 的流程（已移到上方，请参考"完整开发流程"）**

**Commit Message 规范**:
- `feat:` 新功能
- `fix:` bug修复
- `docs:` 文档更新
- `refactor:` 重构
- `style:` 样式调整
- `perf:` 性能优化
- `chore:` 构建/配置

**3. 操作步骤记录流程**

每次完成任务后必须自我检查：
- ✅ 本次操作是否具有可复用性？
- ✅ 是否涉及环境配置、服务启动、工具使用？
- ✅ 下次执行同类任务是否需要这些步骤？

如果答案为"是"，则：
- ✅ 将详细操作步骤记录到相应文档
  - 环境相关 → `本地环境启动说明.md`
  - 部署相关 → `部署指南.md`
  - 开发规范 → `CLAUDE.md`
  - Bug经验 → `CLAUDE.md` 的Bug修复经验库
- ✅ 包含完整的命令、参数、截图说明
- ✅ 注明注意事项和常见问题

**记录原则**：
- 📝 **及时记录**：完成任务后立即记录，趁记忆清晰
- 📝 **详细具体**：包含完整命令，不遗漏参数和选项
- 📝 **可重复性**：其他人或未来的自己能直接执行
- 📝 **问题预警**：标注可能遇到的坑和解决方法

**4. 完整的工作流程总结**

```
开发/修复 → 测试验证 → 记录问题(如需要) → 记录操作步骤 → Git提交 → 推送GitHub
   ↓            ↓           ↓                  ↓              ↓            ↓
 实现功能    确保正常    更新CLAUDE.md      更新操作文档     本地提交    远程同步
```

**自我检查清单**:
- [ ] 功能是否完整实现?
- [ ] 是否测试通过?
- [ ] 是否有值得记录的问题?
- [ ] **是否有可复用的操作步骤需要记录？**
- [ ] 是否更新了相关文档?
- [ ] 是否提交到本地仓库?
- [ ] 是否推送到远程仓库?
