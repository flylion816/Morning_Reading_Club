<!--ä¸ªäººä¸­å¿ƒé¡µé¢-->
<view class="page-profile">
  <!-- æœªç™»å½•çŠ¶æ€ - æ˜¾ç¤ºå®Œæ•´ç™»å½•ç•Œé¢ -->
  <view class="login-container" wx:if="{{!isLogin}}">
    <!-- Logoå’Œæ ‡é¢˜ -->
    <view class="login-header">
      <view class="logo">ğŸ“š</view>
      <text class="app-title">ã€Šé«˜æ•ˆèƒ½äººå£«çš„ä¸ƒä¸ªä¹ æƒ¯ã€‹</text>
      <text class="app-title-second">å‡¡äººæ™¨è¯»è¥</text>
      <text class="app-slogan">ä¸€ä¸ªæ—©èµ·ã€è¯»ä¹¦ã€è°ˆå¿ƒçš„åœ°æ–¹</text>
      <!-- <text class="app-slogan-extra">åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸€èµ·</text>
      <text class="app-slogan-extra">è§‚å¿ƒï¼Œè°ˆå¿ƒï¼Œç”¨å¿ƒï¼Œä¿®å¿ƒï¼Œæ˜å¿ƒ</text> -->
    </view>

    <!-- ç™»å½•å¡ç‰‡ -->
    <view class="login-card">
      <view class="card-title">æ˜ç†å®ä¿®ï¼ŒåŒè§åŒè¡Œ</view>
      <view class="card-desc">æˆ‘ä»¬ä¸€èµ·è§‚å¿ƒï¼Œè°ˆå¿ƒï¼Œç”¨å¿ƒï¼Œä¿®å¿ƒï¼Œæ˜å¿ƒ</view>

      <!-- ç™»å½•æŒ‰é’® -->
      <button
        class="wechat-login-btn {{loading ? 'loading' : ''}}"
        bindtap="handleWechatLogin"
        disabled="{{loading}}"
      >
        <text wx:if="{{!loading}}">å¾®ä¿¡ä¸€é”®ç™»å½•</text>
        <text wx:else>ç™»å½•ä¸­...</text>
      </button>

      <!-- ç”¨æˆ·åè®® -->
      <view class="agreement">
        <text class="agreement-text">ç™»å½•å³è¡¨ç¤ºåŒæ„</text>
        <text class="agreement-link">ã€Šç”¨æˆ·åè®®ã€‹</text>
        <text class="agreement-text">å’Œ</text>
        <text class="agreement-link">ã€Šéšç§æ”¿ç­–ã€‹</text>
      </view>
    </view>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ - æ˜¾ç¤ºä¸»é¡µå†…å®¹ -->
  <view class="user-content" wx:else>
    <!-- é¡¶éƒ¨æ¨ªå¹… -->
    <view class="home-banner">
      <view class="user-avatar-container" bindtap="openEditProfile">
        <image wx:if="{{userInfo.avatarUrl}}" class="user-avatar-img" src="{{userInfo.avatarUrl}}" mode="aspectFill" />
        <text wx:else class="user-avatar-emoji">{{userInfo.avatar || 'ğŸ¦'}}</text>
        <view class="avatar-edit-badge">âœï¸</view>
      </view>
      <view class="banner-content">
        <view class="banner-top-row">
          <view class="user-info-display">
            <view class="user-name-and-period">
              <text class="user-name">{{userInfo.nickname || userInfo.name || 'ç”¨æˆ·'}}</text>
              <view class="user-period-tag" wx:if="{{currentPeriod}}">{{currentPeriod.name || currentPeriod.title}}</view>
            </view>
          </view>
          <text class="user-streak">åšæŒæ™¨è¯»æ‰“å¡ç¬¬ <text class="streak-number">{{userStats.totalCheckinDays || 0}}</text> å¤©</text>
        </view>
        <view class="banner-bubble">
          <text class="bubble-text">{{userInfo.signature || 'æš‚æ— ç­¾å'}}</text>
        </view>
      </view>
    </view>

    <!-- å†…å®¹åŒºåŸŸ -->
    <view class="content-area">
      <!-- ä»Šæ—¥ä»»åŠ¡ -->
      <view class="task-section">
        <view class="section-header">
          <view class="section-header-left">
            <view class="section-icon-clipboard">ğŸ“‹</view>
            <text class="section-header-title">ä»Šæ—¥ä»»åŠ¡</text>
          </view>
          <view class="refresh-timer" wx:if="{{refreshTime}}">
            <text class="timer-icon">â±</text>
            <text class="timer-text">åˆ·æ–° {{refreshTime}} å°æ—¶</text>
          </view>
        </view>
        <view class="period-card" wx:if="{{todaySection}}" catchtap="handleTodaySectionClick">
          <view class="period-cover">
            <view class="book-icon-svg"></view>
            <text class="period-day">Day {{todaySection.day || '06'}}</text>
          </view>
          <view class="period-info-new">
            <view class="period-title-row">
              <view class="period-title-new">{{todaySection.title}}</view>
              <text class="progress-percent">{{todaySection.progress || 0}}%</text>
            </view>
            <view class="period-meta-date">
              <view class="calendar-icon">
                <view class="calendar-top"></view>
                <text class="calendar-text">{{todaySection.day}}</text>
              </view>
              <text class="meta-date-text">{{todaySection.displayDate}}</text>
            </view>
            <view class="period-progress-new">
              <view class="progress-bar-wrapper">
                <view class="progress-bar-fill" style="width: {{todaySection.progress || 0}}%"></view>
                <view class="progress-bar-thumb" style="left: {{todaySection.progress || 0}}%"></view>
              </view>
            </view>
            <view class="checkin-footer">
              <view class="avatar-group">
                <!-- å®é™…æ‰“å¡ç”¨æˆ·å¤´åƒåˆ—è¡¨ -->
                <view wx:for="{{todaySection.checkinUsers}}" wx:key="index" class="avatar-item user-avatar" style="z-index: {{999 - index}}">
                  <!-- å¤´åƒå›¾ç‰‡ -->
                  <image wx:if="{{item.avatarUrl}}" class="avatar-img" src="{{item.avatarUrl}}" mode="aspectFill" />
                  <!-- å¤´åƒemojiï¼ˆå½“æ²¡æœ‰å›¾ç‰‡æ—¶ï¼‰ -->
                  <text wx:else class="avatar-emoji">{{item.avatar || 'ğŸ˜Š'}}</text>
                  <!-- ç”¨æˆ·æ˜µç§°tooltip -->
                  <view class="avatar-tooltip">{{item.nickname}}</view>
                </view>
                <!-- æ‰“å¡äººæ•°ç»Ÿè®¡ -->
                <view class="avatar-item count">{{todaySection.checkinCount || 0}}äºº</view>
              </view>
              <view class="checkin-btn {{todaySection.isCheckedIn ? 'checked' : ''}}" catchtap="handleCreateCheckin">
                <text wx:if="{{todaySection.isCheckedIn}}">âœ“ å·²æ‰“å¡</text>
                <text wx:else>å»æ‰“å¡</text>
                <text class="btn-arrow" wx:if="{{!todaySection.isCheckedIn}}">â†’</text>
              </view>
            </view>
          </view>
        </view>
        <view class="task-empty" wx:else>
          <text>æš‚æ— è¿›è¡Œä¸­çš„è¯¾ç¨‹</text>
        </view>
      </view>

      <!-- å°å‡¡çœ‹è§ -->
      <view class="insights-section">
        <view class="section-header">
          <view class="section-icon-sparkle">âœ¨</view>
          <text class="section-header-title">å°å‡¡çœ‹è§</text>
        </view>
        <view class="insights-list">
          <view
            wx:for="{{recentInsights}}"
            wx:key="id"
            class="insight-item"
            style="border-left-color: {{item.typeConfig.color}};background-color: {{item.typeConfig.bgColor}}"
            data-id="{{item.id}}"
            catchtap="handleInsightClick">
            <view class="insight-content-preview">
              <view class="insight-text">{{item.preview}}</view>
            </view>
          </view>
          <view class="insight-empty" wx:if="{{recentInsights.length === 0}}">
            æœ¬æœŸæš‚æ— å°å‡¡çœ‹è§è®°å½•
          </view>
        </view>
        <view class="insights-more" catchtap="navigateToInsights">
          <text class="more-text">æŸ¥çœ‹æ›´å¤šå†å²</text>
          <text class="more-arrow">â†’</text>
        </view>
      </view>

      <!-- è¯·æ±‚çœ‹è§ -->
      <view class="requests-section">
        <view class="section-header">
          <view class="section-icon-mailbox">ğŸ“¬</view>
          <text class="section-header-title">è¯·æ±‚çœ‹è§</text>
        </view>
        <view class="requests-content">
          <view
            wx:for="{{insightRequests}}"
            wx:key="id"
            class="request-item">
            <view class="request-item-left">
              <view class="request-user-avatar" style="background: {{item.avatarColor || '#4a90e2'}}">
                <text class="request-avatar-text">{{item.fromUserAvatar || 'ğŸ˜Š'}}</text>
              </view>
              <view class="request-info">
                <text class="request-user-name">{{item.fromUserName}}</text>
                <text class="request-time">{{item.time}}</text>
              </view>
            </view>
            <view class="request-actions">
              <view class="request-btn approve-btn" catchtap="handleApproveRequest" data-request="{{item}}">
                <text>âœ“</text>
              </view>
              <view class="request-btn reject-btn" catchtap="handleRejectRequest" data-request="{{item}}">
                <text>âœ—</text>
              </view>
            </view>
          </view>
          <view class="requests-empty" wx:if="{{insightRequests.length === 0}}">
            æš‚æ— è¯·æ±‚
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡† -->
  <view class="edit-profile-modal" wx:if="{{showEditProfile}}" catchtap="closeEditProfile">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ç¼–è¾‘ä¸ªäººä¿¡æ¯</text>
        <text class="modal-close" bindtap="closeEditProfile">Ã—</text>
      </view>

      <!-- å¤´åƒé€‰æ‹© -->
      <view class="modal-section">
        <text class="section-label">é€‰æ‹©å¤´åƒ</text>
        <view class="avatar-options">
          <view wx:for="{{avatarOptions}}" wx:key="index" class="avatar-option {{editForm.avatar === item ? 'selected' : ''}}" bindtap="selectAvatar" data-avatar="{{item}}">
            <text class="avatar-option-text">{{item}}</text>
          </view>
        </view>
      </view>

      <!-- æ˜µç§°è¾“å…¥ -->
      <view class="modal-section">
        <text class="section-label">æ˜µç§°</text>
        <input
          class="modal-input"
          type="text"
          placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°"
          placeholder-class="input-placeholder"
          value="{{editForm.nickname}}"
          bindinput="onNicknameInput"
          maxlength="20"
        />
        <text class="input-count">{{editForm.nickname.length}}/20</text>
      </view>

      <!-- ä¸ªäººç­¾åè¾“å…¥ -->
      <view class="modal-section">
        <text class="section-label">ä¸ªäººç­¾å</text>
        <textarea
          class="modal-textarea"
          placeholder="é€‰å¡«ï¼Œåˆ†äº«ä½ çš„åº§å³é“­æˆ–æƒ³æ³•"
          placeholder-class="input-placeholder"
          value="{{editForm.signature}}"
          bindinput="onSignatureInput"
          maxlength="200"
          show-confirm-bar="false"
          fixed="false"
        ></textarea>
        <text class="input-count">{{editForm.signature.length}}/200</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="modal-actions">
        <view class="btn btn-cancel" bindtap="closeEditProfile">å–æ¶ˆ</view>
        <view class="btn btn-submit {{isSavingProfile ? 'loading' : ''}}" bindtap="saveUserProfile">
          {{isSavingProfile ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-spinner"></view>
  </view>
</view>
