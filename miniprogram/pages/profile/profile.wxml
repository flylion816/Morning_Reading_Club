<!--ä¸ªäººä¸­å¿ƒé¡µé¢-->
<view class="page-profile">
  <!-- æœªç™»å½•çŠ¶æ€ - æ˜¾ç¤ºå®Œæ•´ç™»å½•ç•Œé¢ -->
  <view class="login-container" wx:if="{{!isLogin}}">
    <!-- Logoå’Œæ ‡é¢˜ -->
    <view class="login-header">
      <view class="logo">ğŸ“š</view>
      <text class="app-title">æ™¨è¯»è¥</text>
      <text class="app-slogan">åœ¨æ™¨å…‰ä¸­,é‡è§æ›´å¥½çš„è‡ªå·±</text>
    </view>

    <!-- ç™»å½•å¡ç‰‡ -->
    <view class="login-card">
      <view class="card-title">æ¬¢è¿æ¥åˆ°æ™¨è¯»è¥</view>
      <view class="card-desc">é€šè¿‡å¾®ä¿¡ä¸€é”®ç™»å½•</view>

      <!-- ç™»å½•æŒ‰é’® -->
      <button
        class="wechat-login-btn {{loading ? 'loading' : ''}}"
        bindtap="handleWechatLogin"
        disabled="{{loading}}"
      >
        <text wx:if="{{!loading}}">å¾®ä¿¡ä¸€é”®ç™»å½•</text>
        <text wx:else>ç™»å½•ä¸­...</text>
      </button>

      <!-- ç”¨æˆ·åè®® -->
      <view class="agreement">
        <text class="agreement-text">ç™»å½•å³è¡¨ç¤ºåŒæ„</text>
        <text class="agreement-link">ã€Šç”¨æˆ·åè®®ã€‹</text>
        <text class="agreement-text">å’Œ</text>
        <text class="agreement-link">ã€Šéšç§æ”¿ç­–ã€‹</text>
      </view>
    </view>

    <!-- è¿”å›é¦–é¡µ -->
    <view class="back-home" bindtap="handleBackHome">
      <text>â† è¿”å›é¦–é¡µ</text>
    </view>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ - æ˜¾ç¤ºä¸»é¡µå†…å®¹ -->
  <view class="user-content" wx:else>
    <!-- é¡¶éƒ¨æ¨ªå¹… -->
    <view class="home-banner">
      <view class="user-avatar-container">
        <image wx:if="{{userInfo.avatarUrl}}" class="user-avatar-img" src="{{userInfo.avatarUrl}}" mode="aspectFill" />
        <text wx:else class="user-avatar-emoji">{{userInfo.avatar || 'ğŸ¦'}}</text>
      </view>
      <view class="banner-bubble">
        <text class="bubble-text">åœ¨æ¯ä¸€æ¬¡çœ‹è§ä¸­ä¸ä½ç›¸\nåœ¨æ¯ä¸€æ¬¡å€¾å¬ä¸­ç”Ÿæ…ˆæ‚²</text>
      </view>
    </view>

    <!-- å†…å®¹åŒºåŸŸ -->
    <view class="content-area">
      <!-- ä»Šæ—¥ä»»åŠ¡ -->
      <view class="task-section">
        <view class="section-header">
          <view class="section-icon">ğŸ“‹</view>
          <text class="section-header-title">ä»Šæ—¥ä»»åŠ¡</text>
        </view>
        <view class="period-card" wx:if="{{currentPeriod}}" bindtap="handleCurrentPeriodClick">
          <view class="period-cover" style="background: {{currentPeriod.coverColor || '#4a90e2'}}">
            <text class="cover-emoji">{{currentPeriod.coverEmoji || 'ğŸ”ï¸'}}</text>
          </view>
          <view class="period-info">
            <view class="period-title">{{currentPeriod.title}}</view>
            <view class="period-meta">
              <text class="meta-date">{{currentPeriod.startDate}} è‡³ {{currentPeriod.endDate}}</text>
              <text class="meta-days">å·²æ‰“å¡ {{currentPeriod.completedDays || 0}} å¤©</text>
            </view>
            <view class="period-progress">
              <view class="progress-bar-wrapper">
                <view class="progress-bar-fill" style="width: {{currentPeriod.progress || 0}}%"></view>
              </view>
              <text class="progress-status">è¿›è¡Œä¸­ {{currentPeriod.completedDays || 0}}/{{currentPeriod.totalDays || 23}}</text>
            </view>
          </view>
        </view>
        <view class="task-empty" wx:else>
          <text>æš‚æ— è¿›è¡Œä¸­çš„è¯¾ç¨‹</text>
        </view>
      </view>

      <!-- å°å‡¡çœ‹è§ - æŒ‰ç« èŠ‚ -->
      <view class="insights-section">
        <view class="section-header">
          <view class="section-icon">âœ¨</view>
          <text class="section-header-title">å°å‡¡çœ‹è§ - æŒ‰ç« èŠ‚</text>
        </view>
        <view class="insights-list">
          <view
            wx:for="{{recentInsights}}"
            wx:key="id"
            class="insight-item"
            bindtap="handleInsightClick"
            data-insight="{{item}}">
            <view class="insight-day">{{item.day}}</view>
            <view class="insight-content-preview">
              <view class="insight-title">{{item.title}}</view>
              <view class="insight-text">{{item.preview}}</view>
            </view>
          </view>
          <view class="insight-empty" wx:if="{{recentInsights.length === 0}}">
            æš‚æ— å°å‡¡çœ‹è§è®°å½•
          </view>
        </view>
        <view class="insights-more" bindtap="navigateToInsights">
          <text class="more-text">æŸ¥çœ‹æ›´å¤š</text>
          <text class="more-arrow">â†’</text>
        </view>
      </view>

      <!-- æ”¶åˆ°çš„å°å‡¡çœ‹è§è¯·æ±‚ -->
      <view class="requests-section">
        <view class="section-header">
          <view class="section-icon">ğŸ“¬</view>
          <text class="section-header-title">æ”¶åˆ°çš„å°å‡¡çœ‹è§è¯·æ±‚</text>
        </view>
        <view class="requests-content">
          <view
            wx:for="{{insightRequests}}"
            wx:key="id"
            class="request-item"
            bindtap="handleRequestClick"
            data-request="{{item}}">
            <view class="request-item-left">
              <text class="request-user-emoji">{{item.userAvatar || 'ğŸ˜Š'}}</text>
              <view class="request-info">
                <text class="request-user-name">{{item.userName}}</text>
                <text class="request-time">{{item.time}}</text>
              </view>
            </view>
            <button class="request-btn" catchtap="handleApproveRequest" data-request="{{item}}">
              æˆæƒ
            </button>
          </view>
          <view class="requests-empty" wx:if="{{insightRequests.length === 0}}">
            æš‚æ— è¯·æ±‚
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ›å»ºæ‰“å¡æŒ‰é’® -->
    <view class="create-checkin-btn" bindtap="handleCreateCheckin">
      <text class="btn-icon">+</text>
      <text class="btn-text">åˆ›å»ºæ‰“å¡</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-spinner"></view>
  </view>
</view>
