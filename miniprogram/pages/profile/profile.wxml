<!--个人中心页面-->
<view class="page-profile">
  <!-- 未登录状态 - 显示完整登录界面 -->
  <view class="login-container" wx:if="{{!isLogin}}">
    <!-- Logo和标题 -->
    <view class="login-header">
      <view class="logo">📚</view>
      <text class="app-title">《高效能人士的七个习惯》</text>
      <text class="app-title-second">凡人晨读营</text>
      <text class="app-slogan">一个早起、读书、谈心的地方</text>
      <!-- <text class="app-slogan-extra">在这里，我们一起</text>
      <text class="app-slogan-extra">观心，谈心，用心，修心，明心</text> -->
    </view>

    <!-- 登录卡片 -->
    <view class="login-card">
      <view class="card-title">明理实修，同见同行</view>
      <view class="card-desc">在这里，我们一起 观心，谈心，用心，修心，明心</view>

      <!-- 登录按钮 -->
      <button
        class="wechat-login-btn {{loading ? 'loading' : ''}}"
        bindtap="handleWechatLogin"
        disabled="{{loading}}"
      >
        <text wx:if="{{!loading}}">微信一键登录</text>
        <text wx:else>登录中...</text>
      </button>

      <!-- 用户协议 -->
      <view class="agreement">
        <text class="agreement-text">登录即表示同意</text>
        <text class="agreement-link">《用户协议》</text>
        <text class="agreement-text">和</text>
        <text class="agreement-link">《隐私政策》</text>
      </view>
    </view>
  </view>

  <!-- 已登录状态 - 显示主页内容 -->
  <view class="user-content" wx:else>
    <!-- 顶部横幅 -->
    <view class="home-banner">
      <view class="user-avatar-container">
        <image wx:if="{{userInfo.avatarUrl}}" class="user-avatar-img" src="{{userInfo.avatarUrl}}" mode="aspectFill" />
        <text wx:else class="user-avatar-emoji">{{userInfo.avatar || '🦁'}}</text>
      </view>
      <view class="banner-content">
        <view class="user-info-display">
          <text class="user-name">{{userInfo.nickname || userInfo.name || '用户'}}</text>
          <text class="current-period" wx:if="{{currentPeriod}}">本期: {{currentPeriod.name || currentPeriod.title}}</text>
        </view>
        <view class="banner-bubble">
          <text class="bubble-text">在每一次看见中不住相\n在每一次倾听中生慈悲</text>
        </view>
      </view>
    </view>

    <!-- 内容区域 -->
    <view class="content-area">
      <!-- 今日任务 -->
      <view class="task-section">
        <view class="section-header">
          <view class="section-icon">📋</view>
          <text class="section-header-title">今日任务</text>
        </view>
        <view class="period-card" wx:if="{{todaySection}}" bindtap="handleTodaySectionClick">
          <view class="period-cover" style="background: {{todaySection.coverColor || '#4a90e2'}}">
            <text class="cover-emoji">{{todaySection.coverEmoji || '🏔️'}}</text>
          </view>
          <view class="period-info">
            <view class="period-title">{{todaySection.title}}</view>
            <!-- 今日日期范围显示 -->
            <view class="today-date-range">
              2025-11-27 00:00:00 - 2025-11-27 23:59:59
            </view>
            <view class="period-meta" wx:if="{{todaySection.subtitle}}">
              <text class="meta-subtitle">{{todaySection.subtitleDisplay}}</text>
            </view>
            <view class="period-progress">
              <view class="progress-bar-wrapper">
                <view class="progress-bar-fill" style="width: {{todaySection.progress || 0}}%"></view>
              </view>
              <text class="progress-status">{{todaySection.checkinCount || 0}}人已打卡</text>
            </view>
          </view>
        </view>
        <view class="task-empty" wx:else>
          <text>暂无进行中的课程</text>
        </view>
      </view>

      <!-- 小凡看见 -->
      <view class="insights-section">
        <view class="section-header">
          <view class="section-icon">✨</view>
          <text class="section-header-title">小凡看见</text>
        </view>
        <view class="insights-list">
          <view
            wx:for="{{recentInsights}}"
            wx:key="id"
            class="insight-item"
            style="border-left-color: {{item.typeConfig.color}};background-color: {{item.typeConfig.bgColor}}"
            bindtap="handleInsightClick"
            data-id="{{item.id}}">
            <view class="insight-header">
              <view class="insight-type-badge" style="background-color: {{item.typeConfig.color}}">
                <text class="insight-type-icon">{{item.typeConfig.icon}}</text>
                <text class="insight-type-label">{{item.typeConfig.label}}</text>
              </view>
              <view class="insight-day">{{item.day}}</view>
            </view>
            <view class="insight-content-preview">
              <view class="insight-text">{{item.preview}}</view>
            </view>
          </view>
          <view class="insight-empty" wx:if="{{recentInsights.length === 0}}">
            本期暂无小凡看见记录
          </view>
        </view>
        <view class="insights-more" bindtap="navigateToInsights">
          <text class="more-text">查看更多历史</text>
          <text class="more-arrow">→</text>
        </view>
      </view>

      <!-- 请求看见 -->
      <view class="requests-section">
        <view class="section-header">
          <view class="section-icon">📬</view>
          <text class="section-header-title">请求看见</text>
        </view>
        <view class="requests-content">
          <view
            wx:for="{{insightRequests}}"
            wx:key="id"
            class="request-item">
            <view class="request-item-left">
              <view class="request-user-avatar" style="background: {{item.avatarColor || '#4a90e2'}}">
                <text class="request-avatar-text">{{item.fromUserAvatar || '😊'}}</text>
              </view>
              <view class="request-info">
                <text class="request-user-name">{{item.fromUserName}}</text>
                <text class="request-time">{{item.time}}</text>
              </view>
            </view>
            <view class="request-actions">
              <view class="request-btn approve-btn" catchtap="handleApproveRequest" data-request="{{item}}">
                <text>✓</text>
              </view>
              <view class="request-btn reject-btn" catchtap="handleRejectRequest" data-request="{{item}}">
                <text>✗</text>
              </view>
            </view>
          </view>
          <view class="requests-empty" wx:if="{{insightRequests.length === 0}}">
            暂无请求
          </view>
        </view>
      </view>
    </view>

    <!-- 创建打卡按钮 -->
    <view class="create-checkin-btn" bindtap="handleCreateCheckin">
      <text class="btn-icon">+</text>
      <text class="btn-text">创建打卡</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-spinner"></view>
  </view>
</view>
