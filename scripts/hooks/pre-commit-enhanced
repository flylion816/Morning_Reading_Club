#!/bin/bash
# Enhanced Pre-commit Hook for Morning Reading Club
# 增强版 Pre-commit 钩子

set -e

echo "🔍 运行 Pre-commit 检查..."

# 获取staged文件列表
STAGED_FILES=$(git diff --cached --name-only)

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

# 辅助函数：打印步骤标题
print_step() {
  echo ""
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${BLUE}$1${NC}"
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# 1. ESLint 检查
print_step "📋 Step 1/6: ESLint 代码质量检查"

# Backend 文件
BACKEND_FILES=$(echo "$STAGED_FILES" | grep "^backend/.*\.js$" || true)
if [ -n "$BACKEND_FILES" ]; then
  echo "检查 Backend 文件: $(echo "$BACKEND_FILES" | wc -l | tr -d ' ') 个"
  cd backend
  if ! npx eslint $BACKEND_FILES 2>&1; then
    echo -e "${RED}✗ Backend ESLint 检查失败${NC}"
    echo -e "${YELLOW}提示: 运行 'npm run lint:fix' 自动修复部分问题${NC}"
    ERRORS=$((ERRORS + 1))
  else
    echo -e "${GREEN}✓ Backend ESLint 检查通过${NC}"
  fi
  cd ..
fi

# Admin 文件
ADMIN_FILES=$(echo "$STAGED_FILES" | grep "^admin/.*\.\(ts\|vue\)$" || true)
if [ -n "$ADMIN_FILES" ]; then
  echo "检查 Admin 文件: $(echo "$ADMIN_FILES" | wc -l | tr -d ' ') 个"
  cd admin
  if ! npm run lint -- --max-warnings 0 2>&1; then
    echo -e "${RED}✗ Admin ESLint 检查失败${NC}"
    echo -e "${YELLOW}提示: 运行 'npm run lint:fix' 自动修复部分问题${NC}"
    ERRORS=$((ERRORS + 1))
  else
    echo -e "${GREEN}✓ Admin ESLint 检查通过${NC}"
  fi
  cd ..
fi

# Miniprogram 文件（静态检查）
MINI_FILES=$(echo "$STAGED_FILES" | grep "^miniprogram/.*\.js$" || true)
if [ -n "$MINI_FILES" ]; then
  echo "检查 Miniprogram 文件: $(echo "$MINI_FILES" | wc -l | tr -d ' ') 个"
  # 小程序暂时只做语法检查
  for file in $MINI_FILES; do
    if ! node --check "$file" 2>&1; then
      echo -e "${RED}✗ $file 语法错误${NC}"
      ERRORS=$((ERRORS + 1))
    fi
  done
  echo -e "${GREEN}✓ Miniprogram 语法检查通过${NC}"
fi

# 2. Prettier 格式检查
print_step "✨ Step 2/6: Prettier 代码格式检查"

FORMAT_FILES=$(echo "$STAGED_FILES" | grep "\.\(js\|ts\|jsx\|tsx\|vue\|json\|md\)$" || true)
if [ -n "$FORMAT_FILES" ]; then
  if ! npx prettier --check $FORMAT_FILES 2>&1; then
    echo -e "${YELLOW}⚠ 代码格式不符合规范${NC}"
    echo -e "${YELLOW}提示: 运行 'npx prettier --write <files>' 自动格式化${NC}"
    WARNINGS=$((WARNINGS + 1))
  else
    echo -e "${GREEN}✓ 代码格式检查通过${NC}"
  fi
fi

# 3. 敏感文件检查
print_step "🔐 Step 3/6: 敏感文件检查"

SENSITIVE_FILES=".env .env.local .env.production .env.*.local credentials.json secrets.json private.key"
FOUND_SENSITIVE=false

for file in $SENSITIVE_FILES; do
  if echo "$STAGED_FILES" | grep -q "^$file$\|/$file$"; then
    echo -e "${RED}✗ 禁止提交敏感文件: $file${NC}"
    ERRORS=$((ERRORS + 1))
    FOUND_SENSITIVE=true
  fi
done

if [ "$FOUND_SENSITIVE" = false ]; then
  echo -e "${GREEN}✓ 未发现敏感文件${NC}"
fi

# 4. 检查 debugger 和 console 语句
print_step "🐛 Step 4/6: Debugger 和 Console 检查"

DEBUGGER_FOUND=false
CONSOLE_FOUND=false

for file in $STAGED_FILES; do
  if [[ $file =~ \.(js|ts|jsx|tsx|vue)$ ]]; then
    if [[ ! $file =~ node_modules ]]; then
      # 检查 debugger
      if git diff --cached "$file" | grep "^\+.*debugger" > /dev/null 2>&1; then
        echo -e "${RED}✗ 发现 debugger 语句: $file${NC}"
        ERRORS=$((ERRORS + 1))
        DEBUGGER_FOUND=true
      fi

      # 检查 console.log（警告，不阻止提交）
      if git diff --cached "$file" | grep -E "^\+.*console\.(log|error|warn|info|debug)" | grep -v "// 临时调试" > /dev/null 2>&1; then
        echo -e "${YELLOW}⚠ 发现 console 语句: $file${NC}"
        WARNINGS=$((WARNINGS + 1))
        CONSOLE_FOUND=true
      fi
    fi
  fi
done

if [ "$DEBUGGER_FOUND" = false ] && [ "$CONSOLE_FOUND" = false ]; then
  echo -e "${GREEN}✓ 未发现 debugger 或 console 语句${NC}"
fi

# 5. 检查 TODO/FIXME
print_step "📝 Step 5/6: TODO/FIXME 检查"

CRITICAL_TODOS=$(git diff --cached | grep -E "^\+.*//\s*(TODO|FIXME):" | wc -l || echo "0")
if [ "$CRITICAL_TODOS" -gt 0 ]; then
  echo -e "${YELLOW}⚠ 发现 $CRITICAL_TODOS 个未解决的 TODO/FIXME${NC}"
  git diff --cached | grep -E "^\+.*//\s*(TODO|FIXME):" | head -5
  WARNINGS=$((WARNINGS + 1))
else
  echo -e "${GREEN}✓ 未发现新增的 TODO/FIXME${NC}"
fi

# 6. 快速单元测试（仅修改文件相关）
print_step "🧪 Step 6/6: 快速单元测试"

# Backend 单元测试
if [ -n "$BACKEND_FILES" ]; then
  echo "运行 Backend 单元测试（仅修改文件）..."
  cd backend

  # 提取测试文件名
  TEST_FILES=""
  for file in $BACKEND_FILES; do
    # 转换为测试文件路径
    test_file=$(echo "$file" | sed 's/backend\///g' | sed 's/src\//tests\/unit\//g' | sed 's/\.js/.test.js/g')
    if [ -f "$test_file" ]; then
      TEST_FILES="$TEST_FILES $test_file"
    fi
  done

  if [ -n "$TEST_FILES" ]; then
    if ! npm run test:unit -- $TEST_FILES 2>&1; then
      echo -e "${RED}✗ Backend 单元测试失败${NC}"
      ERRORS=$((ERRORS + 1))
    else
      echo -e "${GREEN}✓ Backend 单元测试通过${NC}"
    fi
  else
    echo -e "${YELLOW}⚠ 未找到对应的测试文件，跳过测试${NC}"
  fi

  cd ..
fi

# Admin TypeScript 类型检查
if [ -n "$ADMIN_FILES" ]; then
  echo "运行 TypeScript 类型检查..."
  cd admin
  if ! npm run type-check 2>&1; then
    echo -e "${RED}✗ TypeScript 类型检查失败${NC}"
    ERRORS=$((ERRORS + 1))
  else
    echo -e "${GREEN}✓ TypeScript 类型检查通过${NC}"
  fi
  cd ..
fi

# 结果汇总
echo ""
echo "========================================="
echo "           检查结果汇总"
echo "========================================="
echo ""

if [ $ERRORS -eq 0 ]; then
  if [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}✅ 所有检查通过！可以提交${NC}"
  else
    echo -e "${YELLOW}⚠️  检查完成，有 $WARNINGS 个警告（不阻止提交）${NC}"
    echo -e "${YELLOW}建议修复警告后再提交${NC}"
  fi
  exit 0
else
  echo -e "${RED}❌ 检查失败，共 $ERRORS 个错误${NC}"

  if [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}⚠️  同时有 $WARNINGS 个警告${NC}"
  fi

  echo ""
  echo "修复建议:"
  echo "1. 查看上方错误信息"
  echo "2. 运行 'npm run lint:fix' 自动修复部分问题"
  echo "3. 运行 'npm run test:unit' 查看详细测试错误"
  echo "4. 如需临时跳过检查（不推荐），使用 'git commit --no-verify'"
  echo ""
  exit 1
fi
