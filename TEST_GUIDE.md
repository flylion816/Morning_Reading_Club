# Mock 数据替换 - 测试指南

**目标**: 验证排行榜、成员列表、打卡记录三个页面已正确使用真实数据库数据

**所需时间**: 15-20 分钟

---

## 📋 前置准备

### 1. 确保后端服务运行
```bash
cd /Users/pica_1/我的坚果云/flylion/AI项目开发/七个习惯晨读营/backend
npm run dev
```

**预期输出**:
```
✅ MongoDB 连接成功
✅ 服务器启动在 http://localhost:3000
```

### 2. 检查初始化脚本已执行
```bash
# 已执行过的标志：数据库中存在报名记录和更新的打卡数据
```

**验证**:
- Enrollment 数据库表中有 24 条记录 (6 用户 × 4 期次)
- Checkin 记录中有 likeCount 和 isFeatured 字段

### 3. 启动微信开发者工具
- 打开项目目录
- 点击"编译"重新构建项目
- 小程序 Mock 登录或使用测试账号登录

---

## ✅ 测试用例

### 测试 1: 排行榜页面 (ranking.js)

**操作步骤**:
1. 从小程序底部 TabBar 进入"晨读营"
2. 选择任意期次（如"智慧之光"）
3. 点击进入期次详情
4. 点击"排行榜"标签进入排行榜页面

**验证点**:
- [ ] **页面加载**: 排行榜页面加载，显示排名列表（不是空白或 Mock 数据）
- [ ] **用户信息**: 显示真实的用户昵称（如"测试用户1"，而非"张三"、"李四"）
- [ ] **头像颜色**: 同一用户的头像颜色保持一致（刷新页面后仍相同）
- [ ] **打卡次数**: 显示的打卡次数与数据库数据一致
- [ ] **当前用户排名**: 底部显示当前登录用户的排名和打卡次数
- [ ] **Tab 切换**:
  - 点击"本周"、"今日"等 Tab，排行榜重新加载
  - 数据应该有变化（或如果没有符合条件的数据则显示空)
- [ ] **错误处理**: 如果后端不可用，应显示错误提示而不是崩溃

**预期行为**:
```
排行榜数据应该显示真实的用户列表，例如：
1. 测试用户2 - 5 次打卡  🟦
2. 测试用户1 - 4 次打卡  🟦
3. 测试用户5 - 3 次打卡  🟦
...

当前用户: 测试用户1, 排名 2, 打卡 4 次
```

---

### 测试 2: 成员列表页面 (members.js)

**操作步骤**:
1. 在期次详情页面，找到"成员列表"选项
2. 进入成员列表页面

**验证点**:
- [ ] **成员显示**: 显示该期次的所有报名成员（6 人）
- [ ] **成员信息**: 显示真实的用户昵称和加入日期
- [ ] **日期格式**: 加入日期显示为 "2025-11-10" 格式（而非时间戳）
- [ ] **头像颜色**: 同一用户的头像颜色保持一致
- [ ] **分页加载**: 如果成员超过 20 人，向下滚动可加载更多
  - 初始显示 20 人
  - 滚动到底部自动加载下一页
- [ ] **人数统计**: 顶部显示正确的总人数（6 人）

**预期行为**:
```
成员列表应显示：
- 测试用户1 - 加入于 2025-11-20
- 测试用户2 - 加入于 2025-11-19
- 测试用户3 - 加入于 2025-11-18
- ...
- 测试用户6 - 加入于 2025-11-15

总成员数: 6 人
```

---

### 测试 3: 打卡记录页面 (checkin-records.js)

**操作步骤**:
1. 在期次详情页面底部，找到"我的打卡"或类似选项
2. 进入打卡记录页面

**验证点**:
- [ ] **页面加载**: 显示打卡统计数据（而非 Mock 的固定值）
- [ ] **统计数据**: 显示真实的统计信息
  - 打卡数 (diaryCount)
  - 获赞数 (likeCount)
  - 精选数 (featuredCount)
  - 连续打卡天数 (consecutiveDays)
- [ ] **日历显示**: 当前月份的日历显示打卡日期标记
  - 有打卡的日期应该有特殊标记（如高亮、加粗）
- [ ] **月份导航**:
  - 点击"上一月"按钮，日历切换到上一月份，统计数据和日历重新加载
  - 点击"下一月"按钮，日历切换到下一月份
- [ ] **打卡记录列表**: 显示该月份的打卡记录列表
  - 每条记录显示时间、课节标题、内容
  - 时间格式为本地化格式（不是 ISO 8601）

**预期行为**:
```
打卡统计:
  打卡数: 2
  获赞数: 16 (8 赞 + 8 赞)
  精选: 1
  连续天数: 2

日历:
  显示 2025 年 11 月
  第 10 日标记为打卡
  第 15 日标记为打卡

打卡记录:
  2025/11/15 10:30 - 第 5 天 - 内容预览...
  2025/11/10 09:45 - 第 3 天 - 内容预览...
```

---

## 🔍 数据一致性验证

### 方法 1: 后端数据查询

```bash
# 查看数据库中的实际数据
mongosh

> use morning-reading-club
> db.enrollments.countDocuments()
# 应该返回 24

> db.checkins.findOne()
# 应该包含 likeCount 和 isFeatured 字段
```

### 方法 2: Network 监控

在微信开发者工具中：
1. 打开"Console"标签
2. 切换到"Network"标签
3. 进入排行榜/成员列表/打卡记录页面
4. 观察网络请求

**验证点**:
- [ ] 请求 URL 正确
  ```
  GET /api/v1/ranking/period/xxx?timeRange=all
  GET /api/v1/enrollments/period/xxx
  GET /api/v1/checkins/user/
  ```
- [ ] 响应状态: 200 OK
- [ ] 响应体包含预期数据结构
  ```json
  {
    "code": 200,
    "message": "成功",
    "data": {
      "list": [...],
      "total": 6
    }
  }
  ```

### 方法 3: Console 日志

在页面加载时，Console 应显示：
```
排行榜页面加载 {periodId: "xxx"}
加载排行榜数据...
获取到排行榜数据: {list: [...], currentUser: {...}, total: 6}
```

---

## ⚠️ 常见问题排查

### 问题 1: 页面显示空白或加载中

**原因**:
- 后端服务未启动
- API 请求超时
- 网络连接问题

**解决**:
1. 确保后端运行: `npm run dev` in backend 目录
2. 检查 Console 是否有错误日志
3. 查看 Network 标签中 API 请求的状态

---

### 问题 2: 显示 Mock 数据（如"张三"、"李四"）

**原因**:
- 代码未更新到最新版本
- 浏览器缓存问题
- 小程序未重新编译

**解决**:
1. 确保 git pull 最新代码
2. 在微信开发者工具中清除缓存（设置 → 清除缓存）
3. 重新编译小程序 (Ctrl+B 或 Cmd+B)

---

### 问题 3: 日期显示不正确

**原因**:
- 日期格式化函数有误
- 时区设置问题

**解决**:
检查 Console 中的日期输出，确保使用了 `toLocaleDateString('zh-CN')`

---

### 问题 4: 头像颜色不一致

**原因**:
- 未使用 `getAvatarColorByUserId()` 函数
- 随机函数用在数据转换中

**解决**:
检查 ranking.js, members.js 中是否调用了正确的函数

---

## 📊 性能检查

### 加载时间

**预期**:
- 排行榜列表: < 500ms
- 成员列表: < 500ms
- 打卡记录: < 500ms

**测试方法**:
在 Network 标签中查看每个 API 请求的响应时间

### 数据包大小

**预期**:
- 排行榜响应: < 20KB
- 成员列表响应: < 30KB (20 条记录)
- 打卡记录响应: < 50KB (统计 + 日历 + 记录列表)

---

## 📝 测试报告模板

```
测试日期: YYYY-MM-DD
测试者: [名字]
测试环境: iOS 14.x / Android 10.x
后端版本: [Commit SHA]
前端版本: [Commit SHA]

## 测试结果

### 排行榜页面
- [ ] 页面加载正常
- [ ] 显示真实数据
- [ ] Tab 切换正常
- [ ] 错误处理正常
- 备注: ___________

### 成员列表页面
- [ ] 页面加载正常
- [ ] 显示真实数据
- [ ] 分页功能正常
- [ ] 日期格式正确
- 备注: ___________

### 打卡记录页面
- [ ] 页面加载正常
- [ ] 统计数据正确
- [ ] 日历显示正确
- [ ] 月份切换正常
- 备注: ___________

## 总体评价
[ ] 通过 - 可以部署到生产环境
[ ] 通过但有小问题 - 需要修复后再部署
[ ] 不通过 - 需要重新开发
```

---

## ✅ 验收标准

项目可视为完成当满足以下条件:

1. **三个页面都显示真实数据**，而不是 Mock 数据
2. **所有 API 调用成功**，响应时间 < 1 秒
3. **数据一致性**，刷新后数据不变
4. **用户体验**，无卡顿、加载提示明确
5. **错误处理**，后端不可用时有错误提示
6. **跨页面一致性**，同一用户的显示信息保持一致

---

## 💡 附加说明

### 数据库中的真实用户

目前数据库中有 6 个测试用户，每个都报名了 4 个期次。如需验证不同用户，可以：

1. 用不同的账号登录小程序
2. 或者通过后台管理系统创建更多测试数据

### 初始化脚本

如果需要重新初始化数据，执行：

```bash
# 重新创建报名关系
node backend/scripts/init-enrollments.js

# 为打卡记录添加点赞和精选标记
node backend/scripts/update-checkins.js
```

**注意**: 这会覆盖现有的 Enrollment 记录，但不会删除 Checkin 记录中的内容。

---

**测试完成后**:
- 将此文档中的测试结果截图保存
- 更新 GitHub Issues 中的测试状态
- 如有问题，记录在相应的 Issues 中
