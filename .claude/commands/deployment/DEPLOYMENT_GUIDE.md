# ğŸš€ æ™¨è¯»è¥å°ç¨‹åº - çº¿ä¸Šéƒ¨ç½²æŒ‡å—

> **æœ€åæ›´æ–°**ï¼š2025-12-08
> **éƒ¨ç½²è„šæœ¬**ï¼š`.claude/deployment/deploy.sh`
> **ç¯å¢ƒæ¨¡æ¿**ï¼š`backend/.env.production.template`

---

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### å¿…é¡»å‡†å¤‡çš„ä¿¡æ¯

```
âœ… æœåŠ¡å™¨IPåœ°å€ï¼š______________________
âœ… æœåŠ¡å™¨ç”¨æˆ·åï¼šubuntu (é»˜è®¤)
âœ… æœåŠ¡å™¨å¯†ç /å¯†é’¥ï¼šå·²å‡†å¤‡
âœ… åŸŸåï¼š______________________
âœ… MongoDBè¿æ¥å­—ç¬¦ä¸²ï¼š______________________
âœ… å¾®ä¿¡AppIDï¼š______________________
âœ… å¾®ä¿¡AppSecretï¼š______________________
âœ… JWTå¯†é’¥ï¼š______________________
```

### å¿…é¡»å®Œæˆçš„æ“ä½œ

- [ ] SSHç™»å½•æˆåŠŸï¼ˆ22ç«¯å£å·²å¼€æ”¾ï¼‰
- [ ] å®‰å…¨ç»„å·²é…ç½®ï¼ˆå¼€æ”¾80ã€443ã€3000ç«¯å£ï¼‰
- [ ] DNSå·²é…ç½®ï¼ˆåŸŸåæŒ‡å‘æœåŠ¡å™¨IPï¼‰
- [ ] SSLè¯ä¹¦å·²å‡†å¤‡ï¼ˆæˆ–ä½¿ç”¨Let's Encryptå…è´¹è¯ä¹¦ï¼‰
- [ ] MongoDBå·²åˆ›å»ºï¼ˆäº‘æœåŠ¡æˆ–è‡ªå»ºï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬1æ­¥ï¼šåˆå§‹åŒ–æœåŠ¡å™¨ï¼ˆä»…éœ€ä¸€æ¬¡ï¼‰

```bash
# åœ¨ä½ æœ¬åœ°æ‰§è¡Œ
bash .claude/deployment/deploy.sh 123.207.223.93 init
```

**è¿™ä¼šè‡ªåŠ¨å®Œæˆï¼š**
- âœ… æ›´æ–°ç³»ç»Ÿè½¯ä»¶
- âœ… å®‰è£…Node.js 18
- âœ… å®‰è£…PM2ï¼ˆè¿›ç¨‹ç®¡ç†ï¼‰
- âœ… å®‰è£…Nginxï¼ˆåå‘ä»£ç†ï¼‰
- âœ… åˆ›å»ºéƒ¨ç½²ç›®å½•
- âœ… é…ç½®é˜²ç«å¢™

**æ‰§è¡Œæ—¶é—´**ï¼š10-15åˆ†é’Ÿ

---

### ç¬¬2æ­¥ï¼šå‡†å¤‡ç¯å¢ƒå˜é‡

åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºåç«¯ç¯å¢ƒé…ç½®ï¼š

```bash
ssh ubuntu@123.207.223.93

# è¿›å…¥åç«¯ç›®å½•
cd /var/www/morning-reading/backend

# å¤åˆ¶æ¨¡æ¿
cp ../../.env.production.template .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano .env  # æˆ– vi .env

# å¡«å…¥ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š
# NODE_ENV=production
# MONGODB_URI=mongodb://...ï¼ˆä½ çš„MongoDBåœ°å€ï¼‰
# API_BASE_URL=https://ä½ çš„åŸŸå/api/v1
# JWT_SECRET=éšæœºç”Ÿæˆçš„å¯†é’¥
# WECHAT_APPID=ä½ çš„AppID
# WECHAT_SECRET=ä½ çš„AppSecret
```

**ç”Ÿæˆå®‰å…¨çš„JWTå¯†é’¥ï¼š**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

### ç¬¬3æ­¥ï¼šéƒ¨ç½²åº”ç”¨

```bash
# åœ¨ä½ æœ¬åœ°æ‰§è¡Œ
bash .claude/deployment/deploy.sh 123.207.223.93 deploy
```

**è¿™ä¼šè‡ªåŠ¨å®Œæˆï¼š**

1. âœ… **å…‹éš†åç«¯ä»£ç **
   - ä»GitHubæ‹‰å–æœ€æ–°ä»£ç 
   - å®‰è£…ç”Ÿäº§ä¾èµ–
   - åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶

2. âœ… **å¯åŠ¨åç«¯æœåŠ¡**
   - ä½¿ç”¨PM2å¯åŠ¨ï¼ˆ2ä¸ªå®ä¾‹é›†ç¾¤æ¨¡å¼ï¼‰
   - é…ç½®å¼€æœºè‡ªå¯
   - è¿›è¡Œå¥åº·æ£€æŸ¥

3. âœ… **æ„å»ºå¹¶éƒ¨ç½²å‰ç«¯**
   - æœ¬åœ°æ„å»ºadmin dist
   - ä¸Šä¼ åˆ°æœåŠ¡å™¨
   - é…ç½®Nginxæä¾›é™æ€æ–‡ä»¶

4. âœ… **é…ç½®Nginxåå‘ä»£ç†**
   - APIè¯·æ±‚ä»£ç†åˆ°åç«¯
   - å‰ç«¯è·¯ç”±SPAæ”¯æŒ
   - å®‰å…¨å¤´é…ç½®

5. âœ… **é…ç½®SSLè¯ä¹¦**
   - ä½¿ç”¨Let's Encryptå…è´¹è¯ä¹¦
   - é…ç½®HTTPS
   - è‡ªåŠ¨ç»­æœŸ

**æ‰§è¡Œæ—¶é—´**ï¼š15-20åˆ†é’Ÿ

---

### ç¬¬4æ­¥ï¼šéªŒè¯éƒ¨ç½²

```bash
# åœ¨ä½ æœ¬åœ°æ‰§è¡Œ
bash .claude/deployment/deploy.sh 123.207.223.93 status
```

**åº”è¯¥çœ‹åˆ°ï¼š**
```
=== PM2æœåŠ¡çŠ¶æ€ ===
â”‚ id â”‚ name                   â”‚ mode    â”‚ â†º â”‚ status
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0  â”‚ morning-reading-api    â”‚ cluster â”‚ 0 â”‚ online
â”‚ 1  â”‚ morning-reading-api    â”‚ cluster â”‚ 0 â”‚ online

=== APIå¥åº·æ£€æŸ¥ ===
{"status":"ok"}

=== NginxçŠ¶æ€ ===
Active: active (running)
```

**éªŒè¯è®¿é—®ï¼š**
```bash
# éªŒè¯åç«¯API
curl -k https://ä½ çš„åŸŸå/api/v1/health

# éªŒè¯å‰ç«¯
curl -k https://ä½ çš„åŸŸå/admin
```

---

## ğŸ“ å¸¸è§æ“ä½œ

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
bash .claude/deployment/deploy.sh 123.207.223.93 logs
```

### æ›´æ–°ä»£ç ï¼ˆæœ‰æ–°æäº¤æ—¶ï¼‰

```bash
# æ¨é€æ–°ä»£ç åˆ°GitHubåï¼Œæ‰§è¡Œï¼š
bash .claude/deployment/deploy.sh 123.207.223.93 update

# è¿™ä¼šï¼š
# 1. æ‹‰å–æœ€æ–°ä»£ç 
# 2. é‡æ–°å®‰è£…ä¾èµ–ï¼ˆå¦‚æœæœ‰æ”¹å˜ï¼‰
# 3. è‡ªåŠ¨é‡å¯PM2
```

### æ‰‹åŠ¨SSHè¿æ¥æœåŠ¡å™¨

```bash
ssh ubuntu@123.207.223.93

# æŸ¥çœ‹PM2çŠ¶æ€
pm2 status
pm2 logs morning-reading-api

# é‡å¯æœåŠ¡
pm2 restart morning-reading-api

# åœæ­¢æœåŠ¡
pm2 stop morning-reading-api

# æŸ¥çœ‹Nginxæ—¥å¿—
tail -f /var/log/nginx/morning-reading-access.log
```

---

## âš ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šAPIæ— æ³•è®¿é—®

```bash
# æ£€æŸ¥PM2çŠ¶æ€
ssh ubuntu@123.207.223.93 "pm2 status"

# æŸ¥çœ‹æ—¥å¿—
ssh ubuntu@123.207.223.93 "pm2 logs morning-reading-api"

# æ£€æŸ¥MongoDBè¿æ¥
ssh ubuntu@123.207.223.93 "curl http://localhost:3000/api/v1/health"
```

**å¸¸è§åŸå› ï¼š**
- MongoDBè¿æ¥å­—ç¬¦ä¸²é”™è¯¯ â†’ æ£€æŸ¥ `.env` æ–‡ä»¶
- ç¯å¢ƒå˜é‡æœªè®¾ç½® â†’ é‡å¯PM2
- ä¾èµ–ç‰ˆæœ¬é—®é¢˜ â†’ é‡æ–° `npm install`

### é—®é¢˜2ï¼šHTTPSè¯ä¹¦é”™è¯¯

```bash
# æ£€æŸ¥è¯ä¹¦è¿‡æœŸæ—¥æœŸ
ssh ubuntu@123.207.223.93 "sudo openssl x509 -in /etc/nginx/ssl/certificate.crt -noout -dates"

# æ‰‹åŠ¨ç»­æœŸ
ssh ubuntu@123.207.223.93 "sudo certbot renew"
```

### é—®é¢˜3ï¼šNginx 502é”™è¯¯

```bash
# æ£€æŸ¥Nginxé…ç½®
ssh ubuntu@123.207.223.93 "sudo nginx -t"

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
ssh ubuntu@123.207.223.93 "tail -50 /var/log/nginx/morning-reading-error.log"

# é‡å¯Nginx
ssh ubuntu@123.207.223.93 "sudo systemctl restart nginx"
```

### é—®é¢˜4ï¼šç£ç›˜ç©ºé—´æ»¡

```bash
# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
ssh ubuntu@123.207.223.93 "df -h"

# æ¸…ç†æ—¥å¿—
ssh ubuntu@123.207.223.93 "sudo journalctl --vacuum=100M"

# æ¸…ç†PM2æ—¥å¿—
ssh ubuntu@123.207.223.93 "pm2 flush"
```

---

## ğŸ“Š æ€§èƒ½ç›‘æ§

### å®æ—¶ç›‘æ§

```bash
ssh ubuntu@123.207.223.93 << 'EOF'
# æŸ¥çœ‹è¿›ç¨‹å ç”¨
top

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
netstat -an | grep ESTABLISHED

# æŸ¥çœ‹ç£ç›˜I/O
iostat -x 1 5
EOF
```

### è®¾ç½®å‘Šè­¦ï¼ˆå¯é€‰ï¼‰

è¿æ¥åˆ°äº‘å‚å•†æ§åˆ¶å°ï¼š

**é˜¿é‡Œäº‘ï¼š**
```
æ§åˆ¶å° â†’ äº‘ç›‘æ§ â†’ å‘Šè­¦è§„åˆ™ â†’ æ–°å»ºè§„åˆ™
- CPU > 80% å‘Šè­¦
- å†…å­˜ > 80% å‘Šè­¦
- ç£ç›˜ > 90% å‘Šè­¦
```

**è…¾è®¯äº‘ï¼š**
```
æ§åˆ¶å° â†’ äº‘ç›‘æ§ â†’ å‘Šè­¦ç®¡ç† â†’ æ–°å»ºç­–ç•¥
- CPU > 80% å‘Šè­¦
- å†…å­˜ > 80% å‘Šè­¦
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### âœ… å¿…åš

- [ ] ä¿®æ”¹SSHé»˜è®¤ç«¯å£ï¼ˆå¯é€‰ä½†æ¨èï¼‰
- [ ] ç¦ç”¨å¯†ç ç™»å½•ï¼Œä»…å…è®¸å¯†é’¥ç™»å½•
- [ ] é…ç½®é˜²ç«å¢™åªå…è®¸å¿…è¦ç«¯å£
- [ ] å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–
- [ ] å®šæœŸå¤‡ä»½æ•°æ®åº“

### ç¯å¢ƒå˜é‡å®‰å…¨

```bash
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ .env æ–‡ä»¶
WECHAT_SECRET=xxxxxxxxxxxx

# âŒ é”™è¯¯ï¼šç¡¬ç¼–ç åœ¨ä»£ç ä¸­
const SECRET = "xxxxxxxxxxxx";

# âŒ é”™è¯¯ï¼šåœ¨GitHubä¸Šæäº¤ .env
git add .env  # ä¸è¦è¿™æ ·åšï¼
```

### æ—¥å¿—å®‰å…¨

```bash
# å®šæœŸæ¸…ç†æ—¥å¿—ï¼ˆé˜²æ­¢ç£ç›˜æ»¡ï¼‰
ssh ubuntu@123.207.223.93 << 'EOF'
# æ¸…ç†7å¤©å‰çš„æ—¥å¿—
find /var/log -type f -name "*.log" -mtime +7 -delete

# é…ç½®æ—¥å¿—è½®è½¬
sudo vim /etc/logrotate.d/nginx
EOF
```

---

## ğŸ“ˆ åç»­ä¼˜åŒ–

### ç¬¬1å‘¨

- [ ] ç›‘æ§é”™è¯¯æ—¥å¿—
- [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ
- [ ] ä¿®å¤å‘ç°çš„Bug
- [ ] ä¼˜åŒ–APIæ€§èƒ½

### ç¬¬2-4å‘¨

- [ ] æ·»åŠ Redisç¼“å­˜
- [ ] ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
- [ ] å¯ç”¨CDNåŠ é€Ÿ
- [ ] æ·»åŠ æ›´å¤šåŠŸèƒ½

### æŒç»­

- [ ] å®šæœŸå¤‡ä»½
- [ ] ç›‘æ§å‘Šè­¦
- [ ] ä»£ç å®¡æŸ¥
- [ ] æ€§èƒ½è°ƒä¼˜

---

## ğŸ†˜ è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼ŸæŒ‰ä»¥ä¸‹é¡ºåºå°è¯•ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**
   ```bash
   bash deploy.sh <IP> logs
   ```

2. **æ£€æŸ¥çŠ¶æ€**
   ```bash
   bash deploy.sh <IP> status
   ```

3. **æŸ¥çœ‹æœ¬æ–‡æ¡£æ•…éšœæ’æŸ¥éƒ¨åˆ†**

4. **SSHè¿æ¥æœåŠ¡å™¨æ‰‹åŠ¨æ£€æŸ¥**

5. **æäº¤Issueåˆ°GitHub**

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²è„šæœ¬è¯´æ˜](.claude/deployment/deploy.sh)
- [ç¯å¢ƒå˜é‡æ¨¡æ¿](./backend/.env.production.template)
- [åœ¨çº¿éƒ¨ç½²è®¡åˆ’](.claude/memory/online-deployment-plan.md)
- [å¼€å‘æŒ‡å—](./DEVELOPMENT.md)

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼ğŸ‰**
