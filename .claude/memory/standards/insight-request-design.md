# å°å‡¡çœ‹è§æŸ¥çœ‹ç”³è¯·åŠŸèƒ½ - å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·å¯ä»¥å‘ä»–äººå‘èµ·æŸ¥çœ‹å…¶"å°å‡¡çœ‹è§"è®°å½•çš„ç”³è¯·ã€‚è¢«ç”³è¯·è€…å¯ä»¥åŒæ„æˆ–æ‹’ç»ã€‚åŒæ„åï¼Œç”³è¯·è€…å¯ä»¥æŸ¥çœ‹è¢«ç”³è¯·è€…åœ¨è¯¥æœŸæ¬¡çš„æ‰€æœ‰å°å‡¡çœ‹è§ã€‚

---

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### 1. InsightRequestï¼ˆæŸ¥çœ‹ç”³è¯·è¡¨ï¼‰

**ç”¨é€”**ï¼šè®°å½•ç”¨æˆ·ä¹‹é—´çš„æŸ¥çœ‹ç”³è¯·

**å­—æ®µè®¾è®¡**ï¼š

```javascript
{
  _id: ObjectId,

  // ç”³è¯·åŒæ–¹
  fromUserId: ObjectId (ref User),      // ç”³è¯·è€…
  toUserId: ObjectId (ref User),        // è¢«ç”³è¯·è€…

  // ç”³è¯·çŠ¶æ€
  status: String (enum: ['pending', 'approved', 'rejected']),

  // ç”³è¯·ä¿¡æ¯
  reason: String (optional),             // ç”³è¯·åŸå› 
  createdAt: Date,
  updatedAt: Date,

  // å®¡æ‰¹ä¿¡æ¯
  approvedAt: Date (optional),           // åŒæ„æ—¶é—´
  rejectedAt: Date (optional),           // æ‹’ç»æ—¶é—´

  // æƒé™èŒƒå›´
  periodId: ObjectId (ref Period),       // å…è®¸æŸ¥çœ‹çš„æœŸæ¬¡ï¼ˆä»…approvedæ—¶æœ‰æ•ˆï¼‰

  // ç´¢å¼•
  indexes: {
    unique: { fromUserId, toUserId },   // åŒä¸€å¯¹ç”¨æˆ·åªèƒ½æœ‰ä¸€ä¸ªpendingç”³è¯·
    composite: { toUserId, status },    // æŒ‰è¢«ç”³è¯·è€…å’ŒçŠ¶æ€æŸ¥è¯¢
    composite: { fromUserId, status },  // æŒ‰ç”³è¯·è€…å’ŒçŠ¶æ€æŸ¥è¯¢
    createdAt: -1                        // æŒ‰åˆ›å»ºæ—¶é—´æ’åº
  }
}
```

**è¯´æ˜**ï¼š

- `unique` ç´¢å¼•é˜²æ­¢é‡å¤ç”³è¯·
- `periodId` ä»…åœ¨ `status='approved'` æ—¶æœ‰æ„ä¹‰
- æ”¯æŒå¤šæœŸæŸ¥çœ‹ï¼šå¦‚æœéœ€è¦å¤šæœŸï¼Œå¯æ‰©å±•ä¸º `periodIds: [ObjectId]`

---

## ğŸ”— å…³ç³»è¡¨è®¾è®¡

### InsightPermissionï¼ˆæƒé™è¡¨ï¼‰- å¯é€‰

å¦‚æœéœ€è¦æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ï¼Œå¯ä½¿ç”¨æ­¤è¡¨ï¼š

```javascript
{
  _id: ObjectId,

  // å…³ç³»
  granteeId: ObjectId (ref User),       // è¢«æˆäºˆæƒé™è€…ï¼ˆç”³è¯·è€…ï¼‰
  grantorId: ObjectId (ref User),       // æˆäºˆæƒé™è€…ï¼ˆè¢«ç”³è¯·è€…ï¼‰

  // æƒé™èŒƒå›´
  periodId: ObjectId (ref Period),      // å¯æŸ¥çœ‹çš„æœŸæ¬¡
  insights: [ObjectId] (ref Insight),   // å¯æŸ¥çœ‹çš„specific insightsï¼ˆå¯é€‰ï¼‰

  // çŠ¶æ€
  status: String (enum: ['active', 'revoked']),

  // æ—¶é—´
  grantedAt: Date,                      // æˆäºˆæ—¶é—´
  expiresAt: Date (optional),           // è¿‡æœŸæ—¶é—´
  revokedAt: Date (optional),           // æ’¤é”€æ—¶é—´

  // ç´¢å¼•
  indexes: {
    composite: { granteeId, grantorId, periodId },
    composite: { grantorId, status }
  }
}
```

**è¯´æ˜**ï¼š

- å½“ InsightRequest.status æ”¹ä¸º 'approved' æ—¶ï¼Œåˆ›å»ºå¯¹åº”çš„ InsightPermission è®°å½•
- æ”¯æŒæƒé™è¿‡æœŸã€æ’¤é”€ç­‰é«˜çº§åŠŸèƒ½

---

## ğŸ”Œ API æ¥å£è®¾è®¡

### 1ï¸âƒ£ å‘èµ·æŸ¥çœ‹ç”³è¯·

**è¯·æ±‚**ï¼š

```
POST /api/v1/insights/requests
Authorization: Bearer {token}

{
  "toUserId": "ç”¨æˆ·ID",
  "reason": "æƒ³çœ‹çœ‹ä½ çš„å­¦ä¹ åé¦ˆ" (optional)
}
```

**å“åº”æˆåŠŸï¼ˆ201ï¼‰**ï¼š

```json
{
  "code": 200,
  "data": {
    "_id": "ç”³è¯·ID",
    "fromUserId": "ç”³è¯·è€…ID",
    "toUserId": "è¢«ç”³è¯·è€…ID",
    "status": "pending",
    "createdAt": "2025-12-04T12:00:00Z"
  },
  "message": "ç”³è¯·å·²å‘é€"
}
```

**é”™è¯¯æƒ…å†µ**ï¼š

- 400: è‡ªå·±ä¸èƒ½å‘è‡ªå·±å‘èµ·ç”³è¯· â†’ "æ— éœ€å‘è‡ªå·±å‘èµ·æŸ¥çœ‹è¯·æ±‚"
- 409: å·²æœ‰pendingç”³è¯· â†’ "ç”³è¯·å·²å­˜åœ¨ï¼Œè¯·ç­‰å¾…å¯¹æ–¹å›å¤"
- 200: å·²æœ‰approvedç”³è¯· â†’ "å·²è·å¾—æŸ¥çœ‹æƒé™"

---

### 2ï¸âƒ£ è·å–æ”¶åˆ°çš„ç”³è¯·åˆ—è¡¨

**è¯·æ±‚**ï¼š

```
GET /api/v1/insights/requests/received?status=pending
Authorization: Bearer {token}
```

**å“åº”**ï¼š

```json
{
  "code": 200,
  "data": [
    {
      "_id": "ç”³è¯·ID",
      "fromUserId": {
        "_id": "ç”¨æˆ·ID",
        "nickname": "é˜¿æ³°",
        "avatarUrl": "...",
        "avatar": "ğŸ¦"
      },
      "status": "pending",
      "reason": "æƒ³çœ‹çœ‹ä½ çš„å­¦ä¹ åé¦ˆ",
      "createdAt": "2025-12-04T12:00:00Z"
    }
  ],
  "message": "è·å–æˆåŠŸ"
}
```

---

### 3ï¸âƒ£ åŒæ„æŸ¥çœ‹ç”³è¯·

**è¯·æ±‚**ï¼š

```
PUT /api/v1/insights/requests/{requestId}/approve
Authorization: Bearer {token}

{
  "periodId": "æœŸæ¬¡ID"  // æœ¬æœŸçš„periodId
}
```

**é€»è¾‘**ï¼š

1. éªŒè¯å½“å‰ç”¨æˆ·æ˜¯ç”³è¯·çš„ `toUserId`
2. éªŒè¯ç”³è¯·çŠ¶æ€ä¸º 'pending'
3. æ›´æ–°ç”³è¯·çŠ¶æ€ä¸º 'approved'
4. åˆ›å»º InsightPermission è®°å½•ï¼ˆå¦‚ä½¿ç”¨ï¼‰
5. è®°å½•åŒæ„æ—¶é—´

**å“åº”ï¼ˆ200ï¼‰**ï¼š

```json
{
  "code": 200,
  "data": {
    "_id": "ç”³è¯·ID",
    "status": "approved",
    "periodId": "æœŸæ¬¡ID",
    "approvedAt": "2025-12-04T12:30:00Z"
  },
  "message": "å·²åŒæ„æŸ¥çœ‹è¯·æ±‚"
}
```

---

### 4ï¸âƒ£ æ‹’ç»æŸ¥çœ‹ç”³è¯·

**è¯·æ±‚**ï¼š

```
PUT /api/v1/insights/requests/{requestId}/reject
Authorization: Bearer {token}
```

**é€»è¾‘**ï¼š

1. éªŒè¯å½“å‰ç”¨æˆ·æ˜¯ç”³è¯·çš„ `toUserId`
2. éªŒè¯ç”³è¯·çŠ¶æ€ä¸º 'pending'
3. æ›´æ–°ç”³è¯·çŠ¶æ€ä¸º 'rejected'
4. è®°å½•æ‹’ç»æ—¶é—´

**å“åº”ï¼ˆ200ï¼‰**ï¼š

```json
{
  "code": 200,
  "data": {
    "_id": "ç”³è¯·ID",
    "status": "rejected",
    "rejectedAt": "2025-12-04T12:35:00Z"
  },
  "message": "å·²æ‹’ç»æŸ¥çœ‹è¯·æ±‚"
}
```

---

### 5ï¸âƒ£ è·å–å‘èµ·çš„ç”³è¯·åˆ—è¡¨

**è¯·æ±‚**ï¼š

```
GET /api/v1/insights/requests/sent?status=all
Authorization: Bearer {token}
```

**å“åº”**ï¼š

```json
{
  "code": 200,
  "data": [
    {
      "_id": "ç”³è¯·ID",
      "toUserId": {
        "_id": "ç”¨æˆ·ID",
        "nickname": "ç‹®å­",
        "avatarUrl": "..."
      },
      "status": "approved",
      "createdAt": "2025-12-04T12:00:00Z",
      "approvedAt": "2025-12-04T12:30:00Z",
      "periodId": "æœŸæ¬¡ID"
    }
  ]
}
```

---

### 6ï¸âƒ£ è·å–ä»–äººçš„å°å‡¡çœ‹è§ï¼ˆéœ€è¦æƒé™æ£€æŸ¥ï¼‰

**è¯·æ±‚**ï¼š

```
GET /api/v1/insights/user/{userId}/period/{periodId}
Authorization: Bearer {token}
```

**æƒé™æ£€æŸ¥é€»è¾‘**ï¼š

1. å¦‚æœ userId === å½“å‰ç”¨æˆ· â†’ å…è®¸æŸ¥çœ‹è‡ªå·±çš„
2. å¦‚æœå­˜åœ¨ approved InsightRequest ä¸” periodId åŒ¹é… â†’ å…è®¸æŸ¥çœ‹
3. å¦åˆ™ â†’ 403 Forbidden

---

## ğŸ”„ å®Œæ•´æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šé˜¿æ³°å‘ç‹®å­å‘èµ·æŸ¥çœ‹ç”³è¯·

#### 1ï¸âƒ£ é˜¿æ³°å‘èµ·ç”³è¯·

```
POST /insights/requests
{ toUserId: "ç‹®å­ID", reason: "æƒ³çœ‹çœ‹ä½ çš„å­¦ä¹ åé¦ˆ" }

â†“ åˆ›å»º InsightRequest è®°å½•
{
  fromUserId: "é˜¿æ³°ID",
  toUserId: "ç‹®å­ID",
  status: "pending"
}
```

#### 2ï¸âƒ£ ç‹®å­åœ¨é¦–é¡µçœ‹åˆ°ç”³è¯·

```
GET /insights/requests/received?status=pending

â†“ è¿”å›å¾…å®¡æ‰¹çš„ç”³è¯·åˆ—è¡¨
[{ fromUserId: "é˜¿æ³°...", status: "pending", ... }]
```

#### 3ï¸âƒ£ ç‹®å­åŒæ„æŸ¥çœ‹

```
PUT /insights/requests/{requestId}/approve
{ periodId: "2025å¹´12æœˆæœŸæ¬¡ID" }

â†“ æ›´æ–°è®°å½•
{
  status: "approved",
  periodId: "2025å¹´12æœˆæœŸæ¬¡ID",
  approvedAt: "2025-12-04T12:30:00Z"
}

â†“ åˆ›å»ºæƒé™è®°å½•ï¼ˆå¯é€‰ï¼‰
InsightPermission: {
  granteeId: "é˜¿æ³°ID",
  grantorId: "ç‹®å­ID",
  periodId: "2025å¹´12æœˆæœŸæ¬¡ID",
  status: "active"
}
```

#### 4ï¸âƒ£ é˜¿æ³°å¯ä»¥æŸ¥çœ‹ç‹®å­æœ¬æœŸçš„å°å‡¡çœ‹è§

```
GET /insights/user/ç‹®å­ID/period/2025å¹´12æœˆæœŸæ¬¡ID

â†“ æƒé™æ£€æŸ¥é€šè¿‡ï¼Œè¿”å›ç‹®å­åœ¨æœ¬æœŸçš„æ‰€æœ‰å°å‡¡çœ‹è§
```

#### 5ï¸âƒ£ å¦‚æœæ‹’ç»

```
PUT /insights/requests/{requestId}/reject

â†“ æ›´æ–°è®°å½•
{
  status: "rejected",
  rejectedAt: "2025-12-04T12:35:00Z"
}

â†“ åœ¨é˜¿æ³°çš„"è¯·æ±‚çœ‹è§"åˆ—è¡¨ä¸­æ˜¾ç¤º"æ‹’ç»"çŠ¶æ€
```

---

## ğŸ“Š å‰ç«¯æ•°æ®æµ

### é¡µé¢1ï¼šä»–äººä¸»é¡µï¼ˆprofile-othersï¼‰

```
ç‚¹å‡»"å°å‡¡çœ‹è§" â†’ æ£€æŸ¥æ˜¯å¦å·²æœ‰æƒé™ â†’
  â”œâ”€ å·²æ‰¹å‡† â†’ æ˜¾ç¤º"æŸ¥çœ‹å°å‡¡çœ‹è§"
  â”œâ”€ å¾…æ‰¹å‡† â†’ æ˜¾ç¤º"ç­‰å¾…å¯¹æ–¹å›å¤"
  â””â”€ æœªç”³è¯·/è¢«æ‹’ â†’ å¼¹çª—ç¡®è®¤å‘èµ·ç”³è¯·
```

### é¡µé¢2ï¼šé¦–é¡µï¼ˆindexï¼‰- æ–°å¢"è¯·æ±‚çœ‹è§"æ¿å—

```
æ˜¾ç¤ºæ”¶åˆ°çš„ç”³è¯·åˆ—è¡¨ï¼š
[
  { æ˜µç§°: "é˜¿æ³°", æ—¶é—´: "2å°æ—¶å‰", çŠ¶æ€: "å¾…å®¡æ‰¹" }
]

ç‚¹å‡»ç”³è¯·è¡Œ â†’ å¼¹çª—æ˜¾ç¤ºç”³è¯·è¯¦æƒ… â†’
  â”œâ”€ ç‚¹å‡»"âœ“" â†’ åŒæ„ â†’ åå°è°ƒç”¨approveæ¥å£
  â””â”€ ç‚¹å‡»"âœ—" â†’ æ‹’ç» â†’ åå°è°ƒç”¨rejectæ¥å£
```

---

## âœ… æ•°æ®ä¸€è‡´æ€§ä¿è¯

| åœºæ™¯                         | å¤„ç†æ–¹å¼             |
| ---------------------------- | -------------------- |
| åŒä¸€å¯¹ç”¨æˆ·å¤šä¸ªpendingç”³è¯·    | åˆ©ç”¨uniqueç´¢å¼•é˜²æ­¢   |
| ç”³è¯·è¢«åˆ é™¤åç”¨æˆ·ä»åœ¨æƒé™åˆ—è¡¨ | æƒé™ç³»ç»Ÿç‹¬ç«‹ç®¡ç†     |
| æœŸæ¬¡åˆ é™¤åæƒé™ä»å­˜åœ¨         | å¯è€ƒè™‘cascade delete |
| ç”¨æˆ·è¢«ç¦ç”¨                   | ç¦ç”¨å…¶æ‰€æœ‰å¾…å®¡æ‰¹ç”³è¯· |

---

## ğŸ” æƒé™æ£€æŸ¥æ¸…å•

- [ ] å‘èµ·ç”³è¯·ï¼šéªŒè¯ä¸æ˜¯è‡ªå·±
- [ ] å®¡æ‰¹ç”³è¯·ï¼šéªŒè¯æ˜¯è¢«ç”³è¯·è€…
- [ ] æŸ¥çœ‹å°å‡¡çœ‹è§ï¼šéªŒè¯æƒé™
- [ ] æ’¤é”€æƒé™ï¼šåªæœ‰è¢«æˆäºˆè€…æˆ–æˆäºˆè€…å¯æ’¤é”€

---

## ğŸ“ˆ å¯é€‰æ‰©å±•

1. **æƒé™è¿‡æœŸ**ï¼šapproved å30å¤©è¿‡æœŸ
2. **æ‰¹é‡æˆæƒ**ï¼šä¸€æ¬¡åŒæ„å¤šä¸ªæœŸæ¬¡
3. **æƒé™æ’¤é”€**ï¼šè¢«æˆäºˆè€…å¯ä»¥å–æ¶ˆæƒé™
4. **ç”³è¯·æé†’**ï¼šå®æ—¶é€šçŸ¥è¢«ç”³è¯·è€…
5. **é»‘åå•**ï¼šå¯æ‹’ç»ç‰¹å®šç”¨æˆ·çš„åç»­ç”³è¯·
6. **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æƒé™å˜æ›´
