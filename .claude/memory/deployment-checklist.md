# 晨读营小程序 + 服务器上线前准备清单

> 📋 完整的上线前检查清单，包括小程序、后端、基础设施、安全、运维等方面

**最后更新**: 2025-12-06
**状态**: ✅ 高优先级完成，现为 90% 准备就绪

## 📊 部署准备进度总结

### ✅ 已完成的高优先级任务（6项）

| 项目                           | 完成时间   | 文件/位置                                            | 验证方式                                |
| ------------------------------ | ---------- | ---------------------------------------------------- | --------------------------------------- |
| 隐私政策和用户协议             | 2025-12-06 | `docs/privacy-policy.md`、`docs/terms-of-service.md` | GitHub commit 30d9b8b                   |
| 移除开发调试代码               | 2025-12-06 | `miniprogram/` 目录                                  | 移除 console.log 和测试用户逻辑         |
| 移除敏感信息                   | 2025-12-06 | `miniprogram/` 和 `backend/`                         | 代码审查完成                            |
| CORS 安全加固                  | 2025-12-06 | `backend/src/config/cors.js`                         | 移除通配符 \* 使用安全配置              |
| 生产环境配置 (.env.production) | 2025-12-06 | `backend/.env.production`                            | 创建配置文件，占位符已标记              |
| JWT 密钥生成                   | 2025-12-06 | `backend/.env.production`                            | 使用 openssl rand -hex 32 生成安全密钥  |
| 数据库定期备份验证             | 2025-12-06 | crontab 设置                                         | 验证 Cron 任务正常运行（10:00 AM 每日） |

**完成率**: 7/7 高优先级任务 ✅ (100%)

### 🟡 待完成的中优先级任务（2项）

| 项目             | 优先级 | 说明                                        |
| ---------------- | ------ | ------------------------------------------- |
| 实现请求速率限制 | 中     | 推荐使用 `express-rate-limit`，防止暴力登录 |
| 应用监控和告警   | 中     | 可选：集成 PM2 Plus、Prometheus+Grafana 等  |

### 📋 待完成的基础设施任务（需手动操作）

- [ ] 购买和配置生产服务器
- [ ] 配置域名和 HTTPS
- [ ] 部署 Node.js 应用
- [ ] 配置数据库（补充用户名密码）
- [ ] 配置 WeChat AppID 和 Secret

---

## 🎯 一、小程序上线准备

### 1.1 微信平台配置

- [ ] **注册微信小程序**
  - [ ] 准备企业资质（营业执照等）
  - [ ] 企业认证（如果需要）
  - [ ] 联系方式和紧急联系人

- [ ] **小程序基本信息**
  - [ ] 应用名称：晨读营
  - [ ] 应用图标（清晰、符合规范）
  - [ ] 应用描述（简洁明了）
  - [x] 隐私政策和用户协议 ✅ (2025-12-06 完成)
  - [ ] 版权声明

- [ ] **微信平台 AppID 和 AppSecret**
  - [ ] 获取正式环境的 AppID
  - [ ] 配置服务器域名（SSL/HTTPS）
  - [ ] 配置消息推送服务器

### 1.2 代码安全审查

- [x] **移除开发调试代码** ✅ (2025-12-06 完成)
  - [x] 删除所有 `console.log()`（已有提示需要删除）
  - [x] 删除 `debugger` 语句
  - [x] 移除测试数据和硬编码的测试 ID

- [x] **敏感信息检查** ✅ (2025-12-06 完成)
  - [x] 不能在代码中硬编码 API 密钥
  - [x] 不能在代码中存储用户密码
  - [x] 移除内部 IP 地址、服务器地址
  - [x] 检查是否有泄露的 token 或密钥

- [ ] **权限声明**
  - [ ] 在 app.json 中声明所有使用的权限
  - [ ] 用户位置、摄像头、麦克风等权限申请

### 1.3 功能完整性检查

- [ ] **核心功能测试**
  - [ ] 登录/注册流程
  - [ ] 打卡功能
  - [ ] 小凡看见（反馈查看）权限系统
  - [ ] 用户信息修改
  - [ ] 数据查询和展示

- [ ] **兼容性测试**
  - [ ] 测试不同 iOS 版本
  - [ ] 测试不同 Android 版本
  - [ ] 测试不同网络环境（WiFi、4G、弱网）

- [ ] **性能优化**
  - [ ] 检查首屏加载时间（目标 < 2s）
  - [ ] 检查内存占用
  - [ ] 检查电池消耗
  - [ ] 实现图片懒加载

### 1.4 用户隐私和安全

- [x] **隐私政策** ✅ (2025-12-06 完成)
  - [x] 声明收集的用户数据类型
  - [x] 数据用途
  - [x] 数据保留期限
  - [x] 用户可以要求删除数据

- [ ] **数据加密**
  - [ ] 所有网络通信使用 HTTPS
  - [ ] 敏感数据加密存储
  - [ ] Token 安全存储（不放在 localStorage）

---

## 🖥️ 二、后端服务器上线准备

### 2.1 服务器选择和配置

- [ ] **云服务器选择**
  - [ ] 选择服务商（阿里云、腾讯云、AWS 等）
  - [ ] 选择合适的配置（CPU、内存、带宽）
  - [ ] 推荐起配：2核4GB、5Mbps 带宽
  - [ ] 配置自动备份

- [ ] **操作系统和基础环境**
  - [ ] 安装 Ubuntu 20.04 LTS（稳定、安全）
  - [ ] 安装 Node.js (v16+ LTS)
  - [ ] 安装 MongoDB (云服务或自建)
  - [ ] 安装 Nginx（反向代理、静态文件）
  - [ ] 安装 PM2（进程管理）

### 2.2 环境变量配置

- [x] **生产环境配置文件** (.env.production) ✅ (2025-12-06 完成)

  ```
  NODE_ENV=production
  PORT=3000
  MONGODB_URI=mongodb://user:password@host:27017/morning_reading
  JWT_SECRET=0f405b99aefbbb7e304e0a82b2ca9db14d0cb4ed02fdecbb57192e6c330a0a06 ✅
  JWT_REFRESH_SECRET=8ffd042c189499bf2c4af4fcb89d983d6b65ee050ca6e99a5a387d0443eed52c ✅
  API_BASE_URL=https://api.yourdomain.com
  WECHAT_APPID=<微信小程序的 AppID>
  WECHAT_APPSECRET=<微信小程序的 AppSecret>
  ```

- [x] **密钥管理** ✅ (2025-12-06 完成)
  - [x] 生成新的 JWT_SECRET（使用 openssl rand -hex 32）
  - [x] 不要在代码仓库中提交 .env 文件
  - [ ] 使用密钥管理系统（如云服务的 KMS）（可选）

### 2.3 数据库配置

- [x] **MongoDB 配置** ✅ (2025-12-06 完成)
  - [ ] 使用云数据库（推荐）或自建并配置主从
  - [ ] 启用认证（用户名和密码）
  - [x] 配置定期备份（已设置：每日 10:00） ✅ 验证完成
  - [ ] 备份存储位置（本地 + 云存储）
  - [ ] 测试备份恢复流程

- [ ] **数据库索引优化**
  - [ ] 为常用查询字段创建索引
  - [ ] 检查是否有重复的索引
  - [ ] 优化慢查询

### 2.4 API 安全加固

- [ ] **请求验证**
  - [ ] 所有 API 都需要认证（JWT Token）
  - [ ] 验证请求参数类型和范围
  - [ ] 实现请求速率限制
  - [ ] 防止 SQL 注入（使用 ORM）
  - [ ] 防止 XSS 攻击（数据转义）

- [x] **CORS 配置** ✅ (2025-12-06 完成)
  - [x] 只允许指定的小程序域名
  - [x] 不要使用通配符 \* (已创建 backend/src/config/cors.js，移除了通配符)

- [ ] **错误处理**
  - [ ] 不要在错误信息中泄露敏感信息
  - [ ] 返回通用的错误信息给客户端
  - [ ] 在服务器日志中记录详细错误

### 2.5 HTTPS 和 SSL 证书 ⭐ **关键部分**

- [ ] **SSL 证书申请**
  - [ ] ❌ **不要使用自签名证书！**（会导致浏览器安全警告）
  - [ ] ✅ **使用 Let's Encrypt 免费证书**（被全球浏览器信任）
  - [ ] 安装 certbot：`apt-get install certbot python3-certbot-nginx`
  - [ ] 申请证书：`certbot certonly --standalone -d your-domain.com`
  - [ ] 证书位置：`/etc/letsencrypt/live/your-domain.com/fullchain.pem`

- [ ] **Nginx 配置**
  - [ ] 更新 ssl_certificate 路径指向 Let's Encrypt 证书
  - [ ] 启用 HTTPS（listen 443 ssl http2）
  - [ ] 重定向 HTTP → HTTPS（listen 80 然后 return 301）
  - [ ] 配置 HSTS 头部：`add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;`

- [ ] **证书自动续期**
  - [ ] ✅ Certbot 已自动配置续期任务（/etc/cron.d/certbot）
  - [ ] 验证：`sudo certbot certificates`
  - [ ] 测试续期：`sudo certbot renew --dry-run`

- [ ] **验证 SSL 配置**

  ```bash
  # 检查证书有效期和颁发者
  openssl x509 -in /etc/letsencrypt/live/your-domain.com/fullchain.pem -text -noout | grep -E "Issuer|Valid"

  # 应该显示：
  # Issuer: C=US; O=Let's Encrypt  ✅ （受信任的 CA）
  # Not Before: ...  Not After: ...
  ```

### 2.6 Nginx 静态资源配置 ⭐ **常见坑**

> **重要！** 这个配置错误会导致页面白屏 + JavaScript 加载失败
> **症状**: 浏览器收到 MIME type 为 text/html 的 JavaScript 文件

- [ ] **Location 块优先级**（这是关键！）
  - [ ] ❌ 不要在 SPA 路由 location 中使用正则 `~`：`location ~ ^/admin/`
  - [ ] ✅ 应该使用非正则前缀 `^~`：`location ^~ /admin/`
  - [ ] 原因：Nginx 优先级 `^~` > `~` （非正则 > 正则）

- [ ] **静态资源 location 必须在前面**

  ```nginx
  # ✅ 正确的顺序

  # 1. API 代理（最高优先）
  location /api/ { proxy_pass http://backend; }

  # 2. 静态资源（必须在 SPA 路由之前！）
  location ^~ /admin/assets/ {
      alias /var/www/.../admin/dist/assets/;
      expires 30d;
      add_header Cache-Control "public, immutable";
  }

  # 3. SPA 路由（放在最后）
  location ^~ /admin/ {
      root /var/www/.../admin/dist;
      try_files $uri /index.html =404;
  }
  ```

- [ ] **MIME 类型验证**

  ```bash
  # 验证静态资源返回正确的 MIME 类型
  curl -I https://your-domain.com/admin/assets/app.js
  # 应该返回：content-type: application/javascript ✅

  curl -I https://your-domain.com/admin/assets/style.css
  # 应该返回：content-type: text/css ✅
  ```

- [ ] **缓存配置**
  - [ ] HTML 文件：`add_header Cache-Control "no-cache, no-store, must-revalidate"`
  - [ ] JS/CSS 文件：`add_header Cache-Control "public, immutable"; expires 30d`
  - [ ] 原因：防止过期 HTML 被缓存，同时充分利用 JS/CSS 缓存

- [ ] **测试完整流程**

  ```bash
  # 重启 Nginx
  sudo systemctl restart nginx

  # 测试首页
  curl -s https://your-domain.com/admin/ | head -20

  # 测试 API
  curl -I https://your-domain.com/api/v1/health
  ```

### 2.7 日志和监控

- [ ] **日志系统**
  - [ ] 配置 winston 或 bunyan 日志库
  - [ ] 日志分离：info、warn、error
  - [ ] 日志文件轮转（不要无限增长）
  - [ ] 日志存储位置：/var/log/morning-reading/

- [ ] **监控告警**
  - [ ] 监控 CPU、内存、磁盘使用率
  - [ ] 监控 API 响应时间
  - [ ] 监控错误率
  - [ ] 当出现异常时发送告警邮件/短信

---

## 🏗️ 三、基础设施准备

### 3.1 域名和 DNS

- [ ] **域名注册**
  - [ ] 注册正式域名（如 morningreading.com）
  - [ ] 备案（中国需要）

- [ ] **DNS 配置**
  - [ ] A 记录指向服务器 IP
  - [ ] CNAME 记录（如果使用 CDN）
  - [ ] MX 记录（如果需要邮件服务）
  - [ ] TXT 记录（SPF 等）

### 3.2 CDN（可选）

- [ ] **静态文件加速**
  - [ ] 配置 CDN 加速静态资源
  - [ ] 配置 CDN 缓存策略
  - [ ] 减少源站压力

### 3.3 邮件服务（可选）

- [ ] **邮件通知**
  - [ ] 配置 SMTP 服务
  - [ ] 用于发送告警、重置密码等

---

## 🔒 四、安全加固

### 4.1 服务器安全

- [ ] **防火墙配置**
  - [ ] 开放必要的端口：80（HTTP）、443（HTTPS）、22（SSH）
  - [ ] 关闭其他所有端口
  - [ ] 禁用 root 登录
  - [ ] 配置 SSH 密钥认证，禁用密码认证

- [ ] **系统更新**
  - [ ] 定期更新系统补丁
  - [ ] 定期更新依赖包

- [ ] **DDoS 防护**
  - [ ] 配置云服务商提供的 DDoS 防护
  - [ ] 考虑 WAF（Web Application Firewall）

### 4.2 应用安全

- [ ] **依赖包安全**
  - [ ] 检查是否有已知安全漏洞：`npm audit`
  - [ ] 定期更新依赖包

- [ ] **代码审查**
  - [ ] 二次确认没有硬编码的密钥
  - [ ] 检查是否有 console.log 输出敏感信息

### 4.3 用户数据保护

- [ ] **数据加密**
  - [ ] 数据库中敏感数据加密（如密码、手机号）
  - [ ] 使用 bcrypt 加密用户密码
  - [ ] Token 有过期时间

- [ ] **备份安全**
  - [ ] 备份文件加密存储
  - [ ] 备份定期测试恢复

---

## ✅ 五、测试和质量保证

### 5.1 功能测试

- [ ] **用户场景测试**
  - [ ] 新用户注册和首次登录
  - [ ] 打卡流程（正常、重复、多设备）
  - [ ] 权限申请和批准流程
  - [ ] 数据查询和展示

- [ ] **边界条件测试**
  - [ ] 网络中断处理
  - [ ] 长时间不操作（token 过期）
  - [ ] 大批量数据处理

### 5.2 性能测试

- [ ] **压力测试**
  - [ ] 模拟 1000+ 并发用户
  - [ ] 检查响应时间是否在可接受范围内
  - [ ] 检查数据库连接池是否充足

- [ ] **优化方向**
  - [ ] 数据库查询优化
  - [ ] API 缓存策略
  - [ ] 前端资源压缩

### 5.3 安全测试

- [ ] **黑盒测试**
  - [ ] 尝试无 token 访问 API
  - [ ] 尝试使用过期 token
  - [ ] 尝试访问他人的数据
  - [ ] SQL 注入测试

- [ ] **代码审计**
  - [ ] 使用 SAST 工具（如 SonarQube）
  - [ ] 手工代码审查

---

## 📋 六、部署流程

### 6.1 部署前检查清单

- [ ] 所有测试通过
- [ ] 代码合并到 main 分支
- [ ] 环境变量配置完毕
- [ ] 数据库备份
- [ ] 部署脚本测试成功

### 6.2 部署步骤

1. [ ] 备份当前生产数据库
2. [ ] 在测试服务器验证新代码
3. [ ] 停止当前服务（或灰度发布）
4. [ ] 拉取最新代码：`git pull origin main`
5. [ ] 安装依赖：`npm install --production`
6. [ ] 运行数据库迁移（如有）
7. [ ] 启动新服务：`pm2 restart all`
8. [ ] 验证服务正常：`curl http://localhost:3000/api/v1/health`
9. [ ] 监控日志 1 小时

### 6.3 回滚方案

- [ ] 保留前 3 个版本的代码
- [ ] 快速回滚脚本：恢复代码和数据库
- [ ] 回滚时间目标：< 5 分钟

---

## 🚀 七、运维计划

### 7.1 日常运维

- [ ] **每日检查**
  - [ ] 服务是否正常运行
  - [ ] 错误日志是否有异常
  - [ ] 磁盘空间是否充足

- [ ] **每周检查**
  - [ ] 数据库备份是否成功
  - [ ] 系统性能是否下降
  - [ ] 是否有用户反馈

- [ ] **每月检查**
  - [ ] 更新系统补丁
  - [ ] 审查依赖包更新
  - [ ] 进行性能分析

### 7.2 灾难恢复计划

- [ ] **RTO（恢复时间目标）**：< 30 分钟
- [ ] **RPO（恢复点目标）**：< 1 小时

- [ ] **应急流程**
  1. 检测异常 → 告警通知
  2. 分析问题 → 确定恢复方案
  3. 执行恢复 → 验证服务
  4. 通知用户 → 总结复盘

### 7.3 文档维护

- [ ] **部署文档**：记录部署步骤和配置
- [ ] **运维手册**：常见问题和解决方案
- [ ] **应急预案**：各种故障的处理流程

---

## 📊 八、成本评估

### 服务器相关

- [ ] 云服务器：200-500 元/月（2核4GB）
- [ ] 数据库：100-300 元/月（云服务）
- [ ] CDN（可选）：按流量计费

### 域名和 SSL

- [ ] 域名注册：50-100 元/年
- [ ] SSL 证书：免费（Let's Encrypt）或 50-500 元/年

### 其他

- [ ] 监控告警服务（可选）：100-500 元/月
- [ ] 邮件服务（可选）：按发送量计费

---

## 🎯 九、上线顺序（推荐）

### Phase 1: 内测（1-2 周）

1. [ ] 选定服务器
2. [ ] 配置生产环境
3. [ ] 部署后端服务
4. [ ] 内部用户测试

### Phase 2: 灰度发布（1-2 周）

1. [ ] 提交微信小程序审核
2. [ ] 邀请 100-500 个测试用户
3. [ ] 收集反馈并修复 bug
4. [ ] 监控系统运行状态

### Phase 3: 正式上线

1. [ ] 微信小程序审核通过
2. [ ] 发布小程序版本
3. [ ] 公开宣传
4. [ ] 全量发布

---

## ⚠️ 常见陷阱（避免这些）

- ❌ 使用开发环境的密钥在生产环境
- ❌ 没有备份计划就上线
- ❌ 没有监控和告警
- ❌ 代码中有 console.log 和调试代码
- ❌ 没有 HTTPS/SSL
- ❌ 没有速率限制（容易被刷）
- ❌ 没有测试就直接部署
- ❌ 没有回滚方案
- ❌ 没有文档和 runbook
- ❌ 一个人负责所有运维

---

## ✨ 快速检查清单（上线前 24 小时）

```
安全检查：
- [ ] 没有 console.log
- [ ] 没有硬编码的密钥
- [ ] JWT 密钥已更换
- [ ] HTTPS 已配置
- [ ] 防火墙规则已设置

功能检查：
- [ ] 所有主要功能已测试
- [ ] 数据库连接正常
- [ ] API 接口响应正常
- [ ] 小程序可以正常登录和使用

系统检查：
- [ ] 服务器资源充足（CPU、内存、磁盘）
- [ ] 数据库备份已测试
- [ ] 日志系统已启动
- [ ] 监控告警已配置

部署检查：
- [ ] 代码已合并到 main
- [ ] 环境变量已配置
- [ ] 部署脚本已测试
- [ ] 回滚方案已准备
```

---

## 📞 上线后支持

- [ ] 24h 值班人员（处理紧急问题）
- [ ] 监控和告警（自动通知）
- [ ] 用户反馈渠道（邮件、客服、论坛）
- [ ] 问题响应时间：SLA < 4 小时

---

**下一步**：根据上述清单，估算所需时间和资源。建议提前 2-4 周开始准备。
